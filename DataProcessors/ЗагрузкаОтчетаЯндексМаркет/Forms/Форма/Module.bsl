
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("Организация") Тогда
		Объект.Организация = Параметры.Организация;
	Иначе
		Объект.Организация = Справочники.Организации.ОрганизацияПоУмолчанию();
	КонецЕсли;
	
	Параметры.Свойство("Магазин", ОрганизацияИзОтчета);
	
	ПропуститьОрганизацию = Параметры.ПропуститьОрганизацию;
	
	Если Параметры.Свойство("АдресХранилища") Тогда
		АдресХранилища = Параметры.АдресХранилища;
	КонецЕсли;
	
	СпособЗагрузки = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(
		Параметры, "СпособЗагрузки", ОбменСМаркетплейсКлиентСервер.СпособЗагрузкиЧерезАПИ());
	
	Если ЗначениеЗаполнено(АдресХранилища) Тогда
		ЗаполнитьПериоды();
		Заголовок = НСтр("ru = 'Загрузка отчета Яндекс.Маркет за '") + Формат(Объект.Период, "ДФ='ММММ ггг'");
	Конецесли;
	
	УправлениеФормой(ЭтотОбъект);
	УстановитьФункциональныеОпцииФормы();
			
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	Если (НЕ ИспользоватьНесколькоОрганизацийБухгалтерскийУчет
		И ЗначениеЗаполнено(Объект.Организация)) ИЛИ ПропуститьОрганизацию Тогда
		//Если ведется учет по одной организации - пропустим указание организации
		ПодключитьОбработчикОжидания("Подключаемый_ПропуститьОрганизацию", 1, Истина);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ДекорацияОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ОткрытьДеревоДокументов();
	
КонецПроцедуры

&НаКлиенте
Процедура КонтрагентПриИзменении(Элемент)
	
	КонтрагентПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ПлатежныйАгентПриИзменении(Элемент)
	
	ПлатежныйАгентПриИзмененииНаСервере();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Назад(Команда)
	
	ШагНазад();
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура Далее(Команда)
	
	Если ПроверкаЗаполнения() Тогда
		ШагВперед();
	КонецЕсли;
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

&НаКлиенте
Процедура Настройка(Команда)
	
	Если ПроверкаЗаполнения() Тогда
		ПрочитатьНастройки();
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка;
		УправлениеФормой(ЭтотОбъект);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьДеревоДокументов()
	
	ПараметрыФормы = ОбменСМАркетплейсКлиент.НовыйПараметрыДереваСвязанныхДокументов();
	ПараметрыФормы.ДеревоДокументов = АдресХранилищаДерева;
	ЗаполнитьЗначенияСвойств(ПараметрыФормы, Объект);
	
	ОповещениеОЗакрытии = Новый ОписаниеОповещения("ДеревоДокументовЗавершение", ЭтотОбъект);
	ОткрытьФорму("Обработка.ЗагрузкаОтчетаЯндексМаркет.Форма.ФормаСписокДокументов", ПараметрыФормы, ЭтотОбъект, , , , ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиентеНаСервереБезКонтекста
Процедура УправлениеФормой(Форма)
	
	Элементы = Форма.Элементы;
	
	Элементы.ФормаНастройка.Видимость = Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаРеквизиты;
	
	Элементы.ФормаНазад.Видимость = Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка
		ИЛИ Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие;
		
	Элементы.ФормаДалее.Видимость = Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаРеквизиты
		ИЛИ Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка
		ИЛИ Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие;
		
	Элементы.ГруппаДляДокументов.Видимость = Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка;
	
	Элементы.ГруппаОшибкаОснованияРеализации.Видимость = Форма.ОшибкаОснованияРеализации;
	Элементы.ГруппаОшибкаОснованияВозврата.Видимость = Форма.ОшибкаОснованияВозврата;
	Элементы.ГруппаОшибокНет.Видимость = НЕ (Форма.ОшибкаОснованияРеализации ИЛИ Форма.ОшибкаОснованияВозврата);
	Элементы.ГруппаОшибкиЕсть.Видимость = (Форма.ОшибкаОснованияРеализации ИЛИ Форма.ОшибкаОснованияВозврата);
	
	Элементы.ФормаДалее.Заголовок = ?(Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие, "Загрузить", "Далее");
	
	Элементы.Декорация2.Видимость = Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаСопоставление;
	Элементы.Декорация3.Видимость = Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаСозданиеДокументов;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьФункциональныеОпцииФормы()

	ИспользоватьНесколькоОрганизацийБухгалтерскийУчет = ПолучитьФункциональнуюОпцию("ИспользоватьНесколькоОрганизацийБухгалтерскийУчет");
	
КонецПроцедуры

&НаСервере
Процедура ПрочитатьНастройки()
	
	НастройкаИнтеграции = Справочники.НастройкиИнтеграцииМаркетплейс.НастройкаПоУмолчанию(Объект.Организация, Перечисления.ВидыМаркетплейсов.ЯндексМаркет);
	ЗаполнитьЗначенияСвойств(Объект, НастройкаИнтеграции);
	
	ГруппаДляНовыхКонтрагентов = ОбщегоНазначения.ХранилищеОбщихНастроекЗагрузить(
		ВладелецХранилищаНастроек(), "ГруппаДляНовыхКонтрагентов");
	
КонецПроцедуры

&НаСервере
Процедура ЗаписатьНастройки()
	
	НастройкаИнтеграции = Справочники.НастройкиИнтеграцииМаркетплейс.НастройкаПоУмолчанию(Объект.Организация, Перечисления.ВидыМаркетплейсов.ЯндексМаркет);
	Если ЗначениеЗаполнено(НастройкаИнтеграции) Тогда
		НастройкаИнтеграцииОбъект = НастройкаИнтеграции.ПолучитьОбъект();
	Иначе
		НастройкаИнтеграцииОбъект = Справочники.НастройкиИнтеграцииМаркетплейс.СоздатьЭлемент();
		НастройкаИнтеграцииОбъект.Владелец = Объект.Организация;
		НастройкаИнтеграцииОбъект.ВидМаркетплейса = Перечисления.ВидыМаркетплейсов.ЯндексМаркет;
		НастройкаИнтеграцииОбъект.Наименование = "Яндекс.Маркет";
	КонецЕсли;
	ЗаполнитьЗначенияСвойств(НастройкаИнтеграцииОбъект, Объект);
	НастройкаИнтеграцииОбъект.Записать();
	
	ОбщегоНазначения.ХранилищеОбщихНастроекСохранить(
		ВладелецХранилищаНастроек(), "ГруппаДляНовыхКонтрагентов", ГруппаДляНовыхКонтрагентов);
	
КонецПроцедуры

&НаСервере
Процедура КонтрагентПриИзмененииНаСервере()
	
	ВидыДоговоров = Новый Массив;
	ВидыДоговоров.Добавить(Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
	РаботаСДоговорамиКонтрагентовБП.УстановитьДоговорКонтрагента(Объект.ДоговорКонтрагента, Объект.Контрагент, Объект.Организация, ВидыДоговоров);
	
КонецПроцедуры

&НаСервере
Процедура ПлатежныйАгентПриИзмененииНаСервере()
	
	ВидыДоговоров = Новый Массив;
	ВидыДоговоров.Добавить(Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
	РаботаСДоговорамиКонтрагентовБП.УстановитьДоговорКонтрагента(Объект.ДоговорПлатежногоАгента, Объект.ПлатежныйАгент, Объект.Организация, ВидыДоговоров);
	
КонецПроцедуры

&НаСервере
Процедура СоздатьДоговор()

	ПараметрыДоговора = Новый Структура;
	ПараметрыДоговора.Вставить("ВидДоговора", Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
	ПараметрыДоговора.Вставить("Организация", Объект.Организация);
	ПараметрыДоговора.Вставить("Владелец",    Объект.Контрагент);
	ПараметрыСоздания = Новый Структура("ЗначенияЗаполнения", ПараметрыДоговора);
	Объект.ДоговорКонтрагента = РаботаСДоговорамиКонтрагентовБПВызовСервера.СоздатьОсновнойДоговорКонтрагента(ПараметрыСоздания);
	
КонецПроцедуры

&НаСервере
Процедура СоздатьДоговорПлатежногоАгента()

	ПараметрыДоговора = Новый Структура;
	ПараметрыДоговора.Вставить("ВидДоговора", Перечисления.ВидыДоговоровКонтрагентов.СПокупателем);
	ПараметрыДоговора.Вставить("Организация", Объект.Организация);
	ПараметрыДоговора.Вставить("Владелец",    Объект.ПлатежныйАгент);
	ПараметрыСоздания = Новый Структура("ЗначенияЗаполнения", ПараметрыДоговора);
	Объект.ДоговорПлатежногоАгента = РаботаСДоговорамиКонтрагентовБПВызовСервера.СоздатьОсновнойДоговорКонтрагента(ПараметрыСоздания);
	
КонецПроцедуры

&НаКлиенте
Процедура ШагВперед()
	
	Если Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаРеквизиты Тогда
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка;
		ПрочитатьНастройки();
		Если ПроверкаЗаполнения() Тогда
			ШагВперед();
		КонецЕсли;
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка Тогда
		ЗаписатьНастройки();
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие;
		ЗаполнитьСвязанныеДокументы();
		Если НЕ (ОшибкаОснованияВозврата ИЛИ ОшибкаОснованияРеализации) Тогда
			ШагВперед();
		КонецЕсли;
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие Тогда
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаСопоставление;
		ПодключитьОбработчикОжидания("НачатьСопоставлениеНоменклатуры", 0.1, Истина);
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаСопоставление Тогда	
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаСозданиеДокументов;
		ПодключитьОбработчикОжидания("НачатьСозданиеДокументов", 0.1, Истина);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ШагНазад()
	
	Если Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка Тогда
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаРеквизиты;
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие Тогда
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка;
		Если ПроверкаЗаполнения() Тогда
			ШагНазад();
		КонецЕсли;
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаСопоставление Тогда
		Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие;
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Функция ПроверкаЗаполнения()
	
	Если Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаРеквизиты Тогда
		
		Если НЕ ЗначениеЗаполнено(Объект.Организация) Тогда
			Возврат Ложь;
		КонецЕсли;
		
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаНастройка Тогда
		
		Если (НЕ ЗначениеЗаполнено(Объект.Контрагент))
			ИЛИ (НЕ ЗначениеЗаполнено(Объект.Склад))
			Или Не ЗначениеЗаполнено(Объект.ПлатежныйАгент) Тогда
			Возврат Ложь;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Объект.ДоговорКонтрагента) 
			И ЗначениеЗаполнено(Объект.Организация) 
			И ЗначениеЗаполнено(Объект.Контрагент) Тогда
			
			СоздатьДоговор();
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Объект.ДоговорПлатежногоАгента)
			И ЗначениеЗаполнено(Объект.Организация)
			И ЗначениеЗаполнено(Объект.ПлатежныйАгент) Тогда
			
			СоздатьДоговорПлатежногоАгента();
		КонецЕсли;
		
	ИначеЕсли Элементы.ГруппаСтраницы.ТекущаяСтраница = Элементы.ГруппаДействие Тогда
		
		Если КоличествоДокументовСоздать = 0 Тогда
			Возврат Ложь;
		КонецЕсли;
				
	КонецЕсли;
	
	Возврат Истина;
		
КонецФункции

&НаСервере
Процедура ЗаполнитьПериоды()
	
	МассивДокументов = ПолучитьИзВременногоХранилища(АдресХранилища);
	Если ТипЗнч(МассивДокументов) = Тип("Массив") Тогда
		Обработки.ЗагрузкаОтчетаЯндексМаркет.ЗаполнитьПериоды(
			Объект, МассивДокументов, ОрганизацияИзОтчета);
	КонецЕсли;
	
КонецПроцедуры

#Область СвязанныеДокументы

&НаСервере
Процедура ЗаполнитьСвязанныеДокументы()
	
	Результат = Обработки.ЗагрузкаОтчетаЯндексМаркет.ЗаполнитьСвязанныеДокументы(Объект);
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, Результат);
	
	АдресХранилищаДерева = ПоместитьВоВременноеХранилище(Результат.Дерево, ЭтотОбъект.УникальныйИдентификатор); 
	
КонецПроцедуры

&НаКлиенте
Процедура ДеревоДокументовЗавершение(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	ОбновитьДеревоДокументов();
	УправлениеФормой(ЭтотОбъект);
	Если НЕ РезультатЗакрытия = Неопределено Тогда
		ШагВперед();
	КонецЕсли;
	
Конецпроцедуры

&НаСервере
Процедура ОбновитьДеревоДокументов()
	
	Дерево = ПолучитьИзВременногоХранилища(АдресХранилищаДерева);
	
	КоличествоДокументов = 1 + Объект.Реализации.Количество() + Объект.Невыкупы.Количество() + Объект.Возвраты.Количество();
	КоличествоДокументовСоздать = Дерево.Строки.НайтиСтроки(Новый Структура("Создать", Истина), Истина).Количество();
	
	//ОшибкаОснованияРеализации
	ОшибкаОснованияРеализации = Ложь;
	СтрокиРеализация = Дерево.Строки.НайтиСтроки(Новый Структура("Блокировка, ТекущийПериод, ТипДокумента", Истина, Истина, "РеализацияОтгруженныхТоваров"), Истина);
	Для Каждого СтрокаДерева Из СтрокиРеализация Цикл
		ОшибкаОснованияРеализации = ПроверитьРодителяСтрокиДерева(СтрокаДерева);
		Если ОшибкаОснованияРеализации Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	//ОшибкаОснованияВозврата
	ОшибкаОснованияВозврата = Ложь;
	СтрокиВозврата = Дерево.Строки.НайтиСтроки(Новый Структура("Блокировка, ТекущийПериод, ТипДокумента", Истина, Истина, "ВозвратТоваровОтПокупателя"), Истина);
	Для Каждого СтрокаДерева Из СтрокиВозврата Цикл
		ОшибкаОснованияВозврата = ПроверитьРодителяСтрокиДерева(СтрокаДерева);
		Если ОшибкаОснованияВозврата Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПроверитьРодителяСтрокиДерева(СтрокаДерева)
	
	ПроверяемаяСтрока = СтрокаДерева.Родитель;
	Если ПроверяемаяСтрока = Неопределено Тогда
		Возврат Ложь;
	ИначеЕсли ПроверяемаяСтрока.ТекущийПериод Тогда
		Возврат ПроверитьРодителяСтрокиДерева(ПроверяемаяСтрока);
	Иначе		
		Возврат НЕ ЗначениеЗаполнено(ПроверяемаяСтрока.Документ);
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область СопоставлениеНоменклатуры

&НаКлиенте
Процедура НачатьСопоставлениеНоменклатуры()
	
	ДлительнаяОперация 	= НачатьПолучениеСписокНеСопоставленнойНоменклатуры();
	ПараметрыОжидания 	= ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	
	Оповещение = Новый ОписаниеОповещения("СопоставлениеНоменклатуры", ЭтотОбъект);
 	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, Оповещение, ПараметрыОжидания);	
	
КонецПроцедуры

&НаСервере
Функция НачатьПолучениеСписокНеСопоставленнойНоменклатуры()
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияФункции(УникальныйИдентификатор);
	ДанныеФайла         = ПолучитьИзВременногоХранилища(АдресХранилища);
 	Возврат ДлительныеОперации.ВыполнитьФункцию(
				ПараметрыВыполнения, 
				"Обработки.ЗагрузкаОтчетаЯндексМаркет.СписокНеСопоставленнойНоменклатурыНаСервере", 
				ДанныеФайла, Объект.Контрагент);
	
КонецФункции

&НаКлиенте
Процедура СопоставлениеНоменклатуры(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	ИначеЕсли Результат.Статус = "Ошибка" Тогда
		ВызватьИсключение Результат.КраткоеПредставлениеОшибки;
	ИначеЕсли Результат.Статус = "Выполнено" Тогда
		СписокНеСопоставленнойНоменклатуры = СписокНеСопоставленнойНоменклатурыНаСервере(Результат.АдресРезультата);
		Если СписокНеСопоставленнойНоменклатуры.Количество() > 0 Тогда
			НастройкиСопоставления = НастройкиСопоставленияНоменклатуры();
			ОбработчикОповещения = Новый ОписаниеОповещения("СопоставлениеНоменклатурыЗавершение", ЭтотОбъект);			
			СопоставлениеНоменклатурыКонтрагентовКлиент.ОткрытьСопоставлениеНоменклатуры(СписокНеСопоставленнойНоменклатуры, НастройкиСопоставления, ОбработчикОповещения);
		Иначе
			СопоставлениеНоменклатурыЗавершение(Истина, Неопределено);
		КонецЕсли;
	КонецЕсли;
			
КонецПроцедуры

&НаСервереБезКонтекста
Функция НастройкиСопоставленияНоменклатуры()
	Возврат ИнтеграцияЯндексМаркет.НастройкиСопоставленияНоменклатуры();
КонецФункции

&НаСервереБезКонтекста
Функция СписокНеСопоставленнойНоменклатурыНаСервере(АдресРезультата)
	
	Возврат ПолучитьИзВременногоХранилища(АдресРезультата);
	
КонецФункции

&НаКлиенте
Процедура СопоставлениеНоменклатурыЗавершение(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	
	ШагВперед();
	УправлениеФормой(ЭтотОбъект);
	
Конецпроцедуры

#КонецОбласти

#Область СозданиеДокументов

&НаКлиенте
Процедура НачатьСозданиеДокументов()
	
	ОтчетМаркетплейса   = Неопределено;
	ДлительнаяОперация 	= НачатьСозданиеДокументовНаСервере(ОтчетМаркетплейса);
	ПараметрыОжидания 	= ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ВыводитьОкноОжидания = Ложь;
	Оповещение = Новый ОписаниеОповещения("ЗавершениеСозданияДокументов", ЭтотОбъект, ОтчетМаркетплейса);
 	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, Оповещение, ПараметрыОжидания);
	
КонецПроцедуры

&НаСервере
Функция НачатьСозданиеДокументовНаСервере(ОтчетМаркетплейса)
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияФункции(УникальныйИдентификатор);
	
	ДанныеФайла         = ПолучитьИзВременногоХранилища(АдресХранилища);
	ДеревоДокументов    = ПолучитьИзВременногоХранилища(АдресХранилищаДерева);
	
	ИнтеграцияЯндексМаркет.УстановитьСпособЗагрузки(ДанныеФайла, СпособЗагрузки);
	
	ПараметрыДокумента = Обработки.ЗагрузкаОтчетаЯндексМаркет.ПараметрыСозданияДокументов(
		Объект, ОрганизацияИзОтчета, ГруппаДляНовыхКонтрагентов);
	
	ОтчетМаркетплейса = ПараметрыДокумента.ОтчетМаркетплейса;
	
	Возврат ДлительныеОперации.ВыполнитьПроцедуру(
				ПараметрыВыполнения,
				"Обработки.ЗагрузкаОтчетаЯндексМаркет.СоздатьДокументы",
				ПараметрыДокумента, ДанныеФайла, ДеревоДокументов);
	
КонецФункции

&НаКлиенте
Процедура ЗавершениеСозданияДокументов(Результат, ОтчетМаркетплейса) Экспорт

	Если Результат = Неопределено Тогда
		Возврат;
	ИначеЕсли Результат.Статус = "Ошибка" Тогда
		ВызватьИсключение Результат.КраткоеПредставлениеОшибки;
	ИначеЕсли Результат.Статус = "Выполнено" Тогда
		ОповеститьОбИзменении(ОтчетМаркетплейса);
		
		ПараметрыФормы = Новый Структура("Ключ", ОтчетМаркетплейса); 
		ОписаниеОповещения = Новый ОписаниеОповещения("ОткрытьФормуДокументаЗавершение", ЭтотОбъект);
		ОткрытьФорму("Документ.ОтчетМаркетплейса.ФормаОбъекта", ПараметрыФормы,,,,,ОписаниеОповещения);
	КонецЕсли;
	
	Оповестить("ИзмененыДокументыМаркетплейсов");
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуДокументаЗавершение(Значение, ДополнительныеПараметры) Экспорт
	Закрыть();
КонецПроцедуры


&НаКлиенте
Процедура Подключаемый_ПропуститьОрганизацию()
	
	ШагВперед();
	УправлениеФормой(ЭтотОбъект);
	
КонецПроцедуры

#КонецОбласти

&НаСервереБезКонтекста
Функция ВладелецХранилищаНастроек()
	
	Возврат ОбменСМаркетплейс.ВладелецХранилищаНастроек();
	
КонецФункции

#КонецОбласти
