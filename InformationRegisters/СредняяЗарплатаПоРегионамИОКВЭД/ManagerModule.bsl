
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Возвращает величину средней зарплаты по переданным коду региона, коду ОКВЭД и дате.
//
// Параметры:
//  КодРегиона - Строка - код субъекта РФ, для которого нужно получить данные.
//  КодОКВЭД - Строка - код вида деятельности, для которого нужно получить данные.
//  Дата - Дата - дата, на которую необходимо получить данные.
// Возвращаемое значение:
//  Неопределено - данные не найдены.
//  Число - величина средней зарплаты.
//
Функция ВеличинаЗарплаты(КодРегиона, КодОКВЭД, Дата) Экспорт
	
	ГодДанных = Год(Дата);
	ИерархияКодовОКВЭД = КлассификаторОКВЭДБП.КодВИерархии(КодОКВЭД);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	МАКСИМУМ(СредняяЗарплатаПоРегионамИОКВЭД.Год) КАК Год
	|ПОМЕСТИТЬ ГодПолученияДанных
	|ИЗ
	|	РегистрСведений.СредняяЗарплатаПоРегионамИОКВЭД КАК СредняяЗарплатаПоРегионамИОКВЭД
	|ГДЕ
	|	СредняяЗарплатаПоРегионамИОКВЭД.Год <= &ГодДанных
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	СредняяЗарплатаПоРегионамИОКВЭД.СредняяЗарплата КАК СредняяЗарплата
	|ИЗ
	|	РегистрСведений.СредняяЗарплатаПоРегионамИОКВЭД КАК СредняяЗарплатаПоРегионамИОКВЭД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ГодПолученияДанных КАК ГодПолученияДанных
	|		ПО СредняяЗарплатаПоРегионамИОКВЭД.Год = ГодПолученияДанных.Год
	|ГДЕ
	|	СредняяЗарплатаПоРегионамИОКВЭД.КодРегиона = &КодРегиона
	|	И СредняяЗарплатаПоРегионамИОКВЭД.КодОКВЭД В(&СписокОКВЭД)
	|
	|УПОРЯДОЧИТЬ ПО
	|	СредняяЗарплатаПоРегионамИОКВЭД.КодОКВЭД УБЫВ";
	
	Запрос.УстановитьПараметр("ГодДанных", ГодДанных);
	Запрос.УстановитьПараметр("КодРегиона", КодРегиона);
	Запрос.УстановитьПараметр("СписокОКВЭД", ИерархияКодовОКВЭД);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.СредняяЗарплата;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// См. РаботаСКлассификаторамиПереопределяемый.ПриДобавленииКлассификаторов.
//
Процедура ПриДобавленииКлассификаторов(Классификаторы) Экспорт
	
	Описатель = РаботаСКлассификаторами.ОписаниеКлассификатора();
	Описатель.Наименование = НСтр("ru = 'Средняя зарплата по регионам и ОКВЭД'");
	Описатель.Идентификатор = ИдентификаторВСервисеКлассификаторов();
	
	Классификаторы.Добавить(Описатель);
	
КонецПроцедуры

// См. РаботаСКлассификаторамиПереопределяемый.ПриЗагрузкеКлассификатора.
//
Процедура ПриЗагрузкеКлассификатора(Идентификатор, Версия, Адрес, Обработан) Экспорт
	
	Если Идентификатор <> ИдентификаторВСервисеКлассификаторов() Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(Адрес);
		Поток = ДвоичныеДанные.ОткрытьПотокДляЧтения();
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.ОткрытьПоток(Поток);
		ДанныеКлассификатора = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		ЗаписатьДанные(ДанныеКлассификатора);
		Обработан = Истина;
		
	Исключение
		
		Обработан = Ложь;
		ЗаписьЖурналаРегистрации("ЗагрузкаКлассификатора",
			УровеньЖурналаРегистрации.Ошибка, 
			Метаданные.РегистрыСведений.СредняяЗарплатаПоРегионамИОКВЭД, ,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		Возврат;
		
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаписатьДанные(ДанныеКлассификатора)
	
	Набор = РегистрыСведений.СредняяЗарплатаПоРегионамИОКВЭД.СоздатьНаборЗаписей();
	Для каждого Элемент Из ДанныеКлассификатора.classifierData Цикл
		
		Запись = Набор.Добавить();
		Запись.Год = Элемент.Год;
		Запись.КодРегиона = Элемент.КодРегиона;
		Запись.КодОКВЭД = Элемент.КодОКВЭД;
		Запись.СредняяЗарплата = Элемент.СредняяЗарплата;
		
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Истина);
	Набор.Записать();
	
КонецПроцедуры

Функция ИдентификаторВСервисеКлассификаторов()

	Возврат "AverageSalaryByRegionAndOKVED";

КонецФункции

#КонецОбласти

#КонецЕсли
