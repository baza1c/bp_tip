#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

Функция ДанныеАвтоматическогоЗаполненияПодготовлены(Уведомление) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Параметры.Вставить("Уведомление", Уведомление);
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	КонтролируемыеСделкиОрганизаций.Регистратор
	|ИЗ
	|	РегистрНакопления.КонтролируемыеСделкиОрганизаций КАК КонтролируемыеСделкиОрганизаций
	|ГДЕ
	|	КонтролируемыеСделкиОрганизаций.Регистратор = &Уведомление";
	РезультатЗапроса = Запрос.Выполнить();
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

Функция УведомлениеЗаполнено(Уведомление) Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Параметры.Вставить("Уведомление", Уведомление);
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &Уведомление
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления";
	
	РезультатЗапроса = Запрос.Выполнить();
	Возврат НЕ РезультатЗапроса.Пустой();
	
КонецФункции

Процедура ПодготовитьДанныеАвтоматическогоЗаполнения(Уведомление) Экспорт
	
	МенеджерВременныхТаблиц = ПолучитьВременныеТаблицыДляЗаполненияСделок(Уведомление);
	
	ТаблицаСделок = ПолучитьТаблицуСделок();
	
	ТаблицаСделок.Очистить();
	ДобавитьСделкиРеализацииТоваровУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиРеализацииОтгруженныхТоваров(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПоступленияТоваровУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПоступленияДопРасходов(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиРеализацииУслугПоПереработке(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПоступленияИзПереработки(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиАктаОбОказанииУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиОтчетаКомитентуОПродажах(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиОтчетаКомиссионераОПродажах(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиОказанияУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПередачиОС(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПоступленияНМА(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиПередачиНМА(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиВозвратаТоваровПоставщику(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиВозвратаТоваровПоставщикуСделкаВТабличнойЧасти(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиВозвратаТоваровОтПокупателя(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиКорректировкиРеализации(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиКорректировкиПоступления(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	ДобавитьСделкиОтчетаКомиссионераОПродажахЗависимымЛицам(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	
	ТаблицаСделок.Колонки.Добавить("Уведомление", Новый ОписаниеТипов("ДокументСсылка.УведомлениеОКонтролируемыхСделках"));
	ТаблицаСделок.ЗаполнитьЗначения(Уведомление, "Уведомление");
	
	КонтролируемыеСделкиНаборЗаписей = РегистрыНакопления.КонтролируемыеСделкиОрганизаций.СоздатьНаборЗаписей();
	КонтролируемыеСделкиНаборЗаписей.Отбор.Регистратор.Значение = Уведомление;

	КонтролируемыеСделкиНаборЗаписей.Загрузить(ТаблицаСделок);
	
	НачатьТранзакцию();
	КонтролируемыеСделкиНаборЗаписей.Записать();
	ОбъектУведомление = Уведомление.ПолучитьОбъект();
	ОбъектУведомление.ДатаФормированияСпискаСделок = ТекущаяДатаСеанса();
	ОбъектУведомление.Записать();
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры

Процедура СформироватьКонтролируемыеСделкиУведомленияВФоне(Параметры, АдресХранилища) Экспорт
	
	СформироватьКонтролируемыеСделки(Параметры.Уведомление, Параметры.СообщатьОПрогрессе);
	
КонецПроцедуры

Процедура СформироватьКонтролируемыеСделкиУведомления(Уведомление) Экспорт
	
	СформироватьКонтролируемыеСделки(Уведомление, Ложь);
	
КонецПроцедуры

Функция ПолучитьВременныеТаблицыДляЗаполненияУведомления(Уведомление) Экспорт
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация,ОтчетныйГод,ВерсияУведомления");
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = ПолучитьВременныеТаблицыДляЗаполненияСделок(Уведомление);
	Запрос.Параметры.Вставить("Уведомление", Уведомление);
	Запрос.Параметры.Вставить("Организация", ПараметрыУведомления.Организация);
	Запрос.Параметры.Вставить("ОтчетныйГод", ПараметрыУведомления.ОтчетныйГод);
	Запрос.Параметры.Вставить("УчитыватьСпецрежимДляПосредников",
		ПараметрыУведомления.ОтчетныйГод >= КонтролируемыеСделки.ДатаНачалаУчетаСпецрежимовДляНевзаимозависимыхПосредников());
	Запрос.Параметры.Вставить("УчитыватьЕНВД", ПараметрыУведомления.ОтчетныйГод < КонтролируемыеСделки.ДатаОтказаОтЕНВД());
	Запрос.Параметры.Вставить("УчитыватьИнвестиционныйВычет", 
		КонтролируемыеСделки.УчитываютсяСделкиСИнвестиционнымНалоговымВычетом(ПараметрыУведомления.ОтчетныйГод));
	
	ГраницыКонтролируемостиСделок = ГраницыКонтролируемостиСделок(ПараметрыУведомления.ОтчетныйГод, ПараметрыУведомления.ВерсияУведомления);
	ДобавитьВПараметрыЗапроса(Запрос, ГраницыКонтролируемостиСделок);
	
	ГраницыДляКонтроля = ГраницыДляКонтроля(ПараметрыУведомления.ВерсияУведомления);
	ДобавитьВПараметрыЗапроса(Запрос, ГраницыДляКонтроля);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	&ОтчетныйГод КАК Период,
	|	НастройкиСистемыНалогообложенияСрезПоследних.Организация КАК Организация,
	|	НастройкиСистемыНалогообложенияСрезПоследних.ПлательщикНалогаНаПрибыль КАК ПлательщикНалогаНаПрибыль
	|ПОМЕСТИТЬ НастройкиСистемыНалогообложения
	|ИЗ
	|	РегистрСведений.НастройкиСистемыНалогообложения.СрезПоследних(&ОтчетныйГод, Организация = &Организация) КАК НастройкиСистемыНалогообложенияСрезПоследних
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	НастройкиСистемыНалогообложения.Период,
	|	НастройкиСистемыНалогообложения.Организация,
	|	НастройкиСистемыНалогообложения.ПлательщикНалогаНаПрибыль
	|ИЗ
	|	РегистрСведений.НастройкиСистемыНалогообложения КАК НастройкиСистемыНалогообложения
	|ГДЕ
	|	НастройкиСистемыНалогообложения.Организация = &Организация
	|	И НастройкиСистемыНалогообложения.Период > &ОтчетныйГод
	|	И НастройкиСистемыНалогообложения.Период <= КОНЕЦПЕРИОДА(&ОтчетныйГод, ГОД)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НастройкиСистемыНалогообложения.Период КАК НачалоПериода,
	|	НастройкиСистемыНалогообложения.Организация КАК Организация,
	|	КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(МИНИМУМ(ЕСТЬNULL(НастройкиСистемыНалогообложения1.Период, КОНЕЦПЕРИОДА(&ОтчетныйГод, ГОД))), СЕКУНДА, -1), ДЕНЬ) КАК ОкончаниеПериода,
	|	НастройкиСистемыНалогообложения.ПлательщикНалогаНаПрибыль КАК ПлательщикНалогаНаПрибыль
	|ПОМЕСТИТЬ УчетнаяПолитикаПоПериодам
	|ИЗ
	|	НастройкиСистемыНалогообложения КАК НастройкиСистемыНалогообложения
	|		ЛЕВОЕ СОЕДИНЕНИЕ НастройкиСистемыНалогообложения КАК НастройкиСистемыНалогообложения1
	|		ПО НастройкиСистемыНалогообложения.Организация = НастройкиСистемыНалогообложения1.Организация
	|			И НастройкиСистемыНалогообложения.Период < НастройкиСистемыНалогообложения1.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	НастройкиСистемыНалогообложения.Организация,
	|	НастройкиСистемыНалогообложения.Период,
	|	НастройкиСистемыНалогообложения.ПлательщикНалогаНаПрибыль
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	НачалоПериода,
	|	ОкончаниеПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НастройкиСистемыНалогообложения
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&ОтчетныйГод КАК Период,
	|	НастройкиУчетаНДССрезПоследних.Организация КАК Организация,
	|	НастройкиУчетаНДССрезПоследних.ПрименяетсяОсвобождениеОтУплатыНДС КАК ОсвобожденОтУплатыНДС
	|ПОМЕСТИТЬ НастройкиСистемыНалогообложенияНДС
	|ИЗ
	|	РегистрСведений.НастройкиУчетаНДС.СрезПоследних(&ОтчетныйГод, Организация = &Организация) КАК НастройкиУчетаНДССрезПоследних
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	НастройкиУчетаНДС.Период,
	|	НастройкиУчетаНДС.Организация,
	|	НастройкиУчетаНДС.ПрименяетсяОсвобождениеОтУплатыНДС
	|ИЗ
	|	РегистрСведений.НастройкиУчетаНДС КАК НастройкиУчетаНДС
	|ГДЕ
	|	НастройкиУчетаНДС.Организация = &Организация
	|	И НастройкиУчетаНДС.Период > &ОтчетныйГод
	|	И НастройкиУчетаНДС.Период <= КОНЕЦПЕРИОДА(&ОтчетныйГод, ГОД)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НастройкиСистемыНалогообложенияНДС.Период КАК НачалоПериода,
	|	НастройкиСистемыНалогообложенияНДС.Организация КАК Организация,
	|	КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(МИНИМУМ(ЕСТЬNULL(НастройкиСистемыНалогообложенияНДС1.Период, КОНЕЦПЕРИОДА(&ОтчетныйГод, ГОД))), СЕКУНДА, -1), ДЕНЬ) КАК ОкончаниеПериода,
	|	НастройкиСистемыНалогообложенияНДС.ОсвобожденОтУплатыНДС КАК ОсвобожденОтУплатыНДС
	|ПОМЕСТИТЬ УчетнаяПолитикаНДСПоПериодам
	|ИЗ
	|	НастройкиСистемыНалогообложенияНДС КАК НастройкиСистемыНалогообложенияНДС
	|		ЛЕВОЕ СОЕДИНЕНИЕ НастройкиСистемыНалогообложенияНДС КАК НастройкиСистемыНалогообложенияНДС1
	|		ПО НастройкиСистемыНалогообложенияНДС.Организация = НастройкиСистемыНалогообложенияНДС1.Организация
	|			И НастройкиСистемыНалогообложенияНДС.Период < НастройкиСистемыНалогообложенияНДС1.Период
	|
	|СГРУППИРОВАТЬ ПО
	|	НастройкиСистемыНалогообложенияНДС.Организация,
	|	НастройкиСистемыНалогообложенияНДС.Период,
	|	НастройкиСистемыНалогообложенияНДС.ОсвобожденОтУплатыНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	НачалоПериода,
	|	ОкончаниеПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НастройкиСистемыНалогообложенияНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеКонтрагенты.Контрагент КАК Контрагент,
	|	КонтролируемыеКонтрагенты.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК КонтрагентЗарегистрированВРФ,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ УчастникиКонтролируемыхСделок
	|ИЗ
	|	КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтролируемыеКонтрагенты.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = КонтролируемыеКонтрагенты.Контрагент)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Организация КАК Организация,
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Уведомление,
	|	КонтролируемыеСделкиОрганизаций.Период КАК ПериодСделки,
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод КАК ОтчетныйГод,
	|	КонтролируемыеСделкиОрганизаций.Контрагент КАК Контрагент,
	|	УчастникиКонтролируемыхСделок.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	КонтролируемыеСделкиОрганизаций.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	КонтролируемыеСделкиОрганизаций.Комиссионер КАК Комиссионер,
	|	КонтролируемыеСделкиОрганизаций.РасчетныйДокумент КАК РасчетныйДокумент,
	|	КонтролируемыеСделкиОрганизаций.ПредметСделки КАК ПредметСделки,
	|	КонтролируемыеСделкиОрганизаций.СуммаБезНДСВРублях КАК СуммаБезНДСВРублях,
	|	КонтролируемыеСделкиОрганизаций.СуммаБезНДСВВалютеРасчетов КАК СуммаБезНДСВВалютеРасчетов,
	|	УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ КАК КонтрагентЗарегистрированВРФ,
	|	ВЫБОР
	|		КОГДА УчетнаяПолитикаПоПериодам.ПлательщикНалогаНаПрибыль <> ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЯвляетсяПлательщикомНалогаНаПрибыль, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоНалогуНаПрибыль,
	|	ВЫБОР
	|		КОГДА УчетнаяПолитикаПоПериодам.ПлательщикНалогаНаПрибыль = ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЯвляетсяПлательщикомНалогаНаПрибыль, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				И (ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СтороныПрименяютРазныеСтавкиПоНалогуНаПрибыль, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ) <> ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ))
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И УчастникиКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли,
	|	УчастникиКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ВЫБОР
	|		КОГДА (ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЯвляетсяПлательщикомНДПИ, ЛОЖЬ)
	|					И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|					И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЯвляетсяПлательщикомНДПИ, ЛОЖЬ)
	|					И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход))
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				И ЕСТЬNULL(ПредметыКонтролируемыхСделок.ОблагаетсяНДПИПоПроцентнойСтавке, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоНДПИ,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ) <> ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЗарегистрированВОЭЗ, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоРегистрацииВОЭЗ,
	|	ВЫБОР
	|		КОГДА &УчитыватьЕНВД
	|				И (ЕСТЬNULL(КонтролируемыеСделкиОрганизаций.ОперацияОблагаетсяЕНВД, ЛОЖЬ)
	|						И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход)
	|						И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|					ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЯвляетсяПлательщикомЕНВД, ЛОЖЬ)
	|						И КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки = ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход)
	|						И ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаОблагаетсяЕНВД, ЛОЖЬ)
	|						И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ))
	|			ТОГДА ВЫБОР
	|					КОГДА ВзаимозависимыеЛицаПоПериодам.НевзаимозависимыйПосредник
	|							И НЕ &УчитыватьСпецрежимДляПосредников
	|						ТОГДА ЛОЖЬ
	|					ИНАЧЕ ИСТИНА
	|				КОНЕЦ
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаОблагаетсяЕНВД,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ЯвляетсяПлательщикомЕСХН, ЛОЖЬ)
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ВЫБОР
	|					КОГДА ВзаимозависимыеЛицаПоПериодам.НевзаимозависимыйПосредник
	|							И НЕ &УчитыватьСпецрежимДляПосредников
	|						ТОГДА ЛОЖЬ
	|					ИНАЧЕ ИСТИНА
	|				КОНЕЦ
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаСПлательщикомЕСХН,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаОтноситсяКДеятельностиНовогоМорскогоМесторождения, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаМорскогоМесторождения,
	|	ВЫБОР
	|		КОГДА (ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ)
	|				ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта, ЛОЖЬ))
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоИнвестиционнымПроектам,
	|	ВЫБОР
	|		КОГДА (ЕСТЬNULL(УчетнаяПолитикаНДСПоПериодам.ОсвобожденОтУплатыНДС, ЛОЖЬ)
	|				ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ОсвобожденОтУплатыНДС, ЛОЖЬ))
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоОсвобождениюНДС,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|				И &УчитыватьИнвестиционныйВычет
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоИнвестиционномуВычету,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаОтноситсяКДеятельностиОблагаемойНалогомНаДопДоход, ЛОЖЬ)
	|				И УчастникиКонтролируемыхСделок.КонтрагентЗарегистрированВРФ
	|				И ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ВзаимозависимыеЛица, ЛОЖЬ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаКонтролируетсяПоДополнительномуДоходуОтСырья,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СделкаНеЯвляетсяКонтролируемойПоП4, ЛОЖЬ) КАК СделкаНеЯвляетсяКонтролируемойПоП4,
	|	ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) КАК ТипВзаимозависимости,
	|	КонтролируемыеСделкиОрганизаций.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемыеСделкиОрганизаций.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КонтролируемыеСделкиОрганизаций.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки,
	|	КонтролируемыеСделкиОрганизаций.ТипКонтролируемойСделки КАК ТипКонтролируемойСделки,
	|	КонтролируемыеСделкиОрганизаций.Грузоотправитель КАК Грузоотправитель,
	|	КонтролируемыеСделкиОрганизаций.Грузополучатель КАК Грузополучатель,
	|	КонтролируемыеСделкиОрганизаций.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	КонтролируемыеСделкиОрганизаций.Валюта КАК Валюта,
	|	КонтролируемыеСделкиОрганизаций.Количество КАК Количество,
	|	КонтролируемыеСделкиОрганизаций.ПроцентнаяСтавка КАК ПроцентнаяСтавка,
	|	КонтролируемыеСделкиОрганизаций.ДатаПроцентнойСтавки КАК ДатаПроцентнойСтавки,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|				ИЛИ ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК СтороныВзаимозависимыПоКодексу,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ВзаимозависимыеЛицаПоПериодам.ТипВзаимозависимости, ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)) = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СделкаСНезависимымПосредником
	|ПОМЕСТИТЬ КонтролируемыеСделки
	|ИЗ
	|	РегистрНакопления.КонтролируемыеСделкиОрганизаций КАК КонтролируемыеСделкиОрганизаций
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|		ПО КонтролируемыеСделкиОрганизаций.Уведомление = УведомлениеОКонтролируемыхСделках.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ УчетнаяПолитикаПоПериодам КАК УчетнаяПолитикаПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = УчетнаяПолитикаПоПериодам.Организация
	|			И КонтролируемыеСделкиОрганизаций.Период >= УчетнаяПолитикаПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= УчетнаяПолитикаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ УчетнаяПолитикаНДСПоПериодам КАК УчетнаяПолитикаНДСПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = УчетнаяПолитикаНДСПоПериодам.Организация
	|			И КонтролируемыеСделкиОрганизаций.Период >= УчетнаяПолитикаНДСПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= УчетнаяПолитикаНДСПоПериодам.ОкончаниеПериода
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО КонтролируемыеСделкиОрганизаций.Контрагент = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = ВзаимозависимыеЛицаПоПериодам.Организация
	|			И КонтролируемыеСделкиОрганизаций.Контрагент = ВзаимозависимыеЛицаПоПериодам.Контрагент
	|			И КонтролируемыеСделкиОрганизаций.Период >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам КАК СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.Организация
	|			И КонтролируемыеСделкиОрганизаций.Период >= СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.НачалоПериода
	|			И КонтролируемыеСделкиОрганизаций.Период <= СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоговорыУчастниковКонтролируемыхСделок КАК ДоговорыУчастниковКонтролируемыхСделок
	|		ПО КонтролируемыеСделкиОрганизаций.Организация = ДоговорыУчастниковКонтролируемыхСделок.Организация
	|			И КонтролируемыеСделкиОрганизаций.Контрагент = ДоговорыУчастниковКонтролируемыхСделок.Контрагент
	|			И КонтролируемыеСделкиОрганизаций.ДоговорКонтрагента = ДоговорыУчастниковКонтролируемыхСделок.ДоговорКонтрагента
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПредметыКонтролируемыхСделок КАК ПредметыКонтролируемыхСделок
	|		ПО КонтролируемыеСделкиОрганизаций.ПредметСделки = ПредметыКонтролируемыхСделок.ПредметСделки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО КонтролируемыеСделкиОрганизаций.ПредметСделки = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= КонтролируемыеСделкиОрганизаций.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= КонтролируемыеСделкиОрганизаций.Период)
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.Ссылка = &Уведомление
	|	И КонтролируемыеСделкиОрганизаций.Уведомление = &Уведомление
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент,
	|	ДоговорКонтрагента,
	|	ПредметСделки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыПоМинимальнойСумме
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) > &МинимальнаяГраницаДляВключенияСделокВУведомление
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоОбщейСумме
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФПоОбщейСумме
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаОбщейСуммыСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыРФКонтролируемыеПоУсловию
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФПоУсловиям
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И (КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ
	|			ИЛИ КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль
	|			ИЛИ КонтролируемыеСделки.СделкаМорскогоМесторождения
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету
	|			ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаОбщейСуммыСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоНДПИ
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФНДПИ
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокНДПИ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоСпецРежиму
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФСпецРежим
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокСпецРежим
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоПрибыли
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФПрибыль
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокПрибыль
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоОЭЗ
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФРегистрацияОЭЗ
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокОЭЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоМорскомуМесторождению
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФНовоеМорскоеМесторождение
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаМорскогоМесторождения
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаНовоеМорскоеМесторождение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФРегиональныйИнвестПроект
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаРегиональныйИнвестиционныйПроект
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоОсвобождениюНДС
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФОсвобождениеНДС
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаОсвобождениеНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоИнвестиционномуВычету
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	&КонтролироватьЗависимыхЛицРФИнвестиционныйВычет
	|	И КонтролируемыеСделки.КонтрагентЗарегистрированВРФ
	|	И КонтролируемыеСделки.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаИнвестиционныйВычет
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	КонтролируемыеСделки.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|	И (КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|			ИЛИ КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаСуммыСделокИностранныхНезависимыхЛиц
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) КАК СуммаБезНДСВРублях
	|ПОМЕСТИТЬ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|ГДЕ
	|	(КонтролируемыеСделки.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ИЛИ КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу
	|				И НЕ КонтролируемыеСделки.КонтрагентЗарегистрированВРФ)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|СГРУППИРОВАТЬ ПО
	|	КонтролируемыеСделки.ГоловнойКонтрагент
	|
	|ИМЕЮЩИЕ
	|	СУММА(КонтролируемыеСделки.СуммаБезНДСВРублях) >= &ГраницаПрочиеВзаимозависимыеЛица";
	
	Запрос.Выполнить();
	
	Возврат Запрос.МенеджерВременныхТаблиц;
	
КонецФункции

Функция ПолучитьТекстЗапросаПоКонтролируемымСделкам_2012() Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонтролируемаяСделка.Номер КАК НомерЛиста1А,
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемаяСделка.Ссылка КАК Сделка,
	|	КонтролируемаяСделка.ТипСделки КАК ТипСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимыПоКодексу)
	|			ТОГДА ""1""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.СамостоятельноеПризнаниеВзаимозависимости)
	|			ТОГДА ""2""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимостьПоРешениюСуда)
	|			ТОГДА ""3""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка100Взаимозависимость,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка121СтороныВзаимозависимыПоКодексу
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка122СделкаВОбластиВнешнейТорговли
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка123СделкаСКонтрагентомСЛьготнымНалогообложением
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка124СделкаСНезависимымПосредником
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка124СделкаСНезависимымПосредником,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости131
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости131,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости132
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости132,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости133
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости133,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости134
	|				ИЛИ КонтролируемаяСделка.ОснованиеКонтролируемости136
	|				ИЛИ КонтролируемаяСделка.ОснованиеКонтролируемости137
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости134,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости135
	|				ИЛИ КонтролируемаяСделка.ОснованиеКонтролируемости138
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости135,
	|	КонтролируемаяСделка.КодНаименованияСделки КАК Строка210КодНаименованияСделки,
	|	КонтролируемаяСделка.КодСтороныСделки КАК Строка211КодСтороныСделки,
	|	КонтролируемаяСделка.СпособОпределенияЦеныСделки КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.СпособОпределенияЦеныСделки.ЦенаЯвляетсяРегулируемой
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка220ПризнакОпределенияЦеныСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКПризнакуОпределенияЦеныСделки, """") КАК Строка220_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки, """") = """"
	|			ТОГДА ""0""
	|		ИНАЧЕ КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки
	|	КОНЕЦ КАК Строка230КодОпределенияЦены,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийККодуОпределенияЦеныСделки, """") КАК Строка230_1Комментарий,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодМетодаЦенообразования, """") КАК Строка240КодМетодовЦенообразования,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКМетодуЦенообразования, """") КАК Строка240_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации251, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка251,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации252, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка252,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации253, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка253,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации254, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка254,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации255, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка255,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации256, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка256,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации257, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка257,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации258, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка258,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации259, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка259,
	|	2 КАК Строка260КоличествоУчастниковСделки,
	|	КонтролируемаяСделка.КомментарийКПункту7 КАК Строка260_1Комментарий,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходов КАК ЧИСЛО(15, 0)) КАК Строка300СуммаДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка301СуммаРегулируемыхДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходов КАК ЧИСЛО(15, 0)) КАК Строка310СуммаРасходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка311СуммаРегулируемыхРасходов,
	|	ВЫБОР
	|		КОГДА Контрагенты.ОбособленноеПодразделение
	|				И Контрагенты.ГоловнойКонтрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.Ссылка
	|		ИНАЧЕ Контрагенты.ГоловнойКонтрагент
	|	КОНЕЦ КАК Контрагент,
	|	Контрагенты.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия) КАК ВнешнеторговаяСделка,
	|	КонтролируемаяСделка.Контрагент.ЮридическоеФизическоеЛицо КАК ТипКонтрагента,
	|	КонтролируемаяСделка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	КонтролируемаяСделка.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемаяСделка.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодТНВЭД.Код, """") КАК КодТНВЭД,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКП.Код, """") КАК КодОКП,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКВЭД.Код, """") КАК КодОКВЭД,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКПД2.Код, """") КАК КодОКПД2,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКВЭД2.Код, """") КАК КодОКВЭД2,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|				И КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки = ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|		ИНАЧЕ КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки
	|	КОНЕЦ КАК СтранаПроисхожденияПредметаСделки,
	|	ЛОЖЬ КАК СделкаСовершенаЧерезКомиссионера,
	|	""0"" КАК СделкаСовАгент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ПустаяСсылка) КАК ТипКомиссионера,
	|	ЛОЖЬ КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1А
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтролируемаяСделка.Контрагент = Контрагенты.Ссылка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаСделки.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаСделки.НомерСтроки КАК НомерСтроки,
	|	Листы1А.ТипПредметаСделки КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА 1
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|			ТОГДА 2
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИЛИ Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|			ТОГДА 3
	|	КОНЕЦ КАК Строка020ТипПредмета,
	|	Листы1А.ТипСделки КАК ТипСделки,
	|	Листы1А.НаименованиеПредметаСделки КАК Строка030НаименованиеПредмета,
	|	Листы1А.КодТНВЭД КАК Строка040КодПоТНВЭД,
	|	Листы1А.КодОКП КАК Строка043КодПоОКП,
	|	Листы1А.КодОКВЭД КАК Строка045КодОКВЭД,
	|	Листы1А.КодОКПД2 КАК Строка043КодПоОКПД2,
	|	Листы1А.КодОКВЭД2 КАК Строка045КодОКВЭД2,
	|	Листы1А.Контрагент КАК Контрагент,
	|	Листы1А.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Листы1А.ДоговорКонтрагента.Номер КАК Строка060НомерДоговора,
	|	Листы1А.ДоговорКонтрагента.Дата КАК Строка065ДатаДоговора,
	|	"""" КАК УникальныйНомерВалютногоКонтроля,
	|	ЕСТЬNULL(Листы1А.СтранаПроисхожденияПредметаСделки.Код, """") КАК Строка070КодСтраныПроисхождения,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаОтправкиТовара.Код, """") КАК Строка080КодСтраныОтправки,
	|	КонтролируемаяСделкаСделки.КодРегионаОтправкиТовара КАК Строка080КодРегионаОтправки,
	|	КонтролируемаяСделкаСделки.ГородОтправкиТовара КАК Строка080ГородОтправки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктОтправкиТовара КАК Строка080НаселенныйПунктОтправки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаСовершенияСделки.Код, """") КАК Строка090КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаСделки.КодРегионаСовершенияСделки КАК Строка090КодРегионаСовершенияСделки,
	|	КонтролируемаяСделкаСделки.ГородСовершенияСделки КАК Строка090ГородСовершенияСделки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктСовершенияСделки КАК Строка090НаселенныйПунктСовершенияСделки,
	|	"""" КАК ОКТМОСовершенияСделки,
	|	КонтролируемаяСделкаСделки.КодУсловийПоставки КАК Строка100КодУсловийПоставки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.ЕдиницаИзмерения.Код, """") КАК Строка110КодЕдиницыИзмерения,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаСделки.Количество > 0
	|				И КонтролируемаяСделкаСделки.Количество < 1
	|			ТОГДА 1
	|		ИНАЧЕ ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Количество КАК ЧИСЛО(15, 0))
	|	КОНЕЦ КАК Строка120Количество,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Цена КАК ЧИСЛО(15, 0)) КАК Строка130Цена,
	|	0 КАК СуммаБазыДляРасчетаРоялти,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Стоимость КАК ЧИСЛО(15, 0)) КАК Строка140Стоимость,
	|	КонтролируемаяСделкаСделки.ДатаСовершенияСделки КАК Строка150ДатаСовершения,
	|	Листы1А.ТипКонтрагента КАК ТипКонтрагента,
	|	Листы1А.ВнешнеторговаяСделка КАК ВнешнеторговаяСделка,
	|	Листы1А.СделкаСовершенаЧерезКомиссионера КАК СделкаСовершенаЧерезКомиссионера,
	|	Листы1А.Комиссионер КАК Комиссионер,
	|	Листы1А.ТипКомиссионера КАК ТипКомиссионера,
	|	КонтролируемаяСделкаСделки.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1Б
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаСделки
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаСделки.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1В.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1В.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ТипЛиста КАК ТипЛиста,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ТипЛиста = ЗНАЧЕНИЕ(Перечисление.ТипыСделокВЦепочкеКонтролируемыхСделок.ПоследующаяРеализация)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""2""
	|	КОНЕЦ КАК КодТипаСделки,
	|	КонтролируемаяСделкаЛисты1В.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.КомментарийКЛисту1Б КАК КомментарийКЛисту1Б,
	|	КонтролируемаяСделкаЛисты1В.ПризнакУчастникаСделки КАК ПризнакУчастникаСделки,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторПредыдущегоЛиста1В КАК ИдентификаторПредыдущегоЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара КАК ИспользованиеПроисхождениеТовара,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара = ЗНАЧЕНИЕ(Перечисление.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.Иное)
	|			ТОГДА КонтролируемаяСделкаЛисты1В.НаименованиеИспользованияПроисхожденияТовара
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК НаименованиеИспользованияПроисхожденияТовара,
	|	КонтролируемаяСделкаЛисты1В.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1В.НомерДоговора КАК НомерДоговора,
	|	КонтролируемаяСделкаЛисты1В.ДатаДоговора КАК ДатаДоговора,
	|	КонтролируемаяСделкаЛисты1В.КодУсловийПоставки КАК КодУсловийПоставки,
	|	КонтролируемаяСделкаЛисты1В.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки КАК СтранаСовершенияСделки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки.Код, """") КАК КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения.Код, """") КАК КодЕдиницыИзмерения,
	|	КонтролируемаяСделкаЛисты1В.Количество КАК Количество,
	|	КонтролируемаяСделкаЛисты1В.Цена КАК Цена,
	|	КонтролируемаяСделкаЛисты1В.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.Валюта.Код, """") КАК КодВалюты,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаЛисты1В.Стоимость КАК ЧИСЛО(15, 0)) КАК Стоимость
	|ПОМЕСТИТЬ Листы1В
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1В КАК КонтролируемаяСделкаЛисты1В
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1В.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Листы1Б.Сделка КАК Сделка,
	|	Листы1Б.НомерСтроки КАК НомерСтроки,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В
	|ПОМЕСТИТЬ СвязиЛистов1Би1В
	|ИЗ
	|	Листы1Б КАК Листы1Б
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.СвязьЛистов1Би1В КАК КонтролируемаяСделкаСвязьЛистов1Би1В
	|		ПО Листы1Б.Сделка = КонтролируемаяСделкаСвязьЛистов1Би1В.Ссылка
	|			И Листы1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б
	|ГДЕ
	|	Листы1Б.УказыватьСведенияЦепочкиСозданияСтоимости
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1Г.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1Г.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1Г.НаименованиеУслуги КАК НаименованиеУслуги,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1Г.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1Г.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции, """") <> """"
	|			ТОГДА УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """") <> """"
	|			ТОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """")
	|		ИНАЧЕ ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000))
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК РегистрационныйНомер,
	|	КонтролируемаяСделкаЛисты1Г.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Г.Валюта.Код, """") КАК КодВалюты,
	|	КонтролируемаяСделкаЛисты1Г.Стоимость КАК Стоимость
	|ПОМЕСТИТЬ Листы1Г
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1Г КАК КонтролируемаяСделкаЛисты1Г
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Г.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО (КонтролируемаяСделкаЛисты1Г.Контрагент = Контрагенты.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Строка020ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК Строка030КакКодСтраныРегистрации,
	|	ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000)) КАК Строка040Наименование,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции, """") КАК Строка040НаименованиеЛат,
	|	Контрагенты.ИНН КАК Строка050ИНН,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.КПП
	|		ИНАЧЕ Контрагенты.КПП
	|	КОНЕЦ КАК Строка060КПП,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК Строка070РегНомерВСтрокеРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК НалоговыйРегистрационныйНомер,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ УчастникиКонтролируемыхСделок.НаименованиеИдентификатораРегистрационногоНомера
	|	КОНЕЦ КАК НаименованиеИдентификатораРегистрационногоНомера,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.НалоговыйНомер
	|	КОНЕЦ КАК Строка080КодНалогВСтранеРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ЕСТЬNULL(КонтактнаяИнформацияКонтрагента.Представление, """")
	|	КОНЕЦ КАК Строка090АдресИностраннойОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ЕСТЬNULL(КонтактнаяИнформацияКонтрагента.Значение, """")
	|	КОНЕЦ КАК АдресИностраннойОрганизацииЗначение
	|ПОМЕСТИТЬ Раздел2
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО Контрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты.КонтактнаяИнформация КАК КонтактнаяИнформацияКонтрагента
	|		ПО (ГоловныеКонтрагенты.Ссылка = КонтактнаяИнформацияКонтрагента.Ссылка)
	|			И (КонтактнаяИнформацияКонтрагента.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияКонтрагента.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента))
	|ГДЕ
	|	Контрагенты.Ссылка В
	|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				Листы1А.Контрагент
	|			ИЗ
	|				Листы1А КАК Листы1А)
	|	И Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыФизическихЛицСрезПоследних.Физлицо КАК Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период КАК Период,
	|	МАКСИМУМ(ДокументыФизическихЛицСрезПоследних.ВидДокумента) КАК ВидДокумента
	|ПОМЕСТИТЬ ВидыДокументовФизическихЛиц
	|ИЗ
	|	РегистрСведений.ДокументыФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			Физлицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиСделок)) КАК ДокументыФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыФизическихЛицСрезПоследних.Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Физлицо,
	|	Период,
	|	ВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна КАК Страна
	|ПОМЕСТИТЬ ГражданствоФизическихЛиц
	|ИЗ
	|	РегистрСведений.ГражданствоФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			ФизическоеЛицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиСделок)) КАК ГражданствоФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ФизическоеЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.КодВидаДеятельностиФизическогоЛица, """") КАК Строка020КодВидаДеятельности,
	|	Контрагенты.ИНН КАК Строка030ИНН,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизическоеЛицо,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.ДатаРождения, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)) КАК ДатаРождения,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.МестоРождения, """") КАК МестоРождения,
	|	ГражданствоФизическихЛиц.Страна КАК ГражданствоФизЛицСтрана,
	|	КонтактнаяИнформацияФизлица.Вид КАК ВидКонтактнойИнформации,
	|	КонтактнаяИнформацияФизлица.ЗначенияПолей КАК КонтактнаяИнформацияЗначенияПолей,
	|	КонтактнаяИнформацияФизлица.Значение КАК КонтактнаяИнформацияЗначениеJSON,
	|	КонтактнаяИнформацияФизлица.Страна КАК КонтактнаяИнформацияСтрана,
	|	КонтактнаяИнформацияФизлица.Представление КАК КонтактнаяИнформацияПредставление,
	|	КонтактнаяИнформацияЗаРФ.Страна КАК КонтактнаяИнформацияЗаРФСтрана,
	|	КонтактнаяИнформацияЗаРФ.Представление КАК КонтактнаяИнформацияЗаРФПредставление,
	|	ДокументыФизическихЛиц.ВидДокумента КАК ВидДокумента,
	|	ДокументыФизическихЛиц.Серия КАК ДокументСерия,
	|	ДокументыФизическихЛиц.Номер КАК ДокументНомер,
	|	ДокументыФизическихЛиц.КемВыдан КАК ДокументКемВыдан,
	|	ДокументыФизическихЛиц.ДатаВыдачи КАК ДокументДатаВыдачи,
	|	ФИОФизЛиц.Фамилия КАК Фамилия,
	|	ФИОФизЛиц.Имя КАК Имя,
	|	ФИОФизЛиц.Отчество КАК Отчество
	|ПОМЕСТИТЬ Раздел3
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО Контрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ГражданствоФизическихЛиц КАК ГражданствоФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ГражданствоФизическихЛиц.ФизическоеЛицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияФизлица
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияФизлица.Ссылка)
	|			И (КонтактнаяИнформацияФизлица.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияФизлица.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресПоПропискеФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияЗаРФ
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияЗаРФ.Ссылка)
	|			И (КонтактнаяИнформацияЗаРФ.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияЗаРФ.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресЗаПределамиРФФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВидыДокументовФизическихЛиц КАК ВидыДокументовФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ВидыДокументовФизическихЛиц.Физлицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДокументыФизическихЛиц КАК ДокументыФизическихЛиц
	|		ПО (ДокументыФизическихЛиц.Физлицо = ВидыДокументовФизическихЛиц.Физлицо)
	|			И (ДокументыФизическихЛиц.Период = ВидыДокументовФизическихЛиц.Период)
	|			И (ДокументыФизическихЛиц.ВидДокумента = ВидыДокументовФизическихЛиц.ВидДокумента)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизическихЛиц.СрезПоследних(&ДатаАктуальностиСведений, ) КАК ФИОФизЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ФИОФизЛиц.ФизическоеЛицо)
	|ГДЕ
	|	Контрагенты.Ссылка В
	|			(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|				Листы1А.Контрагент
	|			ИЗ
	|				Листы1А КАК Листы1А)
	|	И Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции, """") <> """"
	|			ТОГДА УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """") <> """"
	|			ТОГДА УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции
	|		ИНАЧЕ ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000))
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.ИНН
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК РегистрационныйНомер
	|ПОМЕСТИТЬ Раздел4
	|ИЗ
	|	Листы1В КАК Листы1В
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО Листы1В.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)";
	
	Возврат(ТекстЗапроса);
	
КонецФункции

Функция ПолучитьТекстЗапросаПоКонтролируемымСделкам_2018() Экспорт
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонтролируемаяСделка.Номер КАК НомерЛиста1А,
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемаяСделка.Ссылка КАК Сделка,
	|	КонтролируемаяСделка.ТипСделки КАК ТипСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимыПоКодексу)
	|			ТОГДА ""1""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.СамостоятельноеПризнаниеВзаимозависимости)
	|			ТОГДА ""2""
	|		КОГДА КонтролируемаяСделка.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.ВзаимозависимостьПоРешениюСуда)
	|			ТОГДА ""3""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка100Взаимозависимость,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка121СтороныВзаимозависимыПоКодексу
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка122СделкаВОбластиВнешнейТорговли
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка123СделкаСКонтрагентомСЛьготнымНалогообложением
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.Строка124СделкаСНезависимымПосредником
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка124СделкаСНезависимымПосредником,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости131
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости131,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости132
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости132,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости133
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости133,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости134
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости134,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости135
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости135,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости136
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости136,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости137
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости137,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости138
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости138,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости139
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости139,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.ОснованиеКонтролируемости140
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК ОснованиеКонтролируемости140,
	|	КонтролируемаяСделка.КодНаименованияСделки КАК Строка210КодНаименованияСделки,
	|	КонтролируемаяСделка.КодСтороныСделки КАК Строка211КодСтороныСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.Валюта.Код, """") КАК КодВалюты,
	|	КонтролируемаяСделка.СпособОпределенияЦеныСделки КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.СпособОпределенияЦеныСделки.ЦенаЯвляетсяРегулируемой
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка220ПризнакОпределенияЦеныСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКПризнакуОпределенияЦеныСделки, """") КАК Строка220_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки, """") = """"
	|			ТОГДА ""0""
	|		ИНАЧЕ КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодОпределенияЦеныСделки
	|	КОНЕЦ КАК Строка230КодОпределенияЦены,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийККодуОпределенияЦеныСделки, """") КАК Строка230_1Комментарий,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КодМетодаЦенообразования, """") КАК Строка240КодМетодовЦенообразования,
	|	ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.КомментарийКМетодуЦенообразования, """") КАК Строка240_1Комментарий,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации251, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка251,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации252, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка252,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации253, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка253,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации254, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка254,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации255, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка255,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации256, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка256,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации257, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка257,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации258, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка258,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(КонтролируемаяСделка.СпособОпределенияЦеныСделки.ИсточникИнформации259, ЛОЖЬ)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК Строка259,
	|	2 КАК Строка260КоличествоУчастниковСделки,
	|	КонтролируемаяСделка.КомментарийКПункту7 КАК Строка260_1Комментарий,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходов КАК ЧИСЛО(15, 0)) КАК Строка300СуммаДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаДоходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка301СуммаРегулируемыхДоходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходов КАК ЧИСЛО(15, 0)) КАК Строка310СуммаРасходов,
	|	ВЫРАЗИТЬ(КонтролируемаяСделка.СуммаРасходовРегулируемых КАК ЧИСЛО(15, 0)) КАК Строка311СуммаРегулируемыхРасходов,
	|	ВЫБОР
	|		КОГДА Контрагенты.ОбособленноеПодразделение
	|				И Контрагенты.ГоловнойКонтрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.Ссылка
	|		ИНАЧЕ Контрагенты.ГоловнойКонтрагент
	|	КОНЕЦ КАК Контрагент,
	|	Контрагенты.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия) КАК ВнешнеторговаяСделка,
	|	КонтролируемаяСделка.Контрагент.ЮридическоеФизическоеЛицо КАК ТипКонтрагента,
	|	КонтролируемаяСделка.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	КонтролируемаяСделка.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемаяСделка.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодТНВЭД.Код, """") КАК КодТНВЭД,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКПД2.Код, """") КАК КодОКПД2,
	|	ЕСТЬNULL(КонтролируемаяСделка.КодОКВЭД2.Код, """") КАК КодОКВЭД2,
	|	КонтролируемаяСделка.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки,
	|	КонтролируемаяСделка.СделкаСовершенаЧерезКомиссионера КАК СделкаСовершенаЧерезКомиссионера,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделка.СделкаСовершенаЧерезКомиссионера
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК СделкаСовАгент,
	|	ВЫБОР
	|		КОГДА Комиссионеры.ОбособленноеПодразделение
	|				И Комиссионеры.ГоловнойКонтрагент.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Комиссионеры.Ссылка
	|		ИНАЧЕ Комиссионеры.ГоловнойКонтрагент
	|	КОНЕЦ КАК Комиссионер,
	|	Комиссионеры.ЮридическоеФизическоеЛицо КАК ТипКомиссионера,
	|	КонтролируемаяСделка.УказыватьСведенияЦепочкиСозданияСтоимости КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1А
	|ИЗ
	|	Документ.КонтролируемаяСделка КАК КонтролируемаяСделка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтролируемаяСделка.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Комиссионеры
	|		ПО КонтролируемаяСделка.Комиссионер = Комиссионеры.Ссылка
	|ГДЕ
	|	КонтролируемаяСделка.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И НЕ КонтролируемаяСделка.ПометкаУдаления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаСделки.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаСделки.НомерСтроки КАК НомерСтроки,
	|	Листы1А.ТипПредметаСделки КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА 1
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|			ТОГДА 2
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ИЛИ Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|			ТОГДА 3
	|	КОНЕЦ КАК Строка020ТипПредмета,
	|	Листы1А.ТипСделки КАК ТипСделки,
	|	Листы1А.НаименованиеПредметаСделки КАК Строка030НаименованиеПредмета,
	|	Листы1А.КодТНВЭД КАК Строка040КодПоТНВЭД,
	|	Листы1А.КодОКПД2 КАК Строка043КодПоОКПД2,
	|	Листы1А.КодОКВЭД2 КАК Строка045КодОКВЭД2,
	|	Листы1А.Контрагент КАК Контрагент,
	|	Листы1А.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Листы1А.ДоговорКонтрагента.Номер КАК Строка060НомерДоговора,
	|	Листы1А.ДоговорКонтрагента.Дата КАК Строка065ДатаДоговора,
	|	Листы1А.ДоговорКонтрагента.УникальныйНомерВалютногоКонтроля КАК УникальныйНомерВалютногоКонтроля,
	|	ЕСТЬNULL(Листы1А.СтранаПроисхожденияПредметаСделки.Код, """") КАК Строка070КодСтраныПроисхождения,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаОтправкиТовара.Код, """") КАК Строка080КодСтраныОтправки,
	|	КонтролируемаяСделкаСделки.КодРегионаОтправкиТовара КАК Строка080КодРегионаОтправки,
	|	КонтролируемаяСделкаСделки.ГородОтправкиТовара КАК Строка080ГородОтправки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктОтправкиТовара КАК Строка080НаселенныйПунктОтправки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.СтранаСовершенияСделки.Код, """") КАК Строка090КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаСделки.КодРегионаСовершенияСделки КАК Строка090КодРегионаСовершенияСделки,
	|	КонтролируемаяСделкаСделки.ГородСовершенияСделки КАК Строка090ГородСовершенияСделки,
	|	КонтролируемаяСделкаСделки.НаселенныйПунктСовершенияСделки КАК Строка090НаселенныйПунктСовершенияСделки,
	|	КонтролируемаяСделкаСделки.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	ВЫБОР
	|		КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА КонтролируемаяСделкаСделки.КодУсловийПоставки
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Строка100КодУсловийПоставки,
	|	ЕСТЬNULL(КонтролируемаяСделкаСделки.ЕдиницаИзмерения.Код, """") КАК Строка110КодЕдиницыИзмерения,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаСделки.Количество КАК ЧИСЛО(15, 5)) КАК Строка120Количество,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|				ТОГДА 0
	|			ИНАЧЕ КонтролируемаяСделкаСделки.Цена
	|		КОНЕЦ КАК ЧИСЛО(18, 4)) КАК Строка130Цена,
	|	Листы1А.КодВалюты КАК Строка140КодВалюты,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|				ТОГДА КонтролируемаяСделкаСделки.ПроцентнаяСтавка
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК ЧИСЛО(7, 4)) КАК Строка150ПроцентнаяСтавка,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав)
	|				ТОГДА КонтролируемаяСделкаСделки.СуммаБазыДляРасчетаРоялти
	|			ИНАЧЕ 0
	|		КОНЕЦ КАК ЧИСЛО(15, 0)) КАК СуммаБазыДляРасчетаРоялти,
	|	ВЫРАЗИТЬ(ВЫБОР
	|			КОГДА Листы1А.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство)
	|				ТОГДА 0
	|			ИНАЧЕ КонтролируемаяСделкаСделки.Стоимость
	|		КОНЕЦ КАК ЧИСЛО(15, 0)) КАК Строка160Стоимость,
	|	КонтролируемаяСделкаСделки.ДатаСовершенияСделки КАК Строка150ДатаСовершения,
	|	Листы1А.ТипКонтрагента КАК ТипКонтрагента,
	|	Листы1А.ВнешнеторговаяСделка КАК ВнешнеторговаяСделка,
	|	Листы1А.СделкаСовершенаЧерезКомиссионера КАК СделкаСовершенаЧерезКомиссионера,
	|	Листы1А.Комиссионер КАК Комиссионер,
	|	Листы1А.ТипКомиссионера КАК ТипКомиссионера,
	|	КонтролируемаяСделкаСделки.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости КАК УказыватьСведенияЦепочкиСозданияСтоимости
	|ПОМЕСТИТЬ Листы1Б
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаСделки
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаСделки.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1В.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1В.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ТипЛиста КАК ТипЛиста,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ТипЛиста = ЗНАЧЕНИЕ(Перечисление.ТипыСделокВЦепочкеКонтролируемыхСделок.ПоследующаяРеализация)
	|			ТОГДА ""1""
	|		ИНАЧЕ ""2""
	|	КОНЕЦ КАК КодТипаСделки,
	|	КонтролируемаяСделкаЛисты1В.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.КомментарийКЛисту1Б КАК КомментарийКЛисту1Б,
	|	КонтролируемаяСделкаЛисты1В.ПризнакУчастникаСделки КАК ПризнакУчастникаСделки,
	|	КонтролируемаяСделкаЛисты1В.ИдентификаторПредыдущегоЛиста1В КАК ИдентификаторПредыдущегоЛиста1В,
	|	КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара КАК ИспользованиеПроисхождениеТовара,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.ИспользованиеПроисхождениеТовара = ЗНАЧЕНИЕ(Перечисление.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.Иное)
	|			ТОГДА КонтролируемаяСделкаЛисты1В.НаименованиеИспользованияПроисхожденияТовара
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК НаименованиеИспользованияПроисхожденияТовара,
	|	КонтролируемаяСделкаЛисты1В.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1В.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1В.НомерДоговора КАК НомерДоговора,
	|	КонтролируемаяСделкаЛисты1В.ДатаДоговора КАК ДатаДоговора,
	|	КонтролируемаяСделкаЛисты1В.КодУсловийПоставки КАК КодУсловийПоставки,
	|	КонтролируемаяСделкаЛисты1В.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки КАК СтранаСовершенияСделки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.СтранаСовершенияСделки.Код, """") КАК КодСтраныСовершенияСделки,
	|	КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.ЕдиницаИзмерения.Код, """") КАК КодЕдиницыИзмерения,
	|	КонтролируемаяСделкаЛисты1В.Количество КАК Количество,
	|	КонтролируемаяСделкаЛисты1В.Цена КАК Цена,
	|	КонтролируемаяСделкаЛисты1В.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1В.Валюта.Код, """") КАК КодВалюты,
	|	ВЫРАЗИТЬ(КонтролируемаяСделкаЛисты1В.Стоимость КАК ЧИСЛО(15, 0)) КАК Стоимость
	|ПОМЕСТИТЬ Листы1В
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1В КАК КонтролируемаяСделкаЛисты1В
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1В.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1В.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Листы1Б.Сделка КАК Сделка,
	|	Листы1Б.НомерСтроки КАК НомерСтроки,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1В КАК ИдентификаторЛиста1В
	|ПОМЕСТИТЬ СвязиЛистов1Би1В
	|ИЗ
	|	Листы1Б КАК Листы1Б
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.СвязьЛистов1Би1В КАК КонтролируемаяСделкаСвязьЛистов1Би1В
	|		ПО Листы1Б.Сделка = КонтролируемаяСделкаСвязьЛистов1Би1В.Ссылка
	|			И Листы1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаСвязьЛистов1Би1В.ИдентификаторЛиста1Б
	|ГДЕ
	|	Листы1Б.УказыватьСведенияЦепочкиСозданияСтоимости
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КонтролируемаяСделкаЛисты1Г.Ссылка КАК Сделка,
	|	Листы1А.НомерЛиста1А КАК НомерЛиста1А,
	|	КонтролируемаяСделкаЛисты1Г.НомерСтроки КАК НомерСтроки,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Б.НомерСтроки, 0) КАК НомерСтроки1Б,
	|	КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б КАК ИдентификаторЛиста1Б,
	|	КонтролируемаяСделкаЛисты1Г.НаименованиеУслуги КАК НаименованиеУслуги,
	|	ВЫБОР
	|		КОГДА КонтролируемаяСделкаЛисты1Г.УчастникиВзаимозависимы
	|			ТОГДА ""1""
	|		ИНАЧЕ ""0""
	|	КОНЕЦ КАК УчастникиВзаимозависимы,
	|	КонтролируемаяСделкаЛисты1Г.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции, """") <> """"
	|			ТОГДА УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """") <> """"
	|			ТОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """")
	|		ИНАЧЕ ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000))
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК РегистрационныйНомер,
	|	КонтролируемаяСделкаЛисты1Г.Валюта КАК Валюта,
	|	ЕСТЬNULL(КонтролируемаяСделкаЛисты1Г.Валюта.Код, """") КАК КодВалюты,
	|	КонтролируемаяСделкаЛисты1Г.Стоимость КАК Стоимость
	|ПОМЕСТИТЬ Листы1Г
	|ИЗ
	|	Листы1А КАК Листы1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Листы1Г КАК КонтролируемаяСделкаЛисты1Г
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Г.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.КонтролируемаяСделка.Сделки КАК КонтролируемаяСделкаЛисты1Б
	|		ПО Листы1А.Сделка = КонтролируемаяСделкаЛисты1Б.Ссылка
	|			И (КонтролируемаяСделкаЛисты1Б.ИдентификаторЛиста1Б = КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б)
	|			И (КонтролируемаяСделкаЛисты1Г.ИдентификаторЛиста1Б <> &ПустойИдентификатор)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО (КонтролируемаяСделкаЛисты1Г.Контрагент = Контрагенты.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)
	|ГДЕ
	|	Листы1А.УказыватьСведенияЦепочкиСозданияСтоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Листы1А.Контрагент КАК Контрагент
	|ПОМЕСТИТЬ КонтрагентыЛистов1А
	|ИЗ
	|	Листы1А КАК Листы1А
	|ГДЕ
	|	Листы1А.Контрагент <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Листы1А.Комиссионер
	|ИЗ
	|	Листы1А КАК Листы1А
	|ГДЕ
	|	Листы1А.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК Строка020ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК Строка030КакКодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """") = """"
	|			ТОГДА ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000))
	|		ИНАЧЕ ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """")
	|	КОНЕЦ КАК Строка040Наименование,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции, """") КАК Строка040НаименованиеЛат,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА Контрагенты.ИНН
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Строка050ИНН,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.КПП
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК Строка060КПП,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|	КОНЕЦ КАК Строка070РегНомерВСтрокеРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК НалоговыйРегистрационныйНомер,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ УчастникиКонтролируемыхСделок.НаименованиеИдентификатораРегистрационногоНомера
	|	КОНЕЦ КАК НаименованиеИдентификатораРегистрационногоНомера,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.НалоговыйНомер
	|	КОНЕЦ КАК Строка080КодНалогВСтранеРегистрации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ЕСТЬNULL(КонтактнаяИнформацияКонтрагента.Представление, """")
	|	КОНЕЦ КАК Строка090АдресИностраннойОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА """"
	|		ИНАЧЕ ЕСТЬNULL(КонтактнаяИнформацияКонтрагента.Значение, """")
	|	КОНЕЦ КАК АдресИностраннойОрганизацииЗначение
	|ПОМЕСТИТЬ Раздел2
	|ИЗ
	|	КонтрагентыЛистов1А КАК КонтрагентыЛистов1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтрагентыЛистов1А.Контрагент = Контрагенты.Ссылка
	|			И (Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ЮридическоеЛицо))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты.КонтактнаяИнформация КАК КонтактнаяИнформацияКонтрагента
	|		ПО (ГоловныеКонтрагенты.Ссылка = КонтактнаяИнформацияКонтрагента.Ссылка)
	|			И (КонтактнаяИнформацияКонтрагента.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияКонтрагента.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.ЮрАдресКонтрагента))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыФизическихЛицСрезПоследних.Физлицо КАК Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период КАК Период,
	|	МАКСИМУМ(ДокументыФизическихЛицСрезПоследних.ВидДокумента) КАК ВидДокумента
	|ПОМЕСТИТЬ ВидыДокументовФизическихЛиц
	|ИЗ
	|	РегистрСведений.ДокументыФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			Физлицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиСделок)) КАК ДокументыФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыФизическихЛицСрезПоследних.Физлицо,
	|	ДокументыФизическихЛицСрезПоследних.Период
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Физлицо,
	|	Период,
	|	ВидДокумента
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна КАК Страна
	|ПОМЕСТИТЬ ГражданствоФизическихЛиц
	|ИЗ
	|	РегистрСведений.ГражданствоФизическихЛиц.СрезПоследних(
	|			&ДатаАктуальностиСведений,
	|			ФизическоеЛицо В
	|				(ВЫБРАТЬ
	|					УчастникиСделок.ФизическоеЛицо
	|				ИЗ
	|					РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиСделок)) КАК ГражданствоФизическихЛицСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ГражданствоФизическихЛицСрезПоследних.ФизическоеЛицо,
	|	ГражданствоФизическихЛицСрезПоследних.Страна
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ФизическоеЛицо
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.КодВидаДеятельностиФизическогоЛица, """") КАК Строка020КодВидаДеятельности,
	|	Контрагенты.ИНН КАК Строка030ИНН,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо, ЗНАЧЕНИЕ(Справочник.ФизическиеЛица.ПустаяСсылка)) КАК ФизическоеЛицо,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.ДатаРождения, ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)) КАК ДатаРождения,
	|	ЕСТЬNULL(УчастникиКонтролируемыхСделок.ФизическоеЛицо.МестоРождения, """") КАК МестоРождения,
	|	ГражданствоФизическихЛиц.Страна КАК ГражданствоФизЛицСтрана,
	|	КонтактнаяИнформацияФизлица.Вид КАК ВидКонтактнойИнформации,
	|	КонтактнаяИнформацияФизлица.ЗначенияПолей КАК КонтактнаяИнформацияЗначенияПолей,
	|	КонтактнаяИнформацияФизлица.Значение КАК КонтактнаяИнформацияЗначениеJSON,
	|	КонтактнаяИнформацияФизлица.Страна КАК КонтактнаяИнформацияСтрана,
	|	КонтактнаяИнформацияФизлица.Представление КАК КонтактнаяИнформацияПредставление,
	|	КонтактнаяИнформацияЗаРФ.Страна КАК КонтактнаяИнформацияЗаРФСтрана,
	|	КонтактнаяИнформацияЗаРФ.Представление КАК КонтактнаяИнформацияЗаРФПредставление,
	|	ДокументыФизическихЛиц.ВидДокумента КАК ВидДокумента,
	|	ДокументыФизическихЛиц.Серия КАК ДокументСерия,
	|	ДокументыФизическихЛиц.Номер КАК ДокументНомер,
	|	ДокументыФизическихЛиц.КемВыдан КАК ДокументКемВыдан,
	|	ДокументыФизическихЛиц.ДатаВыдачи КАК ДокументДатаВыдачи,
	|	ФИОФизЛиц.Фамилия КАК Фамилия,
	|	ФИОФизЛиц.Имя КАК Имя,
	|	ФИОФизЛиц.Отчество КАК Отчество
	|ПОМЕСТИТЬ Раздел3
	|ИЗ
	|	КонтрагентыЛистов1А КАК КонтрагентыЛистов1А
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО КонтрагентыЛистов1А.Контрагент = Контрагенты.Ссылка
	|			И (Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо))
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО КонтрагентыЛистов1А.Контрагент = УчастникиКонтролируемыхСделок.Контрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ГражданствоФизическихЛиц КАК ГражданствоФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ГражданствоФизическихЛиц.ФизическоеЛицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияФизлица
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияФизлица.Ссылка)
	|			И (КонтактнаяИнформацияФизлица.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияФизлица.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресПоПропискеФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КонтактнаяИнформацияЗаРФ
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = КонтактнаяИнформацияЗаРФ.Ссылка)
	|			И (КонтактнаяИнформацияЗаРФ.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес))
	|			И (КонтактнаяИнформацияЗаРФ.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.АдресЗаПределамиРФФизическиеЛица))
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВидыДокументовФизическихЛиц КАК ВидыДокументовФизическихЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ВидыДокументовФизическихЛиц.Физлицо)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДокументыФизическихЛиц КАК ДокументыФизическихЛиц
	|		ПО (ДокументыФизическихЛиц.Физлицо = ВидыДокументовФизическихЛиц.Физлицо)
	|			И (ДокументыФизическихЛиц.Период = ВидыДокументовФизическихЛиц.Период)
	|			И (ДокументыФизическихЛиц.ВидДокумента = ВидыДокументовФизическихЛиц.ВидДокумента)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизическихЛиц.СрезПоследних(&ДатаАктуальностиСведений, ) КАК ФИОФизЛиц
	|		ПО (УчастникиКонтролируемыхСделок.ФизическоеЛицо = ФИОФизЛиц.ФизическоеЛицо)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ВЫБОР
	|		КОГДА Контрагенты.ЮридическоеФизическоеЛицо = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФизическоеЛицо)
	|			ТОГДА 1
	|		ИНАЧЕ 2
	|	КОНЕЦ КАК ТипОрганизации,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации.Код ЕСТЬ NULL
	|			ТОГДА """"
	|		ИНАЧЕ ГоловныеКонтрагенты.СтранаРегистрации.Код
	|	КОНЕЦ КАК КодСтраныРегистрации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции, """") <> """"
	|			ТОГДА УчастникиКонтролируемыхСделок.НаименованиеВЛатинскойТранскрипции
	|		КОГДА ЕСТЬNULL(УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции, """") <> """"
	|			ТОГДА УчастникиКонтролируемыхСделок.НаименованиеВРусскойТранскрипции
	|		ИНАЧЕ ВЫРАЗИТЬ(ГоловныеКонтрагенты.НаименованиеПолное КАК СТРОКА(1000))
	|	КОНЕЦ КАК НаименованиеКонтрагента,
	|	ВЫБОР
	|		КОГДА ГоловныеКонтрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|			ТОГДА ГоловныеКонтрагенты.ИНН
	|		ИНАЧЕ ВЫБОР
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 1
	|					ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|				КОГДА УчастникиКонтролируемыхСделок.ТипВыводимогоНомера = 2
	|					ТОГДА ГоловныеКонтрагенты.РегистрационныйНомер
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ГоловныеКонтрагенты.НалоговыйНомер <> """"
	|							ТОГДА ГоловныеКонтрагенты.НалоговыйНомер
	|						ИНАЧЕ ГоловныеКонтрагенты.РегистрационныйНомер
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК РегистрационныйНомер
	|ПОМЕСТИТЬ Раздел4
	|ИЗ
	|	Листы1В КАК Листы1В
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО Листы1В.Контрагент = Контрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.УчастникиКонтролируемыхСделок КАК УчастникиКонтролируемыхСделок
	|		ПО (ГоловныеКонтрагенты.Ссылка = УчастникиКонтролируемыхСделок.Контрагент)";
	Возврат(ТекстЗапроса);
	
КонецФункции

Функция ПолучитьТекстНастроекФормированияУведомления(Уведомление) Экспорт
	
	Если ЗначениеЗаполнено(Уведомление) Тогда
		НастройкиФормирования = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "ГруппироватьСделкиСОдинаковойЦеной, КодМестаПредставления");
	Иначе
		НастройкиФормирования = Новый Структура("ГруппироватьСделкиСОдинаковойЦеной, КодМестаПредставления", Ложь, "");
	КонецЕсли;
	
	Если НастройкиФормирования.ГруппироватьСделкиСОдинаковойЦеной Тогда
		ТекстНастроек = НСтр("ru = 'Один лист 1Б для нескольких сделок; Код %1'");
	Иначе
		ТекстНастроек = НСтр("ru = 'Один лист 1Б для каждой сделки; Код %1'");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(НастройкиФормирования.КодМестаПредставления) Тогда
		ТекстНастроек = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстНастроек, НастройкиФормирования.КодМестаПредставления);
	Иначе
		ТекстНастроек = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстНастроек, НСтр("ru = 'не заполнен'"));
	КонецЕсли;
	
	Возврат ТекстНастроек;
	
КонецФункции

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область ВерсияУведомления

Функция ВерсияУведомления(Уведомление) Экспорт
	
	ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012();
	
	Если ЗначениеЗаполнено(Уведомление) Тогда
		
		Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Уведомление, "ВерсияУведомления");
		
	КонецЕсли;
	
	Возврат ВерсияУведомления;
	
КонецФункции

Функция ВерсияУведомленияПоОтчетномуГоду(ОтчетныйГод) Экспорт
	
	Если ОтчетныйГод >= Дата(2024, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024();
	ИначеЕсли ОтчетныйГод >= Дата(2021, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2021();
	ИначеЕсли ОтчетныйГод >= Дата(2019, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019();
	ИначеЕсли ОтчетныйГод >= Дата(2018, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018();
	ИначеЕсли ОтчетныйГод >= Дата(2017, 1, 1) Тогда
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2017();
	Иначе
		Возврат КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012();
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область ПечатьИВыгрузка_2018

Функция СведенияОГражданстве2018(СтранаГражданства) Экспорт
	
	СведенияОГражданстве = Новый Структура();
	СведенияОГражданстве.Вставить("Гражд", "3"); // Без гражданства
	СведенияОГражданстве.Вставить("ОКСМ", "");
	
	Если ЗначениеЗаполнено(СтранаГражданства) Тогда
		СведенияОГражданстве.Гражд = ?(СтранаГражданства = Справочники.СтраныМира.Россия, "1", "2");
		СведенияОГражданстве.ОКСМ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтранаГражданства, "Код");
	КонецЕсли;
	
	Возврат СведенияОГражданстве;
	
КонецФункции

#КонецОбласти

#Область ПечатьИВыгрузка_2024

Функция НужноЗаполнятьСтрануПроисхождения2024(Лист1Б) Экспорт
	
	Возврат Лист1Б.ВнешнеторговаяСделка
		И Лист1Б.ТипСделки = Перечисления.ТипыКонтролируемыхСделок.ОсуществленРасход
		И Лист1Б.Строка020ТипПредмета <> 2;
	
КонецФункции

#КонецОбласти

#Область АвтоматическоеЗаполнение

Процедура СформироватьКонтролируемыеСделки(Уведомление, СообщатьОПрогрессе)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод, ВерсияУведомления");
	
	Если СообщатьОПрогрессе Тогда
		СообщитьОПодготовкеДанных();
	КонецЕсли;
	
	ТаблицаЛистов1А = ПометитьНаУдалениеКонтролируемыеСделкиУведомления(Уведомление);
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = ПолучитьВременныеТаблицыДляЗаполненияУведомления(Уведомление);
	Запрос.Параметры.Вставить("ВалютаРегламентированногоУчета",
		ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета());
	
	Если ПараметрыУведомления.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019() Тогда
		Запрос.Текст = ТекстЗапросаФормированиеКонтролируемыхСделок2019();
	Иначе
		Запрос.Текст = ТекстЗапросаФормированиеКонтролируемыхСделок2012();
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	МетаданныеРегистра = Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций;
	
	ТаблицаСделокЛиста1А = Документы.КонтролируемаяСделка.ПустаяСсылка().Сделки.Выгрузить();
	ТаблицаСделокЛиста1А.Колонки.Добавить("СтоимостьДляРасчетаЦены", МетаданныеРегистра.Ресурсы.СуммаНДСВВалютеРасчетов.Тип);
	ТаблицаСделокЛиста1А.Колонки.Добавить("РасчетныйДокумент", МетаданныеРегистра.Измерения.РасчетныйДокумент.Тип);
	ТекущийНомерЛиста1А = 1;
	
	ПараметрыЗаполнения = ПараметрыЗаполненияУведомления(Уведомление);
	
	ПараметрыСообщенияОПрогрессе = ПараметрыСообщенияОПрогрессе(Выборка);
	
	КлючСделки = КлючСделки();
	
	ДокументСделки = Неопределено;
	Пока Выборка.Следующий() Цикл
		
		Если СообщатьОПрогрессе Тогда
			ОповеститьОПрогрессе(ПараметрыСообщенияОПрогрессе);
		КонецЕсли;
		
		Если ДокументСделки = Неопределено ИЛИ
			НЕ КлючСделкиСовпадает(Выборка, КлючСделки) Тогда
			
			ЗаполнитьЗначенияСвойств(КлючСделки, Выборка);
			
			Если ДокументСделки <> Неопределено Тогда
				ЗаполнитьТаблицуСделокЛиста1А(ДокументСделки, ТаблицаСделокЛиста1А, ПараметрыЗаполнения);
				Если ДокументСделки.Сделки.Количество() <> 0 Тогда
					ДокументСделки.Записать();
					ТекущийНомерЛиста1А = ТекущийНомерЛиста1А + 1;
				КонецЕсли;
				ТаблицаСделокЛиста1А.Очистить();
				ДокументСделки = Неопределено;
			КонецЕсли;
			
			Отбор = Новый Структура("Контрагент, ДоговорКонтрагента, ПредметСделки, Используется",
				КлючСделки.Контрагент, КлючСделки.ДоговорКонтрагента, КлючСделки.ПредметСделки, Ложь);
			ДокументыСделок = ТаблицаЛистов1А.НайтиСтроки(Отбор);
			Если ДокументыСделок.Количество()>0 Тогда
				СтрокаДокументовСделок = ДокументыСделок[0];
				ДокументСделки = СтрокаДокументовСделок.Сделка.ПолучитьОбъект();
				ДокументСделки.ПометкаУдаления = Ложь;
				СтрокаДокументовСделок.Используется = Истина;
			КонецЕсли;
			
			Если ДокументСделки = Неопределено Тогда
				ДокументСделки = Документы.КонтролируемаяСделка.СоздатьДокумент();
				ДокументСделки.Дата = ТекущаяДатаСеанса();
			КонецЕсли;
			
			ДокументСделки.Номер = ТекущийНомерЛиста1А;
			ЗаполнитьЗначенияСвойств(ДокументСделки, Выборка, , ПараметрыЗаполнения.ИсключенияДляЗаполненияЛиста1А);
			
			СписокКодовСтороныСделки = ПараметрыЗаполнения.СписокКодовСторонСделки.Получить(Выборка.КодНаименованияСделки);
			Если СписокКодовСтороныСделки.Количество() = 1 Тогда
				ДокументСделки.КодСтороныСделки = СписокКодовСтороныСделки[0].Значение;
			ИначеЕсли СписокКодовСтороныСделки.Количество() > 1 Тогда
				ДокументСделки.КодСтороныСделки = ?(Выборка.ТипСделки = Перечисления.ТипыКонтролируемыхСделок.ПолученДоход, СписокКодовСтороныСделки[0].Значение, СписокКодовСтороныСделки[1].Значение);
			КонецЕсли;
			ДокументСделки.УказыватьСведенияЦепочкиСозданияСтоимости = ДокументСделки.Строка121СтороныВзаимозависимыПоКодексу
				И ДокументСделки.Строка122СделкаВОбластиВнешнейТорговли;
			ДокументСделки.КомментарийКПункту7 = "";
			ДокументСделки.РедактироватьСуммыСделок = Ложь;
			ДокументСделки.СуммаДоходов = 0;
			ДокументСделки.СуммаДоходовРегулируемых = 0;
			ДокументСделки.СуммаРасходов = 0;
			ДокументСделки.СуммаРасходовРегулируемых = 0;
			
			ДокументСделки.Сделки.Очистить();
			
		КонецЕсли;
		
		НоваяСделка = ТаблицаСделокЛиста1А.Добавить();
		ИсключенияЗаполненияЛиста1Б = ИсключенияЗаполненияЛиста1Б(ПараметрыЗаполнения.Версия, Выборка.ТипПредметаСделки);
		ЗаполнитьЗначенияСвойств(НоваяСделка, Выборка, , ИсключенияЗаполненияЛиста1Б);
		ЗаполнитьДатуСделкиДолговыхОбязательств(НоваяСделка, ПараметрыЗаполнения.Версия, Выборка.ТипПредметаСделки, Выборка.ДатаПроцентнойСтавки);
		НоваяСделка.СтоимостьДляРасчетаЦены = Выборка[ПараметрыЗаполнения.ПолеОпределенияСтоимостиДляРасчетаЦены];
		ЗаполнитьАдресаСделки(НоваяСделка, Выборка.Грузоотправитель, Выборка.Грузополучатель, ПараметрыЗаполнения);
	КонецЦикла;
	
	Если ДокументСделки <> Неопределено Тогда
		ЗаполнитьТаблицуСделокЛиста1А(ДокументСделки, ТаблицаСделокЛиста1А, ПараметрыЗаполнения);
		Если ДокументСделки.Сделки.Количество() <> 0 Тогда
			ДокументСделки.Записать();
		КонецЕсли;
		ДокументСделки = Неопределено;
	КонецЕсли;
	
	ОбъектУведомление = Уведомление.ПолучитьОбъект();
	ОбъектУведомление.ДатаЗаполненияУведомления = ТекущаяДатаСеанса();
	ОбъектУведомление.Записать();
	
КонецПроцедуры

Функция ПараметрыЗаполненияУведомления(Уведомление)
	
	Параметры = Новый Структура;
	Параметры.Вставить("Уведомление", Уведомление);
	Параметры.Вставить("Версия", Документы.УведомлениеОКонтролируемыхСделках.ВерсияУведомления(Уведомление));
	Параметры.Вставить("КлючевыеПоля", Новый Структура());
	Параметры.Вставить("СтрокаСверткиТаблицыСделок", "");
	Параметры.Вставить("ПолеОпределенияСтоимостиДляРасчетаЦены", ПолеОпределенияСтоимостиДляРасчетаЦены(Параметры.Версия));
	Параметры.Вставить("ИсключенияДляЗаполненияЛиста1А", ИсключенияЗаполненияЛиста1А(Параметры.Версия));
	Параметры.Вставить("СписокКодовСторонСделки", КонтролируемыеСделки.ПолучитьСоответствиеКодовСтороныСделки());
	Параметры.Вставить("КешАдресныхДанных", Новый Соответствие);
	Параметры.Вставить("СопутствующиеУслуги", СопутствующиеУслугиКонтролируемыхСделок(Уведомление));
	Параметры.Вставить("ЦепочкиСозданияСтоимости", ЦепочкиСозданияСтоимости(Уведомление));
	Параметры.Вставить("КлючевыеПоляЦепочкиСозданияСтоимости", КлючевыеПоляЦепочкиСозданияСтоимости());
	Параметры.Вставить("РоялтиКонтролируемыхСделок", РоялтиКонтролируемыхСделок(Уведомление));
	
	ЗаполнитьКлючевыеПоляИСтрокуСвертки(Параметры);
	
	Возврат Параметры;
	
КонецФункции

Функция КлючСделки()
	
	Возврат Новый Структура("Контрагент, ДоговорКонтрагента, СделкаСовершенаЧерезКомиссионера, Комиссионер,
		|ПредметСделки,СтранаПроисхожденияПредметаСделки, Строка121СтороныВзаимозависимыПоКодексу, Строка122СделкаВОбластиВнешнейТорговли,
		|Строка123СделкаСКонтрагентомСЛьготнымНалогообложением, Строка124СделкаСНезависимымПосредником,
		|ОснованиеКонтролируемости131, ОснованиеКонтролируемости132,
		|ОснованиеКонтролируемости133, ОснованиеКонтролируемости134,
		|ОснованиеКонтролируемости135, ОснованиеКонтролируемости136, ОснованиеКонтролируемости137,
		|ОснованиеКонтролируемости138, ТипВзаимозависимости, ТипПредметаСделки, НаименованиеПредметаСделки,
		|КодНаименованияСделки, ТипСделки, Валюта");
	
КонецФункции

Процедура ЗаполнитьКлючевыеПоляИСтрокуСвертки(Параметры)
	
	СтруктураКлючевыхПолей = Новый Структура();
	СтруктураКлючевыхПолей.Вставить("РасчетныйДокумент");
	СтрокаСверткиТаблицыСделок = "";
	Для Каждого РеквизитСделки Из Метаданные.Документы.КонтролируемаяСделка.ТабличныеЧасти.Сделки.Реквизиты Цикл
		Если РеквизитСделки.Имя <> "Количество" И РеквизитСделки.Имя <> "Стоимость"
			И РеквизитСделки.Имя <> "ИдентификаторЛиста1Б" Тогда
			СтруктураКлючевыхПолей.Вставить(РеквизитСделки.Имя);
			СтрокаСверткиТаблицыСделок = СтрокаСверткиТаблицыСделок 
				+ ?(СтрокаСверткиТаблицыСделок = "","",", ") + РеквизитСделки.Имя;
		КонецЕсли;
	КонецЦикла;
	
	Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.Уведомление, "ГруппироватьСделкиСОдинаковойЦеной") Тогда
		СтруктураКлючевыхПолей.Удалить("ДатаСовершенияСделки");
		СтруктураКлючевыхПолей.Удалить("РасчетныйДокумент");
		Если Параметры.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
			СтруктураКлючевыхПолей.Удалить("ПроцентнаяСтавка");
		КонецЕсли;
	КонецЕсли;
	
	Параметры.КлючевыеПоля = СтруктураКлючевыхПолей;
	Параметры.СтрокаСверткиТаблицыСделок = СтрокаСверткиТаблицыСделок;
	
КонецПроцедуры

Функция КлючевыеПоляЦепочкиСозданияСтоимости()
	
	СтруктураКлючевыхПолей = Новый Структура();
	СтрокаСверткиТаблицыСделок = "";
	Для Каждого РеквизитСделки Из Метаданные.Документы.ЦепочкаСозданияСтоимостиКонтролируемойСделки.ТабличныеЧасти.Сделки.Реквизиты Цикл
		Если РеквизитСделки.Имя <> "Количество" И РеквизитСделки.Имя <> "Стоимость" Тогда
			СтруктураКлючевыхПолей.Вставить(РеквизитСделки.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СтруктураКлючевыхПолей;
	
КонецФункции

Функция ПолеОпределенияСтоимостиДляРасчетаЦены(ВерсияУведомления)
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		Возврат "Стоимость";
	Иначе
		Возврат "СтоимостьВВалюте";
	КонецЕсли;
	
КонецФункции

Функция ПараметрыСообщенияОПрогрессе(Выборка)
	
	Параметры = Новый Структура;
	Параметры.Вставить("ВсегоСтрок", Выборка.Количество());
	Параметры.Вставить("ОбработаноСтрок", 0);
	Параметры.Вставить("ПрогрессОКоторомСообщили", -1);
	Возврат Параметры;
	
КонецФункции

Процедура ОповеститьОПрогрессе(Параметры)
	
	Параметры.ОбработаноСтрок = Параметры.ОбработаноСтрок + 1;
	ТекущийПрогресс = Цел(Параметры.ОбработаноСтрок / Параметры.ВсегоСтрок * 100);
	Если ТекущийПрогресс <> Параметры.ПрогрессОКоторомСообщили Тогда
		Параметры.ПрогрессОКоторомСообщили = ТекущийПрогресс;
		ТекстОповещенияОПрогрессе = СтрШаблон(НСтр("ru = 'Обработано: %1 из %2'"), Параметры.ОбработаноСтрок, Параметры.ВсегоСтрок);
		ДлительныеОперации.СообщитьПрогресс(ТекущийПрогресс, ТекстОповещенияОПрогрессе);
	КонецЕсли;
	
КонецПроцедуры

Процедура СообщитьОПодготовкеДанных()
	
	ТекстОповещенияОПрогрессе = НСтр("ru = 'Подготовка к заполнению уведомления'");
	ДлительныеОперации.СообщитьПрогресс(0, ТекстОповещенияОПрогрессе);
	
КонецПроцедуры

Процедура ДобавитьВПараметрыЗапроса(Запрос, СтруктураПараметров)
	
	Для Каждого Параметр Из СтруктураПараметров Цикл
		Запрос.УстановитьПараметр(Параметр.Ключ, Параметр.Значение);
	КонецЦикла;
	
КонецПроцедуры

Функция ГраницыДляКонтроля(ВерсияУведомления)
	
	// Функция возвращает список границ, которые контролируются отдельно и независимо.
	// Например, до 2019 года могли быть включены сделки по НДПИ и Прибыли с одним контрагентом обособленно,
	// и сумма сделок контролировалась отдельно для каждой группы.
	// В 2019 году контролируется общая сумма сделок, которые признаются контролируемыми, считать отдельно
	// суммы по видам сделок не требуется.
	
	ГраницыДляКонтроля = Новый Структура;
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФПоОбщейСумме", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФПоУсловиям", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФНДПИ", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФСпецРежим", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФПрибыль", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФРегистрацияОЭЗ", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФНовоеМорскоеМесторождение", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФРегиональныйИнвестПроект", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФОсвобождениеНДС", Ложь);
	ГраницыДляКонтроля.Вставить("КонтролироватьЗависимыхЛицРФИнвестиционныйВычет", Ложь);
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019() Тогда
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФПоОбщейСумме = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФНДПИ = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФСпецРежим = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФПрибыль = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФРегистрацияОЭЗ = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФНовоеМорскоеМесторождение = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФРегиональныйИнвестПроект = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФОсвобождениеНДС = Истина;
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФИнвестиционныйВычет = Истина;
	Иначе
		ГраницыДляКонтроля.КонтролироватьЗависимыхЛицРФПоУсловиям = Истина;
	КонецЕсли;
	
	Возврат ГраницыДляКонтроля;
	
КонецФункции

Функция ГраницыКонтролируемостиСделок(ОтчетныйГод, ВерсияУведомления)
	
	Запрос = Новый Запрос();
	Запрос.Параметры.Вставить("ОтчетныйГод", ОтчетныйГод);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛица)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаОбщейСуммыСделок,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаПлательщикиНДПИ)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаСуммыСделокНДПИ,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаНаСпецрежимах)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаСуммыСделокСпецРежим,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаПлательщикиНалогаНаПрибыль)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаСуммыСделокПрибыль,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаОсобаяЭкономическаяЗона)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаСуммыСделокОЭЗ,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаДеятельностьМорскогоМесторождения)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаНовоеМорскоеМесторождение,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаУчастникиРегиональногоИнвестиционногоПроекта)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаРегиональныйИнвестиционныйПроект,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаОсвобождениеНДС)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаОсвобождениеНДС,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаИнвестиционныйВычет)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаИнвестиционныйВычет,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.НезависимыеИностранныеЛица)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК ГраницаСуммыСделокИностранныхНезависимыхЛиц,
	|	СУММА(ВЫБОР
	|			КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.МинимальнаяСуммаДляВключенияВУведомление)
	|				ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|			ИНАЧЕ 0
	|		КОНЕЦ) КАК МинимальнаяГраницаДляВключенияСделокВУведомление,
	|	СУММА(ВЫБОР
	|		КОГДА ГраницыКонтролируемостиСделокСрезПоследних.ОсобенностьОтнесенияСделкиККонтролируемой = ЗНАЧЕНИЕ(Перечисление.ОсобенностиОтнесенияСделокККонтролируемым.ВзаимозависимыеЛицаПрочие)
	|			ТОГДА ГраницыКонтролируемостиСделокСрезПоследних.ПредельнаяСумма
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ГраницаПрочиеВзаимозависимыеЛица
	|ИЗ
	|	РегистрСведений.ГраницыКонтролируемостиСделок.СрезПоследних(КОНЕЦПЕРИОДА(&ОтчетныйГод, ГОД), ) КАК ГраницыКонтролируемостиСделокСрезПоследних";
	
	ГраницыКонтролируемостиСделок = Новый Структура();
	ГраницыКонтролируемостиСделок.Вставить("ГраницаОбщейСуммыСделок", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаСуммыСделокНДПИ", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаСуммыСделокСпецРежим", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаСуммыСделокПрибыль", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаСуммыСделокОЭЗ", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаНовоеМорскоеМесторождение", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаРегиональныйИнвестиционныйПроект", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаОсвобождениеНДС", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаИнвестиционныйВычет", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаСуммыСделокИностранныхНезависимыхЛиц", 0);
	ГраницыКонтролируемостиСделок.Вставить("ГраницаПрочиеВзаимозависимыеЛица", 0);
	ГраницыКонтролируемостиСделок.Вставить("МинимальнаяГраницаДляВключенияСделокВУведомление", 0);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		
		ЗаполнитьЗначенияСвойств(ГраницыКонтролируемостиСделок, Выборка);
		
		Если ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2021() Тогда
			// В этой версии убрали границу по п.7 ст.105.14 НК РФ, и теперь для всех сделок п.1 ст.105.14 НК РФ действует единая граница.
			// Поэтому заменим значения для ГраницаСуммыСделокИностранныхНезависимыхЛиц значением ГраницаПрочиеВзаимозависимыеЛица
			
			ГраницыКонтролируемостиСделок.ГраницаСуммыСделокИностранныхНезависимыхЛиц = 
				ГраницыКонтролируемостиСделок.ГраницаПрочиеВзаимозависимыеЛица;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ГраницыКонтролируемостиСделок;
	
КонецФункции

Функция ТекстЗапросаФормированиеКонтролируемыхСделок2012()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонтролируемыеСделки.Организация КАК Организация,
	|	КонтролируемыеСделки.Уведомление КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемыеСделки.ПериодСделки КАК ДатаСовершенияСделки,
	|	КонтролируемыеСделки.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	КонтролируемыеСделки.Контрагент КАК Контрагент,
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	КонтролируемыеСделки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(Договоры.РасчетыВУсловныхЕдиницах, ЛОЖЬ) КАК РасчетыВУсловныхЕдиницах,
	|	КонтролируемыеСделки.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК СделкаСовершенаЧерезКомиссионера,
	|	КонтролируемыеСделки.Комиссионер КАК Комиссионер,
	|	КонтролируемыеСделки.ПредметСделки КАК ПредметСделки,
	|	КонтролируемыеСделки.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	КонтролируемыеСделки.СделкаСНезависимымПосредником КАК Строка124СделкаСНезависимымПосредником,
	|	КонтролируемыеСделки.СуммаБезНДСВРублях КАК Стоимость,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Договоры.РасчетыВУсловныхЕдиницах, ЛОЖЬ)
	|			ТОГДА КонтролируемыеСделки.СуммаБезНДСВРублях
	|		ИНАЧЕ КонтролируемыеСделки.СуммаБезНДСВВалютеРасчетов
	|	КОНЕЦ КАК СтоимостьВВалюте,
	|	КонтролируемыеСделки.КонтрагентЗарегистрированВРФ КАК КонтрагентЗарегистрированВРФ,
	|	НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL
	|		И НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL КАК ОснованиеКонтролируемости131,
	|	НЕ КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ КАК ОснованиеКонтролируемости132,
	|	НЕ КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент ЕСТЬ NULL
	|		И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН) КАК ОснованиеКонтролируемости133,
	|	НЕ КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль КАК ОснованиеКонтролируемости134,
	|	НЕ КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ КАК ОснованиеКонтролируемости135,
	|	НЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаМорскогоМесторождения КАК ОснованиеКонтролируемости136,
	|	НЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам КАК ОснованиеКонтролируемости137,
	|	НЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС КАК ОснованиеКонтролируемости138,
	|	НЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету КАК ОснованиеКонтролируемости139,
	|	НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья КАК ОснованиеКонтролируемости140,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """") = """"
	|			ТОГДА ВЫБОР
	|					КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|						ТОГДА ""019""
	|					ИНАЧЕ ""015""
	|				КОНЕЦ
	|		ИНАЧЕ ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """")
	|	КОНЕЦ КАК КодНаименованияСделки,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СпособОпределенияЦеныСделки, ЗНАЧЕНИЕ(Справочник.СпособыОпределенияЦенКонтролируемыхСделок.ПустаяСсылка)) КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодУсловийПоставки, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КодУсловийПоставки,
	|	КонтролируемыеСделки.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемыеСделки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки1,
	|	КонтролируемыеСделки.ТипКонтролируемойСделки КАК ТипСделки,
	|	КонтролируемыеСделки.Грузоотправитель КАК Грузоотправитель,
	|	КонтролируемыеСделки.Грузополучатель КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Договоры.РасчетыВУсловныхЕдиницах, ЛОЖЬ)
	|			ТОГДА &ВалютаРегламентированногоУчета
	|		ИНАЧЕ КонтролируемыеСделки.Валюта
	|	КОНЕЦ КАК Валюта,
	|	КонтролируемыеСделки.РасчетныйДокумент КАК РасчетныйДокумент,
	|	КонтролируемыеСделки.Количество КАК Количество,
	|	КонтролируемыеСделки.ПроцентнаяСтавка КАК ПроцентнаяСтавка,
	|	КонтролируемыеСделки.ДатаПроцентнойСтавки КАК ДатаПроцентнойСтавки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодТНВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|	КОНЕЦ КАК КодТНВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКП, ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКП,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКПД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКПД2,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД2,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
	|		ПО КонтролируемыеСделки.ДоговорКонтрагента = Договоры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоОбщейСумме КАК КонтрагентыКонтролируемыеПоОбщейСумме
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоНДПИ КАК КонтрагентыКонтролируемыеПоНДПИ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоСпецРежиму КАК КонтрагентыКонтролируемыеПоСпецРежиму
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|				ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоПрибыли КАК КонтрагентыКонтролируемыеПоПрибыли
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоОЭЗ КАК КонтрагентыКонтролируемыеПоОЭЗ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоРегистрацииВОЭЗ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению КАК КонтрагентыКонтролируемыеПоМорскомуМесторождению
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаМорскогоМесторождения)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам КАК КонтрагентыКонтролируемыеПоИнвестиционнымПроектам
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционнымПроектам)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС КАК КонтрагентыКонтролируемыеПоОсвобождениюНДС
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету КАК КонтрагентыКонтролируемыеПоИнвестиционномуВычету
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ КАК КонтрагентыКонтролируемыеПоРегистрацииНеВРФ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|				ИЛИ КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица КАК КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоговорыУчастниковКонтролируемыхСделок КАК ДоговорыУчастниковКонтролируемыхСделок
	|		ПО КонтролируемыеСделки.Организация = ДоговорыУчастниковКонтролируемыхСделок.Организация
	|			И КонтролируемыеСделки.Контрагент = ДоговорыУчастниковКонтролируемыхСделок.Контрагент
	|			И КонтролируемыеСделки.ДоговорКонтрагента = ДоговорыУчастниковКонтролируемыхСделок.ДоговорКонтрагента
	|ГДЕ
	|	КонтролируемыеСделки.ГоловнойКонтрагент В
	|			(ВЫБРАТЬ
	|				КонтрагентыПоМинимальнойСумме.ГоловнойКонтрагент
	|			ИЗ
	|				КонтрагентыПоМинимальнойСумме КАК КонтрагентыПоМинимальнойСумме)
	|	И (НЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоОбщейСумме.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоНДПИ.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоСпецРежиму.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоПрибыли.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоОЭЗ.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоМорскомуМесторождению.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоИнвестиционнымПроектам.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоОсвобождениюНДС.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоИнвестиционномуВычету.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	ГоловнойКонтрагент,
	|	Контрагент,
	|	ДоговорКонтрагента,
	|	ПредметСделки,
	|	СтранаПроисхожденияПредметаСделки,
	|	Строка121СтороныВзаимозависимыПоКодексу,
	|	Строка122СделкаВОбластиВнешнейТорговли,
	|	Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	Строка124СделкаСНезависимымПосредником,
	|	ОснованиеКонтролируемости131,
	|	ОснованиеКонтролируемости132,
	|	ОснованиеКонтролируемости133,
	|	ОснованиеКонтролируемости134,
	|	ОснованиеКонтролируемости135,
	|	ОснованиеКонтролируемости136,
	|	ОснованиеКонтролируемости137,
	|	ОснованиеКонтролируемости138,
	|	ОснованиеКонтролируемости139,
	|	ОснованиеКонтролируемости140,
	|	КодНаименованияСделки,
	|	ТипВзаимозависимости,
	|	ТипПредметаСделки,
	|	НаименованиеПредметаСделки,
	|	ТипСделки";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаФормированиеКонтролируемыхСделок2019()
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	КонтролируемыеСделки.Организация КАК Организация,
	|	КонтролируемыеСделки.Уведомление КАК УведомлениеОКонтролируемойСделке,
	|	КонтролируемыеСделки.ПериодСделки КАК ДатаСовершенияСделки,
	|	КонтролируемыеСделки.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	КонтролируемыеСделки.Контрагент КАК Контрагент,
	|	КонтролируемыеСделки.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	КонтролируемыеСделки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ЕСТЬNULL(Договоры.РасчетыВУсловныхЕдиницах, ЛОЖЬ) КАК РасчетыВУсловныхЕдиницах,
	|	КонтролируемыеСделки.Комиссионер <> ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК СделкаСовершенаЧерезКомиссионера,
	|	КонтролируемыеСделки.Комиссионер КАК Комиссионер,
	|	КонтролируемыеСделки.ПредметСделки КАК ПредметСделки,
	|	КонтролируемыеСделки.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	КонтролируемыеСделки.СтороныВзаимозависимыПоКодексу КАК Строка121СтороныВзаимозависимыПоКодексу,
	|	КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли КАК Строка122СделкаВОбластиВнешнейТорговли,
	|	КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	КонтролируемыеСделки.СделкаСНезависимымПосредником КАК Строка124СделкаСНезависимымПосредником,
	|	КонтролируемыеСделки.СуммаБезНДСВРублях КАК Стоимость,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Договоры.РасчетыВУсловныхЕдиницах, ЛОЖЬ)
	|			ТОГДА КонтролируемыеСделки.СуммаБезНДСВРублях
	|		ИНАЧЕ КонтролируемыеСделки.СуммаБезНДСВВалютеРасчетов
	|	КОНЕЦ КАК СтоимостьВВалюте,
	|	КонтролируемыеСделки.КонтрагентЗарегистрированВРФ КАК КонтрагентЗарегистрированВРФ,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль КАК ОснованиеКонтролируемости131,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ КАК ОснованиеКонтролируемости132,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И (КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|			ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН) КАК ОснованиеКонтролируемости133,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль КАК ОснованиеКонтролируемости134,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаМорскогоМесторождения КАК ОснованиеКонтролируемости135,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС КАК ОснованиеКонтролируемости136,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету КАК ОснованиеКонтролируемости137,
	|	НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|		И КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья КАК ОснованиеКонтролируемости138,
	|	ЛОЖЬ КАК ОснованиеКонтролируемости139,
	|	ЛОЖЬ КАК ОснованиеКонтролируемости140,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """") = """"
	|			ТОГДА ВЫБОР
	|					КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга)
	|						ТОГДА ""019""
	|					ИНАЧЕ ""015""
	|				КОНЕЦ
	|		ИНАЧЕ ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодНаименованияСделки, """")
	|	КОНЕЦ КАК КодНаименованияСделки,
	|	ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.СпособОпределенияЦеныСделки, ЗНАЧЕНИЕ(Справочник.СпособыОпределенияЦенКонтролируемыхСделок.ПустаяСсылка)) КАК СпособОпределенияЦеныСделки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(ДоговорыУчастниковКонтролируемыхСделок.КодУсловийПоставки, """")
	|		ИНАЧЕ """"
	|	КОНЕЦ КАК КодУсловийПоставки,
	|	КонтролируемыеСделки.ТипПредметаСделки КАК ТипПредметаСделки,
	|	КонтролируемыеСделки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки1,
	|	КонтролируемыеСделки.ТипКонтролируемойСделки КАК ТипСделки,
	|	КонтролируемыеСделки.Грузоотправитель КАК Грузоотправитель,
	|	КонтролируемыеСделки.Грузополучатель КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Договоры.РасчетыВУсловныхЕдиницах, ЛОЖЬ)
	|			ТОГДА &ВалютаРегламентированногоУчета
	|		ИНАЧЕ КонтролируемыеСделки.Валюта
	|	КОНЕЦ КАК Валюта,
	|	КонтролируемыеСделки.РасчетныйДокумент КАК РасчетныйДокумент,
	|	КонтролируемыеСделки.Количество КАК Количество,
	|	КонтролируемыеСделки.ПроцентнаяСтавка КАК ПроцентнаяСтавка,
	|	КонтролируемыеСделки.ДатаПроцентнойСтавки КАК ДатаПроцентнойСтавки,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодТНВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторТНВЭД.ПустаяСсылка)
	|	КОНЕЦ КАК КодТНВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКП, ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ОбщероссийскийКлассификаторПродукции.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКП,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД, ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторВидовЭкономическойДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки = ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКПД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКПД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКПД2,
	|	ВЫБОР
	|		КОГДА КонтролируемыеСделки.ТипПредметаСделки <> ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар)
	|			ТОГДА ЕСТЬNULL(КонтролируемыеСделки.ПредметСделки.КодОКВЭД2, ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлассификаторОКВЭД2.ПустаяСсылка)
	|	КОНЕЦ КАК КодОКВЭД2,
	|	КонтролируемыеСделки.СтранаПроисхожденияПредметаСделки КАК СтранаПроисхожденияПредметаСделки
	|ИЗ
	|	КонтролируемыеСделки КАК КонтролируемыеСделки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДоговорыКонтрагентов КАК Договоры
	|		ПО КонтролируемыеСделки.ДоговорКонтрагента = Договоры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыРФКонтролируемыеПоУсловию КАК КонтрагентыРФКонтролируемыеПоУсловию
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.СделкаКонтролируетсяПоРазнымСтавкамНалогаНаПрибыль
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНДПИ
	|				ИЛИ КонтролируемыеСделки.СделкаОблагаетсяЕНВД
	|				ИЛИ КонтролируемыеСделки.СделкаСПлательщикомЕСХН
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоНалогуНаПрибыль
	|				ИЛИ КонтролируемыеСделки.СделкаМорскогоМесторождения
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоОсвобождениюНДС
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоИнвестиционномуВычету
	|				ИЛИ КонтролируемыеСделки.СделкаКонтролируетсяПоДополнительномуДоходуОтСырья)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ КАК КонтрагентыКонтролируемыеПоРегистрацииНеВРФ
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент
	|			И (КонтролируемыеСделки.ЗарегистрированВСтранеСЛьготнымНалогообложением
	|				ИЛИ КонтролируемыеСделки.СделкаВнешнейТорговлиТоваромМировойБиржевойТорговли)
	|		ЛЕВОЕ СОЕДИНЕНИЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица КАК КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица
	|		ПО КонтролируемыеСделки.ГоловнойКонтрагент = КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДоговорыУчастниковКонтролируемыхСделок КАК ДоговорыУчастниковКонтролируемыхСделок
	|		ПО КонтролируемыеСделки.Организация = ДоговорыУчастниковКонтролируемыхСделок.Организация
	|			И КонтролируемыеСделки.Контрагент = ДоговорыУчастниковКонтролируемыхСделок.Контрагент
	|			И КонтролируемыеСделки.ДоговорКонтрагента = ДоговорыУчастниковКонтролируемыхСделок.ДоговорКонтрагента
	|ГДЕ
	|	КонтролируемыеСделки.ГоловнойКонтрагент В
	|			(ВЫБРАТЬ
	|				КонтрагентыПоМинимальнойСумме.ГоловнойКонтрагент
	|			ИЗ
	|				КонтрагентыПоМинимальнойСумме КАК КонтрагентыПоМинимальнойСумме)
	|	И (НЕ КонтрагентыРФКонтролируемыеПоУсловию.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеКакПрочиеЗависимыеЛица.ГоловнойКонтрагент ЕСТЬ NULL
	|			ИЛИ НЕ КонтрагентыКонтролируемыеПоРегистрацииНеВРФ.ГоловнойКонтрагент ЕСТЬ NULL)
	|	И НЕ КонтролируемыеСделки.СделкаНеЯвляетсяКонтролируемойПоП4
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	ГоловнойКонтрагент,
	|	Контрагент,
	|	ДоговорКонтрагента,
	|	ПредметСделки,
	|	СтранаПроисхожденияПредметаСделки,
	|	Строка121СтороныВзаимозависимыПоКодексу,
	|	Строка122СделкаВОбластиВнешнейТорговли,
	|	Строка123СделкаСКонтрагентомСЛьготнымНалогообложением,
	|	Строка124СделкаСНезависимымПосредником,
	|	ОснованиеКонтролируемости131,
	|	ОснованиеКонтролируемости132,
	|	ОснованиеКонтролируемости133,
	|	ОснованиеКонтролируемости134,
	|	ОснованиеКонтролируемости135,
	|	ОснованиеКонтролируемости136,
	|	ОснованиеКонтролируемости137,
	|	ОснованиеКонтролируемости138,
	|	ОснованиеКонтролируемости139,
	|	ОснованиеКонтролируемости140,
	|	КодНаименованияСделки,
	|	ТипВзаимозависимости,
	|	ТипПредметаСделки,
	|	НаименованиеПредметаСделки,
	|	ТипСделки";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция СопутствующиеУслугиКонтролируемыхСделок(Уведомление)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("УведомлениеОКонтролируемойСделке", Уведомление);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	СопутствующиеУслугиКонтролируемойСделки.Контрагент КАК КонтрагентСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.ДоговорКонтрагента КАК ДоговорКонтрагентаСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.ПредметСделки КАК ПредметСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.РасчетныйДокумент КАК РасчетныйДокументСделки,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.НомерСтроки КАК НомерСтроки,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.НаименованиеУслуги КАК НаименованиеУслуги,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Контрагент КАК Контрагент,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.УчастникиВзаимозависимы КАК УчастникиВзаимозависимы,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Валюта КАК Валюта,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Стоимость КАК Стоимость
	|ИЗ
	|	Документ.СопутствующиеУслугиКонтролируемойСделки КАК СопутствующиеУслугиКонтролируемойСделки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СопутствующиеУслугиКонтролируемойСделки.СопутствующиеУслуги КАК СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги
	|		ПО СопутствующиеУслугиКонтролируемойСделки.Ссылка = СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.Ссылка
	|ГДЕ
	|	СопутствующиеУслугиКонтролируемойСделки.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И СопутствующиеУслугиКонтролируемойСделки.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	Контрагент,
	|	ДоговорКонтрагента,
	|	ПредметСделки,
	|	СопутствующиеУслугиКонтролируемойСделки.Ссылка,
	|	СопутствующиеУслугиКонтролируемойСделкиСопутствующиеУслуги.НомерСтроки";
	
	СопутствующиеУслугиКонтролируемыхСделок = Запрос.Выполнить().Выгрузить();
	СопутствующиеУслугиКонтролируемыхСделок.Индексы.Добавить("КонтрагентСделки,ДоговорКонтрагентаСделки,ПредметСделки");
	
	Возврат СопутствующиеУслугиКонтролируемыхСделок;
	
КонецФункции

Функция ЦепочкиСозданияСтоимости(Уведомление)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("УведомлениеОКонтролируемойСделке", Уведомление);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.Контрагент КАК КонтрагентСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ДоговорКонтрагента КАК ДоговорКонтрагентаСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ПредметСделки КАК ПредметСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.РасчетныйДокумент КАК РасчетныйДокументСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ТипСделки КАК ТипЛиста,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.Ссылка КАК Цепочка,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.НомерСтроки КАК УровеньЦепочки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.ИспользованиеПроисхождениеТовара КАК ИспользованиеПроисхождениеТовара,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.НаименованиеИспользованияПроисхожденияТовара КАК НаименованиеИспользованияПроисхожденияТовара,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.ПризнакУчастникаСделки КАК ПризнакУчастникаСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Контрагент КАК Контрагент,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.УчастникиВзаимозависимы КАК УчастникиВзаимозависимы,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.НомерДоговора КАК НомерДоговора,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.ДатаДоговора КАК ДатаДоговора,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.КодУсловийПоставки КАК КодУсловийПоставки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.СтранаСовершенияСделки КАК СтранаСовершенияСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.ОКТМОСовершенияСделки КАК ОКТМОСовершенияСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Количество КАК Количество,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Цена КАК Цена,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Валюта КАК Валюта,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Стоимость КАК Стоимость,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ЦепочкаСозданияСтоимостиКонтролируемойСделки.Дата) КАК ДатаРасчетногоДокументаСделки
	|ИЗ
	|	Документ.ЦепочкаСозданияСтоимостиКонтролируемойСделки КАК ЦепочкаСозданияСтоимостиКонтролируемойСделки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЦепочкаСозданияСтоимостиКонтролируемойСделки.Сделки КАК ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки
	|		ПО ЦепочкаСозданияСтоимостиКонтролируемойСделки.Ссылка = ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ЦепочкаСозданияСтоимостиКонтролируемойСделки.РасчетныйДокумент = ДанныеПервичныхДокументов.Документ
	|			И ЦепочкаСозданияСтоимостиКонтролируемойСделки.Организация = ДанныеПервичныхДокументов.Организация
	|ГДЕ
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И ЦепочкаСозданияСтоимостиКонтролируемойСделки.Проведен
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.Контрагент,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ДоговорКонтрагента,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ПредметСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделки.ТипСделки,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.Ссылка,
	|	ЦепочкаСозданияСтоимостиКонтролируемойСделкиСделки.НомерСтроки";
	
	ЦепочкиСозданияСтоимости = Запрос.Выполнить().Выгрузить();
	ЦепочкиСозданияСтоимости.Индексы.Добавить("КонтрагентСделки,ДоговорКонтрагентаСделки,ПредметСделки");
	
	Возврат ЦепочкиСозданияСтоимости;
	
КонецФункции

Функция ПоляОтбораРоялти()
	Возврат "Контрагент,ДоговорКонтрагента,ПредметСделки,НаименованиеПредметаСделки";
КонецФункции

Функция РоялтиКонтролируемыхСделок(Уведомление)
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("УведомлениеОКонтролируемойСделке", Уведомление);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РоялтиКонтролируемойСделки.Контрагент КАК Контрагент,
	|	РоялтиКонтролируемойСделки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	РоялтиКонтролируемойСделкиСделкиРоялти.ПредметСделки КАК ПредметСделки,
	|	РоялтиКонтролируемойСделкиСделкиРоялти.НаименованиеПредметаСделки КАК НаименованиеПредметаСделки,
	|	РоялтиКонтролируемойСделкиСделкиРоялти.ДатаСовершенияСделки КАК ДатаСовершенияСделки,
	|	РоялтиКонтролируемойСделкиСделкиРоялти.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА РоялтиКонтролируемойСделкиСделкиРоялти.ТипРоялти = ЗНАЧЕНИЕ(Перечисление.ТипыРоялтиКонтролируемыхСделок.Процентом)
	|			ТОГДА РоялтиКонтролируемойСделкиСделкиРоялти.СуммаБазыДляРасчетаРоялти
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаБазыДляРасчетаРоялти
	|ИЗ
	|	Документ.РоялтиКонтролируемойСделки КАК РоялтиКонтролируемойСделки
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РоялтиКонтролируемойСделки.СделкиРоялти КАК РоялтиКонтролируемойСделкиСделкиРоялти
	|		ПО РоялтиКонтролируемойСделки.Ссылка = РоялтиКонтролируемойСделкиСделкиРоялти.Ссылка
	|ГДЕ
	|	РоялтиКонтролируемойСделки.УведомлениеОКонтролируемойСделке = &УведомлениеОКонтролируемойСделке
	|	И РоялтиКонтролируемойСделки.Проведен
	|	И РоялтиКонтролируемойСделкиСделкиРоялти.ТипРоялти <> ЗНАЧЕНИЕ(Перечисление.ТипыРоялтиКонтролируемыхСделок.НеРоялти)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РоялтиКонтролируемойСделки.Контрагент,
	|	РоялтиКонтролируемойСделки.ДоговорКонтрагента,
	|	ПредметСделки,
	|	РоялтиКонтролируемойСделки.Ссылка,
	|	РоялтиКонтролируемойСделкиСделкиРоялти.НомерСтроки";
	
	РоялтиКонтролируемыхСделок = Запрос.Выполнить().Выгрузить();
	РоялтиКонтролируемыхСделок.Индексы.Добавить(ПоляОтбораРоялти());
	
	Возврат РоялтиКонтролируемыхСделок;
	
КонецФункции

Функция ИсключенияЗаполненияЛиста1А(ВерсияУведомления)
	
	ИсключенияДляЗаполненияЛиста1А = Новый Массив;
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		// Все показатели Листа 1А и 1Б уведомления о контролируемых сделках выводятся в рублях.
		// Поэтому из сделки валюта не переносится - она устанавливается при записи документа - всегда в валюту регламентированного учета.
		ИсключенияДляЗаполненияЛиста1А.Добавить("Валюта");
	КонецЕсли;
	
	Если ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012() Тогда
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКПД2");
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКВЭД2");
	Иначе
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКП");
		ИсключенияДляЗаполненияЛиста1А.Добавить("КодОКВЭД");
	КонецЕсли;
	
	Возврат СтрСоединить(ИсключенияДляЗаполненияЛиста1А, ",");
	
КонецФункции

Функция ИсключенияЗаполненияЛиста1Б(ВерсияУведомления, ТипПредметаСделки)
	
	ИсключенияДляЗаполненияЛиста1Б = Новый Массив;
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018()
		Или ТипПредметаСделки <> Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
		ИсключенияДляЗаполненияЛиста1Б.Добавить("ПроцентнаяСтавка");
	КонецЕсли;
	
	Возврат СтрСоединить(ИсключенияДляЗаполненияЛиста1Б, ",");
	
КонецФункции

Процедура ЗаполнитьДатуСделкиДолговыхОбязательств(Сделка, ВерсияУведомления, ТипПредметаСделки, ДатаПроцентнойСтавки)
	
	Если ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018()
		И ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
		Сделка.ДатаСовершенияСделки = ДатаПроцентнойСтавки;
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьТаблицуСделокЛиста1А(Лист1А, ТаблицаСделок, ПараметрыЗаполнения)
	
	СписокПолейСделки = ПараметрыЗаполнения.СтрокаСверткиТаблицыСделок;
	ТаблицаСделок.Свернуть(СписокПолейСделки + ", РасчетныйДокумент", "Количество, Стоимость, СтоимостьДляРасчетаЦены");
	Если Лист1А.ТипПредметаСделки <> Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
		Для Каждого Сделка Из ТаблицаСделок Цикл
			Сделка.Цена = ?(Сделка.Количество = 0, Сделка.СтоимостьДляРасчетаЦены, Окр(Сделка.СтоимостьДляРасчетаЦены/Сделка.Количество, 2));
		КонецЦикла;
	КонецЕсли;
	
	ТаблицаСделок.Сортировать("ДатаСовершенияСделки");
	
	Листы1Б = ТаблицаСделок.СкопироватьКолонки();
	Листы1Б.Колонки.Добавить("ИдентификаторЛиста1Б", Новый ОписаниеТипов("УникальныйИдентификатор"));
	
	ИдентификаторыЛистовРасчетныхДокументов = Новый Соответствие;
	
	СделкаДокумента = Неопределено;
	Для Каждого Сделка Из ТаблицаСделок Цикл
		Если (Сделка.Количество <> 0) ИЛИ (Сделка.Стоимость <> 0) ИЛИ (Сделка.ПроцентнаяСтавка <> 0) Тогда
			
			Если СделкаДокумента = Неопределено 
				ИЛИ Лист1А.ТипПредметаСделки <> Перечисления.ТипыПредметовКонтролируемыхСделок.Товар
				ИЛИ НЕ СделкиСовпадают(СделкаДокумента, Сделка, ПараметрыЗаполнения.КлючевыеПоля) Тогда
				СделкаДокумента = Листы1Б.Добавить();
				СделкаДокумента.ИдентификаторЛиста1Б = Новый УникальныйИдентификатор();
				ЗаполнитьЗначенияСвойств(СделкаДокумента, Сделка, , "Количество,Стоимость");
			КонецЕсли;
			ИдентификаторыЛистовРасчетныхДокументов.Вставить(Сделка.РасчетныйДокумент, СделкаДокумента.ИдентификаторЛиста1Б);
			СделкаДокумента.Количество = СделкаДокумента.Количество + Сделка.Количество;
			СделкаДокумента.Стоимость = СделкаДокумента.Стоимость + Сделка.Стоимость;
			СделкаДокумента.ДатаСовершенияСделки = Сделка.ДатаСовершенияСделки;
		КонецЕсли;
	КонецЦикла;
	
	Лист1А.Сделки.Загрузить(Листы1Б);
	Лист1А.СвязьЛистов1Би1В.Очистить();
	
	Лист1А.Листы1В.Очистить();
	Лист1А.Листы1Г.Очистить();
	
	Если Лист1А.УказыватьСведенияЦепочкиСозданияСтоимости
		И Лист1А.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
		
		ЗаполнитьЛисты1В(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения);
		
		ЗаполнитьЛисты1Г(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения);
		
	КонецЕсли;
	
	Если ПараметрыЗаполнения.Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
		ЗаполнитьРоялтиЛистов1Б(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьЛисты1В(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения)
	
	ОтборПоСделке = Новый Структура();
	ОтборПоСделке.Вставить("КонтрагентСделки", Лист1А.Контрагент);
	ОтборПоСделке.Вставить("ДоговорКонтрагентаСделки", Лист1А.ДоговорКонтрагента);
	ОтборПоСделке.Вставить("ПредметСделки", Лист1А.ПредметСделки);
	
	// Т.к. НайтиСтроки не гарантирует сохранение порядка строк исходной таблицы, поэтому
	// заполним отдельную таблицу для сортировки и отсортируем ее правильно.
	
	ТаблицаЦепочекЛиста1А = ПараметрыЗаполнения.ЦепочкиСозданияСтоимости.СкопироватьКолонки(
		"КонтрагентСделки,ДоговорКонтрагентаСделки,ПредметСделки,РасчетныйДокументСделки,ДатаРасчетногоДокументаСделки,ТипЛиста,Цепочка,УровеньЦепочки");
	ТаблицаЦепочекЛиста1А.Колонки.Добавить("СортировкаТипаЛиста", ОбщегоНазначения.ОписаниеТипаЧисло(1, 0));
	ТаблицаЦепочекЛиста1А.Колонки.Добавить("СтрокаЦепочки");
	
	СтрокиЦепочки = ПараметрыЗаполнения.ЦепочкиСозданияСтоимости.НайтиСтроки(ОтборПоСделке);
	Для Каждого СтрокаЦепочки Из СтрокиЦепочки Цикл
		СтрокаЦепочки1А = ТаблицаЦепочекЛиста1А.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаЦепочки1А, СтрокаЦепочки);
		СтрокаЦепочки1А.СтрокаЦепочки = СтрокаЦепочки;
		СтрокаЦепочки1А.СортировкаТипаЛиста = ?(СтрокаЦепочки1А.ТипЛиста = Перечисления.ТипыСделокВЦепочкеКонтролируемыхСделок.ПредшествующаяПокупка, 0, 1);
	КонецЦикла;
	
	ПустойИдентификатор = ОбщегоНазначенияКлиентСервер.ПустойУникальныйИдентификатор();
	ИдентификаторПредыдущегоЛиста1В = ПустойИдентификатор;
	
	ТаблицаЦепочекЛиста1А.Сортировать("СортировкаТипаЛиста,ДатаРасчетногоДокументаСделки,Цепочка,УровеньЦепочки", Новый СравнениеЗначений());
	Для Каждого СтрокаЦепочкиЛиста1А Из ТаблицаЦепочекЛиста1А Цикл
		
		ИдентификаторЛиста1Б = ИдентификаторыЛистовРасчетныхДокументов.Получить(СтрокаЦепочкиЛиста1А.РасчетныйДокументСделки);
		Если ИдентификаторЛиста1Б = Неопределено Тогда
			// Этого расчетного документа нет среди листов 1Б.
			// Поэтому эти строки пропускаем.
			Продолжить;
		КонецЕсли;
		
		Если СтрокаЦепочкиЛиста1А.УровеньЦепочки = 1 Тогда
			ИдентификаторПредыдущегоЛиста1В = ПустойИдентификатор;
		КонецЕсли;
		
		СтрокаЦепочки = СтрокаЦепочкиЛиста1А.СтрокаЦепочки;
		
		ДанныеЛиста1В = НайтиСоздатьЛист1В(Лист1А, ИдентификаторЛиста1Б, ИдентификаторПредыдущегоЛиста1В, СтрокаЦепочки, ПараметрыЗаполнения);
		ДанныеЛиста1В.Количество = ДанныеЛиста1В.Количество + СтрокаЦепочки.Количество;
		ДанныеЛиста1В.Стоимость = ДанныеЛиста1В.Стоимость + СтрокаЦепочки.Стоимость;
		
		ИдентификаторПредыдущегоЛиста1В = ДанныеЛиста1В.ИдентификаторЛиста1В;
		
		// Эту строку больше нельзя использовать в других листах 1А, даже если они и подойдут по параметрам.
		// Поэтому удалим ее сразу же.
		ПараметрыЗаполнения.ЦепочкиСозданияСтоимости.Удалить(СтрокаЦепочки);
		
	КонецЦикла;
	
КонецПроцедуры

Функция НайтиСоздатьЛист1В(Лист1А, ИдентификаторЛиста1Б, ИдентификаторПредыдущегоЛиста1В, СтрокаЦепочки, ПараметрыЗаполнения)
	
	Для Каждого СтрокаЛиста1В Из Лист1А.Листы1В Цикл
		Если СделкиСовпадают(СтрокаЛиста1В, СтрокаЦепочки, ПараметрыЗаполнения.КлючевыеПоляЦепочкиСозданияСтоимости)
			И СтрокаЛиста1В.ИдентификаторЛиста1Б = ИдентификаторЛиста1Б
			И СтрокаЛиста1В.ИдентификаторПредыдущегоЛиста1В = ИдентификаторПредыдущегоЛиста1В Тогда
			Возврат СтрокаЛиста1В;
		КонецЕсли;
	КонецЦикла;
	
	СтрокаЛиста1В = Лист1А.Листы1В.Добавить();
	СтрокаЛиста1В.ИдентификаторЛиста1В = Новый УникальныйИдентификатор;
	СтрокаЛиста1В.ИдентификаторЛиста1Б = ИдентификаторЛиста1Б;
	СтрокаЛиста1В.ИдентификаторПредыдущегоЛиста1В = ИдентификаторПредыдущегоЛиста1В;
	ЗаполнитьЗначенияСвойств(СтрокаЛиста1В, СтрокаЦепочки, ,"Количество,Стоимость");
	Возврат СтрокаЛиста1В;
	
КонецФункции

Процедура ЗаполнитьЛисты1Г(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения)
	
	ОтборПоСделке = Новый Структура();
	ОтборПоСделке.Вставить("КонтрагентСделки", Лист1А.Контрагент);
	ОтборПоСделке.Вставить("ДоговорКонтрагентаСделки", Лист1А.ДоговорКонтрагента);
	ОтборПоСделке.Вставить("ПредметСделки", Лист1А.ПредметСделки);
	
	СтрокиСопутствующихУслуг = ПараметрыЗаполнения.СопутствующиеУслуги.НайтиСтроки(ОтборПоСделке);
	Для Каждого СтрокаСопутствующейУслуги Из СтрокиСопутствующихУслуг Цикл
		
		ИдентификаторЛиста1БРасчетногоДокумента = ИдентификаторыЛистовРасчетныхДокументов.Получить(СтрокаСопутствующейУслуги.РасчетныйДокументСделки);
		Если ИдентификаторЛиста1БРасчетногоДокумента = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		ДанныеЛиста1Г = Лист1А.Листы1Г.Добавить();
		ДанныеЛиста1Г.ИдентификаторЛиста1Б = ИдентификаторЛиста1БРасчетногоДокумента;
		ЗаполнитьЗначенияСвойств(ДанныеЛиста1Г, СтрокаСопутствующейУслуги,
			"НаименованиеУслуги,УчастникиВзаимозависимы,Контрагент,Валюта,Стоимость");
		
		ПараметрыЗаполнения.СопутствующиеУслуги.Удалить(СтрокаСопутствующейУслуги);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьРоялтиЛистов1Б(Лист1А, ИдентификаторыЛистовРасчетныхДокументов, ПараметрыЗаполнения)
	
	ОтборСтрокРоялти = Новый Структура(ПоляОтбораРоялти());
	ЗаполнитьЗначенияСвойств(ОтборСтрокРоялти, Лист1А);
	
	ЕстьРоялти = Ложь;
	
	ОтборЛистов1Б = Новый Структура("ИдентификаторЛиста1Б");
	
	
	СтрокиРоялтиСделки = ПараметрыЗаполнения.РоялтиКонтролируемыхСделок.НайтиСтроки(ОтборСтрокРоялти);
	Для Каждого СтрокаРоялти Из СтрокиРоялтиСделки Цикл
		
		ИдентификаторЛиста1БРасчетногоДокумента = ИдентификаторыЛистовРасчетныхДокументов.Получить(СтрокаРоялти.РасчетныйДокумент);
		Если ИдентификаторЛиста1БРасчетногоДокумента = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		ОтборЛистов1Б.ИдентификаторЛиста1Б = ИдентификаторЛиста1БРасчетногоДокумента;
		
		СтрокиЛистов1Б = Лист1А.Сделки.НайтиСтроки(ОтборЛистов1Б);
		Если Не ЗначениеЗаполнено(СтрокиЛистов1Б) Тогда
			Продолжить;
		КонецЕсли;
		
		СтрокаЛиста1Б = СтрокиЛистов1Б[0];
		СтрокаЛиста1Б.СуммаБазыДляРасчетаРоялти = СтрокаЛиста1Б.СуммаБазыДляРасчетаРоялти + СтрокаРоялти.СуммаБазыДляРасчетаРоялти;
		
		ПараметрыЗаполнения.РоялтиКонтролируемыхСделок.Удалить(СтрокаРоялти);
		
		ЕстьРоялти = Истина;
		
	КонецЦикла;
	
	Если ЕстьРоялти Тогда
		// Если предмет сделки содержит роялти, то это точно лицензионный платеж,
		// а он - не услуга, а иной объект гражданских прав. Хотя и отражается в базе, как услуга.
		Лист1А.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав;
	КонецЕсли;
	
КонецПроцедуры

Функция СделкиСовпадают(Сделка1, Сделка2, СтруктураКлючевыхПолей)
	
	Для Каждого Поле Из СтруктураКлючевыхПолей Цикл
		Если Сделка1[Поле.Ключ] <> Сделка2[Поле.Ключ] Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	Возврат Истина;
	
КонецФункции

Функция ПолучитьВременныеТаблицыДляЗаполненияСделок(Уведомление)
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	Организации = Новый Массив(1);
	Организации[0] = ПараметрыУведомления.Организация;
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц();
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("СписокОрганизаций", Организации);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("СписокОфшоров", КонтролируемыеСделки.СписокОфшоров(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ТаблицаКодовТНВЭДМировойБиржевойТорговли",
		КонтролируемыеСделки.ТаблицаКодовТНВЭДМировойБиржевойТорговли());
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Страны.Ссылка КАК Страна
	|ПОМЕСТИТЬ СтраныСЛьготнымНалогообложением
	|ИЗ
	|	Справочник.СтраныМира КАК Страны
	|ГДЕ
	|	Страны.Ссылка В(&СписокОфшоров)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Страна
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КодыТНВЭДМировойБиржевойТорговли.СсылкаТНВЭД КАК СсылкаТНВЭД,
	|	КодыТНВЭДМировойБиржевойТорговли.ДатаНачалаДействия КАК ДатаНачалаДействия,
	|	КодыТНВЭДМировойБиржевойТорговли.ДатаОкончанияДействия КАК ДатаОкончанияДействия
	|ПОМЕСТИТЬ КодТВНЭДМировойБиржевойТорговли
	|ИЗ
	|	&ТаблицаКодовТНВЭДМировойБиржевойТорговли КАК КодыТНВЭДМировойБиржевойТорговли
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК ПредметСделки,
	|	КодТВНЭДМировойБиржевойТорговли.ДатаНачалаДействия КАК ДатаНачалаДействия,
	|	КодТВНЭДМировойБиржевойТорговли.ДатаОкончанияДействия КАК ДатаОкончанияДействия
	|ПОМЕСТИТЬ ТоварыМировойБиржевойТорговли
	|ИЗ
	|	КодТВНЭДМировойБиржевойТорговли КАК КодТВНЭДМировойБиржевойТорговли
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
	|		ПО КодТВНЭДМировойБиржевойТорговли.СсылкаТНВЭД = Номенклатура.КодТНВЭД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПредметСделки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&НачалоПериода КАК НачалоПериода,
	|	ВзаимозависимыеЛицаСрезПоследних.Организация КАК Организация,
	|	ВзаимозависимыеЛицаСрезПоследних.Контрагент КАК Контрагент,
	|	ВзаимозависимыеЛицаСрезПоследних.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	ВзаимозависимыеЛицаСрезПоследних.ЯвляетсяПлательщикомНалогаНаПрибыль КАК ЯвляетсяПлательщикомНалогаНаПрибыль,
	|	ВзаимозависимыеЛицаСрезПоследних.ЯвляетсяПлательщикомНДПИ КАК ЯвляетсяПлательщикомНДПИ,
	|	ВзаимозависимыеЛицаСрезПоследних.ЯвляетсяПлательщикомЕСХН КАК ЯвляетсяПлательщикомЕСХН,
	|	ВзаимозависимыеЛицаСрезПоследних.ЯвляетсяПлательщикомЕНВД КАК ЯвляетсяПлательщикомЕНВД,
	|	ВзаимозависимыеЛицаСрезПоследних.ЗарегистрированВОЭЗ КАК ЗарегистрированВОЭЗ,
	|	ВзаимозависимыеЛицаСрезПоследних.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта КАК ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|	ВзаимозависимыеЛицаСрезПоследних.ОсвобожденОтУплатыНДС КАК ОсвобожденОтУплатыНДС,
	|	ВзаимозависимыеЛицаСрезПоследних.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль КАК ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль
	|ПОМЕСТИТЬ ВзаимозависимыеЛицаГоловныеКонтрагенты
	|ИЗ
	|	РегистрСведений.ВзаимозависимыеЛица.СрезПоследних(&НачалоПериода, Организация В (&СписокОрганизаций)) КАК ВзаимозависимыеЛицаСрезПоследних
	|ГДЕ
	|	ВзаимозависимыеЛицаСрезПоследних.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВзаимозависимыеЛица.Период,
	|	ВзаимозависимыеЛица.Организация,
	|	ВзаимозависимыеЛица.Контрагент,
	|	ВзаимозависимыеЛица.ТипВзаимозависимости,
	|	ВзаимозависимыеЛица.ЯвляетсяПлательщикомНалогаНаПрибыль,
	|	ВзаимозависимыеЛица.ЯвляетсяПлательщикомНДПИ,
	|	ВзаимозависимыеЛица.ЯвляетсяПлательщикомЕСХН,
	|	ВзаимозависимыеЛица.ЯвляетсяПлательщикомЕНВД,
	|	ВзаимозависимыеЛица.ЗарегистрированВОЭЗ,
	|	ВзаимозависимыеЛица.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|	ВзаимозависимыеЛица.ОсвобожденОтУплатыНДС,
	|	ВзаимозависимыеЛица.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль
	|ИЗ
	|	РегистрСведений.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица
	|ГДЕ
	|	ВзаимозависимыеЛица.Период > &НачалоПериода
	|	И ВзаимозависимыеЛица.Период <= &ОкончаниеПериода
	|	И ВзаимозависимыеЛица.Организация В(&СписокОрганизаций)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.НачалоПериода КАК НачалоПериода,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.Организация КАК Организация,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.Контрагент КАК Контрагент,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.Контрагент КАК ГоловнойКонтрагент,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомНалогаНаПрибыль КАК ЯвляетсяПлательщикомНалогаНаПрибыль,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомНДПИ КАК ЯвляетсяПлательщикомНДПИ,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомЕСХН КАК ЯвляетсяПлательщикомЕСХН,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомЕНВД КАК ЯвляетсяПлательщикомЕНВД,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЗарегистрированВОЭЗ КАК ЗарегистрированВОЭЗ,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта КАК ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ОсвобожденОтУплатыНДС КАК ОсвобожденОтУплатыНДС,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль КАК ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль
	|ПОМЕСТИТЬ ВзаимозависимыеЛица
	|ИЗ
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты КАК ВзаимозависимыеЛицаГоловныеКонтрагенты
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.НачалоПериода,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.Организация,
	|	Контрагенты.Ссылка,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.Контрагент,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ТипВзаимозависимости,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомНалогаНаПрибыль,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомНДПИ,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомЕСХН,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЯвляетсяПлательщикомЕНВД,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ЗарегистрированВОЭЗ,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ОсвобожденОтУплатыНДС,
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль
	|ИЗ
	|	ВзаимозависимыеЛицаГоловныеКонтрагенты КАК ВзаимозависимыеЛицаГоловныеКонтрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК Контрагенты
	|		ПО ВзаимозависимыеЛицаГоловныеКонтрагенты.Контрагент = Контрагенты.ГоловнойКонтрагент
	|			И (Контрагенты.ОбособленноеПодразделение)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Контрагент,
	|	НачалоПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВзаимозависимыеЛицаПоПериодамВсе.Организация КАК Организация,
	|	ВзаимозависимыеЛицаПоПериодамВсе.НачалоПериода КАК НачалоПериода,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ОкончаниеПериода КАК ОкончаниеПериода,
	|	ВзаимозависимыеЛицаПоПериодамВсе.Контрагент КАК Контрагент,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодамВсе.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодамВсе.ТипВзаимозависимости = ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимыйПосредник)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК НевзаимозависимыйПосредник,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ЯвляетсяПлательщикомНалогаНаПрибыль КАК ЯвляетсяПлательщикомНалогаНаПрибыль,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ЯвляетсяПлательщикомНДПИ КАК ЯвляетсяПлательщикомНДПИ,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ЯвляетсяПлательщикомЕСХН КАК ЯвляетсяПлательщикомЕСХН,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ЯвляетсяПлательщикомЕНВД КАК ЯвляетсяПлательщикомЕНВД,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ЗарегистрированВОЭЗ КАК ЗарегистрированВОЭЗ,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта КАК ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ОсвобожденОтУплатыНДС КАК ОсвобожденОтУплатыНДС,
	|	ВзаимозависимыеЛицаПоПериодамВсе.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль КАК ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль
	|ПОМЕСТИТЬ ВзаимозависимыеЛицаПоПериодам
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВзаимозависимыеЛица.Организация КАК Организация,
	|		ВзаимозависимыеЛица.НачалоПериода КАК НачалоПериода,
	|		КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(МИНИМУМ(ЕСТЬNULL(ВзаимозависимыеЛица1.НачалоПериода, &ОкончаниеПериода)), СЕКУНДА, -1), ДЕНЬ) КАК ОкончаниеПериода,
	|		ВзаимозависимыеЛица.Контрагент КАК Контрагент,
	|		ВзаимозависимыеЛица.ГоловнойКонтрагент КАК ГоловнойКонтрагент,
	|		ВзаимозависимыеЛица.ТипВзаимозависимости КАК ТипВзаимозависимости,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомНалогаНаПрибыль КАК ЯвляетсяПлательщикомНалогаНаПрибыль,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомНДПИ КАК ЯвляетсяПлательщикомНДПИ,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомЕСХН КАК ЯвляетсяПлательщикомЕСХН,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомЕНВД КАК ЯвляетсяПлательщикомЕНВД,
	|		ВзаимозависимыеЛица.ЗарегистрированВОЭЗ КАК ЗарегистрированВОЭЗ,
	|		ВзаимозависимыеЛица.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта КАК ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|		ВзаимозависимыеЛица.ОсвобожденОтУплатыНДС КАК ОсвобожденОтУплатыНДС,
	|		ВзаимозависимыеЛица.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль КАК ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль
	|	ИЗ
	|		ВзаимозависимыеЛица КАК ВзаимозависимыеЛица
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛица КАК ВзаимозависимыеЛица1
	|			ПО ВзаимозависимыеЛица.Организация = ВзаимозависимыеЛица1.Организация
	|				И ВзаимозависимыеЛица.Контрагент = ВзаимозависимыеЛица1.Контрагент
	|				И ВзаимозависимыеЛица.НачалоПериода < ВзаимозависимыеЛица1.НачалоПериода
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ВзаимозависимыеЛица.Организация,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомНалогаНаПрибыль,
	|		ВзаимозависимыеЛица.ТипВзаимозависимости,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомНДПИ,
	|		ВзаимозависимыеЛица.ЗарегистрированВОЭЗ,
	|		ВзаимозависимыеЛица.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта,
	|		ВзаимозависимыеЛица.ОсвобожденОтУплатыНДС,
	|		ВзаимозависимыеЛица.ПрименяетИнвестиционныйВычетПоНалогуНаПрибыль,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомЕСХН,
	|		ВзаимозависимыеЛица.ЯвляетсяПлательщикомЕНВД,
	|		ВзаимозависимыеЛица.НачалоПериода,
	|		ВзаимозависимыеЛица.Контрагент,
	|		ВзаимозависимыеЛица.ГоловнойКонтрагент) КАК ВзаимозависимыеЛицаПоПериодамВсе
	|ГДЕ
	|	ВзаимозависимыеЛицаПоПериодамВсе.ТипВзаимозависимости <> ЗНАЧЕНИЕ(Перечисление.ТипыВзаимозависимости.НеВзаимозависимы)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВзаимозависимыеЛицаПоПериодамВсе.Организация,
	|	ВзаимозависимыеЛицаПоПериодамВсе.Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	&НачалоПериода КАК НачалоПериода,
	|	СведенияОбОрганизацииДляКонтролируемыхСделокСрезПоследних.Организация КАК Организация,
	|	СведенияОбОрганизацииДляКонтролируемыхСделокСрезПоследних.ЯвляетсяПлательщикомНДПИ КАК ЯвляетсяПлательщикомНДПИ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделокСрезПоследних.ЗарегистрированВОЭЗ КАК ЗарегистрированВОЭЗ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделокСрезПоследних.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта КАК ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта
	|ПОМЕСТИТЬ СведенияОбОрганизацииДляКонтролируемыхСделок
	|ИЗ
	|	РегистрСведений.СведенияОбОрганизацииДляКонтролируемыхСделок.СрезПоследних(&НачалоПериода, Организация В (&СписокОрганизаций)) КАК СведенияОбОрганизацииДляКонтролируемыхСделокСрезПоследних
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.Период,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.Организация,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ЯвляетсяПлательщикомНДПИ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ЗарегистрированВОЭЗ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта
	|ИЗ
	|	РегистрСведений.СведенияОбОрганизацииДляКонтролируемыхСделок КАК СведенияОбОрганизацииДляКонтролируемыхСделок
	|ГДЕ
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.Период > &НачалоПериода
	|	И СведенияОбОрганизацииДляКонтролируемыхСделок.Период <= &ОкончаниеПериода
	|	И СведенияОбОрганизацииДляКонтролируемыхСделок.Организация В(&СписокОрганизаций)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	НачалоПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.НачалоПериода КАК НачалоПериода,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.Организация КАК Организация,
	|	КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(МИНИМУМ(ЕСТЬNULL(СведенияОбОрганизацииДляКонтролируемыхСделок1.НачалоПериода, &ОкончаниеПериода)), СЕКУНДА, -1), ДЕНЬ) КАК ОкончаниеПериода,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ЯвляетсяПлательщикомНДПИ КАК ЯвляетсяПлательщикомНДПИ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ЗарегистрированВОЭЗ КАК ЗарегистрированВОЭЗ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта КАК ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта
	|ПОМЕСТИТЬ СведенияОбОрганизацииДляКонтролируемыхСделокПоПериодам
	|ИЗ
	|	СведенияОбОрганизацииДляКонтролируемыхСделок КАК СведенияОбОрганизацииДляКонтролируемыхСделок
	|		ЛЕВОЕ СОЕДИНЕНИЕ СведенияОбОрганизацииДляКонтролируемыхСделок КАК СведенияОбОрганизацииДляКонтролируемыхСделок1
	|		ПО СведенияОбОрганизацииДляКонтролируемыхСделок.Организация = СведенияОбОрганизацииДляКонтролируемыхСделок1.Организация
	|			И СведенияОбОрганизацииДляКонтролируемыхСделок.НачалоПериода < СведенияОбОрганизацииДляКонтролируемыхСделок1.НачалоПериода
	|
	|СГРУППИРОВАТЬ ПО
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.Организация,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ЯвляетсяПлательщикомНДПИ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ЗарегистрированВОЭЗ,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.НачалоПериода,
	|	СведенияОбОрганизацииДляКонтролируемыхСделок.ПрименяетЛьготыУчастникаРегиональногоИнвестиционногоПроекта
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка КАК Контрагент,
	|	ЕСТЬNULL(ГоловныеКонтрагенты.Ссылка, Контрагенты.Ссылка) КАК ГоловнойКонтрагент,
	|	ВЫБОР
	|		КОГДА СтраныСЛьготнымНалогообложением.Страна ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ИСТИНА КАК СделкаВОбластиВнешнейТорговли
	|ПОМЕСТИТЬ ИностранныеКонтрагенты
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО Контрагенты.ГоловнойКонтрагент = ГоловныеКонтрагенты.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтраныСЛьготнымНалогообложением КАК СтраныСЛьготнымНалогообложением
	|		ПО (СтраныСЛьготнымНалогообложением.Страна = Контрагенты.СтранаРегистрации)
	|ГДЕ
	|	Контрагенты.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Контрагенты.Ссылка,
	|	ГоловныеКонтрагенты.Ссылка,
	|	ВЫБОР
	|		КОГДА СтраныСЛьготнымНалогообложением.Страна ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК ГоловныеКонтрагенты
	|		ПО (ГоловныеКонтрагенты.Ссылка = Контрагенты.ГоловнойКонтрагент)
	|		ЛЕВОЕ СОЕДИНЕНИЕ СтраныСЛьготнымНалогообложением КАК СтраныСЛьготнымНалогообложением
	|		ПО (СтраныСЛьготнымНалогообложением.Страна = ГоловныеКонтрагенты.СтранаРегистрации)
	|ГДЕ
	|	Контрагенты.ГоловнойКонтрагент <> Контрагенты.Ссылка
	|	И ГоловныеКонтрагенты.СтранаРегистрации <> ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|	И Контрагенты.СтранаРегистрации = ЗНАЧЕНИЕ(Справочник.СтраныМира.Россия)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Контрагент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВзаимозависимыеЛица
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КонтролируемыеКонтрагенты.Контрагент КАК Контрагент,
	|	КонтролируемыеКонтрагенты.ГоловнойКонтрагент КАК ГоловнойКонтрагент
	|ПОМЕСТИТЬ КонтролируемыеКонтрагенты
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВзаимозависимыеЛицаПоПериодам.Контрагент КАК Контрагент,
	|		ВзаимозависимыеЛицаПоПериодам.ГоловнойКонтрагент КАК ГоловнойКонтрагент
	|	ИЗ
	|		ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|	
	|	ОБЪЕДИНИТЬ
	|	
	|	ВЫБРАТЬ
	|		ИностранныеКонтрагенты.Контрагент,
	|		ИностранныеКонтрагенты.ГоловнойКонтрагент
	|	ИЗ
	|		ИностранныеКонтрагенты КАК ИностранныеКонтрагенты) КАК КонтролируемыеКонтрагенты
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	КонтролируемыеКонтрагенты.Контрагент";
	Запрос.Выполнить();
	
	Возврат Запрос.МенеджерВременныхТаблиц;
	
КонецФункции

Функция ПометитьНаУдалениеКонтролируемыеСделкиУведомления(Уведомление)
	
	ТаблицаСделок = Новый ТаблицаЗначений();
	ТаблицаСделок.Колонки.Добавить("Сделка", Новый ОписаниеТипов("ДокументСсылка.КонтролируемаяСделка"));
	ТаблицаСделок.Колонки.Добавить("Используется", Новый ОписаниеТипов("Булево"));
	
	РеквизитыСделки = Метаданные.Документы.КонтролируемаяСделка.Реквизиты;
	Для Каждого Реквизит Из РеквизитыСделки Цикл
		ТаблицаСделок.Колонки.Добавить(Реквизит.Имя, Новый ОписаниеТипов(Реквизит.Тип));
	КонецЦикла;
	
	ДокументыСделок = Документы.КонтролируемаяСделка.Выбрать( , , Новый Структура("УведомлениеОКонтролируемойСделке", Уведомление));
	Пока ДокументыСделок.Следующий() Цикл
		ДокументСделка = ДокументыСделок.ПолучитьОбъект();
		СтрокаСделок = ТаблицаСделок.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаСделок, ДокументСделка);
		СтрокаСделок.Сделка = ДокументСделка.Ссылка;
		ДокументСделка.УстановитьПометкуУдаления(Истина);
	КонецЦикла;
	
	ТаблицаСделок.Индексы.Добавить("Контрагент, ДоговорКонтрагента, ПредметСделки, Используется");
	
	Возврат ТаблицаСделок;
	
КонецФункции

Функция КлючСделкиСовпадает(Сделка, КлючСделки) 
	
	Для Каждого Ключ Из КлючСделки Цикл
		Если Сделка[Ключ.Ключ] <> Ключ.Значение Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Функция ПолучитьТаблицуСделок()
	
	ОписаниеТиповРасчетныхДокументов = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.РасчетныйДокумент.Тип;
	ОписаниеТиповПредметовСделки = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Измерения.ПредметСделки.Тип;
	ОписаниеГрузоотправителя = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Реквизиты.Грузоотправитель.Тип;
	ОписаниеГрузополучателя  = 
		Метаданные.РегистрыНакопления.КонтролируемыеСделкиОрганизаций.Реквизиты.Грузополучатель.Тип;
	
	ТаблицаСделок = Новый ТаблицаЗначений();
	ТаблицаСделок.Колонки.Добавить("Период", Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.ДатаВремя)));
	ТаблицаСделок.Колонки.Добавить("Организация", Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ТаблицаСделок.Колонки.Добавить("Контрагент", Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	ТаблицаСделок.Колонки.Добавить("ДоговорКонтрагента", Новый ОписаниеТипов("СправочникСсылка.ДоговорыКонтрагентов"));
	ТаблицаСделок.Колонки.Добавить("Комиссионер", Новый ОписаниеТипов("СправочникСсылка.Контрагенты"));
	ТаблицаСделок.Колонки.Добавить("РасчетныйДокумент", ОписаниеТиповРасчетныхДокументов);
	ТаблицаСделок.Колонки.Добавить("ПредметСделки", ОписаниеТиповПредметовСделки);
	ТаблицаСделок.Колонки.Добавить("ТипПредметаСделки", Новый ОписаниеТипов("ПеречислениеСсылка.ТипыПредметовКонтролируемыхСделок"));
	ТаблицаСделок.Колонки.Добавить("НаименованиеПредметаСделки", Новый ОписаниеТипов("Строка", , Новый КвалификаторыСтроки(512)));
	ТаблицаСделок.Колонки.Добавить("ЕдиницаИзмерения", Новый ОписаниеТипов("СправочникСсылка.КлассификаторЕдиницИзмерения"));
	ТаблицаСделок.Колонки.Добавить("СтранаПроисхожденияПредметаСделки", Новый ОписаниеТипов("СправочникСсылка.СтраныМира"));
	ТаблицаСделок.Колонки.Добавить("ХозяйственнаяОперация", Новый ОписаниеТипов("ПеречислениеСсылка.ХозяйственныеОперацииКонтролируемыхСделок"));
	ТаблицаСделок.Колонки.Добавить("Валюта", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	ТаблицаСделок.Колонки.Добавить("Количество", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,3)));
	ТаблицаСделок.Колонки.Добавить("СтавкаНДС", Новый ОписаниеТипов("ПеречислениеСсылка.СтавкиНДС"));
	ТаблицаСделок.Колонки.Добавить("ЦенаВРублях", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаСделок.Колонки.Добавить("СуммаБезНДСВРублях", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаСделок.Колонки.Добавить("СуммаНДСВРублях", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаСделок.Колонки.Добавить("СуммаБезНДСВВалютеРасчетов", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаСделок.Колонки.Добавить("СуммаНДСВВалютеРасчетов", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаСделок.Колонки.Добавить("ВсегоВВалютеРасчетов", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	ТаблицаСделок.Колонки.Добавить("ТипКонтролируемойСделки", Новый ОписаниеТипов("ПеречислениеСсылка.ТипыКонтролируемыхСделок"));
	ТаблицаСделок.Колонки.Добавить("ТоварМировойБиржевойТорговли", Новый ОписаниеТипов("Булево"));
	ТаблицаСделок.Колонки.Добавить("ОперацияОблагаетсяЕНВД", Новый ОписаниеТипов("Булево"));
	
	ТаблицаСделок.Колонки.Добавить("Грузоотправитель", ОписаниеГрузоотправителя);
	ТаблицаСделок.Колонки.Добавить("Грузополучатель", ОписаниеГрузополучателя);
	
	Возврат ТаблицаСделок;
	
КонецФункции

Процедура ЗаполнитьАдресаСделки(СведенияОСделке, Грузоотправитель, Грузополучатель, ПараметрыЗаполнения)
	
	Если ПараметрыЗаполнения.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
		ПараметрыАдресаГрузоотправителя = ПараметрыАдресаСделки(Грузоотправитель, СведенияОСделке.ДатаСовершенияСделки);
		Если ПараметрыАдресаГрузоотправителя <> Неопределено Тогда
			СведенияОСделке.СтранаОтправкиТовара = ПараметрыАдресаГрузоотправителя.Страна;
			СведенияОСделке.КодРегионаОтправкиТовара = ПараметрыАдресаГрузоотправителя.КодРегиона;
			Если ПараметрыЗаполнения.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
				СведенияОСделке.ГородОтправкиТовара = ПараметрыАдресаГрузоотправителя.Город;
				СведенияОСделке.НаселенныйПунктОтправкиТовара = ПараметрыАдресаГрузоотправителя.НаселенныйПункт;
			Иначе
				ЧастиНаселенногоПункта = Новый Массив;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузоотправителя.Город) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузоотправителя.Город);
				КонецЕсли;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузоотправителя.НаселенныйПункт) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузоотправителя.НаселенныйПункт);
				КонецЕсли;
				СведенияОСделке.НаселенныйПунктОтправкиТовара = СтрСоединить(ЧастиНаселенногоПункта, ", ");
			КонецЕсли;
		КонецЕсли;
		
		ПараметрыАдресаГрузополучателя = ПараметрыАдресаСделки(Грузополучатель, СведенияОСделке.ДатаСовершенияСделки);
		Если ПараметрыАдресаГрузополучателя <> Неопределено Тогда
			
			СведенияОСделке.СтранаСовершенияСделки = ПараметрыАдресаГрузополучателя.Страна;
			СведенияОСделке.КодРегионаСовершенияСделки = ПараметрыАдресаГрузополучателя.КодРегиона;
			Если ПараметрыЗаполнения.Версия < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
				СведенияОСделке.ГородСовершенияСделки = ПараметрыАдресаГрузополучателя.Город;
				СведенияОСделке.НаселенныйПунктСовершенияСделки = ПараметрыАдресаГрузополучателя.НаселенныйПункт;
			Иначе
				ЧастиНаселенногоПункта = Новый Массив;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузополучателя.Город) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузополучателя.Город);
				КонецЕсли;
				Если ЗначениеЗаполнено(ПараметрыАдресаГрузополучателя.НаселенныйПункт) Тогда
					ЧастиНаселенногоПункта.Добавить(ПараметрыАдресаГрузополучателя.НаселенныйПункт);
				КонецЕсли;
				СведенияОСделке.НаселенныйПунктСовершенияСделки = СтрСоединить(ЧастиНаселенногоПункта, ", ");
			КонецЕсли;
		КонецЕсли;
		
	Иначе
		
		ПараметрыАдресаГрузополучателя = ПараметрыАдресаСделки2024(Грузополучатель, ПараметрыЗаполнения.КешАдресныхДанных);
		Если ПараметрыАдресаГрузополучателя <> Неопределено Тогда
			СведенияОСделке.ОКТМОСовершенияСделки = ПараметрыАдресаГрузополучателя.ОКТМО;
			СведенияОСделке.НаселенныйПунктСовершенияСделки = ПараметрыАдресаГрузополучателя.НаселенныйПункт;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ВидАдресаКонтактнойИнформации(Объект)
	
	Если ТипЗнч(Объект) = Тип("СправочникСсылка.Организации") Тогда
		Возврат Справочники.ВидыКонтактнойИнформации.ФактАдресОрганизации;
	ИначеЕсли ТипЗнч(Объект) = Тип("СправочникСсылка.Контрагенты") Тогда
		Возврат Справочники.ВидыКонтактнойИнформации.ФактАдресКонтрагента;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПараметрыАдресаСделки(Объект, ДатаСовершенияСделки)
	
	Если НЕ ЗначениеЗаполнено(Объект) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ВидКонтактнойИнформации = ВидАдресаКонтактнойИнформации(Объект);
	Если ВидКонтактнойИнформации = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	СведенияОбАдресе = УправлениеКонтактнойИнформациейБП.АдресСтруктурой(Объект, ВидКонтактнойИнформации, ДатаСовершенияСделки);
	
	Если Не ЗначениеЗаполнено(СведенияОбАдресе)
		Или НЕ ЗначениеЗаполнено(СведенияОбАдресе.Страна) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	СтранаМира = Справочники.СтраныМира.НайтиПоНаименованию(СведенияОбАдресе.Страна);
	
	ДанныеАдреса = Новый Структура();
	ДанныеАдреса.Вставить("Страна", СтранаМира);
	ДанныеАдреса.Вставить("КодРегиона", "");
	ДанныеАдреса.Вставить("Город", "");
	ДанныеАдреса.Вставить("НаселенныйПункт", "");
	
	Если СтранаМира = Справочники.СтраныМира.Россия Тогда
		Если ЗначениеЗаполнено(СведенияОбАдресе.КодРегиона) Тогда
			ДанныеАдреса.КодРегиона = СведенияОбАдресе.КодРегиона;
		ИначеЕсли ЗначениеЗаполнено(СведенияОбАдресе.Регион) Тогда
			ДанныеАдреса.КодРегиона = РегламентированнаяОтчетностьВызовСервера.КодРегионаПоНазванию(СведенияОбАдресе.Регион);
		КонецЕсли;
		СведенияОбАдресе.Свойство("Город", ДанныеАдреса.Город);
		СведенияОбАдресе.Свойство("НаселенныйПункт", ДанныеАдреса.НаселенныйПункт);
	КонецЕсли;
	
	Возврат ДанныеАдреса;
	
КонецФункции

Функция ПараметрыАдресаСделки2024(Объект, КешАдресныхДанных)
	
	Если НЕ ЗначениеЗаполнено(Объект) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ДанныеАдресаИзКеша = КешАдресныхДанных.Получить(Объект);
	Если ЗначениеЗаполнено(ДанныеАдресаИзКеша) Тогда
		Возврат ДанныеАдресаИзКеша;
	КонецЕсли;
	
	ВидКонтактнойИнформации = ВидАдресаКонтактнойИнформации(Объект);
	Если ВидКонтактнойИнформации = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Т.к. мы определяем данные по фактическому адресу, то можно использовать интерфейс БСП, т.к. по нему история не ведется.
	// Поэтому запросим данные без учета истории.
	ТаблицаАдреса = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(Объект, ВидКонтактнойИнформации, , Ложь);
	
	Если Не ЗначениеЗаполнено(ТаблицаАдреса) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("КодыАдреса", Истина);
	АдресJSON = ТаблицаАдреса[0].Значение;
	
	СведенияОбАдресе = РаботаСАдресами.СведенияОбАдресе(АдресJSON, ДополнительныеПараметры);
	
	ДанныеАдреса = Новый Структура();
	ДанныеАдреса.Вставить("Страна", Справочники.СтраныМира.ПустаяСсылка());
	ДанныеАдреса.Вставить("ОКТМО", "");
	ДанныеАдреса.Вставить("НаселенныйПункт", "");
	
	Если ЗначениеЗаполнено(СведенияОбАдресе.Страна) Тогда
		СтранаМира = Справочники.СтраныМира.НайтиПоНаименованию(СведенияОбАдресе.Страна);
	КонецЕсли;
	
	ДанныеАдреса.Страна = СтранаМира;
	Если СтранаМира = Справочники.СтраныМира.Россия Тогда
		Если СведенияОбАдресе.ДополнительныеКоды.Свойство("ОКТМО")
			И ЗначениеЗаполнено(СведенияОбАдресе.ДополнительныеКоды.ОКТМО) Тогда
			ДанныеАдреса.ОКТМО = СведенияОбАдресе.ДополнительныеКоды.ОКТМО;
		Иначе
			// Получаем коды из классификатора.
			КодыАдреса = АдресныйКлассификатор.КодыАдреса(АдресJSON);
			ДанныеАдреса.ОКТМО = КодыАдреса.ОКТМО;
		КонецЕсли;
	КонецЕсли;
	
	ЧастиАдреса = Новый Массив;
	
	Если ЗначениеЗаполнено(ДанныеАдреса.Страна) Тогда
		
		РеквизитыСтраны = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(
			ДанныеАдреса.Страна, "Код,НаименованиеПолное,Наименование");
			
		// В соответствии с Письмом ФНС № ШЮ-4-13/4858@ от 19.05.2025
		// в поле "Населенный пункт" указывается полный адрес места совершения сделки,
		// включая код страны по классификатору ОКСМ.
		
		ОписаниеКодаСтраны = "";
		Если ЗначениеЗаполнено(РеквизитыСтраны.Код) Тогда
			ОписаниеКодаСтраны = СтрШаблон("(%1)", РеквизитыСтраны.Код);
		КонецЕсли;
		
		ОписаниеСтраны = СтрШаблон("%1 %2",
			?(ЗначениеЗаполнено(РеквизитыСтраны.НаименованиеПолное), РеквизитыСтраны.НаименованиеПолное, РеквизитыСтраны.Наименование),
			ОписаниеКодаСтраны);
		
		ЧастиАдреса.Добавить(ОписаниеСтраны);
		
	КонецЕсли;
	
	ПараметрыПредставленияАдреса = УправлениеКонтактнойИнформацией.НовыеПараметрыПредставленияАдреса();
	ПараметрыПредставленияАдреса.ВключатьЗданияИПомещения = Ложь;
	ПараметрыПредставленияАдреса.ВключатьПочтовыйИндекс = Ложь;
	ПараметрыПредставленияАдреса.ВключатьСтрану = Ложь;
	ПараметрыПредставленияАдреса.ТолькоНаселенныйПункт = Истина;
	ПараметрыПредставленияАдреса.ВключатьУлицу = Ложь;
	
	ЧастиАдреса.Добавить(УправлениеКонтактнойИнформацией.ПредставлениеАдреса(
		АдресJSON, ПараметрыПредставленияАдреса));
	
	Если ЗначениеЗаполнено(ЧастиАдреса) Тогда
		
		ДанныеАдреса.НаселенныйПункт = СтрСоединить(ЧастиАдреса, ", ");
		
	КонецЕсли;
	
	КешАдресныхДанных.Вставить(Объект, ДанныеАдреса);
	
	Возврат ДанныеАдреса;
	
КонецФункции

Процедура ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемаяСделка, ТаблицаДокумента)
	
	СтруктураПоиска = Новый Структура("РасчетныйДокумент",КонтролируемаяСделка.РасчетныйДокумент);
	Если ТаблицаДокумента.Колонки.Найти("Контрагент") <> Неопределено Тогда
		СтруктураПоиска.Вставить("Контрагент", КонтролируемаяСделка.Контрагент);
	КонецЕсли;
	
	ДатаОтказаОтЕНВД = КонтролируемыеСделки.ДатаОтказаОтЕНВД();
	
	НайденныеСтроки = ТаблицаДокумента.НайтиСтроки(СтруктураПоиска);
	Если НайденныеСтроки.Количество() > 0 Тогда
	
		ТаблицаСделокДокумента = ПолучитьТаблицуСделок();
		ТаблицаСделокДокумента.Колонки.Добавить("ВключатьСоставСделок", Новый ОписаниеТипов("Булево"));
		
		Для Каждого ВыборкаСтрок Из НайденныеСтроки Цикл
			Сделка = ТаблицаСделокДокумента.Добавить();
			Сделка.Период                     = КонтролируемаяСделка.Период;
			Сделка.Организация                = КонтролируемаяСделка.Организация;
			Сделка.Контрагент                 = КонтролируемаяСделка.Контрагент;
			Сделка.Комиссионер                = КонтролируемаяСделка.Комиссионер;
			Сделка.ДоговорКонтрагента         = КонтролируемаяСделка.ДоговорКонтрагента;
			Сделка.РасчетныйДокумент          = КонтролируемаяСделка.РасчетныйДокумент;
			Сделка.ПредметСделки              = ВыборкаСтрок.ПредметСделки;
			Сделка.ТипПредметаСделки          = ВыборкаСтрок.ТипПредметаСделки;
			Сделка.НаименованиеПредметаСделки = ВыборкаСтрок.НаименованиеПредметаСделки;
			Сделка.СтранаПроисхожденияПредметаСделки = ВыборкаСтрок.СтранаПроисхождения;
			Сделка.ВключатьСоставСделок       = ВыборкаСтрок.ВключатьСоставСделок;
			Сделка.ХозяйственнаяОперация      = ВыборкаСтрок.ХозяйственнаяОперация;
			Сделка.Валюта                 = КонтролируемаяСделка.ВалютаДокумента;
			Сделка.ЕдиницаИзмерения           = ВыборкаСтрок.ЕдиницаИзмеренияПоКлассификатору;
			Сделка.Количество                 = ВыборкаСтрок.Количество;
			Сделка.СтавкаНДС                  = ВыборкаСтрок.СтавкаНДС;
			Сделка.СуммаБезНДСВВалютеРасчетов = ВыборкаСтрок.СуммаБезНДС;
			Сделка.СуммаНДСВВалютеРасчетов = ВыборкаСтрок.СуммаНДС;
			Сделка.СуммаБезНДСВРублях         = ?(КонтролируемаяСделка.РасчетыВВалюте, ВыборкаСтрок.СуммаБезНДСВРублях, ВыборкаСтрок.СуммаБезНДС);
			Сделка.СуммаНДСВРублях            = ?(КонтролируемаяСделка.РасчетыВВалюте, ВыборкаСтрок.СуммаНДСВРублях, ВыборкаСтрок.СуммаНДС);
			
			Сделка.ТипКонтролируемойСделки    = ВыборкаСтрок.ТипКонтролируемойСделки;
			Сделка.ТоварМировойБиржевойТорговли = ВыборкаСтрок.ТоварМировойБиржевойТорговли;
			Если Сделка.Период < ДатаОтказаОтЕНВД Тогда
				Сделка.ОперацияОблагаетсяЕНВД     = ВыборкаСтрок.ОперацияОблагаетсяЕНВД;
			КонецЕсли;
			
			Если ВыборкаСтрок.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
				Сделка.Грузоотправитель           = КонтролируемаяСделка.Грузоотправитель;
			КонецЕсли;
			Сделка.Грузополучатель            = КонтролируемаяСделка.Грузополучатель;
		КонецЦикла;
		
		Для Каждого СделкаДокумента Из ТаблицаСделокДокумента Цикл
			Если (СделкаДокумента.ТоварМировойБиржевойТорговли И КонтролируемаяСделка.ИностранныйКонтрагент)
					ИЛИ КонтролируемаяСделка.ВзаимозависимыеЛица
					ИЛИ КонтролируемаяСделка.ЗарегистрированВСтранеСЛьготнымНалогообложением Тогда
					Если СделкаДокумента.ВключатьСоставСделок
						И (СделкаДокумента.СуммаБезНДСВРублях <> 0
							ИЛИ СделкаДокумента.СуммаНДСВРублях <> 0
							ИЛИ СделкаДокумента.Количество <> 0) Тогда
					Сделка = ТаблицаСделок.Добавить();
					ЗаполнитьЗначенияСвойств(Сделка, СделкаДокумента);
					Сделка.ЦенаВРублях = Сделка.СуммаБезНДСВРублях / ?(Сделка.Количество = 0, 1, Сделка.Количество);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента)
	
	СделкиДокумента.Колонки.Добавить("СуммаБезНДСВРублях", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	СделкиДокумента.Колонки.Добавить("СуммаНДСВРублях", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15,2)));
	
	Для Каждого ДокументСделки Из РублевыеСуммыСделок Цикл
		
		ВсегоВРублях = ДокументСделки.ВсегоВРублях;
		СуммаНДСВРублях =ДокументСделки.СуммаНДСВРублях;
		
		СтрокиДокумента = СделкиДокумента.НайтиСтроки(Новый Структура("Сделка",ДокументСделки.Сделка));
		Если СтрокиДокумента.Количество() > 0 Тогда
			
			СуммыВсегоВВалюте = Новый Массив(СтрокиДокумента.Количество());
			СуммыНДСВВалюте   = Новый Массив(СтрокиДокумента.Количество());
			Для К=0 По СтрокиДокумента.Количество()-1 Цикл
				СуммыВсегоВВалюте[К] = СтрокиДокумента[К].СуммаБезНДС + СтрокиДокумента[К].СуммаНДС;
				СуммыНДСВВалюте[К] = ?(СтрокиДокумента[К].УчитыватьНДСПриРаспределении, СтрокиДокумента[К].СуммаНДС, 0);
			КонецЦикла;
			
			//Подсчитаем рублевые суммы документа
			РаспределениеСуммВсего = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(ВсегоВРублях, СуммыВсегоВВалюте);
			РаспределениеСуммНДС   = ОбщегоНазначенияБПКлиентСервер.РаспределитьПропорционально(СуммаНДСВРублях, СуммыНДСВВалюте);
			
			Если РаспределениеСуммВсего <> Неопределено Тогда
				Для К=0 По СтрокиДокумента.Количество()-1 Цикл
					СуммаНДС = ?(РаспределениеСуммНДС = Неопределено,0, РаспределениеСуммНДС[К]);
					СтрокиДокумента[К].СуммаБезНДСВРублях = РаспределениеСуммВсего[К] - СуммаНДС;
					СтрокиДокумента[К].СуммаНДСВРублях = СуммаНДС;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция СтатьиКурсовыхРазниц()
	
	СтатьиКурсовыхРазниц = Новый Массив;
	
	СтатьяКурсоваяРазница = ОбщегоНазначения.ПредопределенныйЭлемент(
		"Справочник.ПрочиеДоходыИРасходы.КурсовыеРазницы");
	Если ЗначениеЗаполнено(СтатьяКурсоваяРазница) Тогда
		СтатьиКурсовыхРазниц.Добавить(СтатьяКурсоваяРазница);
	КонецЕсли;
	
	СтатьяКурсоваяРазницаУЕ = ОбщегоНазначения.ПредопределенныйЭлемент(
		"Справочник.ПрочиеДоходыИРасходы.КурсовыеРазницыПоРасчетамВУЕ");
	Если ЗначениеЗаполнено(СтатьяКурсоваяРазницаУЕ) Тогда
		СтатьиКурсовыхРазниц.Добавить(СтатьяКурсоваяРазницаУЕ);
	КонецЕсли;
	
	Возврат СтатьиКурсовыхРазниц;
	
КонецФункции

Процедура ДобавитьСделкиРеализацииТоваровУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Организация КАК Организация,
	|	РеализацияТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	РеализацияТоваровУслуг.Дата КАК Период,
	|	РеализацияТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Контрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Организация
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	РеализацияТоваровУслуг.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	РеализацияТоваровУслуг.ВалютаДокумента,
	|	РеализацияТоваровУслуг.СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕстьNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|			И РеализацияТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И РеализацияТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|ГДЕ
	|	РеализацияТоваровУслуг.Организация В(&СтруктураОрганизации)
	|	И РеализацияТоваровУслуг.Дата >= &НачалоПериода
	|	И РеализацияТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И РеализацияТоваровУслуг.Проведен = ИСТИНА
	|	И РеализацияТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И РеализацияТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ОтгрузкаБезПереходаПраваСобственности)
	|	И РеализацияТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПокупателем)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияТоваровУслугТовары.Ссылка КАК Сделка,
	|	РеализацияТоваровУслугТовары.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	РеализацияТоваровУслугТовары.Номенклатура КАК ПредметСделки,
	|	РеализацияТоваровУслугТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК УчитыватьНДСПриРаспределении,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СчетУчета.Забалансовый
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	РеализацияТоваровУслугТовары.Количество КАК Количество,
	|	РеализацияТоваровУслугТовары.Количество КАК КоличествоВУчете,
	|	РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	РеализацияТоваровУслугТовары.СтавкаНДС КАК СтавкаНДС,
	|	РеализацияТоваровУслугТовары.СуммаНДС КАК СуммаНДС,
	|	РеализацияТоваровУслугТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО РеализацияТоваровУслугТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО РеализацияТоваровУслугТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО РеализацияТоваровУслугТовары.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РеализацияТоваровУслугУслуги.Ссылка,
	|	РеализацияТоваровУслугУслуги.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	РеализацияТоваровУслугУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ РеализацияТоваровУслугУслуги.Содержание ПОДОБНО """"
	|			ТОГДА РеализацияТоваровУслугУслуги.Содержание
	|		ИНАЧЕ РеализацияТоваровУслугУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг),
	|	РеализацияТоваровУслугУслуги.Количество,
	|	РеализацияТоваровУслугУслуги.Количество,
	|	РеализацияТоваровУслугУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА РеализацияТоваровУслугУслуги.Сумма - РеализацияТоваровУслугУслуги.СуммаНДС
	|		ИНАЧЕ РеализацияТоваровУслугУслуги.Сумма
	|	КОНЕЦ,
	|	РеализацияТоваровУслугУслуги.СтавкаНДС,
	|	РеализацияТоваровУслугУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Услуги КАК РеализацияТоваровУслугУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО РеализацияТоваровУслугУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО РеализацияТоваровУслугУслуги.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	РеализацияТоваровУслугУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	РеализацияТоваровУслугАгентскиеУслуги.Ссылка,
	|	РеализацияТоваровУслугАгентскиеУслуги.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	РеализацияТоваровУслугАгентскиеУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ РеализацияТоваровУслугАгентскиеУслуги.Содержание ПОДОБНО """"
	|			ТОГДА РеализацияТоваровУслугАгентскиеУслуги.Содержание
	|		ИНАЧЕ РеализацияТоваровУслугАгентскиеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхУслуг),
	|	РеализацияТоваровУслугАгентскиеУслуги.Количество,
	|	РеализацияТоваровУслугАгентскиеУслуги.Количество,
	|	РеализацияТоваровУслугАгентскиеУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА РеализацияТоваровУслугАгентскиеУслуги.Сумма - РеализацияТоваровУслугАгентскиеУслуги.СуммаНДС
	|		ИНАЧЕ РеализацияТоваровУслугАгентскиеУслуги.Сумма
	|	КОНЕЦ,
	|	РеализацияТоваровУслугАгентскиеУслуги.СтавкаНДС,
	|	РеализацияТоваровУслугАгентскиеУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.АгентскиеУслуги КАК РеализацияТоваровУслугАгентскиеУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО РеализацияТоваровУслугАгентскиеУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	РеализацияТоваровУслугАгентскиеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)";
	
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиРеализацииОтгруженныхТоваров(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок);
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РеализацияОтгруженныхТоваров.Организация КАК Организация,
	|	РеализацияОтгруженныхТоваров.Дата КАК Период,
	|	РеализацияОтгруженныхТоваров.Ссылка КАК РасчетныйДокумент,
	|	РеализацияТоваровУслуг.Ссылка КАК ДокументОтгрузки,
	|	РеализацияОтгруженныхТоваров.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Контрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Организация
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	РеализацияОтгруженныхТоваров.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	РеализацияОтгруженныхТоваров.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	РеализацияТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	РеализацияТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	РеализацияОтгруженныхТоваров.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	РеализацияОтгруженныхТоваров.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияОтгруженныхТоваров КАК РеализацияОтгруженныхТоваров
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ПО РеализацияОтгруженныхТоваров.ДокументОтгрузки = РеализацияТоваровУслуг.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияОтгруженныхТоваров.Контрагент)
	|			И РеализацияОтгруженныхТоваров.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И РеализацияОтгруженныхТоваров.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияОтгруженныхТоваров.Контрагент)
	|ГДЕ
	|	РеализацияОтгруженныхТоваров.Организация В(&СтруктураОрганизации)
	|	И РеализацияОтгруженныхТоваров.Дата >= &НачалоПериода
	|	И РеализацияОтгруженныхТоваров.Дата <= &ОкончаниеПериода
	|	И РеализацияОтгруженныхТоваров.Проведен = ИСТИНА
	|	И РеализацияОтгруженныхТоваров.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументОтгрузки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделок.ДокументОтгрузки = НДСЗаписиКнигиПродаж.Регистратор
	|	ГДЕ
	|		ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК Сделка,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	РеализацияТоваровУслугТовары.Номенклатура КАК ПредметСделки,
	|	РеализацияТоваровУслугТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК УчитыватьНДСПриРаспределении,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслугТовары.СчетУчета.Забалансовый
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияКомиссионныхТоваров)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров)
	|	КОНЕЦ КАК ХозяйственнаяОперация,
	|	РеализацияТоваровУслугТовары.Количество КАК Количество,
	|	РеализацияТоваровУслугТовары.Количество КАК КоличествоВУчете,
	|	РеализацияТоваровУслугТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаНДС
	|		ИНАЧЕ РеализацияТоваровУслугТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	РеализацияТоваровУслугТовары.СтавкаНДС,
	|	РеализацияТоваровУслугТовары.СуммаНДС,
	|	РеализацияТоваровУслугТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL 
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО РеализацияТоваровУслугТовары.Ссылка = ДокументыКонтролируемыхСделок.ДокументОтгрузки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО РеализацияТоваровУслугТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО РеализацияТоваровУслугТовары.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	РеализацияТоваровУслугТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.ДокументОтгрузки
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиПоступленияТоваровУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("ЕдиницаИзмеренияШтука", РегистрыСведений.НастройкиФормированияКонтролируемыхСделок.ПолучитьЕдиницуИзмеренияШтука());
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПоступлениеТоваровУслуг.Организация КАК Организация,
	|	ПоступлениеТоваровУслуг.Дата КАК Период,
	|	ПоступлениеТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Организация
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Контрагент
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеТоваровУслуг.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПоступлениеТоваровУслуг.ВалютаДокумента,
	|	ПоступлениеТоваровУслуг.СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕстьNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.УчетАгентскогоНДС КАК УчетАгентскогоНДС
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|			И ПоступлениеТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|ГДЕ
	|	ПоступлениеТоваровУслуг.Организация В(&СтруктураОрганизации)
	|	И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПоступлениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
	|	И ПоступлениеТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|	И ПоступлениеТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоступлениеТоваровУслуг.ВПереработку)
	|	И ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.УчетАгентскогоНДС КАК УчетАгентскогоНДС,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетДт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.НДС,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделокВВалюте.УчетАгентскогоНДС
	|				ТОГДА НДСПредъявленный.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугТовары.Ссылка КАК Сделка,
	|	ПоступлениеТоваровУслугТовары.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ПоступлениеТоваровУслугТовары.Номенклатура КАК ПредметСделки,
	|	ПоступлениеТоваровУслугТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров) КАК ХозяйственнаяОперация,
	|	ПоступлениеТоваровУслугТовары.Количество КАК Количество,
	|	ПоступлениеТоваровУслугТовары.Количество КАК КоличествоВУчете,
	|	ПоступлениеТоваровУслугТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугТовары.Сумма - ПоступлениеТоваровУслугТовары.СуммаНДС
	|		ИНАЧЕ ПоступлениеТоваровУслугТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ПоступлениеТоваровУслугТовары.СтавкаНДС КАК СтавкаНДС,
	|	ПоступлениеТоваровУслугТовары.СуммаНДС КАК СуммаНДС,
	|	ПоступлениеТоваровУслугТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеТоваровУслугТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ПоступлениеТоваровУслугТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|ГДЕ
	|	ПоступлениеТоваровУслугТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугУслуги.Ссылка,
	|	ПоступлениеТоваровУслугУслуги.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	ПоступлениеТоваровУслугУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ ПоступлениеТоваровУслугУслуги.Содержание ПОДОБНО """"
	|			ТОГДА ПоступлениеТоваровУслугУслуги.Содержание
	|		ИНАЧЕ ПоступлениеТоваровУслугУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг),
	|	ПоступлениеТоваровУслугУслуги.Количество,
	|	ПоступлениеТоваровУслугУслуги.Количество,
	|	ПоступлениеТоваровУслугУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугУслуги.Сумма - ПоступлениеТоваровУслугУслуги.СуммаНДС
	|		ИНАЧЕ ПоступлениеТоваровУслугУслуги.Сумма
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугУслуги.СтавкаНДС,
	|	ПоступлениеТоваровУслугУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Услуги КАК ПоступлениеТоваровУслугУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеТоваровУслугУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПоступлениеТоваровУслугУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугОборудование.Ссылка,
	|	ПоступлениеТоваровУслугОборудование.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	ПоступлениеТоваровУслугОборудование.Номенклатура,
	|	ПоступлениеТоваровУслугОборудование.Номенклатура.НаименованиеПолное,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеТоваров),
	|	ПоступлениеТоваровУслугОборудование.Количество,
	|	ПоступлениеТоваровУслугОборудование.Количество,
	|	ПоступлениеТоваровУслугОборудование.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугОборудование.Сумма - ПоступлениеТоваровУслугОборудование.СуммаНДС
	|		ИНАЧЕ ПоступлениеТоваровУслугОборудование.Сумма
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугОборудование.СтавкаНДС,
	|	ПоступлениеТоваровУслугОборудование.СуммаНДС,
	|	ПоступлениеТоваровУслугОборудование.СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.Оборудование КАК ПоступлениеТоваровУслугОборудование
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеТоваровУслугОборудование.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ПоступлениеТоваровУслугОборудование.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|ГДЕ
	|	ПоступлениеТоваровУслугОборудование.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугОбъектыСтроительства.Ссылка,
	|	ПоступлениеТоваровУслугОбъектыСтроительства.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	ПоступлениеТоваровУслугОбъектыСтроительства.ОбъектСтроительства,
	|	ПоступлениеТоваровУслугОбъектыСтроительства.ОбъектСтроительства.Наименование,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеОбъектовСтроительства),
	|	1,
	|	1,
	|	&ЕдиницаИзмеренияШтука,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугОбъектыСтроительства.Сумма - ПоступлениеТоваровУслугОбъектыСтроительства.СуммаНДС
	|		ИНАЧЕ ПоступлениеТоваровУслугОбъектыСтроительства.Сумма
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугОбъектыСтроительства.СтавкаНДС,
	|	ПоступлениеТоваровУслугОбъектыСтроительства.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.ОбъектыСтроительства КАК ПоступлениеТоваровУслугОбъектыСтроительства
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеТоваровУслугОбъектыСтроительства.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПоступлениеТоваровУслугОбъектыСтроительства.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка,
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ ПоступлениеТоваровУслугАгентскиеУслуги.Содержание ПОДОБНО """"
	|			ТОГДА ПоступлениеТоваровУслугАгентскиеУслуги.Содержание
	|		ИНАЧЕ ПоступлениеТоваровУслугАгентскиеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеАгентскихУслуг),
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Количество,
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Количество,
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугАгентскиеУслуги.Сумма - ПоступлениеТоваровУслугАгентскиеУслуги.СуммаНДС
	|		ИНАЧЕ ПоступлениеТоваровУслугАгентскиеУслуги.Сумма
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугАгентскиеУслуги.СтавкаНДС,
	|	ПоступлениеТоваровУслугАгентскиеУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.АгентскиеУслуги КАК ПоступлениеТоваровУслугАгентскиеУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПоступлениеТоваровУслугАгентскиеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслугОсновныеСредства.Ссылка,
	|	ПоступлениеТоваровУслугОсновныеСредства.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	ПоступлениеТоваровУслугОсновныеСредства.ОсновноеСредство,
	|	ПоступлениеТоваровУслугОсновныеСредства.ОсновноеСредство.НаименованиеПолное,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеОсновныхСредств),
	|	1,
	|	1,
	|	&ЕдиницаИзмеренияШтука,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеТоваровУслугОсновныеСредства.Сумма - ПоступлениеТоваровУслугОсновныеСредства.СуммаНДС
	|		ИНАЧЕ ПоступлениеТоваровУслугОсновныеСредства.Сумма
	|	КОНЕЦ,
	|	ПоступлениеТоваровУслугОсновныеСредства.СтавкаНДС,
	|	ПоступлениеТоваровУслугОсновныеСредства.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг.ОсновныеСредства КАК ПоступлениеТоваровУслугОсновныеСредства
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеТоваровУслугОсновныеСредства.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПоступлениеТоваровУслугОсновныеСредства.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиПоступленияДопРасходов(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("ЕдиницаИзмеренияШтука", РегистрыСведений.НастройкиФормированияКонтролируемыхСделок.ПолучитьЕдиницуИзмеренияШтука());
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПоступлениеДопРасходов.Организация КАК Организация,
	|	ПоступлениеДопРасходов.Дата КАК Период,
	|	ПоступлениеДопРасходов.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеДопРасходов.Контрагент КАК Контрагент,
	|	ПоступлениеДопРасходов.Организация КАК Грузополучатель,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ПоступлениеДопРасходов.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеДопРасходов.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПоступлениеДопРасходов.ВалютаДокумента КАК ВалютаДокумента,
	|	ПоступлениеДопРасходов.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ПоступлениеДопРасходов.Содержание КАК Содержание,
	|	ПоступлениеДопРасходов.СтавкаНДС КАК СтавкаНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеДопРасходов.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ПоступлениеДопРасходов.ДоговорКонтрагента.УчетАгентскогоНДС КАК УчетАгентскогоНДС
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеДопРасходов КАК ПоступлениеДопРасходов
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеДопРасходов.Контрагент)
	|			И ПоступлениеДопРасходов.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеДопРасходов.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеДопРасходов.Контрагент)
	|ГДЕ
	|	ПоступлениеДопРасходов.Организация В(&СтруктураОрганизации)
	|	И ПоступлениеДопРасходов.Дата >= &НачалоПериода
	|	И ПоступлениеДопРасходов.Дата <= &ОкончаниеПериода
	|	И ПоступлениеДопРасходов.Проведен = ИСТИНА
	|	И ПоступлениеДопРасходов.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.УчетАгентскогоНДС КАК УчетАгентскогоНДС,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетДт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.НДС,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделокВВалюте.УчетАгентскогоНДС
	|				ТОГДА НДСПредъявленный.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеДополнительныхУслуг.РасчетныйДокумент КАК Сделка,
	|	ПоступлениеДополнительныхУслуг.РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ПоступлениеДополнительныхУслуг.Номенклатура КАК ПредметСделки,
	|	ВЫБОР
	|		КОГДА НЕ ПоступлениеДополнительныхУслуг.Содержание ПОДОБНО """"
	|			ТОГДА ПоступлениеДополнительныхУслуг.Содержание
	|		ИНАЧЕ ПоступлениеДополнительныхУслуг.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	СУММА(ПоступлениеДополнительныхУслуг.Количество) КАК Количество,
	|	СУММА(ПоступлениеДополнительныхУслуг.Количество) КАК КоличествоВУчете,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмеренияПоКлассификатору,
	|	СУММА(ПоступлениеДополнительныхУслуг.СуммаБезНДС) КАК СуммаБезНДС,
	|	ПоступлениеДополнительныхУслуг.СтавкаНДС,
	|	СУММА(ПоступлениеДополнительныхУслуг.СуммаНДС) КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	(ВЫБРАТЬ
	|		ПоступлениеДопРасходов.Ссылка КАК РасчетныйДокумент,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|		ПоступлениеДопРасходов.Содержание КАК Содержание,
	|		1 КАК Количество,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|				ТОГДА ПоступлениеДопРасходов.Сумма - ПоступлениеДопРасходов.СуммаНДС
	|			ИНАЧЕ ПоступлениеДопРасходов.Сумма
	|		КОНЕЦ КАК СуммаБезНДС,
	|		ПоступлениеДопРасходов.СтавкаНДС КАК СтавкаНДС,
	|		ПоступлениеДопРасходов.СуммаНДС КАК СуммаНДС
	|	ИЗ
	|		Документ.ПоступлениеДопРасходов КАК ПоступлениеДопРасходов
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|			ПО ПоступлениеДопРасходов.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|	ГДЕ
	|		ПоступлениеДопРасходов.Ссылка В
	|				(ВЫБРАТЬ
	|					ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|				ИЗ
	|					ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ПоступлениеДопРасходовТовары.Ссылка,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
	|		ДокументыКонтролируемыхСделок.Содержание,
	|		0,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|				ТОГДА ПоступлениеДопРасходовТовары.Сумма - ПоступлениеДопРасходовТовары.СуммаНДС
	|			ИНАЧЕ ПоступлениеДопРасходовТовары.Сумма
	|		КОНЕЦ,
	|		ДокументыКонтролируемыхСделок.СтавкаНДС,
	|		ПоступлениеДопРасходовТовары.СуммаНДС
	|	ИЗ
	|		Документ.ПоступлениеДопРасходов.Товары КАК ПоступлениеДопРасходовТовары
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|			ПО ПоступлениеДопРасходовТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|	ГДЕ
	|		ПоступлениеДопРасходовТовары.Ссылка В
	|				(ВЫБРАТЬ
	|					ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|				ИЗ
	|					ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)) КАК ПоступлениеДополнительныхУслуг
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоступлениеДополнительныхУслуг.РасчетныйДокумент,
	|	ПоступлениеДополнительныхУслуг.Номенклатура,
	|	ПоступлениеДополнительныхУслуг.Содержание,
	|	ПоступлениеДополнительныхУслуг.СтавкаНДС,
	|	ПоступлениеДополнительныхУслуг.РасчетныйДокумент,
	|	ВЫБОР
	|		КОГДА НЕ ПоступлениеДополнительныхУслуг.Содержание ПОДОБНО """"
	|			ТОГДА ПоступлениеДополнительныхУслуг.Содержание
	|		ИНАЧЕ ПоступлениеДополнительныхУслуг.Номенклатура.НаименованиеПолное
	|	КОНЕЦ
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПоступлениеДополнительныхУслуг.РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиРеализацииУслугПоПереработке(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	РеализацияУслугПоПереработке.Организация КАК Организация,
	|	РеализацияУслугПоПереработке.Дата КАК Период,
	|	РеализацияУслугПоПереработке.Ссылка КАК РасчетныйДокумент,
	|	РеализацияУслугПоПереработке.Контрагент КАК Контрагент,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	РеализацияУслугПоПереработке.Контрагент КАК Грузополучатель,
	|	РеализацияУслугПоПереработке.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	РеализацияУслугПоПереработке.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	РеализацияУслугПоПереработке.ВалютаДокумента КАК ВалютаДокумента,
	|	РеализацияУслугПоПереработке.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	РеализацияУслугПоПереработке.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияУслугПоПереработке КАК РеализацияУслугПоПереработке
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияУслугПоПереработке.Контрагент)
	|			И РеализацияУслугПоПереработке.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И РеализацияУслугПоПереработке.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияУслугПоПереработке.Контрагент)
	|ГДЕ
	|	РеализацияУслугПоПереработке.Организация В(&СтруктураОрганизации)
	|	И РеализацияУслугПоПереработке.Дата >= &НачалоПериода
	|	И РеализацияУслугПоПереработке.Дата <= &ОкончаниеПериода
	|	И РеализацияУслугПоПереработке.Проведен = ИСТИНА
	|	И РеализацияУслугПоПереработке.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияУслугПоПереработкеУслуги.Ссылка КАК Сделка,
	|	РеализацияУслугПоПереработкеУслуги.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	РеализацияУслугПоПереработкеУслуги.Номенклатура КАК ПредметСделки,
	|	ВЫБОР
	|		КОГДА НЕ РеализацияУслугПоПереработкеУслуги.Содержание ПОДОБНО """"
	|			ТОГДА РеализацияУслугПоПереработкеУслуги.Содержание
	|		ИНАЧЕ РеализацияУслугПоПереработкеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	РеализацияУслугПоПереработкеУслуги.Количество,
	|	РеализацияУслугПоПереработкеУслуги.Количество КАК КоличествоВУчете,
	|	РеализацияУслугПоПереработкеУслуги.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА РеализацияУслугПоПереработкеУслуги.Сумма - РеализацияУслугПоПереработкеУслуги.СуммаНДС
	|		ИНАЧЕ РеализацияУслугПоПереработкеУслуги.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	РеализацияУслугПоПереработкеУслуги.СтавкаНДС,
	|	РеализацияУслугПоПереработкеУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияУслугПоПереработке.Услуги КАК РеализацияУслугПоПереработкеУслуги
	|		ПО ДокументыКонтролируемыхСделок.РасчетныйДокумент = РеализацияУслугПоПереработкеУслуги.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО (РеализацияУслугПоПереработкеУслуги.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет)
	|ГДЕ
	|	РеализацияУслугПоПереработкеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиАктаОбОказанииУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Акт.Организация КАК Организация,
	|	Акт.Дата КАК Период,
	|	Акт.Ссылка КАК РасчетныйДокумент,
	|	Акт.Контрагент КАК Контрагент,
	|	Акт.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	Акт.Организация КАК Грузоотправитель,
	|	Акт.Контрагент КАК Грузополучатель,
	|	Акт.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	Акт.ВалютаДокумента КАК ВалютаДокумента,
	|	Акт.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	Акт.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.АктОбОказанииПроизводственныхУслуг КАК Акт
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = Акт.Контрагент)
	|			И Акт.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И Акт.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = Акт.Контрагент)
	|ГДЕ
	|	Акт.Организация В(&СтруктураОрганизации)
	|	И Акт.Дата >= &НачалоПериода
	|	И Акт.Дата <= &ОкончаниеПериода
	|	И Акт.Проведен = ИСТИНА
	|	И Акт.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	АктОбОказанииПроизводственныхУслугУслуги.Ссылка КАК Сделка,
	|	АктОбОказанииПроизводственныхУслугУслуги.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура КАК ПредметСделки,
	|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	АктОбОказанииПроизводственныхУслугУслуги.Количество,
	|	АктОбОказанииПроизводственныхУслугУслуги.Количество КАК КоличествоВУчете,
	|	АктОбОказанииПроизводственныхУслугУслуги.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА АктОбОказанииПроизводственныхУслугУслуги.Сумма - АктОбОказанииПроизводственныхУслугУслуги.СуммаНДС
	|		ИНАЧЕ АктОбОказанииПроизводственныхУслугУслуги.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	АктОбОказанииПроизводственныхУслугУслуги.СтавкаНДС,
	|	АктОбОказанииПроизводственныхУслугУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.АктОбОказанииПроизводственныхУслуг.Услуги КАК АктОбОказанииПроизводственныхУслугУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО АктОбОказанииПроизводственныхУслугУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО АктОбОказанииПроизводственныхУслугУслуги.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	АктОбОказанииПроизводственныхУслугУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиПоступленияНМА(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("ЕдиницаИзмеренияШтука", РегистрыСведений.НастройкиФормированияКонтролируемыхСделок.ПолучитьЕдиницуИзмеренияШтука());
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПоступлениеНМА.Организация КАК Организация,
	|	ПоступлениеНМА.Дата КАК Период,
	|	ПоступлениеНМА.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеНМА.Контрагент КАК Контрагент,
	|	ПоступлениеНМА.Организация КАК Грузополучатель,
	|	ПоступлениеНМА.Контрагент КАК Грузоотправитель,
	|	ПоступлениеНМА.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПоступлениеНМА.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеНМА.ВалютаДокумента КАК ВалютаДокумента,
	|	ПоступлениеНМА.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеНМА.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	ПоступлениеНМА.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ПоступлениеНМА.ДоговорКонтрагента.УчетАгентскогоНДС КАК УчетАгентскогоНДС
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеНМА КАК ПоступлениеНМА
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеНМА.Контрагент)
	|			И ПоступлениеНМА.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеНМА.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеНМА.Контрагент)
	|ГДЕ
	|	ПоступлениеНМА.Организация В(&СтруктураОрганизации)
	|	И ПоступлениеНМА.Дата >= &НачалоПериода
	|	И ПоступлениеНМА.Дата <= &ОкончаниеПериода
	|	И ПоступлениеНМА.Проведен = ИСТИНА
	|	И ПоступлениеНМА.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|	И ПоступлениеНМА.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.УчетАгентскогоНДС КАК УчетАгентскогоНДС,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетДт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.НДС,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделокВВалюте.УчетАгентскогоНДС
	|				ТОГДА НДСПредъявленный.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеНМАНематериальныеАктивы.Ссылка КАК Сделка,
	|	ПоступлениеНМАНематериальныеАктивы.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ПоступлениеНМАНематериальныеАктивы.НематериальныйАктив КАК ПредметСделки,
	|	ПоступлениеНМАНематериальныеАктивы.НематериальныйАктив.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПриобретениеНематериальныхАктивов) КАК ХозяйственнаяОперация,
	|	1 КАК Количество,
	|	1 КАК КоличествоВУчете,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеНМАНематериальныеАктивы.Сумма - ПоступлениеНМАНематериальныеАктивы.СуммаНДС
	|		ИНАЧЕ ПоступлениеНМАНематериальныеАктивы.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ПоступлениеНМАНематериальныеАктивы.СтавкаНДС,
	|	ПоступлениеНМАНематериальныеАктивы.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ПоступлениеНМА.НематериальныеАктивы КАК ПоступлениеНМАНематериальныеАктивы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеНМАНематериальныеАктивы.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПоступлениеНМАНематериальныеАктивы.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиПередачиОС(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПередачаОС.Организация КАК Организация,
	|	ПередачаОС.Дата КАК Период,
	|	ПередачаОС.Ссылка КАК РасчетныйДокумент,
	|	ПередачаОС.Контрагент КАК Контрагент,
	|	ПередачаОС.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ВЫБОР
	|		КОГДА ПередачаОС.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПередачаОС.Организация
	|		ИНАЧЕ ПередачаОС.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ВЫБОР
	|		КОГДА ПередачаОС.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПередачаОС.Контрагент
	|		ИНАЧЕ ПередачаОС.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ПередачаОС.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПередачаОС.ВалютаДокумента КАК ВалютаДокумента,
	|	ПередачаОС.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПередачаОС.КурсВзаиморасчетов КАК КурсВзаиморасчетов,
	|	ПередачаОС.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПередачаОС КАК ПередачаОС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПередачаОС.Контрагент)
	|			И ПередачаОС.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПередачаОС.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПередачаОС.Контрагент)
	|ГДЕ
	|	ПередачаОС.Организация В(&СтруктураОрганизации)
	|	И ПередачаОС.Дата >= &НачалоПериода
	|	И ПередачаОС.Дата <= &ОкончаниеПериода
	|	И ПередачаОС.Проведен = ИСТИНА
	|	И ПередачаОС.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПередачаОСОС.Ссылка КАК Сделка,
	|	ПередачаОСОС.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ПередачаОСОС.ОсновноеСредство КАК ПредметСделки,
	|	ПередачаОСОС.ОсновноеСредство.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияОсновныхСредств) КАК ХозяйственнаяОперация,
	|	ПередачаОСОС.Количество КАК Количество,
	|	ПередачаОСОС.Количество КАК КоличествоВУчете,
	|	ПередачаОСОС.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПередачаОСОС.Сумма - ПередачаОСОС.СуммаНДС
	|		ИНАЧЕ ПередачаОСОС.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ПередачаОСОС.СтавкаНДС,
	|	ПередачаОСОС.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ПередачаОС.ОС КАК ПередачаОСОС
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПередачаОСОС.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПередачаОСОС.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиПередачиНМА(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("ЕдиницаИзмеренияШтука", РегистрыСведений.НастройкиФормированияКонтролируемыхСделок.ПолучитьЕдиницуИзмеренияШтука());
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПередачаНМА.Организация КАК Организация,
	|	ПередачаНМА.Дата КАК Период,
	|	ПередачаНМА.Ссылка КАК РасчетныйДокумент,
	|	ПередачаНМА.Контрагент КАК Контрагент,
	|	ПередачаНМА.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПередачаНМА.Организация КАК Грузоотправитель,
	|	ПередачаНМА.Контрагент КАК Грузополучатель,
	|	ПередачаНМА.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПередачаНМА.ВалютаДокумента КАК ВалютаДокумента,
	|	ПередачаНМА.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПередачаНМА.КурсВзаиморасчетов КАК КурсВзаиморасчетов,
	|	ПередачаНМА.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПередачаНМА КАК ПередачаНМА
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПередачаНМА.Контрагент)
	|			И ПередачаНМА.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПередачаНМА.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПередачаНМА.Контрагент)
	|ГДЕ
	|	ПередачаНМА.Организация В(&СтруктураОрганизации)
	|	И ПередачаНМА.Дата >= &НачалоПериода
	|	И ПередачаНМА.Дата <= &ОкончаниеПериода
	|	И ПередачаНМА.Проведен = ИСТИНА
	|	И ПередачаНМА.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПередачаНМА.Ссылка КАК Сделка,
	|	ПередачаНМА.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ПередачаНМА.НематериальныйАктив КАК ПредметСделки,
	|	ПередачаНМА.НематериальныйАктив.Наименование КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияОсновныхСредств) КАК ХозяйственнаяОперация,
	|	1 КАК Количество,
	|	1 КАК КоличествоВУчете,
	|	&ЕдиницаИзмеренияШтука КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПередачаНМА.Сумма - ПередачаНМА.СуммаНДС
	|		ИНАЧЕ ПередачаНМА.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ПередачаНМА.СтавкаНДС,
	|	ПередачаНМА.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ПередачаНМА КАК ПередачаНМА
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПередачаНМА.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПередачаНМА.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.СуммаВключаетНДС,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиОтчетаКомитентуОПродажах(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтчетКомитентуОПродажах.Организация КАК Организация,
	|	ОтчетКомитентуОПродажах.Дата КАК Период,
	|	ОтчетКомитентуОПродажах.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомитентуОПродажах.Контрагент КАК Контрагент,
	|	ОтчетКомитентуОПродажах.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ОтчетКомитентуОПродажах.Контрагент КАК Грузополучатель,
	|	ОтчетКомитентуОПродажах.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ОтчетКомитентуОПродажах.ВалютаДокумента,
	|	ОтчетКомитентуОПродажах.СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ОтчетКомитентуОПродажах.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомитентуОПродажах КАК ОтчетКомитентуОПродажах
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомитентуОПродажах.Контрагент)
	|			И ОтчетКомитентуОПродажах.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомитентуОПродажах.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомитентуОПродажах.Контрагент)
	|ГДЕ
	|	ОтчетКомитентуОПродажах.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомитентуОПродажах.Дата >= &НачалоПериода
	|	И ОтчетКомитентуОПродажах.Дата <= &ОкончаниеПериода
	|	И ОтчетКомитентуОПродажах.Проведен = ИСТИНА
	|	И ОтчетКомитентуОПродажах.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL 
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL )
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомитентуОПродажахТоварыСгрупированный.Ссылка КАК Сделка,
	|	ОтчетКомитентуОПродажахТоварыСгрупированный.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ОтчетКомитентуОПродажах.УслугаПоВознаграждению КАК ПредметСделки,
	|	ОтчетКомитентуОПродажах.УслугаПоВознаграждению.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	1 КАК Количество,
	|	1 КАК КоличествоВУчете,
	|	ОтчетКомитентуОПродажах.УслугаПоВознаграждению.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ОтчетКомитентуОПродажахТоварыСгрупированный.СуммаБезНДС КАК СуммаБезНДС,
	|	ОтчетКомитентуОПродажах.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	ОтчетКомитентуОПродажахТоварыСгрупированный.СуммаНДС КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОтчетКомитентуОПродажахТовары.Ссылка КАК Ссылка,
	|		СУММА(ОтчетКомитентуОПродажахТовары.СуммаНДСВознаграждения) КАК СуммаНДС,
	|		СУММА(ВЫБОР
	|				КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|					ТОГДА ОтчетКомитентуОПродажахТовары.СуммаВознаграждения - ОтчетКомитентуОПродажахТовары.СуммаНДСВознаграждения
	|				ИНАЧЕ ОтчетКомитентуОПродажахТовары.СуммаВознаграждения
	|			КОНЕЦ) КАК СуммаБезНДС
	|	ИЗ
	|		Документ.ОтчетКомитентуОПродажах.Товары КАК ОтчетКомитентуОПродажахТовары
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|			ПО ОтчетКомитентуОПродажахТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|	ГДЕ
	|		ОтчетКомитентуОПродажахТовары.Ссылка В
	|				(ВЫБРАТЬ
	|					ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|				ИЗ
	|					ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ОтчетКомитентуОПродажахТовары.Ссылка) КАК ОтчетКомитентуОПродажахТоварыСгрупированный
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомитентуОПродажах КАК ОтчетКомитентуОПродажах
	|		ПО (ОтчетКомитентуОПродажах.Ссылка = ОтчетКомитентуОПродажахТоварыСгрупированный.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО (ОтчетКомитентуОПродажах.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет)
	|ГДЕ
	|	ОтчетКомитентуОПродажах.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиОтчетаКомиссионераОПродажах(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	НастройкиФормированияСписка = РегистрыСведений.НастройкиФормированияКонтролируемыхСделок.ПолучитьНастройкиФормированияКонтролируемыхСделок();
	КомиссионноеВознаграждение = НастройкиФормированияСписка.КомиссионноеВознаграждение;
	
	Если НЕ ЗначениеЗаполнено(КомиссионноеВознаграждение) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru = 'В настройках формирования списка сделок не указан предмет сделки для комиссионного вознаграждения.
			|В сделках по отражению комиссионного вознаграждения предмет сделки будет не заполнен.'", 
			ОбщегоНазначения.КодОсновногоЯзыка()));
	КонецЕсли;
	
	СвойстваКомиссионногоВознаграждения = Новый Структура();
	СвойстваКомиссионногоВознаграждения.Вставить("КомиссионноеВознаграждениеНаименование", "Комиссионное вознаграждение");
	СвойстваКомиссионногоВознаграждения.Вставить("КомиссионноеВознаграждениеЕдиницаИзмерения", РегистрыСведений.НастройкиФормированияКонтролируемыхСделок.ПолучитьЕдиницуИзмеренияШтука());
	
	Если ЗначениеЗаполнено(КомиссионноеВознаграждение) Тогда
		Свойства = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(КомиссионноеВознаграждение, "НаименованиеПолное, ЕдиницаИзмерения");
		СвойстваКомиссионногоВознаграждения.КомиссионноеВознаграждениеНаименование = Свойства.НаименованиеПолное;
		СвойстваКомиссионногоВознаграждения.КомиссионноеВознаграждениеЕдиницаИзмерения = Свойства.ЕдиницаИзмерения;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("КомиссионноеВознаграждение", КомиссионноеВознаграждение);
	Запрос.УстановитьПараметр("КомиссионноеВознаграждениеНаименование", СвойстваКомиссионногоВознаграждения.КомиссионноеВознаграждениеНаименование);
	Запрос.УстановитьПараметр("КомиссионноеВознаграждениеЕдиницаИзмерения", СвойстваКомиссионногоВознаграждения.КомиссионноеВознаграждениеЕдиницаИзмерения);
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажах.Организация КАК Организация,
	|	ОтчетКомиссионераОПродажах.Дата КАК Период,
	|	ОтчетКомиссионераОПродажах.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомиссионераОПродажах.Контрагент КАК Контрагент,
	|	ОтчетКомиссионераОПродажах.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ОтчетКомиссионераОПродажах.Организация КАК Грузополучатель,
	|	ОтчетКомиссионераОПродажах.СчетУчетаРасчетовЗаПосредническиеУслуги КАК СчетУчетаРасчетов,
	|	ОтчетКомиссионераОПродажах.ВалютаДокумента КАК ВалютаДокумента,
	|	ОтчетКомиссионераОПродажах.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ОтчетКомиссионераОПродажах.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомиссионераОПродажах.Контрагент)
	|			И ОтчетКомиссионераОПродажах.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомиссионераОПродажах.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОтчетКомиссионераОПродажах.Контрагент)
	|ГДЕ
	|	ОтчетКомиссионераОПродажах.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомиссионераОПродажах.Дата >= &НачалоПериода
	|	И ОтчетКомиссионераОПродажах.Дата <= &ОкончаниеПериода
	|	И ОтчетКомиссионераОПродажах.Проведен = ИСТИНА
	|	И ОтчетКомиссионераОПродажах.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетДт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажахТоварыСгрупированный.Ссылка КАК Сделка,
	|	ОтчетКомиссионераОПродажахТоварыСгрупированный.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	&КомиссионноеВознаграждение КАК ПредметСделки,
	|	&КомиссионноеВознаграждениеНаименование КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	1 КАК Количество,
	|	1 КАК КоличествоВУчете,
	|	&КомиссионноеВознаграждениеЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ОтчетКомиссионераОПродажахТоварыСгрупированный.СуммаБезНДС КАК СуммаБезНДС,
	|	ОтчетКомиссионераОПродажах.СтавкаНДСВознаграждения КАК СтавкаНДС,
	|	ОтчетКомиссионераОПродажахТоварыСгрупированный.СуммаНДС КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОтчетКомиссионераОПродажахТовары.Ссылка КАК Ссылка,
	|		СУММА(ОтчетКомиссионераОПродажахТовары.СуммаНДСВознаграждения) КАК СуммаНДС,
	|		СУММА(ВЫБОР
	|				КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|					ТОГДА ОтчетКомиссионераОПродажахТовары.СуммаВознаграждения - ОтчетКомиссионераОПродажахТовары.СуммаНДСВознаграждения
	|				ИНАЧЕ ОтчетКомиссионераОПродажахТовары.СуммаВознаграждения
	|			КОНЕЦ) КАК СуммаБезНДС
	|	ИЗ
	|		Документ.ОтчетКомиссионераОПродажах.Товары КАК ОтчетКомиссионераОПродажахТовары
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|			ПО ОтчетКомиссионераОПродажахТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|	ГДЕ
	|		ОтчетКомиссионераОПродажахТовары.Ссылка В
	|				(ВЫБРАТЬ
	|					ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|				ИЗ
	|					ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ОтчетКомиссионераОПродажахТовары.Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ОтчетКомиссионераОПродажахУслуги.Ссылка,
	|		СУММА(ОтчетКомиссионераОПродажахУслуги.СуммаНДСВознаграждения),
	|		СУММА(ВЫБОР
	|				КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|					ТОГДА ОтчетКомиссионераОПродажахУслуги.СуммаВознаграждения - ОтчетКомиссионераОПродажахУслуги.СуммаНДСВознаграждения
	|				ИНАЧЕ ОтчетКомиссионераОПродажахУслуги.СуммаВознаграждения
	|			КОНЕЦ)
	|	ИЗ
	|		Документ.ОтчетКомиссионераОПродажах.Услуги КАК ОтчетКомиссионераОПродажахУслуги
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|			ПО ОтчетКомиссионераОПродажахУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|	ГДЕ
	|		ОтчетКомиссионераОПродажахУслуги.Ссылка В
	|				(ВЫБРАТЬ
	|					ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|				ИЗ
	|					ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ОтчетКомиссионераОПродажахУслуги.Ссылка) КАК ОтчетКомиссионераОПродажахТоварыСгрупированный
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|		ПО (ОтчетКомиссионераОПродажах.Ссылка = ОтчетКомиссионераОПродажахТоварыСгрупированный.Ссылка)
	|ГДЕ
	|	ОтчетКомиссионераОПродажах.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиВозвратаТоваровПоставщику(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВозвратТоваровПоставщику.Ссылка КАК ДокументВозврата,
	|	ПоступлениеТоваровУслуг.Ссылка КАК ДокументПоступления,
	|	ВозвратТоваровПоставщику.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВозвратТоваровПоставщику.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ВозвратТоваровПоставщику.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ ДокументыПоступленияИВозврата
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ПО ВозвратТоваровПоставщику.Сделка = ПоступлениеТоваровУслуг.Ссылка
	|ГДЕ
	|	ВозвратТоваровПоставщику.Организация В(&СтруктураОрганизации)
	|	И ВозвратТоваровПоставщику.Дата >= &НачалоПериода
	|	И ВозвратТоваровПоставщику.Проведен = ИСТИНА
	|	И ВозвратТоваровПоставщику.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И ВозвратТоваровПоставщику.Сделка <> ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.ПустаяСсылка)
	|	И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПоступлениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПоступлениеТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоступлениеТоваровУслуг.ВПереработку)
	|	И ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	ДокументВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслуг.Организация КАК Организация,
	|	ПоступлениеТоваровУслуг.Дата КАК Период,
	|	ПоступлениеТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Организация
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Контрагент
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	ПоступлениеТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|			И ПоступлениеТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|ГДЕ
	|	ПоступлениеТоваровУслуг.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыПоступленияИВозврата.ДокументПоступления
	|			ИЗ
	|				ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата)
	|	И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПоступлениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
	|	И ПоступлениеТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|	И ПоступлениеТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоступлениеТоваровУслуг.ВПереработку)
	|	И ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыПоступленияИВозврата.ДокументВозврата КАК РасчетныйДокумент,
	|	ДокументыПоступленияИВозврата.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата
	|ГДЕ
	|	ДокументыПоступленияИВозврата.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыПоступленияИВозврата.ДокументВозврата,
	|	ДокументыПоступленияИВозврата.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		-РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		-НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыПоступленияИВозврата.ДокументВозврата КАК Сделка,
	|	ДокументыПоступленияИВозврата.ДокументПоступления КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ВозвратТоваровПоставщикуТовары.Номенклатура КАК ПредметСделки,
	|	ВозвратТоваровПоставщикуТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ВозвратТоваров) КАК ХозяйственнаяОперация,
	|	-ВозвратТоваровПоставщикуТовары.Количество КАК Количество,
	|	-ВозвратТоваровПоставщикуТовары.Количество КАК КоличествоВУчете,
	|	ВозвратТоваровПоставщикуТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыПоступленияИВозврата.СуммаВключаетНДС
	|			ТОГДА -(ВозвратТоваровПоставщикуТовары.Сумма - ВозвратТоваровПоставщикуТовары.СуммаНДС)
	|		ИНАЧЕ -ВозвратТоваровПоставщикуТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ВозвратТоваровПоставщикуТовары.СтавкаНДС КАК СтавкаНДС,
	|	-ВозвратТоваровПоставщикуТовары.СуммаНДС КАК СуммаНДС,
	|	ВозвратТоваровПоставщикуТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику.Товары КАК ВозвратТоваровПоставщикуТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата
	|		ПО ВозвратТоваровПоставщикуТовары.Ссылка = ДокументыПоступленияИВозврата.ДокументВозврата
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ДокументыПоступленияИВозврата.ДокументПоступления)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ВозвратТоваровПоставщикуТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|ГДЕ
	|	ВозвратТоваровПоставщикуТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыПоступленияИВозврата.ДокументВозврата
	|			ИЗ
	|				ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты
	|		ПО (КонтролируемыеКонтрагенты.Контрагент = ДокументыКонтролируемыхСделок.Контрагент)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыПоступленияИВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();

КонецПроцедуры

Процедура ДобавитьСделкиВозвратаТоваровПоставщикуСделкаВТабличнойЧасти(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	ПустыеЗначенияСделка = ОбщегоНазначенияБП.МассивПустыхЗначенийРеквизита(Метаданные.Документы.ВозвратТоваровПоставщику.Реквизиты.Сделка);
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("ПустыеЗначенияСделка", ПустыеЗначенияСделка);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВозвратТоваровПоставщику.Ссылка КАК Ссылка,
	|	ВозвратТоваровПоставщикуТовары.Сделка КАК Сделка,
	|	ВозвратТоваровПоставщику.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВозвратТоваровПоставщику.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетовСКонтрагентом,
	|	ВозвратТоваровПоставщику.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ ВозвратТоваровПоставщику
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВозвратТоваровПоставщику.Товары КАК ВозвратТоваровПоставщикуТовары
	|		ПО ВозвратТоваровПоставщику.Ссылка = ВозвратТоваровПоставщикуТовары.Ссылка
	|ГДЕ
	|	ВозвратТоваровПоставщику.Организация В(&СтруктураОрганизации)
	|	И ВозвратТоваровПоставщику.Сделка В(&ПустыеЗначенияСделка)
	|	И ВозвратТоваровПоставщику.Дата >= &НачалоПериода
	|	И ВозвратТоваровПоставщику.Проведен = ИСТИНА
	|	И ВозвратТоваровПоставщику.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВозвратТоваровПоставщику.Ссылка КАК ДокументВозврата,
	|	ПоступлениеТоваровУслуг.Ссылка КАК ДокументПоступления,
	|	ВозвратТоваровПоставщику.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВозвратТоваровПоставщику.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ВозвратТоваровПоставщику.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ ДокументыПоступленияИВозврата
	|ИЗ
	|	ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ПО ВозвратТоваровПоставщику.Сделка = ПоступлениеТоваровУслуг.Ссылка
	|ГДЕ
	|	ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПоступлениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПоступлениеТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоступлениеТоваровУслуг.ВПереработку)
	|	И ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	ДокументВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслуг.Организация КАК Организация,
	|	ПоступлениеТоваровУслуг.Дата КАК Период,
	|	ПоступлениеТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Организация
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Контрагент
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	ПоступлениеТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL КАК ВзаимозависимыеЛица,
	|	НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|			И ПоступлениеТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|ГДЕ
	|	ПоступлениеТоваровУслуг.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыПоступленияИВозврата.ДокументПоступления
	|			ИЗ
	|				ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата)
	|	И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПоступлениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
	|	И ПоступлениеТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|	И ПоступлениеТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоступлениеТоваровУслуг.ВПереработку)
	|	И ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыПоступленияИВозврата.ДокументВозврата КАК РасчетныйДокумент,
	|	ДокументыПоступленияИВозврата.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата
	|ГДЕ
	|	ДокументыПоступленияИВозврата.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыПоступленияИВозврата.ДокументВозврата,
	|	ДокументыПоступленияИВозврата.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		-РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		-НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВозвратТоваровПоставщику.Ссылка КАК Ссылка,
	|	ВозвратТоваровПоставщику.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВозвратТоваровПоставщику.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетовСКонтрагентом,
	|	ВозвратТоваровПоставщику.ВалютаДокумента КАК ВалютаДокумента
	|ПОМЕСТИТЬ УникальныеДокументыВозвратаТоваровПоставщику
	|ИЗ
	|	ВозвратТоваровПоставщику КАК ВозвратТоваровПоставщику
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВозвратТоваровПоставщикуТовары.Ссылка КАК Сделка,
	|	ЕСТЬNULL(ВозвратТоваровПоставщикуТовары.Сделка, НЕОПРЕДЕЛЕНО) КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ВозвратТоваровПоставщикуТовары.Номенклатура КАК ПредметСделки,
	|	ВозвратТоваровПоставщикуТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ВозвратТоваров) КАК ХозяйственнаяОперация,
	|	-ВозвратТоваровПоставщикуТовары.Количество КАК Количество,
	|	-ВозвратТоваровПоставщикуТовары.Количество КАК КоличествоВУчете,
	|	ВозвратТоваровПоставщикуТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА УникальныеДокументыВозвратаТоваровПоставщику.СуммаВключаетНДС
	|			ТОГДА -(ВозвратТоваровПоставщикуТовары.Сумма - ВозвратТоваровПоставщикуТовары.СуммаНДС)
	|		ИНАЧЕ -ВозвратТоваровПоставщикуТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ВозвратТоваровПоставщикуТовары.СтавкаНДС КАК СтавкаНДС,
	|	-ВозвратТоваровПоставщикуТовары.СуммаНДС КАК СуммаНДС,
	|	ВозвратТоваровПоставщикуТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|		И ЕСТЬNULL(ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) = ИСТИНА КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ВозвратТоваровПоставщику.Товары КАК ВозвратТоваровПоставщикуТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ УникальныеДокументыВозвратаТоваровПоставщику КАК УникальныеДокументыВозвратаТоваровПоставщику
	|		ПО ВозвратТоваровПоставщикуТовары.Ссылка = УникальныеДокументыВозвратаТоваровПоставщику.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ВозвратТоваровПоставщикуТовары.Сделка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ВозвратТоваровПоставщикуТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|ГДЕ
	|	ВозвратТоваровПоставщикуТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыПоступленияИВозврата.ДокументВозврата
	|			ИЗ
	|				ДокументыПоступленияИВозврата КАК ДокументыПоступленияИВозврата)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	
	// В запросе по сделкам документа нужно выбирать все строки табличной части ВозвратТоваровПоставщику,
	// т.к. для валютных документов нужно корректно распределить рублевые суммы.
	// Это можно сделать только в том случае, если в выборке вернутся все строки, даже с незаполненной сделкой.
	// Незаполненная сделка (ДокументРасчетов) в дальнейшем распределении не повлияет на результат,
	// т.к. выборка для включения в уведомление работает только по заполненным ДокументРасчетов.
	
	СделкиДокумента = Результаты[2].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты
	|		ПО (КонтролируемыеКонтрагенты.Контрагент = ДокументыКонтролируемыхСделок.Контрагент)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыПоступленияИВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();

КонецПроцедуры

Процедура ДобавитьСделкиВозвратаТоваровОтПокупателя(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВозвратТоваровОтПокупателя.Ссылка КАК ДокументВозврата,
	|	РеализацияТоваровУслуг.Ссылка КАК ДокументРеализации,
	|	ВозвратТоваровОтПокупателя.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВозвратТоваровОтПокупателя.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ВозвратТоваровОтПокупателя.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением
	|ПОМЕСТИТЬ ДокументыРеализацииИВозврата
	|ИЗ
	|	Документ.ВозвратТоваровОтПокупателя КАК ВозвратТоваровОтПокупателя
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ПО ВозвратТоваровОтПокупателя.Сделка = РеализацияТоваровУслуг.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|			И (РеализацияТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода)
	|			И (РеализацияТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|ГДЕ
	|	ВозвратТоваровОтПокупателя.Организация В(&СтруктураОрганизации)
	|	И ВозвратТоваровОтПокупателя.Дата >= &НачалоПериода
	|	И ВозвратТоваровОтПокупателя.Проведен = ИСТИНА
	|	И ВозвратТоваровОтПокупателя.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И РеализацияТоваровУслуг.Дата >= &НачалоПериода
	|	И РеализацияТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И РеализацияТоваровУслуг.Проведен = ИСТИНА
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|	И РеализацияТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ОтгрузкаБезПереходаПраваСобственности)
	|	И РеализацияТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПокупателем)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументРеализации,
	|	ДокументВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Организация КАК Организация,
	|	РеализацияТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	РеализацияТоваровУслуг.Дата КАК Период,
	|	РеализацияТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Контрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Организация
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	РеализацияТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	РеализацияТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ДокументыРеализацииИВозврата.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыРеализацииИВозврата.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыРеализацииИВозврата.СделкаВОбластиВнешнейТорговли КАК СделкаВОбластиВнешнейТорговли,
	|	ДокументыРеализацииИВозврата.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыРеализацииИВозврата КАК ДокументыРеализацииИВозврата
	|		ПО РеализацияТоваровУслуг.Ссылка = ДокументыРеализацииИВозврата.ДокументРеализации
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыРеализацииИВозврата.ДокументРеализации
	|			ИЗ
	|				ДокументыРеализацииИВозврата КАК ДокументыРеализацииИВозврата)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыРеализацииИВозврата.ДокументВозврата КАК РасчетныйДокумент,
	|	ДокументыРеализацииИВозврата.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыРеализацииИВозврата КАК ДокументыРеализацииИВозврата
	|ГДЕ
	|	ДокументыРеализацииИВозврата.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыРеализацииИВозврата.ДокументВозврата,
	|	ДокументыРеализацииИВозврата.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		-НДСПредъявленный.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВозвратТоваровОтПокупателяТовары.Ссылка КАК Сделка,
	|	ДокументыРеализацииИВозврата.ДокументРеализации КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ВозвратТоваровОтПокупателяТовары.Номенклатура КАК ПредметСделки,
	|	ВозвратТоваровОтПокупателяТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтПокупателяТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ВЫБОР
	|		КОГДА ВозвратТоваровОтПокупателяТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ВозвратТоваров) КАК ХозяйственнаяОперация,
	|	-ВозвратТоваровОтПокупателяТовары.Количество КАК Количество,
	|	-ВозвратТоваровОтПокупателяТовары.Количество КАК КоличествоВУчете,
	|	ВозвратТоваровОтПокупателяТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыРеализацииИВозврата.СуммаВключаетНДС
	|			ТОГДА -(ВозвратТоваровОтПокупателяТовары.Сумма - ВозвратТоваровОтПокупателяТовары.СуммаНДС)
	|		ИНАЧЕ -ВозвратТоваровОтПокупателяТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ВозвратТоваровОтПокупателяТовары.СтавкаНДС КАК СтавкаНДС,
	|	-ВозвратТоваровОтПокупателяТовары.СуммаНДС КАК СуммаНДС,
	|	ВозвратТоваровОтПокупателяТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ВозвратТоваровОтПокупателя.Товары КАК ВозвратТоваровОтПокупателяТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыРеализацииИВозврата КАК ДокументыРеализацииИВозврата
	|		ПО (ДокументыРеализацииИВозврата.ДокументВозврата = ВозвратТоваровОтПокупателяТовары.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ДокументыРеализацииИВозврата.ДокументРеализации)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО ВозвратТоваровОтПокупателяТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО ВозвратТоваровОтПокупателяТовары.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	ВозвратТоваровОтПокупателяТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыРеализацииИВозврата.ДокументВозврата
	|			ИЗ
	|				ДокументыРеализацииИВозврата КАК ДокументыРеализацииИВозврата)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыРеализацииИВозврата
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиКорректировкиРеализации(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("СчетаУчетаКурсовыхРазниц", БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.ПрочиеДоходыИРасходы));
	Запрос.УстановитьПараметр("ВидСубконтоПрочиеДоходыРасходы", ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПрочиеДоходыИРасходы);
	Запрос.УстановитьПараметр("СтатьиКурсовыхРазниц", СтатьиКурсовыхРазниц());
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КорректировкаРеализации.Ссылка КАК ДокументКорректировки,
	|	КорректировкаРеализации.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	КорректировкаРеализации.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	КорректировкаРеализации.ВалютаДокумента,
	|	КорректировкаРеализации.ДокументРеализации
	|ПОМЕСТИТЬ ДокументыКорректировки
	|ИЗ
	|	Документ.КорректировкаРеализации КАК КорректировкаРеализации
	|ГДЕ
	|	КорректировкаРеализации.Организация В(&СтруктураОрганизации)
	|	И КорректировкаРеализации.Дата >= &НачалоПериода
	|	И КорректировкаРеализации.Проведен = ИСТИНА
	|	И КорректировкаРеализации.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И КорректировкаРеализации.КорректироватьБУиНУ = ИСТИНА
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументКорректировки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКорректировки.ДокументКорректировки,
	|	ДокументыКорректировки.СуммаВключаетНДС,
	|	ДокументыКорректировки.ДокументРеализации
	|ИЗ
	|	ДокументыКорректировки КАК ДокументыКорректировки";
	
	ТаблицаКорректировок = Новый ТаблицаЗначений();
	ТаблицаКорректировок.Колонки.Добавить("ДокументКорректировки", Новый ОписаниеТипов("ДокументСсылка.КорректировкаРеализации"));
	ТаблицаКорректировок.Колонки.Добавить("СуммаВключаетНДС", Новый ОписаниеТипов("Булево"));
	ТаблицаКорректировок.Колонки.Добавить("ДокументРеализации", Метаданные.Документы.КорректировкаРеализации.Реквизиты.ИсправляемыйДокументРеализации.Тип);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		СтрокаКорректировок = ТаблицаКорректировок.Добавить();
		СтрокаКорректировок.ДокументКорректировки = Выборка.ДокументКорректировки;
		СтрокаКорректировок.СуммаВключаетНДС = Выборка.СуммаВключаетНДС;
		СтрокаКорректировок.ДокументРеализации = УчетНДСПереопределяемый.ПолучитьИсправляемыйДокументРеализации(Выборка.ДокументРеализации, Истина);
	КонецЦикла;

	Запрос.Параметры.Вставить("ДокументыКорректировкиИРеализации", ТаблицаКорректировок);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДокументыКорректировкиИРеализации.ДокументКорректировки КАК ДокументКорректировки,
	|	ДокументыКорректировкиИРеализации.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации КАК ДокументРеализации
	|ПОМЕСТИТЬ ДокументыКорректировкиИРеализации
	|ИЗ
	|	&ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументРеализации,
	|	ДокументКорректировки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РеализацияТоваровУслуг.Организация КАК Организация,
	|	РеализацияТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	РеализацияТоваровУслуг.Дата КАК Период,
	|	РеализацияТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Контрагент
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА РеализацияТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА РеализацияТоваровУслуг.Организация
	|		ИНАЧЕ РеализацияТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	РеализацияТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	РеализацияТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента.ВидДоговора КАК ВидДоговора,
	|	РеализацияТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|			И РеализацияТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И РеализацияТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = РеализацияТоваровУслуг.Контрагент)
	|ГДЕ
	|	РеализацияТоваровУслуг.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИРеализации.ДокументРеализации
	|			ИЗ
	|				ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации)
	|	И РеализацияТоваровУслуг.Дата >= &НачалоПериода
	|	И РеализацияТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И РеализацияТоваровУслуг.Проведен = ИСТИНА
	|	И РеализацияТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|	И РеализацияТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ОтгрузкаБезПереходаПраваСобственности)
	|	И РеализацияТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПокупателем)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Акт.Организация,
	|	Акт.Ссылка,
	|	Акт.Дата,
	|	Акт.Контрагент,
	|	Акт.Контрагент,
	|	НЕОПРЕДЕЛЕНО,
	|	Акт.ДоговорКонтрагента,
	|	Акт.ВалютаДокумента,
	|	Акт.СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ),
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ),
	|	Акт.ДоговорКонтрагента.ВидДоговора,
	|	Акт.ДоговорКонтрагента.ВалютаВзаиморасчетов
	|ИЗ
	|	Документ.АктОбОказанииПроизводственныхУслуг КАК Акт
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = Акт.Контрагент)
	|			И Акт.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И Акт.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = Акт.Контрагент)
	|ГДЕ
	|	Акт.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИРеализации.ДокументРеализации
	|			ИЗ
	|				ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации)
	|	И Акт.Дата >= &НачалоПериода
	|	И Акт.Дата <= &ОкончаниеПериода
	|	И Акт.Проведен = ИСТИНА
	|	И Акт.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКорректировки.ДокументКорректировки КАК РасчетныйДокумент,
	|	ДокументыКорректировки.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКорректировки КАК ДокументыКорректировки
	|ГДЕ
	|	ДокументыКорректировки.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКорректировки.ДокументКорректировки,
	|	ДокументыКорректировки.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор,
	|		0,
	|		-РасчетыДокумента.Сумма
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И (РасчетыДокумента.СчетКт В (&СчетаУчетаКурсовыхРазниц))
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный.Субконто КАК СубконтоКурсовыхРазниц
	|			ПО (РасчетыДокумента.Регистратор = СубконтоКурсовыхРазниц.Регистратор)
	|				И (РасчетыДокумента.НомерСтроки = СубконтоКурсовыхРазниц.НомерСтроки)
	|				И (СубконтоКурсовыхРазниц.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияБухгалтерии.Кредит))
	|				И (СубконтоКурсовыхРазниц.Вид = &ВидСубконтоПрочиеДоходыРасходы)
	|				И (СубконтоКурсовыхРазниц.Значение В (&СтатьиКурсовыхРазниц))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		-НДСПредъявленный.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КорректировкаРеализацииТовары.Ссылка КАК Сделка,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	КорректировкаРеализацииТовары.Номенклатура КАК ПредметСделки,
	|	КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка) КАК ХозяйственнаяОперация,
	|	-КорректировкаРеализацииТовары.КоличествоДоИзменения КАК Количество,
	|	-КорректировкаРеализацииТовары.КоличествоДоИзменения КАК КоличествоВУчете,
	|	КорректировкаРеализацииТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИРеализации.СуммаВключаетНДС
	|			ТОГДА -(КорректировкаРеализацииТовары.СуммаДоИзменения - КорректировкаРеализацииТовары.СуммаНДСДоИзменения)
	|		ИНАЧЕ -КорректировкаРеализацииТовары.СуммаДоИзменения
	|	КОНЕЦ КАК СуммаБезНДС,
	|	КорректировкаРеализацииТовары.СтавкаНДСДоИзменения КАК СтавкаНДС,
	|	-КорректировкаРеализацииТовары.СуммаНДСДоИзменения КАК СуммаНДС,
	|	КорректировкаРеализацииТовары.СтранаПроисхожденияДоИзменения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО (ДокументыКорректировкиИРеализации.ДокументКорректировки = КорректировкаРеализацииТовары.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ДокументыКорректировкиИРеализации.ДокументРеализации)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО КорректировкаРеализацииТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО КорректировкаРеализацииТовары.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	КорректировкаРеализацииТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировки.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировки КАК ДокументыКорректировки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииТовары.Ссылка,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	КорректировкаРеализацииТовары.Номенклатура,
	|	КорректировкаРеализацииТовары.Номенклатура.НаименованиеПолное,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА КорректировкаРеализацииТовары.СчетУчета.Забалансовый
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	КорректировкаРеализацииТовары.Количество,
	|	КорректировкаРеализацииТовары.Количество,
	|	КорректировкаРеализацииТовары.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИРеализации.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииТовары.Сумма - КорректировкаРеализацииТовары.СуммаНДС
	|		ИНАЧЕ КорректировкаРеализацииТовары.Сумма
	|	КОНЕЦ,
	|	КорректировкаРеализацииТовары.СтавкаНДС,
	|	КорректировкаРеализацииТовары.СуммаНДС,
	|	КорректировкаРеализацииТовары.СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК КорректировкаРеализацииТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО (ДокументыКорректировкиИРеализации.ДокументКорректировки = КорректировкаРеализацииТовары.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ДокументыКорректировкиИРеализации.ДокументРеализации)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО КорректировкаРеализацииТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО КорректировкаРеализацииТовары.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	КорректировкаРеализацииТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировки.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировки КАК ДокументыКорректировки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииУслуги.Ссылка,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	КорректировкаРеализацииУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаРеализацииУслуги.СодержаниеДоИзменения ПОДОБНО """"
	|			ТОГДА КорректировкаРеализацииУслуги.СодержаниеДоИзменения
	|		ИНАЧЕ КорректировкаРеализацииУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	-КорректировкаРеализацииУслуги.КоличествоДоИзменения,
	|	-КорректировкаРеализацииУслуги.КоличествоДоИзменения,
	|	КорректировкаРеализацииУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИРеализации.СуммаВключаетНДС
	|			ТОГДА -(КорректировкаРеализацииУслуги.СуммаДоИзменения - КорректировкаРеализацииУслуги.СуммаНДСДоИзменения)
	|		ИНАЧЕ -КорректировкаРеализацииУслуги.СуммаДоИзменения
	|	КОНЕЦ,
	|	КорректировкаРеализацииУслуги.СтавкаНДСДоИзменения,
	|	-КорректировкаРеализацииУслуги.СуммаНДСДоИзменения,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|ИЗ
	|	Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО (ДокументыКорректировкиИРеализации.ДокументКорректировки = КорректировкаРеализацииУслуги.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО КорректировкаРеализацииУслуги.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	КорректировкаРеализацииУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировки.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировки КАК ДокументыКорректировки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииУслуги.Ссылка,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	КорректировкаРеализацииУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаРеализацииУслуги.Содержание ПОДОБНО """"
	|			ТОГДА КорректировкаРеализацииУслуги.Содержание
	|		ИНАЧЕ КорректировкаРеализацииУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	КорректировкаРеализацииУслуги.Количество,
	|	КорректировкаРеализацииУслуги.Количество,
	|	КорректировкаРеализацииУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИРеализации.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииУслуги.Сумма - КорректировкаРеализацииУслуги.СуммаНДС
	|		ИНАЧЕ КорректировкаРеализацииУслуги.Сумма
	|	КОНЕЦ,
	|	КорректировкаРеализацииУслуги.СтавкаНДС,
	|	КорректировкаРеализацииУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|ИЗ
	|	Документ.КорректировкаРеализации.Услуги КАК КорректировкаРеализацииУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО (ДокументыКорректировкиИРеализации.ДокументКорректировки = КорректировкаРеализацииУслуги.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО КорректировкаРеализацииУслуги.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет
	|ГДЕ
	|	КорректировкаРеализацииУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировки.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировки КАК ДокументыКорректировки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииАгентскиеУслуги.Ссылка,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	КорректировкаРеализацииАгентскиеУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаРеализацииАгентскиеУслуги.СодержаниеДоИзменения ПОДОБНО """"
	|			ТОГДА КорректировкаРеализацииАгентскиеУслуги.СодержаниеДоИзменения
	|		ИНАЧЕ КорректировкаРеализацииАгентскиеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	-КорректировкаРеализацииАгентскиеУслуги.КоличествоДоИзменения,
	|	-КорректировкаРеализацииАгентскиеУслуги.КоличествоДоИзменения,
	|	КорректировкаРеализацииАгентскиеУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИРеализации.СуммаВключаетНДС
	|			ТОГДА -(КорректировкаРеализацииАгентскиеУслуги.СуммаДоИзменения - КорректировкаРеализацииАгентскиеУслуги.СуммаНДСДоИзменения)
	|		ИНАЧЕ -КорректировкаРеализацииАгентскиеУслуги.СуммаДоИзменения
	|	КОНЕЦ,
	|	КорректировкаРеализацииАгентскиеУслуги.СтавкаНДСДоИзменения,
	|	-КорректировкаРеализацииАгентскиеУслуги.СуммаНДСДоИзменения,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаРеализации.АгентскиеУслуги КАК КорректировкаРеализацииАгентскиеУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО (ДокументыКорректировкиИРеализации.ДокументКорректировки = КорректировкаРеализацииАгентскиеУслуги.Ссылка)
	|ГДЕ
	|	КорректировкаРеализацииАгентскиеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировки.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировки КАК ДокументыКорректировки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаРеализацииАгентскиеУслуги.Ссылка,
	|	ДокументыКорректировкиИРеализации.ДокументРеализации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	КорректировкаРеализацииАгентскиеУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаРеализацииАгентскиеУслуги.Содержание ПОДОБНО """"
	|			ТОГДА КорректировкаРеализацииАгентскиеУслуги.Содержание
	|		ИНАЧЕ КорректировкаРеализацииАгентскиеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	КорректировкаРеализацииАгентскиеУслуги.Количество,
	|	КорректировкаРеализацииАгентскиеУслуги.Количество,
	|	КорректировкаРеализацииАгентскиеУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИРеализации.СуммаВключаетНДС
	|			ТОГДА КорректировкаРеализацииАгентскиеУслуги.Сумма - КорректировкаРеализацииАгентскиеУслуги.СуммаНДС
	|		ИНАЧЕ КорректировкаРеализацииАгентскиеУслуги.Сумма
	|	КОНЕЦ,
	|	КорректировкаРеализацииАгентскиеУслуги.СтавкаНДС,
	|	КорректировкаРеализацииАгентскиеУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаРеализации.АгентскиеУслуги КАК КорректировкаРеализацииАгентскиеУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИРеализации КАК ДокументыКорректировкиИРеализации
	|		ПО (ДокументыКорректировкиИРеализации.ДокументКорректировки = КорректировкаРеализацииАгентскиеУслуги.Ссылка)
	|ГДЕ
	|	КорректировкаРеализацииАгентскиеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировки.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировки КАК ДокументыКорректировки)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКорректировкиИРеализации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКорректировки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();

	
КонецПроцедуры

Процедура ДобавитьСделкиКорректировкиПоступления(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.УстановитьПараметр("СчетаУчетаКурсовыхРазниц", БухгалтерскийУчетПовтИсп.СчетаВИерархии(ПланыСчетов.Хозрасчетный.ПрочиеДоходыИРасходы));
	Запрос.УстановитьПараметр("ВидСубконтоПрочиеДоходыРасходы", ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ПрочиеДоходыИРасходы);
	Запрос.УстановитьПараметр("СтатьиКурсовыхРазниц", СтатьиКурсовыхРазниц());
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КорректировкаПоступления.Ссылка КАК ДокументКорректировки,
	|	КорректировкаПоступления.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	КорректировкаПоступления.ВалютаДокумента,
	|	КорректировкаПоступления.ДокументПоступления,
	|	КорректировкаПоступления.ДоговорКонтрагента.УчетАгентскогоНДС КАК УчетАгентскогоНДС
	|ИЗ
	|	Документ.КорректировкаПоступления КАК КорректировкаПоступления
	|ГДЕ
	|	КорректировкаПоступления.Организация В(&СтруктураОрганизации)
	|	И КорректировкаПоступления.Дата >= &НачалоПериода
	|	И КорректировкаПоступления.Проведен = ИСТИНА
	|	И КорректировкаПоступления.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И КорректировкаПоступления.КорректироватьБУиНУ = ИСТИНА";
	
	ТаблицаКорректировок = Новый ТаблицаЗначений();
	ТаблицаКорректировок.Колонки.Добавить("ДокументКорректировки", Новый ОписаниеТипов("ДокументСсылка.КорректировкаПоступления"));
	ТаблицаКорректировок.Колонки.Добавить("ВалютаДокумента", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	ТаблицаКорректировок.Колонки.Добавить("СуммаВключаетНДС", Новый ОписаниеТипов("Булево"));
	ТаблицаКорректировок.Колонки.Добавить("УчетАгентскогоНДС", Новый ОписаниеТипов("Булево"));
	ТаблицаКорректировок.Колонки.Добавить("ДокументПоступления", Метаданные.Документы.КорректировкаПоступления.Реквизиты.ИсправляемыйДокументПоступления.Тип);
	ТаблицаКорректировок.Колонки.Добавить("СчетУчетаРасчетов", Новый ОписаниеТипов("ПланСчетовСсылка.Хозрасчетный"));
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		СтрокаКорректировок = ТаблицаКорректировок.Добавить();
		СтрокаКорректировок.ДокументКорректировки = Выборка.ДокументКорректировки;
		СтрокаКорректировок.ВалютаДокумента = Выборка.ВалютаДокумента;
		СтрокаКорректировок.УчетАгентскогоНДС = Выборка.УчетАгентскогоНДС;
		СтрокаКорректировок.СуммаВключаетНДС = Выборка.СуммаВключаетНДС;
		СтрокаКорректировок.ДокументПоступления = УчетНДСПереопределяемый.ПолучитьИсправляемыйДокументПоступления(Выборка.ДокументПоступления, Истина);
		Если ОбщегоНазначения.ЕстьРеквизитОбъекта("СчетУчетаРасчетовСКонтрагентом", СтрокаКорректировок.ДокументПоступления.Метаданные()) Тогда
			СтрокаКорректировок.СчетУчетаРасчетов = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаКорректировок.ДокументПоступления, "СчетУчетаРасчетовСКонтрагентом");
		КонецЕсли;
	КонецЦикла;

	Запрос.Параметры.Вставить("ДокументыКорректировкиИПоступления", ТаблицаКорректировок);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ДокументыКорректировкиИПоступления.ДокументКорректировки КАК ДокументКорректировки,
	|	ДокументыКорректировкиИПоступления.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ДокументыКорректировкиИПоступления.ВалютаДокумента КАК ВалютаДокумента,
	|	ДокументыКорректировкиИПоступления.СчетУчетаРасчетов КАК СчетУчетаРасчетов,
	|	ДокументыКорректировкиИПоступления.УчетАгентскогоНДС КАК УчетАгентскогоНДС,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления КАК ДокументПоступления
	|ПОМЕСТИТЬ ДокументыКорректировкиИПоступления
	|ИЗ
	|	&ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументПоступления,
	|	ДокументКорректировки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеТоваровУслуг.Организация КАК Организация,
	|	ПоступлениеТоваровУслуг.Дата КАК Период,
	|	ПоступлениеТоваровУслуг.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеТоваровУслуг.Контрагент КАК Контрагент,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузополучатель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Организация
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузополучатель
	|	КОНЕЦ КАК Грузополучатель,
	|	ВЫБОР
	|		КОГДА ПоступлениеТоваровУслуг.Грузоотправитель = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
	|			ТОГДА ПоступлениеТоваровУслуг.Контрагент
	|		ИНАЧЕ ПоступлениеТоваровУслуг.Грузоотправитель
	|	КОНЕЦ КАК Грузоотправитель,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеТоваровУслуг.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПоступлениеТоваровУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	ПоступлениеТоваровУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ) КАК СделкаВОбластиВнешнейТорговли,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|			И ПоступлениеТоваровУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеТоваровУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеТоваровУслуг.Контрагент)
	|ГДЕ
	|	ПоступлениеТоваровУслуг.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументПоступления
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|	И ПоступлениеТоваровУслуг.Дата >= &НачалоПериода
	|	И ПоступлениеТоваровУслуг.Дата <= &ОкончаниеПериода
	|	И ПоступлениеТоваровУслуг.Проведен = ИСТИНА
	|	И ПоступлениеТоваровУслуг.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|	И ПоступлениеТоваровУслуг.ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПоступлениеТоваровУслуг.ВПереработку)
	|	И ПоступлениеТоваровУслуг.ДоговорКонтрагента.ВидДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыДоговоровКонтрагентов.СПоставщиком)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПоступлениеДопРасходов.Организация,
	|	ПоступлениеДопРасходов.Дата,
	|	ПоступлениеДопРасходов.Ссылка,
	|	ПоступлениеДопРасходов.Контрагент,
	|	ПоступлениеДопРасходов.Организация,
	|	НЕОПРЕДЕЛЕНО,
	|	ПоступлениеДопРасходов.ДоговорКонтрагента,
	|	ПоступлениеДопРасходов.СчетУчетаРасчетовСКонтрагентом,
	|	ПоступлениеДопРасходов.ВалютаДокумента,
	|	ПоступлениеДопРасходов.СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.СделкаВОбластиВнешнейТорговли, ЛОЖЬ),
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ),
	|	ПоступлениеДопРасходов.ДоговорКонтрагента.ВалютаВзаиморасчетов
	|ИЗ
	|	Документ.ПоступлениеДопРасходов КАК ПоступлениеДопРасходов
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеДопРасходов.Контрагент)
	|			И ПоступлениеДопРасходов.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеДопРасходов.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеДопРасходов.Контрагент)
	|ГДЕ
	|	ПоступлениеДопРасходов.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументПоступления
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|	И ПоступлениеДопРасходов.Дата >= &НачалоПериода
	|	И ПоступлениеДопРасходов.Дата <= &ОкончаниеПериода
	|	И ПоступлениеДопРасходов.Проведен = ИСТИНА
	|	И ПоступлениеДопРасходов.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКорректировкиИПоступления.ДокументКорректировки КАК РасчетныйДокумент,
	|	ДокументыКорректировкиИПоступления.СчетУчетаРасчетов КАК СчетУчетаРасчетов,
	|	ДокументыКорректировкиИПоступления.УчетАгентскогоНДС КАК УчетАгентскогоНДС
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|ГДЕ
	|	ДокументыКорректировкиИПоступления.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКорректировкиИПоступления.ДокументКорректировки,
	|	ДокументыКорректировкиИПоступления.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетДт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор,
	|		0,
	|		-РасчетыДокумента.Сумма
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И (РасчетыДокумента.СчетДт В (&СчетаУчетаКурсовыхРазниц))
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный.Субконто КАК СубконтоКурсовыхРазниц
	|			ПО (РасчетыДокумента.Регистратор = СубконтоКурсовыхРазниц.Регистратор)
	|				И (РасчетыДокумента.НомерСтроки = СубконтоКурсовыхРазниц.НомерСтроки)
	|				И (СубконтоКурсовыхРазниц.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияБухгалтерии.Дебет))
	|				И (СубконтоКурсовыхРазниц.Вид = &ВидСубконтоПрочиеДоходыРасходы)
	|				И (СубконтоКурсовыхРазниц.Значение В (&СтатьиКурсовыхРазниц))
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		-НДСЗаписиКнигиПродаж.НДС,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделокВВалюте.УчетАгентскогоНДС
	|				ТОГДА -НДСЗаписиКнигиПродаж.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.НДС,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделокВВалюте.УчетАгентскогоНДС
	|				ТОГДА НДСПредъявленный.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КорректировкаПоступленияТовары.Ссылка КАК Сделка,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	КорректировкаПоступленияТовары.Номенклатура КАК ПредметСделки,
	|	КорректировкаПоступленияТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка) КАК ХозяйственнаяОперация,
	|	-КорректировкаПоступленияТовары.КоличествоДоИзменения КАК Количество,
	|	-КорректировкаПоступленияТовары.КоличествоДоИзменения КАК КоличествоВУчете,
	|	КорректировкаПоступленияТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИПоступления.СуммаВключаетНДС
	|			ТОГДА -(КорректировкаПоступленияТовары.СуммаДоИзменения - КорректировкаПоступленияТовары.СуммаНДСДоИзменения)
	|		ИНАЧЕ -КорректировкаПоступленияТовары.СуммаДоИзменения
	|	КОНЕЦ КАК СуммаБезНДС,
	|	КорректировкаПоступленияТовары.СтавкаНДСДоИзменения КАК СтавкаНДС,
	|	-КорректировкаПоступленияТовары.СуммаНДСДоИзменения КАК СуммаНДС,
	|	КорректировкаПоступленияТовары.СтранаПроисхожденияДоИзменения КАК СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.КорректировкаПоступления.Товары КАК КорректировкаПоступленияТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|		ПО (ДокументыКорректировкиИПоступления.ДокументКорректировки = КорректировкаПоступленияТовары.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ДокументыКорректировкиИПоступления.ДокументПоступления)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО КорректировкаПоступленияТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|ГДЕ
	|	КорректировкаПоступленияТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаПоступленияТовары.Ссылка,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	КорректировкаПоступленияТовары.Номенклатура,
	|	КорректировкаПоступленияТовары.Номенклатура.НаименованиеПолное,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	КорректировкаПоступленияТовары.Количество,
	|	КорректировкаПоступленияТовары.Количество,
	|	КорректировкаПоступленияТовары.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИПоступления.СуммаВключаетНДС
	|			ТОГДА КорректировкаПоступленияТовары.Сумма - КорректировкаПоступленияТовары.СуммаНДС
	|		ИНАЧЕ КорректировкаПоступленияТовары.Сумма
	|	КОНЕЦ,
	|	КорректировкаПоступленияТовары.СтавкаНДС,
	|	КорректировкаПоступленияТовары.СуммаНДС,
	|	КорректировкаПоступленияТовары.СтранаПроисхождения,
	|	ВЫБОР
	|		КОГДА НЕ ТоварыМировойБиржевойТорговли.ПредметСделки ЕСТЬ NULL
	|				И ДокументыКонтролируемыхСделок.СделкаВОбластиВнешнейТорговли = ИСТИНА
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаПоступления.Товары КАК КорректировкаПоступленияТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|		ПО (ДокументыКорректировкиИПоступления.ДокументКорректировки = КорректировкаПоступленияТовары.Ссылка)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО (ДокументыКонтролируемыхСделок.РасчетныйДокумент = ДокументыКорректировкиИПоступления.ДокументПоступления)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыМировойБиржевойТорговли КАК ТоварыМировойБиржевойТорговли
	|		ПО КорректировкаПоступленияТовары.Номенклатура = ТоварыМировойБиржевойТорговли.ПредметСделки
	|			И (ТоварыМировойБиржевойТорговли.ДатаНачалаДействия <= ДокументыКонтролируемыхСделок.Период)
	|			И (ТоварыМировойБиржевойТорговли.ДатаОкончанияДействия >= ДокументыКонтролируемыхСделок.Период)
	|ГДЕ
	|	КорректировкаПоступленияТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаПоступленияУслуги.Ссылка,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	КорректировкаПоступленияУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаПоступленияУслуги.СодержаниеДоИзменения ПОДОБНО """"
	|			ТОГДА КорректировкаПоступленияУслуги.СодержаниеДоИзменения
	|		ИНАЧЕ КорректировкаПоступленияУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	-КорректировкаПоступленияУслуги.КоличествоДоИзменения,
	|	-КорректировкаПоступленияУслуги.КоличествоДоИзменения,
	|	КорректировкаПоступленияУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИПоступления.СуммаВключаетНДС
	|			ТОГДА -(КорректировкаПоступленияУслуги.СуммаДоИзменения - КорректировкаПоступленияУслуги.СуммаНДСДоИзменения)
	|		ИНАЧЕ -КорректировкаПоступленияУслуги.СуммаДоИзменения
	|	КОНЕЦ,
	|	КорректировкаПоступленияУслуги.СтавкаНДСДоИзменения,
	|	-КорректировкаПоступленияУслуги.СуммаНДСДоИзменения,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаПоступления.Услуги КАК КорректировкаПоступленияУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|		ПО (ДокументыКорректировкиИПоступления.ДокументКорректировки = КорректировкаПоступленияУслуги.Ссылка)
	|ГДЕ
	|	КорректировкаПоступленияУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаПоступленияУслуги.Ссылка,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	КорректировкаПоступленияУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаПоступленияУслуги.Содержание ПОДОБНО """"
	|			ТОГДА КорректировкаПоступленияУслуги.Содержание
	|		ИНАЧЕ КорректировкаПоступленияУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ИСТИНА,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	КорректировкаПоступленияУслуги.Количество,
	|	КорректировкаПоступленияУслуги.Количество,
	|	КорректировкаПоступленияУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИПоступления.СуммаВключаетНДС
	|			ТОГДА КорректировкаПоступленияУслуги.Сумма - КорректировкаПоступленияУслуги.СуммаНДС
	|		ИНАЧЕ КорректировкаПоступленияУслуги.Сумма
	|	КОНЕЦ,
	|	КорректировкаПоступленияУслуги.СтавкаНДС,
	|	КорректировкаПоступленияУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаПоступления.Услуги КАК КорректировкаПоступленияУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|		ПО (ДокументыКорректировкиИПоступления.ДокументКорректировки = КорректировкаПоступленияУслуги.Ссылка)
	|ГДЕ
	|	КорректировкаПоступленияУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаПоступленияАгентскиеУслуги.Ссылка,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	КорректировкаПоступленияАгентскиеУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаПоступленияАгентскиеУслуги.СодержаниеДоИзменения ПОДОБНО """"
	|			ТОГДА КорректировкаПоступленияАгентскиеУслуги.СодержаниеДоИзменения
	|		ИНАЧЕ КорректировкаПоступленияАгентскиеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	-КорректировкаПоступленияАгентскиеУслуги.КоличествоДоИзменения,
	|	-КорректировкаПоступленияАгентскиеУслуги.КоличествоДоИзменения,
	|	КорректировкаПоступленияАгентскиеУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИПоступления.СуммаВключаетНДС
	|			ТОГДА -(КорректировкаПоступленияАгентскиеУслуги.СуммаДоИзменения - КорректировкаПоступленияАгентскиеУслуги.СуммаНДСДоИзменения)
	|		ИНАЧЕ -КорректировкаПоступленияАгентскиеУслуги.СуммаДоИзменения
	|	КОНЕЦ,
	|	КорректировкаПоступленияАгентскиеУслуги.СтавкаНДСДоИзменения,
	|	-КорректировкаПоступленияАгентскиеУслуги.СуммаНДСДоИзменения,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаПоступления.АгентскиеУслуги КАК КорректировкаПоступленияАгентскиеУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|		ПО (ДокументыКорректировкиИПоступления.ДокументКорректировки = КорректировкаПоступленияАгентскиеУслуги.Ссылка)
	|ГДЕ
	|	КорректировкаПоступленияАгентскиеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	КорректировкаПоступленияАгентскиеУслуги.Ссылка,
	|	ДокументыКорректировкиИПоступления.ДокументПоступления,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход),
	|	КорректировкаПоступленияАгентскиеУслуги.Номенклатура,
	|	ВЫБОР
	|		КОГДА НЕ КорректировкаПоступленияАгентскиеУслуги.Содержание ПОДОБНО """"
	|			ТОГДА КорректировкаПоступленияАгентскиеУслуги.Содержание
	|		ИНАЧЕ КорректировкаПоступленияАгентскиеУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.Корректировка),
	|	КорректировкаПоступленияАгентскиеУслуги.Количество,
	|	КорректировкаПоступленияАгентскиеУслуги.Количество,
	|	КорректировкаПоступленияАгентскиеУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ДокументыКорректировкиИПоступления.СуммаВключаетНДС
	|			ТОГДА КорректировкаПоступленияАгентскиеУслуги.Сумма - КорректировкаПоступленияАгентскиеУслуги.СуммаНДС
	|		ИНАЧЕ КорректировкаПоступленияАгентскиеУслуги.Сумма
	|	КОНЕЦ,
	|	КорректировкаПоступленияАгентскиеУслуги.СтавкаНДС,
	|	КорректировкаПоступленияАгентскиеУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.КорректировкаПоступления.АгентскиеУслуги КАК КорректировкаПоступленияАгентскиеУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления
	|		ПО (ДокументыКорректировкиИПоступления.ДокументКорректировки = КорректировкаПоступленияАгентскиеУслуги.Ссылка)
	|ГДЕ
	|	КорректировкаПоступленияАгентскиеУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКорректировкиИПоступления.ДокументКорректировки
	|			ИЗ
	|				ДокументыКорректировкиИПоступления КАК ДокументыКорректировкиИПоступления)";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКорректировкиИПоступления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();

	
КонецПроцедуры

Процедура ДобавитьСделкиОтчетаКомиссионераОПродажахЗависимымЛицам(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажах.Организация КАК Организация,
	|	ОтчетКомиссионераОПродажах.Дата КАК Период,
	|	ОтчетКомиссионераОПродажах.Ссылка КАК РасчетныйДокумент,
	|	ОтчетКомиссионераОПродажах.Контрагент КАК Комиссионер,
	|	ОтчетКомиссионераОПродажахПокупатели.Покупатель КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка) КАК ДоговорКонтрагента,
	|	ОтчетКомиссионераОПродажах.Контрагент КАК Грузоотправитель,
	|	НЕОПРЕДЕЛЕНО КАК Грузополучатель,
	|	ОтчетКомиссионераОПродажах.ВалютаДокумента КАК ВалютаДокумента,
	|	ОтчетКомиссионераОПродажах.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ОтчетКомиссионераОПродажах.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ОтчетКомиссионераОПродажах.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах КАК ОтчетКомиссионераОПродажах
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажахПокупатели
	|		ПО ОтчетКомиссионераОПродажах.Ссылка = ОтчетКомиссионераОПродажахПокупатели.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОтчетКомиссионераОПродажахПокупатели.Покупатель)
	|			И ОтчетКомиссионераОПродажах.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ОтчетКомиссионераОПродажах.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|ГДЕ
	|	ОтчетКомиссионераОПродажах.Организация В(&СтруктураОрганизации)
	|	И ОтчетКомиссионераОПродажах.Дата >= &НачалоПериода
	|	И ОтчетКомиссионераОПродажах.Дата <= &ОкончаниеПериода
	|	И ОтчетКомиссионераОПродажах.Проведен = ИСТИНА
	|	И ОтчетКомиссионераОПродажахПокупатели.Покупатель В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажахТовары.Ссылка КАК Сделка,
	|	ОтчетКомиссионераОПродажахТовары.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ОтчетКомиссионераОПродажахТовары.Номенклатура КАК ПредметСделки,
	|	ОтчетКомиссионераОПродажахТовары.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.Товар) КАК ТипПредметаСделки,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.РасчетныйДокумент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхТоваров) КАК ХозяйственнаяОперация,
	|	ОтчетКомиссионераОПродажахТовары.Количество КАК Количество,
	|	ОтчетКомиссионераОПродажахТовары.Количество КАК КоличествоВУчете,
	|	ОтчетКомиссионераОПродажахТовары.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераОПродажахТовары.Ссылка.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераОПродажахТовары.Сумма - ОтчетКомиссионераОПродажахТовары.СуммаНДС
	|		ИНАЧЕ ОтчетКомиссионераОПродажахТовары.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ОтчетКомиссионераОПродажахТовары.СтавкаНДС КАК СтавкаНДС,
	|	ОтчетКомиссионераОПродажахТовары.СуммаНДС КАК СуммаНДС,
	|	ОтчетКомиссионераОПродажахТовары.СтранаПроисхождения КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах.Товары КАК ОтчетКомиссионераОПродажахТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажахПокупатели
	|		ПО (ОтчетКомиссионераОПродажахПокупатели.КлючСтроки = ОтчетКомиссионераОПродажахТовары.КлючСтроки)
	|			И (ОтчетКомиссионераОПродажахПокупатели.Ссылка = ОтчетКомиссионераОПродажахТовары.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ОтчетКомиссионераОПродажахТовары.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			И (ДокументыКонтролируемыхСделок.Контрагент = ОтчетКомиссионераОПродажахПокупатели.Покупатель)
	|ГДЕ
	|	ОтчетКомиссионераОПродажахТовары.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ОтчетКомиссионераОПродажахУслуги.Ссылка,
	|	ОтчетКомиссионераОПродажахУслуги.Ссылка,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход),
	|	ОтчетКомиссионераОПродажахУслуги.Номенклатура,
	|	ОтчетКомиссионераОПродажахУслуги.Номенклатура.НаименованиеПолное,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга),
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.РасчетныйДокумент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ,
	|	ИСТИНА,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг),
	|	ОтчетКомиссионераОПродажахУслуги.Количество,
	|	ОтчетКомиссионераОПродажахУслуги.Количество,
	|	ОтчетКомиссионераОПродажахУслуги.Номенклатура.ЕдиницаИзмерения,
	|	ВЫБОР
	|		КОГДА ОтчетКомиссионераОПродажахУслуги.Ссылка.СуммаВключаетНДС
	|			ТОГДА ОтчетКомиссионераОПродажахУслуги.Сумма - ОтчетКомиссионераОПродажахУслуги.СуммаНДС
	|		ИНАЧЕ ОтчетКомиссионераОПродажахУслуги.Сумма
	|	КОНЕЦ,
	|	ОтчетКомиссионераОПродажахУслуги.СтавкаНДС,
	|	ОтчетКомиссионераОПродажахУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка),
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.ОтчетКомиссионераОПродажах.Услуги КАК ОтчетКомиссионераОПродажахУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОтчетКомиссионераОПродажах.Покупатели КАК ОтчетКомиссионераОПродажахПокупатели
	|		ПО (ОтчетКомиссионераОПродажахПокупатели.КлючСтроки = ОтчетКомиссионераОПродажахУслуги.КлючСтроки)
	|			И (ОтчетКомиссионераОПродажахПокупатели.Ссылка = ОтчетКомиссионераОПродажахУслуги.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ОтчетКомиссионераОПродажахУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			И (ДокументыКонтролируемыхСделок.Контрагент = ОтчетКомиссионераОПродажахПокупатели.Покупатель)
	|ГДЕ
	|	ОтчетКомиссионераОПродажахУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Комиссионер КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ЛОЖЬ КАК ИностранныйКонтрагент,
	|	ЛОЖЬ КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();

КонецПроцедуры

Процедура ДобавитьСделкиПоступленияИзПереработки(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПоступлениеИзПереработки.Организация КАК Организация,
	|	ПоступлениеИзПереработки.Дата КАК Период,
	|	ПоступлениеИзПереработки.Ссылка КАК РасчетныйДокумент,
	|	ПоступлениеИзПереработки.Контрагент КАК Контрагент,
	|	ПоступлениеИзПереработки.Организация КАК Грузополучатель,
	|	НЕОПРЕДЕЛЕНО КАК Грузоотправитель,
	|	ПоступлениеИзПереработки.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ПоступлениеИзПереработки.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ПоступлениеИзПереработки.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ПоступлениеИзПереработки.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ПоступлениеИзПереработки.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов,
	|	ПоступлениеИзПереработки.ДоговорКонтрагента.УчетАгентскогоНДС КАК УчетАгентскогоНДС
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ПоступлениеИзПереработки КАК ПоступлениеИзПереработки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ПоступлениеИзПереработки.Контрагент)
	|			И ПоступлениеИзПереработки.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода
	|			И ПоступлениеИзПереработки.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ПоступлениеИзПереработки.Контрагент)
	|ГДЕ
	|	ПоступлениеИзПереработки.Организация В(&СтруктураОрганизации)
	|	И ПоступлениеИзПереработки.Дата >= &НачалоПериода
	|	И ПоступлениеИзПереработки.Дата <= &ОкончаниеПериода
	|	И ПоступлениеИзПереработки.Проведен = ИСТИНА
	|	И ПоступлениеИзПереработки.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.УчетАгентскогоНДС КАК УчетАгентскогоНДС,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетКт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетДт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.НДС,
	|		ВЫБОР
	|			КОГДА ДокументыКонтролируемыхСделокВВалюте.УчетАгентскогоНДС
	|				ТОГДА НДСПредъявленный.НДС
	|			ИНАЧЕ 0
	|		КОНЕЦ
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСПредъявленный.Регистратор
	|				И (НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход))) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоступлениеИзПереработкиУслуги.Ссылка КАК Сделка,
	|	ПоступлениеИзПереработкиУслуги.Ссылка КАК РасчетныйДокумент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ОсуществленРасход) КАК ТипКонтролируемойСделки,
	|	ПоступлениеИзПереработкиУслуги.Номенклатура КАК ПредметСделки,
	|	ВЫБОР
	|		КОГДА НЕ ПоступлениеИзПереработкиУслуги.Содержание ПОДОБНО """"
	|			ТОГДА ПоступлениеИзПереработкиУслуги.Содержание
	|		ИНАЧЕ ПоступлениеИзПереработкиУслуги.Номенклатура.НаименованиеПолное
	|	КОНЕЦ КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.ПолучениеУслуг) КАК ХозяйственнаяОперация,
	|	ПоступлениеИзПереработкиУслуги.Количество,
	|	ПоступлениеИзПереработкиУслуги.Количество КАК КоличествоВУчете,
	|	ПоступлениеИзПереработкиУслуги.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ПоступлениеИзПереработкиУслуги.Сумма - ПоступлениеИзПереработкиУслуги.СуммаНДС
	|		ИНАЧЕ ПоступлениеИзПереработкиУслуги.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ПоступлениеИзПереработкиУслуги.СтавкаНДС,
	|	ПоступлениеИзПереработкиУслуги.СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ЛОЖЬ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ПоступлениеИзПереработки.Услуги КАК ПоступлениеИзПереработкиУслуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ПоступлениеИзПереработкиУслуги.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|ГДЕ
	|	ПоступлениеИзПереработкиУслуги.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

Процедура ДобавитьСделкиОказанияУслуг(Уведомление, МенеджерВременныхТаблиц, ТаблицаСделок)
	
	ПараметрыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация, ОтчетныйГод");
	СтруктураОрганизации = БухгалтерскийУчетПереопределяемый.СтруктураОрганизации(ПараметрыУведомления.Организация);
	Организации = СтруктураОрганизации.Организация;
	
	ВалютаРегламентированногоУчета = Константы.ВалютаРегламентированногоУчета.Получить();
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("СтруктураОрганизации", Организации);
	Запрос.УстановитьПараметр("Организация", ПараметрыУведомления.Организация);
	Запрос.УстановитьПараметр("НачалоПериода", НачалоГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ОкончаниеПериода", КонецГода(ПараметрыУведомления.ОтчетныйГод));
	Запрос.УстановитьПараметр("ВалютаРегламентированногоУчета", ВалютаРегламентированногоУчета);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ОказаниеУслуг.Организация КАК Организация,
	|	ОказаниеУслуг.Дата КАК Период,
	|	ОказаниеУслуг.Ссылка КАК РасчетныйДокумент,
	|	ОказаниеУслугКонтрагенты.Контрагент КАК Контрагент,
	|	ОказаниеУслугКонтрагенты.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ОказаниеУслуг.Организация КАК Грузоотправитель,
	|	ОказаниеУслугКонтрагенты.Контрагент КАК Грузополучатель,
	|	ОказаниеУслугКонтрагенты.СчетУчетаРасчетовСКонтрагентом КАК СчетУчетаРасчетов,
	|	ОказаниеУслуг.ВалютаДокумента КАК ВалютаДокумента,
	|	ОказаниеУслуг.СуммаВключаетНДС КАК СуммаВключаетНДС,
	|	ВЫБОР
	|		КОГДА ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ВзаимозависимыеЛица,
	|	ВЫБОР
	|		КОГДА ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ИностранныйКонтрагент,
	|	ЕСТЬNULL(ИностранныеКонтрагенты.ЗарегистрированВСтранеСЛьготнымНалогообложением, ЛОЖЬ) КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ОказаниеУслугКонтрагенты.ДоговорКонтрагента.ВалютаВзаиморасчетов КАК ВалютаВзаиморасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделок
	|ИЗ
	|	Документ.ОказаниеУслуг.Контрагенты КАК ОказаниеУслугКонтрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОказаниеУслуг КАК ОказаниеУслуг
	|		ПО ОказаниеУслугКонтрагенты.Ссылка = ОказаниеУслуг.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВзаимозависимыеЛицаПоПериодам КАК ВзаимозависимыеЛицаПоПериодам
	|		ПО (ВзаимозависимыеЛицаПоПериодам.Организация = &Организация)
	|			И (ВзаимозависимыеЛицаПоПериодам.Контрагент = ОказаниеУслугКонтрагенты.Контрагент)
	|			И (ОказаниеУслуг.Дата >= ВзаимозависимыеЛицаПоПериодам.НачалоПериода)
	|			И (ОказаниеУслуг.Дата <= ВзаимозависимыеЛицаПоПериодам.ОкончаниеПериода)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИностранныеКонтрагенты КАК ИностранныеКонтрагенты
	|		ПО (ИностранныеКонтрагенты.Контрагент = ОказаниеУслугКонтрагенты.Контрагент)
	|ГДЕ
	|	ОказаниеУслуг.Организация В(&СтруктураОрганизации)
	|	И ОказаниеУслуг.Дата >= &НачалоПериода
	|	И ОказаниеУслуг.Дата <= &ОкончаниеПериода
	|	И ОказаниеУслуг.Проведен = ИСТИНА
	|	И ОказаниеУслугКонтрагенты.Контрагент В
	|			(ВЫБРАТЬ
	|				КонтролируемыеКонтрагенты.Контрагент
	|			ИЗ
	|				КонтролируемыеКонтрагенты КАК КонтролируемыеКонтрагенты)
	|	И (НЕ ВзаимозависимыеЛицаПоПериодам.Контрагент ЕСТЬ NULL
	|			ИЛИ НЕ ИностранныеКонтрагенты.Контрагент ЕСТЬ NULL)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	РасчетныйДокумент
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов КАК СчетУчетаРасчетов
	|ПОМЕСТИТЬ ДокументыКонтролируемыхСделокВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|ГДЕ
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.СчетУчетаРасчетов";
	
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОплатыКонтролируемыхСделок.Сделка КАК Сделка,
	|	СУММА(ОплатыКонтролируемыхСделок.СуммаНДСВРублях) КАК СуммаНДСВРублях,
	|	СУММА(ОплатыКонтролируемыхСделок.ВсегоВРублях) КАК ВсегоВРублях
	|ИЗ
	|	(ВЫБРАТЬ
	|		РасчетыДокумента.Регистратор КАК Сделка,
	|		0 КАК СуммаНДСВРублях,
	|		РасчетыДокумента.Сумма КАК ВсегоВРублях
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрБухгалтерии.Хозрасчетный КАК РасчетыДокумента
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = РасчетыДокумента.Регистратор
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов = РасчетыДокумента.СчетДт
	|				И ДокументыКонтролируемыхСделокВВалюте.СчетУчетаРасчетов <> РасчетыДокумента.СчетКт
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор,
	|		НДСЗаписиКнигиПродаж.НДС,
	|		0
	|	ИЗ
	|		ДокументыКонтролируемыхСделокВВалюте КАК ДокументыКонтролируемыхСделокВВалюте
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ПО ДокументыКонтролируемыхСделокВВалюте.РасчетныйДокумент = НДСЗаписиКнигиПродаж.Регистратор) КАК ОплатыКонтролируемыхСделок
	|
	|СГРУППИРОВАТЬ ПО
	|	ОплатыКонтролируемыхСделок.Сделка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОказаниеУслугКонтрагенты.Ссылка КАК Сделка,
	|	ОказаниеУслугКонтрагенты.Ссылка КАК РасчетныйДокумент,
	|	ОказаниеУслугКонтрагенты.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыКонтролируемыхСделок.ПолученДоход) КАК ТипКонтролируемойСделки,
	|	ОказаниеУслугКонтрагенты.Ссылка.Номенклатура КАК ПредметСделки,
	|	ОказаниеУслугКонтрагенты.Ссылка.Номенклатура.НаименованиеПолное КАК НаименованиеПредметаСделки,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыПредметовКонтролируемыхСделок.РаботаУслуга) КАК ТипПредметаСделки,
	|	ИСТИНА КАК ВключатьСоставСделок,
	|	ИСТИНА КАК УчитыватьНДСПриРаспределении,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперацииКонтролируемыхСделок.РеализацияСобственныхУслуг) КАК ХозяйственнаяОперация,
	|	ОказаниеУслугКонтрагенты.Количество КАК Количество,
	|	ОказаниеУслугКонтрагенты.Количество КАК КоличествоВУчете,
	|	ОказаниеУслуг.Номенклатура.ЕдиницаИзмерения КАК ЕдиницаИзмеренияПоКлассификатору,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.СуммаВключаетНДС
	|			ТОГДА ОказаниеУслугКонтрагенты.Сумма - ОказаниеУслугКонтрагенты.СуммаНДС
	|		ИНАЧЕ ОказаниеУслугКонтрагенты.Сумма
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ОказаниеУслугКонтрагенты.Ссылка.СтавкаНДС КАК СтавкаНДС,
	|	ОказаниеУслугКонтрагенты.СуммаНДС КАК СуммаНДС,
	|	ЗНАЧЕНИЕ(Справочник.СтраныМира.ПустаяСсылка) КАК СтранаПроисхождения,
	|	ЛОЖЬ КАК ТоварМировойБиржевойТорговли,
	|	ВЫБОР
	|		КОГДА СчетаДоходовИРасходовЕНВД.Счет ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ОперацияОблагаетсяЕНВД
	|ИЗ
	|	Документ.ОказаниеУслуг.Контрагенты КАК ОказаниеУслугКонтрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ОказаниеУслуг КАК ОказаниеУслуг
	|		ПО ОказаниеУслугКонтрагенты.Ссылка = ОказаниеУслуг.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|		ПО ОказаниеУслугКонтрагенты.Ссылка = ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			И ОказаниеУслугКонтрагенты.Контрагент = ДокументыКонтролируемыхСделок.Контрагент
	|			И ОказаниеУслугКонтрагенты.ДоговорКонтрагента = ДокументыКонтролируемыхСделок.ДоговорКонтрагента
	|			И ОказаниеУслугКонтрагенты.СчетУчетаРасчетовСКонтрагентом = ДокументыКонтролируемыхСделок.СчетУчетаРасчетов
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаДоходовИРасходовЕНВД КАК СчетаДоходовИРасходовЕНВД
	|		ПО (ОказаниеУслуг.СчетДоходов = СчетаДоходовИРасходовЕНВД.Счет)
	|ГДЕ
	|	ОказаниеУслугКонтрагенты.Ссылка В
	|			(ВЫБРАТЬ
	|				ДокументыКонтролируемыхСделок.РасчетныйДокумент
	|			ИЗ
	|				ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок)
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	Результаты = Запрос.ВыполнитьПакет();
	РублевыеСуммыСделок = Результаты[0].Выгрузить();
	СделкиДокумента = Результаты[1].Выгрузить();
	
	СделкиДокумента.Индексы.Добавить("Сделка");
	СделкиДокумента.Индексы.Добавить("РасчетныйДокумент");
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&Организация КАК Организация,
	|	ДокументыКонтролируемыхСделок.Период КАК Период,
	|	ДокументыКонтролируемыхСделок.РасчетныйДокумент КАК РасчетныйДокумент,
	|	ДокументыКонтролируемыхСделок.Контрагент КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Комиссионер,
	|	ДокументыКонтролируемыхСделок.ВзаимозависимыеЛица КАК ВзаимозависимыеЛица,
	|	ДокументыКонтролируемыхСделок.ИностранныйКонтрагент КАК ИностранныйКонтрагент,
	|	ДокументыКонтролируемыхСделок.ЗарегистрированВСтранеСЛьготнымНалогообложением КАК ЗарегистрированВСтранеСЛьготнымНалогообложением,
	|	ДокументыКонтролируемыхСделок.Грузоотправитель КАК Грузоотправитель,
	|	ДокументыКонтролируемыхСделок.Грузополучатель КАК Грузополучатель,
	|	ДокументыКонтролируемыхСделок.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	ДокументыКонтролируемыхСделок.ВалютаДокумента КАК ВалютаДокумента,
	|	ВЫБОР
	|		КОГДА ДокументыКонтролируемыхСделок.ВалютаДокумента <> &ВалютаРегламентированногоУчета
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК РасчетыВВалюте
	|ИЗ
	|	ДокументыКонтролируемыхСделок КАК ДокументыКонтролируемыхСделок
	|
	|УПОРЯДОЧИТЬ ПО
	|	РасчетныйДокумент";
	
	КонтролируемыеСделкиВыборка = Запрос.Выполнить().Выбрать();
	
	ЗаполнитьРублевыеСуммыСделок(РублевыеСуммыСделок, СделкиДокумента);
	
	Пока КонтролируемыеСделкиВыборка.Следующий() Цикл
		
		ОбработатьКонтролируемуюСделку(ТаблицаСделок, КонтролируемыеСделкиВыборка, СделкиДокумента);
		
	КонецЦикла;
	
	ЗапросУдаленияВременныхТаблиц = Новый Запрос();
	ЗапросУдаленияВременныхТаблиц.МенеджерВременныхТаблиц = Запрос.МенеджерВременныхТаблиц;
	ЗапросУдаленияВременныхТаблиц.Текст = 
	"УНИЧТОЖИТЬ ДокументыКонтролируемыхСделок
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыКонтролируемыхСделокВВалюте";
	
	ЗапросУдаленияВременныхТаблиц.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область ПараметрыДляРегламентированнойОтчетности

Функция ПолучитьСведенияОбУведомлении(Уведомление) Экспорт
	
	Реквизиты = Новый Структура();
	Реквизиты.Вставить("Уведомление", "Ссылка");
	Реквизиты.Вставить("КодМестаПредставления", "КодМестаПредставления");
	Реквизиты.Вставить("Организация", "Организация");
	Реквизиты.Вставить("НаименованиеОрганизации", "Организация.НаименованиеПолное");
	Реквизиты.Вставить("ИНН", "Организация.ИНН");
	Реквизиты.Вставить("КПП", "Организация.КПП");
	Реквизиты.Вставить("КрупнейшийНалогоплательщик", "Организация.КрупнейшийНалогоплательщик");
	Реквизиты.Вставить("ОтчетныйГод", "ОтчетныйГод");
	Реквизиты.Вставить("ВерсияУведомления", "ВерсияУведомления");
	Реквизиты.Вставить("ЮридическоеФизическоеЛицо", "Организация.ЮридическоеФизическоеЛицо");
	Реквизиты.Вставить("НомерКорректировки", "НомерКорректировки");
	Реквизиты.Вставить("ИндивидуальныйПредприниматель", "Организация.ИндивидуальныйПредприниматель");
	Реквизиты.Вставить("ВерсияУведомления", "ВерсияУведомления");
	
	Сведения = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, Реквизиты);
	
	ДатаСведений = ТекущаяДатаСеанса();
	
	Если Сведения.ЮридическоеФизическоеЛицо = Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо
		И ЗначениеЗаполнено(Сведения.ИндивидуальныйПредприниматель) Тогда
		
		Сведения.Вставить("ИндивидуальныйПредпринимательФИО", ПолучитьФИОФизлица(Сведения.ИндивидуальныйПредприниматель, ДатаСведений));
		
	КонецЕсли;
	
	// Представление отчета по месту регистрации в качестве крупнейшего налогоплательщика.
	Если Сведения.КодМестаПредставления = КодМестаПредставленияКрупнейший() И Сведения.КрупнейшийНалогоплательщик Тогда
		РеквизитыКН = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(Сведения.Организация,
			ДатаСведений, "КППЮЛКрупнейший");
		Сведения.Вставить("КПП", РеквизитыКН.КППЮЛКрупнейший);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Сведения.ВерсияУведомления) Тогда
		Сведения.ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012();
	КонецЕсли;
	
	Сведения.Вставить("ПараметрыВерсии", ПараметрыВерсииУведомления(Сведения.ВерсияУведомления));
	
	Возврат Сведения;
	
КонецФункции

Функция КодМестаПредставленияКрупнейший() Экспорт
	Возврат "213";
КонецФункции

Функция ПараметрыВерсииУведомления(Версия)
	
	ПараметрыПечати = Новый Структура();
	
	Если Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 3);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 10);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1_2024");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2_2024");
		Макеты.Вставить("Лист1А", "Страница1А_2024");
		Макеты.Вставить("Лист1Б", "Страница1Б_2024");
		Макеты.Вставить("Лист1В", "Страница1В_2024");
		Макеты.Вставить("Лист1Г", "Страница1Г_2024");
		Макеты.Вставить("Раздел2", "Раздел2_2024");
		Макеты.Вставить("Раздел3", "Раздел3_2024");
		Макеты.Вставить("Раздел4", "Раздел4_2024");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	ИначеЕсли Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019() Тогда
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 3);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 6);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1_2019");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2_2019");
		Макеты.Вставить("Лист1А", "Страница1А_2019");
		Макеты.Вставить("Лист1Б", "Страница1Б_2019");
		Макеты.Вставить("Лист1В", "");
		Макеты.Вставить("Лист1Г", "");
		Макеты.Вставить("Раздел2", "Раздел2_2019");
		Макеты.Вставить("Раздел3", "Раздел3_2019");
		Макеты.Вставить("Раздел4", "");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	ИначеЕсли Версия >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 3);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 6);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1_2018");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2_2018");
		Макеты.Вставить("Лист1А", "Страница1А_2018");
		Макеты.Вставить("Лист1Б", "Страница1Б_2018");
		Макеты.Вставить("Лист1В", "");
		Макеты.Вставить("Лист1Г", "");
		Макеты.Вставить("Раздел2", "Раздел2_2018");
		Макеты.Вставить("Раздел3", "Раздел3_2018");
		Макеты.Вставить("Раздел4", "");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	Иначе
		
		ПараметрыПечати.Вставить("ДлинаНомераСтраница", 5);
		ПараметрыПечати.Вставить("ДлинаНомераЛистовРаздела1", 6);
		
		Макеты = Новый Структура;
		Макеты.Вставить("ТитульныйЛист", "Лист1");
		Макеты.Вставить("ТитульныйЛистФизическоеЛицо", "Лист2");
		Макеты.Вставить("Лист1А", "Страница1А");
		Макеты.Вставить("Лист1Б", "Страница1Б");
		Макеты.Вставить("Лист1В", "");
		Макеты.Вставить("Лист1Г", "");
		Макеты.Вставить("Раздел2", "Раздел2");
		Макеты.Вставить("Раздел3", "Раздел3");
		Макеты.Вставить("Раздел4", "");
		
		ПараметрыПечати.Вставить("Макеты", Макеты);
		
	КонецЕсли;
	
	Возврат ПараметрыПечати;
	
КонецФункции

Функция СведенияОбОрганизацииДляОтправки(Уведомление, ДатаСведений) Экспорт
	
	РеквизитыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление,
		"Организация, КодМестаПредставления");
	
	СведенияОбОрганизацииДляОтправки = Новый Структура;
	СведенияОбОрганизацииДляОтправки.Вставить("Организация", РеквизитыУведомления.Организация);
	
	ПараметрыОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(РеквизитыУведомления.Организация,
		"ИНН, КПП, НаименованиеПолное, КодНалоговогоОргана, ЮридическоеФизическоеЛицо, РегистрацияВНалоговомОргане, КрупнейшийНалогоплательщик");
	
	СведенияОбОрганизацииДляОтправки.Вставить("ЮридическоеФизическоеЛицо", ПараметрыОрганизации.ЮридическоеФизическоеЛицо);
	СведенияОбОрганизацииДляОтправки.Вставить("ИНН", ПараметрыОрганизации.ИНН);
	СведенияОбОрганизацииДляОтправки.Вставить("КПП", ПараметрыОрганизации.КПП);
	СведенияОбОрганизацииДляОтправки.Вставить("НаименованиеПолное", ПараметрыОрганизации.НаименованиеПолное);
	СведенияОбОрганизацииДляОтправки.Вставить("РегистрацияВНалоговомОргане", ПараметрыОрганизации.РегистрацияВНалоговомОргане);
	
	ОКТМО = "";
	Если ЗначениеЗаполнено(ПараметрыОрганизации.РегистрацияВНалоговомОргане) Тогда
		ОКТМО = СокрЛП(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПараметрыОрганизации.РегистрацияВНалоговомОргане, "КодПоОКТМО"));
	КонецЕсли;
	СведенияОбОрганизацииДляОтправки.Вставить("ОКТМО", ОКТМО);
	
	СведенияОбОрганизацииДляОтправки.Вставить("КодНалоговогоОргана", 
		ПараметрыОрганизации.КодНалоговогоОргана);
	
	СведенияОбОрганизацииДляОтправки.Вставить("КодМестаПредставления", РеквизитыУведомления.КодМестаПредставления);
	
	// Представление отчета по месту регистрации в качестве крупнейшего налогоплательщика.
	Если РеквизитыУведомления.КодМестаПредставления = КодМестаПредставленияКрупнейший() И ПараметрыОрганизации.КрупнейшийНалогоплательщик Тогда
		РеквизитыКН = РегламентированнаяОтчетностьВызовСервера.ПолучитьСведенияОбОрганизации(РеквизитыУведомления.Организация,
			ДатаСведений, "КодНОКрупнейший, КППЮЛКрупнейший, ОКТМОКрупнейший");
		СведенияОбОрганизацииДляОтправки.Вставить("КодНалоговогоОргана", РеквизитыКН.КодНОКрупнейший);
		СведенияОбОрганизацииДляОтправки.Вставить("КПП", РеквизитыКН.КППЮЛКрупнейший);
		СведенияОбОрганизацииДляОтправки.Вставить("ОКТМО", СокрЛП(РеквизитыКН.ОКТМОКрупнейший));
	КонецЕсли;
	
	ДобавитьСведенияОПодписанте(СведенияОбОрганизацииДляОтправки, ДатаСведений);
	
	Возврат СведенияОбОрганизацииДляОтправки;
	
КонецФункции

Процедура ДобавитьСведенияОПодписанте(СведенияОбОрганизацииДляОтправки, ДатаСведений)
	
	ТипПодписанта = "1";
	
	Организация = СведенияОбОрганизацииДляОтправки.Организация;
	КодНО = СведенияОбОрганизацииДляОтправки.КодНалоговогоОргана;
	КПП   = ?(СведенияОбОрганизацииДляОтправки.Свойство("КПП"), СведенияОбОрганизацииДляОтправки.КПП, "");
	
	СведенияОПредставителе = РегламентированнаяОтчетностьВызовСервера.ПолучитьПоКодамСведенияОПредставителе(Организация, КодНО, КПП);
	
	Подписант = Новый Структура;
	СведенияОбОрганизацииДляОтправки.Вставить("Подписант", Подписант);
	
	Подписант.Вставить("ПризнакПодписанта", "1");
	Подписант.Вставить("Фамилия", "");
	Подписант.Вставить("Имя", "");
	Подписант.Вставить("Отчество", "");
	Подписант.Вставить("НаименованиеОрганизацииПредставителя", "");
	Подписант.Вставить("НаименованиеДоверенностиПредставителя", "");
	
	ТипПодписанта = СведенияОПредставителе.ТипПодписанта;
	Подписант.ПризнакПодписанта = ТипПодписанта;
	
	Если ТипПодписанта = "1" Тогда
		// Представителя нет.
		Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Организация, "ЮридическоеФизическоеЛицо")
				= Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо Тогда
			// ФИО подписанта не заполняется.
		Иначе
			РеквизитыОтветственныхЛиц = ОтветственныеЛицаБП.ОтветственныеЛица(Организация, ДатаСведений);
			
			Подписант.Фамилия = РеквизитыОтветственныхЛиц.РуководительФИО.Фамилия;
			Подписант.Имя = РеквизитыОтветственныхЛиц.РуководительФИО.Имя;
			Подписант.Отчество = РеквизитыОтветственныхЛиц.РуководительФИО.Отчество;
		КонецЕсли;
	Иначе
		// Есть представитель.
		Если ТипЗнч(СведенияОПредставителе.ПредставительСсылка) = Тип("СправочникСсылка.Контрагенты") Тогда
			ФИОПодписанта = ФизическиеЛицаКлиентСервер.ЧастиИмени(СведенияОПредставителе.ФИОПредставителя);
			Подписант.Вставить("НаимОргПодп", СведенияОПредставителе.НаименованиеОрганизацииПредставителя);
		Иначе
			ФИОПодписанта = ПолучитьФИОФизлица(СведенияОПредставителе.ПредставительСсылка, ДатаСведений);
		КонецЕсли;
		
		Подписант.Вставить("Фамилия", ФИОПодписанта.Фамилия);
		Подписант.Вставить("Имя", ФИОПодписанта.Имя);
		Подписант.Вставить("Отчество", ФИОПодписанта.Отчество);
		
		Подписант.Вставить("НаименованиеДоверенностиПредставителя", СведенияОПредставителе.ДокументПредставителя);
		
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьОсновныеСведенияУведомленияДляВыгрузки(Уведомление) Экспорт
	
	ОсновныеСведения = Новый Структура;
	
	РеквизитыУведомления = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление,
		"Организация, НомерКорректировки, ВерсияУведомления, КодМестаПредставления,
		|ОтчетныйГод, КодФормыРеорганизации, ИННРеорганизованнойОрганизации, КППРеорганизованнойОрганизации");
	
	ВерсияУведомления = РеквизитыУведомления.ВерсияУведомления;
	Организация  = РеквизитыУведомления.Организация;
	ДатаСведений = ТекущаяДатаСеанса();
	
	СведенияОбОрганизацииДляОтправки = СведенияОбОрганизацииДляОтправки(Уведомление, ДатаСведений);
	
	ОсновныеСведения.Вставить("ВерсияУведомления", ВерсияУведомления);
	ОсновныеСведения.Вставить("Организация", Организация);
	ОсновныеСведения.Вставить("ДатаДок", ДатаСведений);
	ОсновныеСведения.Вставить("НомКорр", Формат(РеквизитыУведомления.НомерКорректировки, "ЧН=; ЧГ=0"));
	ОсновныеСведения.Вставить("ПоМесту", СведенияОбОрганизацииДляОтправки.КодМестаПредставления);
	ОсновныеСведения.Вставить("ВерсПрог", РегламентированнаяОтчетность.НазваниеИВерсияПрограммы());
	
	Если РеквизитыУведомления.КодФормыРеорганизации <> "" Тогда
		ОсновныеСведения.Вставить("ФормРеорг",  РеквизитыУведомления.КодФормыРеорганизации);
		ОсновныеСведения.Вставить("ИННЮЛРеорг", РеквизитыУведомления.ИННРеорганизованнойОрганизации);
		ОсновныеСведения.Вставить("КППЮЛРеорг", РеквизитыУведомления.КППРеорганизованнойОрганизации);
	КонецЕсли;
	
	ОтчетГод = Формат(РеквизитыУведомления.ОтчетныйГод, "ДФ=yyyy");
	ОсновныеСведения.Вставить("ОтчетГод", ОтчетГод);
	ОсновныеСведения.Вставить("ОтчетныйГод", РеквизитыУведомления.ОтчетныйГод);
	
	ПараметрыОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Организация,
		"НаименованиеПолное, ЮридическоеФизическоеЛицо, ИндивидуальныйПредприниматель,
		|КодОКВЭД, КодОКВЭД2, КрупнейшийНалогоплательщик");
	
	ОрганизацияФизЛицо = СведенияОбОрганизацииДляОтправки.ЮридическоеФизическоеЛицо = Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо;
	
	ТелефонОрганизации = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(
		Организация, Справочники.ВидыКонтактнойИнформации.ТелефонОрганизации);
	ЭлектроннаяПочтаОрганизации = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(Организация,
		Справочники.ВидыКонтактнойИнформации.EmailОрганизации);
	
	ТелефонОрганизации = СтрЗаменить(ТелефонОрганизации, " ", "");
	
	ОКАТО = "";
	
	Если ЗначениеЗаполнено(СведенияОбОрганизацииДляОтправки.РегистрацияВНалоговомОргане) Тогда
		ОКАТО = СокрЛП(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СведенияОбОрганизацииДляОтправки.РегистрацияВНалоговомОргане, "КодПоОКАТО"));
	КонецЕсли;
	
	Если ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		Если СтрДлина(СведенияОбОрганизацииДляОтправки.ОКТМО) > 0 Тогда
			Пока СтрДлина(СведенияОбОрганизацииДляОтправки.ОКТМО)< 11 Цикл
				СведенияОбОрганизацииДляОтправки.ОКТМО = СведенияОбОрганизацииДляОтправки.ОКТМО + "0";
			КонецЦикла;
		КонецЕсли;
		Если РеквизитыУведомления.ОтчетныйГод < Дата(2012,12,31) Тогда
			ОсновныеСведения.Вставить("ОКАТО", ОКАТО);
		Иначе
			ОсновныеСведения.Вставить("ОКАТО", СведенияОбОрганизацииДляОтправки.ОКТМО);
		КонецЕсли;
		ОсновныеСведения.Вставить("ОКВЭД", ПараметрыОрганизации.КодОКВЭД);
	Иначе
		ОсновныеСведения.Вставить("ОКТМО", СведенияОбОрганизацииДляОтправки.ОКТМО);
	КонецЕсли;
	
	Если ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012() Тогда
		ОсновныеСведения.Вставить("ОКВЭД", ПараметрыОрганизации.КодОКВЭД);
	Иначе
		ОсновныеСведения.Вставить("ОКВЭД", ПараметрыОрганизации.КодОКВЭД2);
	КонецЕсли;
	
	ОсновныеСведения.Вставить("Тлф",   ТелефонОрганизации);
	ОсновныеСведения.Вставить("ЭлПочта", ЭлектроннаяПочтаОрганизации);
	
	ОсновныеСведения.Вставить("НаименованиеОрганизации", СведенияОбОрганизацииДляОтправки.НаименованиеПолное);
	ОсновныеСведения.Вставить("РегистрацияВНалоговомОргане", СведенияОбОрганизацииДляОтправки.РегистрацияВНалоговомОргане);
	
	Если ОрганизацияФизЛицо Тогда
		ИНН = СведенияОбОрганизацииДляОтправки.ИНН;
		ЕстьИНН = ЗначениеЗаполнено(ИНН);
		
		ОсновныеСведения.Вставить("ЭтоПБОЮЛ", Истина);
		ОсновныеСведения.Вставить("ИндивидуальныйПредприниматель", ПараметрыОрганизации.ИндивидуальныйПредприниматель);
		ОсновныеСведения.Вставить("ЕстьИННФЛ", ЕстьИНН);
		ОсновныеСведения.Вставить("ИННФЛ", ИНН);
		
		СписокКадровыхДанных = "Фамилия, Имя, Отчество, ФамилияИО, ФИОПолные, ДокументВид, ДокументСерия, ДокументНомер, ДокументДатаВыдачи, ДокументКемВыдан, ДокументКодПодразделения, ДокументПредставление, Страна, СтатусНалогоплательщика, ДатаРождения, МестоРождения, АдресПоПрописке, АдресЗаПределамиРФ";
		
		КадровыеДанныеФизЛиц = КадровыйУчет.КадровыеДанныеФизическихЛиц(Истина, ПараметрыОрганизации.ИндивидуальныйПредприниматель, СписокКадровыхДанных, ДатаСведений);
		Если КадровыеДанныеФизЛиц.Количество()>0 Тогда
			ДанныеФизЛица = КадровыеДанныеФизЛиц[0];
			
			ОсновныеСведения.Вставить("НПФЛФамилия",  ДанныеФизЛица.Фамилия);
			ОсновныеСведения.Вставить("НПФЛИмя",      ДанныеФизЛица.Имя);
			ОсновныеСведения.Вставить("НПФЛОтчество", ДанныеФизЛица.Отчество);
			ОсновныеСведения.Вставить("НаименованиеДляЛиста1", ДанныеФизЛица.ФИОПолные);
			
			ОсновныеСведения.Вставить("НПФЛДатаРожд",  ДанныеФизЛица.ДатаРождения);
			ОсновныеСведения.Вставить("НПФЛМестоРожд", ПерсонифицированныйУчетКлиентСервер.ПредставлениеМестаРождения(ДанныеФизЛица.МестоРождения));
			
			Если ДанныеФизЛица.Страна = Справочники.СтраныМира.Россия Тогда
				ОсновныеСведения.Вставить("НПФЛНалГражд", "1");
				ОсновныеСведения.Вставить("НПФЛОКСМ", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФизЛица.Страна, "Код"));
			ИначеЕсли ЗначениеЗаполнено(ДанныеФизЛица.Страна) Тогда
				ОсновныеСведения.Вставить("НПФЛНалГражд", "2");
				ОсновныеСведения.Вставить("НПФЛОКСМ", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФизЛица.Страна, "Код"));
			Иначе
				ОсновныеСведения.Вставить("НПФЛНалГражд", "3");
				ОсновныеСведения.Вставить("НПФЛОКСМ", "");
			КонецЕсли;
			
			Если ДанныеФизЛица.СтатусНалогоплательщика = Справочники.СтатусыНалогоплательщиковПоНДФЛ.Резидент Тогда
				ОсновныеСведения.Вставить("НПФЛСтатусНП", "1");
			Иначе
				ОсновныеСведения.Вставить("НПФЛСтатусНП", "2");
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ДанныеФизЛица.ДокументВид) Тогда
				ОсновныеСведения.Вставить("НПФЛКодВидДок", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеФизЛица.ДокументВид, "КодМВД"));
				ОсновныеСведения.Вставить("НПФЛСерНомДок", Строка(ДанныеФизЛица.ДокументСерия)+" "+Строка(ДанныеФизЛица.ДокументНомер));
				ОсновныеСведения.Вставить("НПФЛДатаДок",   ДанныеФизЛица.ДокументДатаВыдачи);
				ОсновныеСведения.Вставить("НПФЛВыдДок",    ДанныеФизЛица.ДокументКемВыдан);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ДанныеФизЛица.АдресПоПрописке) Тогда
				
				Если ДанныеФизЛица.Страна = Справочники.СтраныМира.Россия Тогда
					ОсновныеСведения.Вставить("НПФЛПрАдр", "1");
				Иначе
					ОсновныеСведения.Вставить("НПФЛПрАдр", "2");
				КонецЕсли;
				
				АдресСтруктурой = УправлениеКонтактнойИнформациейБП.СтруктураАдреса(ДанныеФизЛица.АдресПоПрописке);
				
				Если АдресСтруктурой.Свойство("Регион") Тогда
					ОсновныеСведения.Вставить("НПФЛКодРегион", РегламентированнаяОтчетностьВызовСервера.КодРегионаПоНазванию(АдресСтруктурой.Регион));
				Иначе
					ОсновныеСведения.Вставить("НПФЛКодРегион", "");
				КонецЕсли;
				
				ОсновныеСведения.Вставить("НПФЛИндекс", АдресСтруктурой.Индекс);
				ОсновныеСведения.Вставить("НПФЛРайон",  АдресСтруктурой.Район);
				ОсновныеСведения.Вставить("НПФЛГород",  АдресСтруктурой.Город);
				ОсновныеСведения.Вставить("НПФЛНаселПункт", АдресСтруктурой.НаселенныйПункт);
				ОсновныеСведения.Вставить("НПФЛУлица",   АдресСтруктурой.Улица);
				ОсновныеСведения.Вставить("НПФЛДом",     АдресСтруктурой.Дом);
				ОсновныеСведения.Вставить("НПФЛКорпус",  АдресСтруктурой.Корпус);
				ОсновныеСведения.Вставить("НПФЛКварт",   АдресСтруктурой.Квартира);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ДанныеФизЛица.АдресЗаПределамиРФ) Тогда
				АдресСтруктурой = УправлениеКонтактнойИнформациейБП.СтруктураАдреса(ДанныеФизЛица.АдресЗаПределамиРФ,
					Справочники.ВидыКонтактнойИнформации.АдресЗаПределамиРФФизическиеЛица);
				ОсновныеСведения.Вставить("АдрИнКодСтраны", АдресСтруктурой.КодСтраны);
				Если СтрНайти(АдресСтруктурой.Представление, АдресСтруктурой.Страна+", ") = 1 Тогда
					ОсновныеСведения.Вставить("АдрИнТекст", Сред(АдресСтруктурой.Представление, СтрДлина(АдресСтруктурой.Страна+", ") + 1));
				Иначе
					ОсновныеСведения.Вставить("АдрИнТекст", АдресСтруктурой.Представление);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		ОсновныеСведения.Вставить("ЭтоПБОЮЛ", Ложь);
		ОсновныеСведения.Вставить("НаимОрг", СведенияОбОрганизацииДляОтправки.НаименованиеПолное);
		ОсновныеСведения.Вставить("НаименованиеДляЛиста1", СведенияОбОрганизацииДляОтправки.НаименованиеПолное);
		ОсновныеСведения.Вставить("ИННЮЛ",   СведенияОбОрганизацииДляОтправки.ИНН);
		ОсновныеСведения.Вставить("КППЮЛ",   СведенияОбОрганизацииДляОтправки.КПП);
	КонецЕсли;
	
	ОсновныеСведения.Вставить("КодНО", СведенияОбОрганизацииДляОтправки.КодНалоговогоОргана);
	
	ОсновныеСведения.Вставить("ПрПодп", СведенияОбОрганизацииДляОтправки.Подписант.ПризнакПодписанта);
	Если Не ОрганизацияФизЛицо Тогда
		ОсновныеСведения.Вставить("ПодпФамилия", СведенияОбОрганизацииДляОтправки.Подписант.Фамилия);
		ОсновныеСведения.Вставить("ПодпИмя", СведенияОбОрганизацииДляОтправки.Подписант.Имя);
		ОсновныеСведения.Вставить("ПодпОтчество", СведенияОбОрганизацииДляОтправки.Подписант.Отчество);
	КонецЕсли;
	Если СведенияОбОрганизацииДляОтправки.Подписант.ПризнакПодписанта <> "1" Тогда
		ОсновныеСведения.Вставить("НаимОргПодп", СведенияОбОрганизацииДляОтправки.Подписант.НаименованиеОрганизацииПредставителя);
		ОсновныеСведения.Вставить("НаимДокПодп", СведенияОбОрганизацииДляОтправки.Подписант.НаименованиеДоверенностиПредставителя);
	КонецЕсли;
	
	ИдентификаторФайла = ИдентификаторФайлаЭлектронногоПредставления(ОсновныеСведения);
	ОсновныеСведения.Вставить("ИдФайл", ИдентификаторФайла);
	
	Возврат ОсновныеСведения;
	
КонецФункции

Функция ИдентификаторФайлаЭлектронногоПредставления(СведенияОтправки) Экспорт
	
	Префикс = "UT_UVKNRSD";
	Если СведенияОтправки.ЭтоПБОЮЛ Тогда
		ИдентификаторОтправителя = СокрЛП(СведенияОтправки.ИННФЛ);
	Иначе
		ИдентификаторОтправителя = СокрЛП(СведенияОтправки.ИННЮЛ) + СокрЛП(СведенияОтправки.КППЮЛ);
	КонецЕсли;
	ИдентификаторПолучателя = СведенияОтправки.КодНО + "_" + СведенияОтправки.КодНО;
	ДатаФормированияФайла = Формат(СведенияОтправки.ДатаДок, "ДФ=yyyyMMdd");
	ИдентификационныйНомер = Строка(Новый УникальныйИдентификатор);
	
	ИдентификаторФайла = Префикс
	                   + "_" + ИдентификаторПолучателя
	                   + "_" + ИдентификаторОтправителя
	                   + "_" + ДатаФормированияФайла
	                   + "_" + ИдентификационныйНомер;
	
	Возврат ИдентификаторФайла;
	
КонецФункции

Функция ПолучитьФИОФизлица(ФизЛицо, ДатаСведений)
	
	ФИО = Новый Структура("Фамилия, Имя, Отчество", "", "", "");
	ДанныеФЛ = РегистрыСведений.ФИОФизическихЛиц.СрезПоследних(ДатаСведений, Новый Структура("ФизическоеЛицо", ФизЛицо));
	Если ДанныеФЛ.Количество() > 0 Тогда
		ЗаполнитьЗначенияСвойств(ФИО, ДанныеФЛ[0]);
	КонецЕсли;
	
	Возврат ФИО;
	
КонецФункции

#КонецОбласти

#Область ПроверкаЗаполненияДанныхУведомления

Функция ПроверитьЗаполнениеУведомления(Уведомление, УникальныйИдентификатор = Неопределено) Экспорт
	
	ОсновныеСведения = ПолучитьОсновныеСведенияУведомленияДляВыгрузки(Уведомление);
	ОсновныеСведения.Вставить("УведомлениеОКонтролируемыхСделках", Уведомление);
	
	ЛистыУведомления = КонтролируемыеСделки.ПолучитьЛистыУведомления(Уведомление);
	
	ИнформацияОбОшибках = ВыводСообщенийОбОшибках.НовыйДетальнаяИнформацияОбОшибках();
	
	Ошибки = Новый СписокЗначений;
	
	ПроверитьТитульныйЛист(ОсновныеСведения, Ошибки);
	ПроверитьТитульныйЛистФизЛицо(ОсновныеСведения, Ошибки);
	ПроверитьЛисты1А(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛисты1Б(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛисты1В(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛисты1Г(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛистыРаздела2(ОсновныеСведения, ЛистыУведомления, Ошибки);
	ПроверитьЛистыРаздела3(ЛистыУведомления, Ошибки);
	ПроверитьЛистыРаздела4(ОсновныеСведения, ЛистыУведомления, Ошибки);
	
	СформироватьИнформациюОбОшибках(ИнформацияОбОшибках, Ошибки);
	
	ДанныеДляВывода = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Уведомление, "Организация");
	ХранилищеЗначения = ВыводСообщенийОбОшибках.ОписаниеОшибок(ИнформацияОбОшибках, ПолучитьМакет("МакетВыводаОшибок"), ДанныеДляВывода);
	
	Если УникальныйИдентификатор = Неопределено Тогда
		АдресХранилища = ПоместитьВоВременноеХранилище(ХранилищеЗначения, Новый УникальныйИдентификатор);
	Иначе
		АдресХранилища = ПоместитьВоВременноеХранилище(ХранилищеЗначения, УникальныйИдентификатор);
	КонецЕсли;
	
	Возврат Новый Структура("АдресХранилища", АдресХранилища);
	
КонецФункции

Процедура ПроверитьТитульныйЛист(ОсновныеСведения, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	// Код налогового органа
	Если Не ЗначениеЗаполнено(ОсновныеСведения.КодНО) Или СтрДлина(ОсновныеСведения.КодНО) <> 4 Тогда
		ДобавитьОшибку("1010", ОсновныеСведения.Организация, ТекущиеОшибки);		
	КонецЕсли;
	
	// Код по месту учета
	Если Не ЗначениеЗаполнено(ОсновныеСведения.ПоМесту) Тогда
		ДобавитьОшибку("1020", ОсновныеСведения.УведомлениеОКонтролируемыхСделках, ТекущиеОшибки);
	КонецЕсли;
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		Если ОсновныеСведения.ОтчетныйГод < Дата(2012,12,31) Тогда
			// Код ОКАТО
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКАТО) Или СтрДлина(ОсновныеСведения.ОКАТО) <> 11 Тогда
				ДобавитьОшибку("1030", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		Иначе
			// Код ОКТМО
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКАТО) Тогда
				ДобавитьОшибку("1031", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	Иначе
		// Код ОКТМО
		Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКТМО) Тогда
			ДобавитьОшибку("1031", ОсновныеСведения.Организация, ТекущиеОшибки);
		КонецЕсли;
	КонецЕсли;
	
	// Наименование организации
	Если Не ЗначениеЗаполнено(ОсновныеСведения.НаименованиеОрганизации) Тогда
		ДобавитьОшибку("1050", ОсновныеСведения.Организация, ТекущиеОшибки);
	КонецЕсли;
	
	Если Не ОсновныеСведения.ЭтоПБОЮЛ Тогда
		
		// ИНН, КПП юр. лица
		Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННЮЛ) Или СтрДлина(ОсновныеСведения.ИННЮЛ) <> 10
			Или Не ЗначениеЗаполнено(ОсновныеСведения.КППЮЛ) Или СтрДлина(ОсновныеСведения.КППЮЛ) <> 9 Тогда
			ДобавитьОшибку("1040", ОсновныеСведения.Организация, ТекущиеОшибки);
		КонецЕсли;
		
		// ИНН/КПП реорганизованной организации
		Если ОсновныеСведения.Свойство("ФормРеорг") И ЗначениеЗаполнено(ОсновныеСведения.ФормРеорг) Тогда 
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННЮЛРеорг) Или Не ЗначениеЗаполнено(ОсновныеСведения.КППЮЛРеорг) Тогда
				ДобавитьОшибку("1060", ОсновныеСведения.УведомлениеОКонтролируемыхСделках, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	
	КонецЕсли;
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
		// Код ОКВЭД
		СтрокаПоиска = "/" + ОсновныеСведения.ПоМесту + "/";
		Если СтрНайти("/120/213/214/215/", СтрокаПоиска) > 0 Тогда
			Если Не ЗначениеЗаполнено(ОсновныеСведения.ОКВЭД) Тогда
				ДобавитьОшибку("1070", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Титульный лист ФИО подписанта
	ФамилияПодписанта = Неопределено; ИмяПодписанта = Неопределено;
	
	ОсновныеСведения.Свойство("ПодпФамилия", ФамилияПодписанта);
	ОсновныеСведения.Свойство("ПодпИмя", ИмяПодписанта); 
	
	ФИОПодписантаЗаполнено = ЗначениеЗаполнено(ФамилияПодписанта) И ЗначениеЗаполнено(ИмяПодписанта);
	
	Если Не ФИОПодписантаЗаполнено Тогда
		Если ОсновныеСведения.ПрПодп = "1" Тогда // Если представителя нет
			Если Не ОсновныеСведения.ЭтоПБОЮЛ  Тогда
				ДобавитьОшибку("1080", ОсновныеСведения.Организация, ТекущиеОшибки);
			КонецЕсли;
		Иначе // есть представитель
			ДобавитьОшибку("1090", ОсновныеСведения.РегистрацияВНалоговомОргане, ТекущиеОшибки);
		КонецЕсли;
	КонецЕсли;
	
	// Наименование документа представителя
	Если ОсновныеСведения.ПрПодп <> "1" И Не ЗначениеЗаполнено(ОсновныеСведения.НаимДокПодп) Тогда
		ДобавитьОшибку("1100", ОсновныеСведения.РегистрацияВНалоговомОргане, ТекущиеОшибки);
	КонецЕсли;
	
	Ошибки.Добавить(ТекущиеОшибки, "Титульный лист");
	
КонецПроцедуры

Процедура ПроверитьТитульныйЛистФизЛицо(ОсновныеСведения, Ошибки)
	
	Если Не ОсновныеСведения.ЭтоПБОЮЛ Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	// Фамилия, Имя
	Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛФамилия) Или Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛИмя) Тогда
		ДобавитьОшибку("2010", ОсновныеСведения.Организация, ТекущиеОшибки);
	КонецЕсли;
	
	// ИНН физ. лица
	СтрокаПоиска = "/" + ОсновныеСведения.ПоМесту + "/";
	Если СтрНайти("/120/125/126/", СтрокаПоиска) > 0 Тогда
		Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННФЛ) Или СтрДлина(ОсновныеСведения.ИННФЛ) <> 12 Тогда
			ДобавитьОшибку("2020", ОсновныеСведения.Организация, ТекущиеОшибки);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ОсновныеСведения.ИННФЛ) Тогда
		
		// Дата рождения
		Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛДатаРожд) Тогда
			ДобавитьОшибку("2030", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		// Место рождения
		Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛМестоРожд) Тогда
			ДобавитьОшибку("2040", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		// Сведения о гражданстве
		ОшибкаЗаполнения = Не (ОсновныеСведения.НПФЛНалГражд = "1" Или (ОсновныеСведения.НПФЛНалГражд = "2" И ЗначениеЗаполнено(ОсновныеСведения.НПФЛОКСМ)));
		Если ОшибкаЗаполнения Тогда
			ДобавитьОшибку("2050", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		Если ОсновныеСведения.НПФЛНалГражд = "1" Тогда
			
			// Адрес места жительства/прибывания
			АдресЗаполнен = ОсновныеСведения.Свойство("НПФЛКодРегион") И ЗначениеЗаполнено(ОсновныеСведения.НПФЛКодРегион);
			Если Не АдресЗаполнен Тогда
				ДобавитьОшибку("2060", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
			КонецЕсли;
			
		Иначе
			
			// Адрес за пределами РФ
			АдресЗаполнен = ОсновныеСведения.Свойство("АдрИнКодСтраны") И ЗначениеЗаполнено(ОсновныеСведения.АдрИнКодСтраны)
				И ЗначениеЗаполнено(ОсновныеСведения.АдрИнТекст);
				
			Если Не АдресЗаполнен Тогда
				ДобавитьОшибку("2070", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		// Статус налогоплательщика
		Если Не ЗначениеЗаполнено(ОсновныеСведения.НПФЛСтатусНП) Тогда
			ДобавитьОшибку("2080", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
		
		// Документ удостоверяющий личность
		// Код вида документа, серия, номер, дата выдачи, кем выдан
		ДанныеДокументаЗаполнены = ОсновныеСведения.Свойство("НПФЛКодВидДок") И ЗначениеЗаполнено(ОсновныеСведения.НПФЛКодВидДок) 
			И ЗначениеЗаполнено(ОсновныеСведения.НПФЛСерНомДок)	И ЗначениеЗаполнено(ОсновныеСведения.НПФЛДатаДок) 
			И ЗначениеЗаполнено(ОсновныеСведения.НПФЛВыдДок);
		
		Если Не ДанныеДокументаЗаполнены Тогда
			ДобавитьОшибку("2090", ОсновныеСведения.ИндивидуальныйПредприниматель, ТекущиеОшибки);
		КонецЕсли;
			
	КонецЕсли;
	
	Ошибки.Добавить(ТекущиеОшибки, "Титульный лист (сведения о физ. лице)");
	
КонецПроцедуры

Процедура ПроверитьЛисты1А(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	СоответствиеКодов = КонтролируемыеСделки.ПолучитьСоответствиеКодовСтороныСделки();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1А Цикл
		
		// Код наименования сделки
		Если Не ЗначениеЗаполнено(Лист.Строка210КодНаименованияСделки) Тогда
			ДобавитьОшибку("3010", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Код стороны сделки
		Если Не ЗначениеЗаполнено(Лист.Строка211КодСтороныСделки) Тогда
			ДобавитьОшибку("3020", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Соответствие кодов
		Если ЗначениеЗаполнено(Лист.Строка210КодНаименованияСделки) И ЗначениеЗаполнено(Лист.Строка211КодСтороныСделки) Тогда
			
			КодыСторонСделки = СоответствиеКодов.Получить(Лист.Строка210КодНаименованияСделки);
			
			Если КодыСторонСделки = Неопределено Тогда
				ДобавитьОшибку("3030", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);	
			ИначеЕсли КодыСторонСделки.НайтиПоЗначению(Лист.Строка211КодСтороныСделки) = Неопределено Тогда
				ДобавитьОшибку("3040", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
			// Комментарий по признаку определения цены сделки, он выводится для 2024 года.
			// Затем он удален.
			Если Лист.Строка220ПризнакОпределенияЦеныСделки = "1"
				И Не ЗначениеЗаполнено(Лист.Строка220_1Комментарий) Тогда
				ДобавитьОшибку("3050", Лист.СпособОпределенияЦеныСделки, ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
		
		// наличие листов раздела 1Б
		Если Лист.Количество1Б = 0 Тогда
			ДобавитьОшибку("3060", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
			// Код методов ценообразования должен попадать в список 01...07. Остальные коды недействуют,
			// например код 08 был ранее, но теперь он недоступен.
			// По обязательности заполнения кода методов ценообразования см. Письме ФНС ШЮ-4-13/4858@ от 19.05.2025
			Если Не ЗначениеЗаполнено(Лист.Строка240КодМетодовЦенообразования)
				Или СтрНайти("|01|02|03|04|05|06|07|", "|" + Лист.Строка240КодМетодовЦенообразования + "|") = 0 Тогда
				Если ЗначениеЗаполнено(Лист.СпособОпределенияЦеныСделки) Тогда
					ДобавитьОшибку("3090", Лист.СпособОпределенияЦеныСделки, ТекущиеОшибки);
				Иначе
					ДобавитьОшибку("3110", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
			Если Лист.УказыватьСведенияЦепочкиСозданияСтоимости И Лист.Количество1В = 0 Тогда
				ДобавитьОшибку("3100", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
		
		// Одновременное заполнение показателей 122-123 и 131-138
		Если Лист.Строка122СделкаВОбластиВнешнейТорговли = "1"
			ИЛИ Лист.Строка123СделкаСКонтрагентомСЛьготнымНалогообложением = "1" Тогда
			
			Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
				Если Лист.ОснованиеКонтролируемости131 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости132 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости133 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости134 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости135 = "1" Тогда
					
					ДобавитьОшибку("3070", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					
				КонецЕсли;
				
			Иначе
				
				Если Лист.ОснованиеКонтролируемости131 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости132 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости133 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости134 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости135 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости136 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости137 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости138 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости139 = "1"
					ИЛИ Лист.ОснованиеКонтролируемости140 = "1" Тогда
					
					ДобавитьОшибку("3070", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
			Если Лист.СделкаСовАгент = "1"
				И Не ЗначениеЗаполнено(Лист.Комиссионер) Тогда
				ДобавитьОшибку("3080", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Лист 1А");
	
КонецПроцедуры

Процедура ПроверитьЛисты1Б(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1Б Цикл
		
		Если ЗначениеЗаполнено(Лист.Строка020ТипПредмета) Тогда
			
			Если ОсновныеСведения.ВерсияУведомления = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2012() Тогда
			
				Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
					
					// Код ОКВЭД
					Если ЗначениеЗаполнено(Лист.Строка045КодОКВЭД) Тогда
						ДобавитьОшибку("4030", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Должен быть указан код ОКП или код ТНВЭД
					Если НЕ ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД)
						И НЕ ЗначениеЗаполнено(Лист.Строка043КодПоОКП) Тогда
						ДобавитьОшибку("4055", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				ИначеЕсли Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.РаботаУслуга
					Или Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав Тогда
					
					// Код ТНВЭД
					Если ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД) Тогда
						ДобавитьОшибку("4040", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Код ОКП
					Если ЗначениеЗаполнено(Лист.Строка043КодПоОКП) Тогда
						ДобавитьОшибку("4050", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			Иначе
				
				Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
					
					// Код ОКВЭД2 для товаров не заполняется
					Если ЗначениеЗаполнено(Лист.Строка045КодОКВЭД2) Тогда
						ДобавитьОшибку("4130", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Для внешнеторговых сделок должен быть указан код код ТНВЭД
					Если НЕ ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД)
						И Лист.ВнешнеторговаяСделка Тогда
						ДобавитьОшибку("4150", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Для внутрироссийских сделок должен быть указан код код по ОКПД2
					Если НЕ ЗначениеЗаполнено(Лист.Строка043КодПоОКПД2)
						И НЕ Лист.ВнешнеторговаяСделка Тогда
						ДобавитьОшибку("4160", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				Иначе
					
					// Код ТНВЭД
					Если ЗначениеЗаполнено(Лист.Строка040КодПоТНВЭД) Тогда
						ДобавитьОшибку("4040", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Код ОКПД2
					Если ЗначениеЗаполнено(Лист.Строка043КодПоОКПД2) Тогда
						ДобавитьОшибку("4140", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
					// Код ОКВЭД2
					Если НЕ ЗначениеЗаполнено(Лист.Строка045КодОКВЭД2) Тогда
						ДобавитьОшибку("4135", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		Иначе
			// Тип предмета сделки
			ДобавитьОшибку("4010", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Наименование предмета сделки
		Если Не ЗначениеЗаполнено(Лист.Строка030НаименованиеПредмета) Тогда
			ДобавитьОшибку("4020", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.ДоговорКонтрагента) Тогда
			// Договор контрагента
			ДобавитьОшибку("4060", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			
		ИначеЕсли Не ЗначениеЗаполнено(Лист.Строка060НомерДоговора) Или Не ЗначениеЗаполнено(Лист.Строка065ДатаДоговора) Тогда
			// Номер, дата договора
			ДобавитьОшибку("4070", Лист.ДоговорКонтрагента, ТекущиеОшибки);
			
		КонецЕсли;
		
		Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.Товар Тогда
			
			Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024()
				Или НужноЗаполнятьСтрануПроисхождения2024(Лист) Тогда
				
				// Код страны происхождения
				Если Не ЗначениеЗаполнено(Лист.Строка070КодСтраныПроисхождения) Тогда
					ДобавитьОшибку("4080", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				ИначеЕсли НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СокрЛП(Лист.Строка070КодСтраныПроисхождения)) Тогда
					ДобавитьОшибку("4081", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
				
			КонецЕсли;
			
			Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
				// Страна отправки товара проверялась до уведомления 2024. Начиная с этой версии страна отправки вообще не заполняется.
				Если ЗначениеЗаполнено(Лист.Строка080КодСтраныОтправки)
					И НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СокрЛП(Лист.Строка080КодСтраныОтправки)) Тогда
					ДобавитьОшибку("4085", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
			
		ИначеЕсли Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.РаботаУслуга
			Или Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ИнойОбъектГражданскихПрав Тогда
			
			// Код условий поставки
			Если ЗначениеЗаполнено(Лист.Строка100КодУсловийПоставки) Тогда
				ДобавитьОшибку("4100", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		
			// Страна совершения сделки
			Если ЗначениеЗаполнено(Лист.Строка090КодСтраныСовершенияСделки)
				И НЕ СтроковыеФункцииКлиентСервер.ТолькоЦифрыВСтроке(СокрЛП(Лист.Строка090КодСтраныСовершенияСделки)) Тогда
				ДобавитьОшибку("4090", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			// Код региона совершения сделки
			Если Лист.Строка090КодСтраныСовершенияСделки = "643" 
				И НЕ ЗначениеЗаполнено(Лист.Строка090КодРегионаСовершенияСделки) Тогда
				ДобавитьОшибку("4091", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
		// Код единицы измерения
		Если Не ЗначениеЗаполнено(Лист.Строка110КодЕдиницыИзмерения) Тогда
			ДобавитьОшибку("4110", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		ДлинаКодаЕдиницыИзмерения = СтрДлина(СокрЛП((Лист.Строка110КодЕдиницыИзмерения)));
		Если ДлинаКодаЕдиницыИзмерения < 3 Или ДлинаКодаЕдиницыИзмерения > 4 Тогда
			ДобавитьОшибку("4111", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		// Количество
		Если Лист.Строка120Количество <= 0 Тогда
			ДобавитьОшибку("4120", ДанныеВыводаОшибкиСведенияОПредметеСделки(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если ОсновныеСведения.ВерсияУведомления >= КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2018() Тогда
			// Код валюты сделки
			Если Не ЗначениеЗаполнено(Лист.Строка140КодВалюты) Тогда
				ДобавитьОшибку("4170", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			// Долговое обязательство должно быть заполнено.
			Если Лист.ТипПредметаСделки = Перечисления.ТипыПредметовКонтролируемыхСделок.ДолговоеОбязательство Тогда
				Если Не ЗначениеЗаполнено(Лист.Строка150ПроцентнаяСтавка) Тогда
					ДобавитьОшибку("4180", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Лист.Строка130Цена)
					ИЛИ ЗначениеЗаполнено(Лист.Строка160Стоимость) Тогда
					ДобавитьОшибку("4190", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
			Иначе
				Если ЗначениеЗаполнено(Лист.Строка150ПроцентнаяСтавка) Тогда
					ДобавитьОшибку("4200", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
				Если Не ЗначениеЗаполнено(Лист.Строка130Цена)
					ИЛИ Не ЗначениеЗаполнено(Лист.Строка160Стоимость) Тогда
					ДобавитьОшибку("4210", ДанныеВыводаОшибкиСделка(Лист), ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Лист 1Б");
	
КонецПроцедуры

Процедура ПроверитьЛисты1В(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1В Цикл
		
		Если Лист.НомерЛиста1Б = 0
			И Не ЗначениеЗаполнено(Лист.КомментарийКЛисту1Б) Тогда
			ДобавитьОшибку("7010", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		КодИспользованияТовара = Перечисления.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.КодДляВыгрузки(
			Лист.ИспользованиеПроисхождениеТовара);
		Если СтрНайти("|1|2|3|4|5|", "|" + КодИспользованияТовара + "|") = 0 Тогда
			ДобавитьОшибку("7020", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если КодИспользованияТовара = "5"
			И Не ЗначениеЗаполнено(Лист.НаименованиеИспользованияПроисхожденияТовара) Тогда
			ДобавитьОшибку("7030", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		НужноВыгружатьСведенияОСделке = Перечисления.ТипыИспользованияПроисхожденияТовараКонтролируемыхСделок.НужноВыгружатьСведенияОСделке(
			Лист.ИспользованиеПроисхождениеТовара);
		Если НужноВыгружатьСведенияОСделке Тогда
			
			ПрУчСд = Перечисления.ТипыУчастниковЦепочкиКонтролируемыхСделок.КодДляВыгрузки(Лист.ПризнакУчастникаСделки);
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.Контрагент) Тогда
				ДобавитьОшибку("7040", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И (Не ЗначениеЗаполнено(Лист.НомерДоговора)
				Или Не ЗначениеЗаполнено(Лист.ДатаДоговора)) Тогда
				ДобавитьОшибку("7050", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.СтранаСовершенияСделки) Тогда
				ДобавитьОшибку("7060", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если Лист.Количество <= 0 Тогда
				ДобавитьОшибку("7070", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.Цена) Тогда
				ДобавитьОшибку("7080", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
			Если ПрУчСд <> "3" И Не ЗначениеЗаполнено(Лист.ДатаСовершенияСделки) Тогда
				ДобавитьОшибку("7090", ДанныеВыводаОшибкиСведенияОПоследующейРеализации(Лист), ТекущиеОшибки);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Лист 1В");
	
КонецПроцедуры

Процедура ПроверитьЛисты1Г(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ЛистыРаздела1Г Цикл
		
		Если Не ЗначениеЗаполнено(Лист.НомерЛиста1Б) Тогда
			ДобавитьОшибку("8010", ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.НаименованиеУслуги) Тогда
			ДобавитьОшибку("8020", ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(Лист), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.Контрагент) Тогда
			ДобавитьОшибку("8030", ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(Лист), ТекущиеОшибки);
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Лист 1Г");
	
КонецПроцедуры

Процедура ПроверитьЛистыРаздела2(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ДанныеРаздела2 Цикл
		
		// Наименование контрагента
		Если Не ЗначениеЗаполнено(Лист.Строка040Наименование) Тогда
			ДобавитьОшибку("5010", Лист.Контрагент, ТекущиеОшибки);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Лист.Строка030КакКодСтраныРегистрации) Тогда 
			
			Если Лист.Строка020ТипОрганизации = 1 Тогда
				
				// ИНН/КПП
				Если Не ЗначениеЗаполнено(Лист.Строка050ИНН) Или СтрДлина(Лист.Строка050ИНН) <> 10
					Или Не ЗначениеЗаполнено(Лист.Строка060КПП) Или СтрДлина(Лист.Строка060КПП) <> 9 Тогда
					ДобавитьОшибку("5030", Лист.Контрагент, ТекущиеОшибки);
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Лист.Строка050ИНН) Тогда
					РезультатПроверки = ИдентификационныеНомераНалогоплательщиков.ПроверитьСоответствиеТребованиямИНН(
						Лист.Строка050ИНН, Истина);
					Если НЕ РезультатПроверки.СоответствуетТребованиям Тогда
						ДобавитьОшибку("5050", Лист.Контрагент, ТекущиеОшибки);
					КонецЕсли;
				КонецЕсли;
				
				Если ЗначениеЗаполнено(Лист.Строка060КПП) Тогда
					РезультатПроверки = ИдентификационныеНомераНалогоплательщиков.ПроверитьСоответствиеТребованиямФорматаКПП(
						Лист.Строка060КПП, Истина);
					Если НЕ РезультатПроверки.СоответствуетТребованиям Тогда
						ДобавитьОшибку("5055", Лист.Контрагент, ТекущиеОшибки);
					КонецЕсли;
				КонецЕсли;
				
			Иначе
				
				Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
					
					// Должен быть заполнен один из:
					//   Регистрационный номер в стране регистрации (инкорпорации)
					//   Код налогоплательщика в стране регистрации (инкорпорациии)
					
					ОшибкаЗаполнения = Не (ЗначениеЗаполнено(Лист.Строка070РегНомерВСтрокеРегистрации) ИЛИ ЗначениеЗаполнено(Лист.Строка080КодНалогВСтранеРегистрации));
					Если ОшибкаЗаполнения Тогда
						ДобавитьОшибку("5040", Лист.Контрагент, ТекущиеОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЕсли;
			
		Иначе
			
			// Страна регистрации
			ДобавитьОшибку("5020", Лист.Контрагент, ТекущиеОшибки);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Раздел 2");
	
КонецПроцедуры

Процедура ПроверитьЛистыРаздела3(ЛистыУведомления, Ошибки)
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ДанныеРаздела3 Цикл
		
		//
		Если Не ЗначениеЗаполнено(Лист.ФизическоеЛицо) Тогда
			ДобавитьОшибку("6010", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		// Код вида деятельности
		Если Не ЗначениеЗаполнено(Лист.Строка020КодВидаДеятельности) Тогда
			ДобавитьОшибку("6030", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		
		Если Не ЗначениеЗаполнено(Лист.ФизическоеЛицо) Тогда
			Продолжить;
		КонецЕсли;
		
		// Фамилия, имя физ. лица
		Если Не ЗначениеЗаполнено(Лист.Фамилия) Или Не ЗначениеЗаполнено(Лист.Имя) Тогда
			ДобавитьОшибку("6020", Лист.ФизическоеЛицо, ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.Строка030ИНН) Тогда
			
			// Дата рождения
			Если Не ЗначениеЗаполнено(Лист.ДатаРождения) Тогда
				ДобавитьОшибку("6050", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
			// Место рождения
			МестоРождения = ПерсонифицированныйУчетКлиентСервер.ПредставлениеМестаРождения(Лист.МестоРождения);
			Если Не ЗначениеЗаполнено(МестоРождения) Тогда
				ДобавитьОшибку("6060", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
			// Сведения о гражданстве
			Если Не ЗначениеЗаполнено(Лист.ГражданствоФизЛицСтрана) Тогда
				ДобавитьОшибку("6070", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
			Если Лист.ГражданствоФизЛицСтрана = Справочники.СтраныМира.Россия ИЛИ Не ЗначениеЗаполнено(Лист.ГражданствоФизЛицСтрана) Тогда
				
				// ИНН физ. лица.
				ДобавитьОшибку("6040", Лист.Контрагент, ТекущиеОшибки);
				
				// Адрес места жительства/прибывания
				АдресСтруктурой = РаботаСАдресами.ПредыдущаяСтруктураКонтактнойИнформацииXML(Лист.КонтактнаяИнформацияЗначенияПолей);
				
				АдресЗаполнен = АдресСтруктурой.Свойство("КодРегиона") И ЗначениеЗаполнено(АдресСтруктурой.КодРегиона);  
				Если Не АдресЗаполнен Тогда
					ДобавитьОшибку("6080", Лист.ФизическоеЛицо, ТекущиеОшибки);	
				КонецЕсли;
				
			Иначе
				
				// Адрес за пределами РФ
				АдресЗаполнен = ЗначениеЗаполнено(Лист.КонтактнаяИнформацияЗаРФСтрана) И ЗначениеЗаполнено(Лист.КонтактнаяИнформацияЗаРФПредставление); 
				Если Не АдресЗаполнен Тогда
					ДобавитьОшибку("6090", Лист.ФизическоеЛицо, ТекущиеОшибки);
				КонецЕсли;
				
			КонецЕсли;
			
			// Документ удостоверяющий личность
			// Код вида документа, серия, номер, дата выдачи, кем выдан
			КодВидаДокумента = КонтролируемыеСделки.ПолучитьКодВидаДокументаПоВидуДокумента(Лист.ВидДокумента);
			
			ДанныеДокументаЗаполнены = ЗначениеЗаполнено(КодВидаДокумента) И ЗначениеЗаполнено(Лист.ДокументСерия) И ЗначениеЗаполнено(Лист.ДокументНомер)
				И ЗначениеЗаполнено(Лист.ДокументДатаВыдачи) И ЗначениеЗаполнено(Лист.ДокументКемВыдан);
				
			Если Не ДанныеДокументаЗаполнены Тогда
				ДобавитьОшибку("6100", Лист.ФизическоеЛицо, ТекущиеОшибки);
			КонецЕсли;
			
		Иначе
			
			Если ЗначениеЗаполнено(Лист.Строка030ИНН) Тогда
				РезультатПроверки = ИдентификационныеНомераНалогоплательщиков.ПроверитьСоответствиеТребованиямИНН(
					Лист.Строка030ИНН, Ложь);
				Если НЕ РезультатПроверки.СоответствуетТребованиям Тогда
					ДобавитьОшибку("6045", Лист.Контрагент, ТекущиеОшибки);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Раздел 3");
	
КонецПроцедуры

Процедура ПроверитьЛистыРаздела4(ОсновныеСведения, ЛистыУведомления, Ошибки)
	
	Если ОсновныеСведения.ВерсияУведомления < КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024() Тогда
		Возврат;
	КонецЕсли;
	
	ТекущиеОшибки = ОписаниеТаблицыОшибок();
	
	Для Каждого Лист Из ЛистыУведомления.ДанныеРаздела4 Цикл
		
		Если Не ЗначениеЗаполнено(Лист.НаименованиеКонтрагента) Тогда
			ДобавитьОшибку("9010", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.КодСтраныРегистрации) Тогда
			ДобавитьОшибку("9020", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(Лист.РегистрационныйНомер) Тогда
			ДобавитьОшибку("9030", ДанныеВыводаОшибкиСведенияОРегистрации(Лист.Контрагент), ТекущиеОшибки);
		КонецЕсли;
		
	КонецЦикла;
	
	Ошибки.Добавить(ТекущиеОшибки, "Раздел 4");
	
КонецПроцедуры

Процедура СформироватьИнформациюОбОшибках(ИнформацияОбОшибках, Ошибки)
	
	ПредставлениеОшибок = ПолучитьОписаниеОшибок();
	
	Для Каждого Ошибка Из Ошибки Цикл
		
		РазделОтчета  = Ошибка.Представление;
		ТаблицаОшибок = Ошибка.Значение;
		
		ОписаниеОшибки = ВыводСообщенийОбОшибках.ДобавитьОписаниеОшибки(ИнформацияОбОшибках);
		
		СекцияРазделОтчета = ВыводСообщенийОбОшибках.ДобавитьСекцию(ОписаниеОшибки, "Раздел", РазделОтчета);
		
		Если ТаблицаОшибок.Количество() > 0 Тогда
			
			ТаблицаОшибок.Сортировать("Код");
			
			Для Каждого ДанныеОшибки Из ТаблицаОшибок Цикл
				
				ОписаниеОшибки = ПредставлениеОшибок.Найти(ДанныеОшибки.Код, "Код");
				
				Если ОписаниеОшибки = Неопределено Тогда
					Продолжить;
				КонецЕсли;
				
				СекцияОшибка = ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияРазделОтчета, "Раздел", ОписаниеОшибки.Текст);
				
				Если ЗначениеЗаполнено(ОписаниеОшибки.Описание) Тогда
					ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "Текст", ОписаниеОшибки.Описание);
				КонецЕсли;
				
				Если ЗначениеЗаполнено(ОписаниеОшибки.Рекомендации) Тогда
					ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "Текст", ОписаниеОшибки.Рекомендации);
				КонецЕсли;
				
				Для Каждого ЭлементКоллекции Из ДанныеОшибки.Объекты Цикл
					Если ТипЗнч(ЭлементКоллекции.Значение) = Тип("Структура") Тогда
						ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "СсылкаПроизвольная", ЭлементКоллекции.Значение);
					Иначе
						ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияОшибка, "Ссылка", ЭлементКоллекции.Значение);
					КонецЕсли;
				КонецЦикла;
				
			КонецЦикла;
			
		Иначе
			
			ВыводСообщенийОбОшибках.ДобавитьСекцию(СекцияРазделОтчета, "Текст", "Ошибок не обнаружено.");
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьОшибку(КодОшибки, Объект, ТаблицаОшибок)
	
	ДанныеОшибки = ТаблицаОшибок.Найти(КодОшибки, "Код");
	
	Если ДанныеОшибки = Неопределено Тогда
		ДанныеОшибки = ТаблицаОшибок.Добавить();
		ДанныеОшибки.Код 	 = КодОшибки;
		ДанныеОшибки.Объекты = Новый Соответствие;
	КонецЕсли;
	
	Если ТипЗнч(Объект) = Тип("Структура") Тогда
		ДанныеОшибки.Объекты.Вставить(Объект.Ключ, Объект);	
	Иначе
		ДанныеОшибки.Объекты.Вставить(Объект, Объект);	
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьОписаниеОшибок()
	
	ОписаниеТиповСтрока = Новый ОписаниеТипов("Строка");
	
	Таблица = Новый ТаблицаЗначений;
	
	Таблица.Колонки.Добавить("Код", ОписаниеТиповСтрока);
	Таблица.Колонки.Добавить("Текст", ОписаниеТиповСтрока);
	Таблица.Колонки.Добавить("Описание", ОписаниеТиповСтрока);
	Таблица.Колонки.Добавить("Рекомендации", ОписаниеТиповСтрока);
	
	Макет = ПолучитьМакет("ОписаниеОшибок");
	ОписаниеОшибок = Макет.ПолучитьОбласть("ОписаниеОшибок");
	
	Для НомерСтроки = 1 По Макет.ВысотаТаблицы Цикл
		
		Код = ОписаниеОшибок.Область(НомерСтроки, 1).Текст;
		
		Если Не ЗначениеЗаполнено(Код) Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяСтрока = Таблица.Добавить();
		НоваяСтрока.Код = Код;
		НоваяСтрока.Текст = ОписаниеОшибок.Область(НомерСтроки, 2).Текст;
		НоваяСтрока.Описание = ОписаниеОшибок.Область(НомерСтроки, 3).Текст;
		НоваяСтрока.Рекомендации = ОписаниеОшибок.Область(НомерСтроки, 4).Текст;
		
	КонецЦикла;
	
	Таблица.Индексы.Добавить("Код");
	
	Возврат Таблица;
	
КонецФункции

Функция ОписаниеТаблицыОшибок()
	
	Таблица = Новый ТаблицаЗначений;
	Таблица.Колонки.Добавить("Код");
	Таблица.Колонки.Добавить("Объекты");
	
	Возврат Таблица;
	
КонецФункции

Функция ДанныеВыводаОшибкиСведенияОРегистрации(Контрагент)
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаЗаписиУчастникиКонтролируемыхСделок");
	Расшифровка.Вставить("Контрагент", Контрагент);
	
	ДанныеВывода = Новый Структура;
	ДанныеВывода.Вставить("Ключ",   Контрагент);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Сведения о регистрации %1'"),
		Контрагент));
	
	Возврат ДанныеВывода;

КонецФункции

Функция ДанныеВыводаОшибкиСведенияОПредметеСделки(ДанныеЛиста)
	
	КлючОбъекта = ПолучитьНавигационнуюСсылку(ДанныеЛиста.Сделка, "Сделки.НомерСтроки", ДанныеЛиста.НомерСтроки - 1);
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаДокументаСтрокаТабличнойЧасти");
	Расшифровка.Вставить("Объект", "Документ.КонтролируемаяСделка");
	Расшифровка.Вставить("Документ", ДанныеЛиста.Сделка);
	Расшифровка.Вставить("ИмяТабличнойЧасти", "Сделки");
	Расшифровка.Вставить("НомерСтроки", ДанныеЛиста.НомерСтроки);
	
	ДанныеВывода = Новый Структура;
	
	ДанныеВывода.Вставить("Ключ", 	КлючОбъекта);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1, листы 1Б, строка %2'"),
		ДанныеЛиста.НомерЛиста1А,
		ДанныеЛиста.НомерСтроки));
	
	Возврат ДанныеВывода;

КонецФункции

Функция ДанныеВыводаОшибкиСведенияОПоследующейРеализации(ДанныеЛиста)
	
	КлючОбъекта = ПолучитьНавигационнуюСсылку(ДанныеЛиста.Сделка, "Листы1В.НомерСтроки", ДанныеЛиста.НомерСтроки - 1);
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаДокументаСтрокаТабличнойЧасти");
	Расшифровка.Вставить("Объект", "Документ.КонтролируемаяСделка");
	Расшифровка.Вставить("Документ", ДанныеЛиста.Сделка);
	Расшифровка.Вставить("ИмяТабличнойЧасти", "Листы1В");
	Расшифровка.Вставить("НомерСтроки", ДанныеЛиста.НомерСтроки);
	
	ДанныеВывода = Новый Структура;
	
	ДанныеВывода.Вставить("Ключ", 	КлючОбъекта);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1, листы 1В, строка %2'"),
		ДанныеЛиста.НомерЛиста1А,
		ДанныеЛиста.НомерСтроки));
	
	Возврат ДанныеВывода;

КонецФункции

Функция ДанныеВыводаОшибкиСведенияОСопутствующихУслугах(ДанныеЛиста)
	
	КлючОбъекта = ПолучитьНавигационнуюСсылку(ДанныеЛиста.Сделка, "Листы1Г.НомерСтроки", ДанныеЛиста.НомерСтроки - 1);
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("ФормаДокументаСтрокаТабличнойЧасти");
	Расшифровка.Вставить("Объект", "Документ.КонтролируемаяСделка");
	Расшифровка.Вставить("Документ", ДанныеЛиста.Сделка);
	Расшифровка.Вставить("ИмяТабличнойЧасти", "Листы1Г");
	Расшифровка.Вставить("НомерСтроки", ДанныеЛиста.НомерСтроки);
	
	ДанныеВывода = Новый Структура;
	
	ДанныеВывода.Вставить("Ключ", 	КлючОбъекта);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1, листы 1Г, строка %2'"),
		ДанныеЛиста.НомерЛиста1А,
		ДанныеЛиста.НомерСтроки));
	
	Возврат ДанныеВывода;

КонецФункции

Функция ДанныеВыводаОшибкиСделка(ДанныеЛиста)
	
	Расшифровка = ВыводСообщенийОбОшибках.НовыйОписаниеРасшифровки("Ссылка");
	Расшифровка.Вставить("Ссылка", ДанныеЛиста.Сделка);
	
	ДанныеВывода = Новый Структура;
	ДанныеВывода.Вставить("Ключ",   ДанныеЛиста.Сделка);
	ДанныеВывода.Вставить("Ссылка", Расшифровка);
	ДанныеВывода.Вставить("Представление", СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Лист 1А № %1'"),
		ДанныеЛиста.НомерЛиста1А));
	
	Возврат ДанныеВывода	
КонецФункции

#КонецОбласти

#Область ОбновлениеИнформационнойБазы

Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках() Экспорт
	
	Запрос = Новый Запрос();
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Уведомление,
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ВерсияУведомления = 0";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ОбъектУведомление = Выборка.Уведомление.ПолучитьОбъект();
		ОбъектУведомление.ВерсияУведомления = Документы.УведомлениеОКонтролируемыхСделках.ВерсияУведомленияПоОтчетномуГоду(Выборка.ОтчетныйГод);
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(ОбъектУведомление);
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках2019() Экспорт
	
	Версия2019 = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2019();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Версия2019", Версия2019);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод >= ДАТАВРЕМЯ(2019, 1, 1)
	|	И УведомлениеОКонтролируемыхСделках.ВерсияУведомления <> &Версия2019";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
		УведомлениеОбъект.ВерсияУведомления = Версия2019;
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(УведомлениеОбъект);
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках2021() Экспорт
	
	Версия2021 = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2021();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Версия2021", Версия2021);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод >= ДАТАВРЕМЯ(2021, 1, 1)
	|	И УведомлениеОКонтролируемыхСделках.ВерсияУведомления <> &Версия2021";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
		УведомлениеОбъект.ВерсияУведомления = Версия2021;
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(УведомлениеОбъект);
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьВерсиюУведомленияОКонтролируемыхСделках2024() Экспорт
	
	Версия2024 = КонтролируемыеСделкиКлиентСервер.ВерсияУведомления_2024();
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Версия2024", Версия2024);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	УведомлениеОКонтролируемыхСделках.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.УведомлениеОКонтролируемыхСделках КАК УведомлениеОКонтролируемыхСделках
	|ГДЕ
	|	УведомлениеОКонтролируемыхСделках.ОтчетныйГод >= ДАТАВРЕМЯ(2024, 1, 1)
	|	И УведомлениеОКонтролируемыхСделках.ВерсияУведомления <> &Версия2024";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		УведомлениеОбъект = Выборка.Ссылка.ПолучитьОбъект();
		УведомлениеОбъект.ВерсияУведомления = Версия2024;
		ОбновлениеИнформационнойБазы.ЗаписатьОбъект(УведомлениеОбъект);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ОбработкаПолученияПредставления(Данные, Представление, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Представление = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Уведомление о контролируемых сделках за %1 г.'"),
		Формат(Данные.ОтчетныйГод, "ДФ=yyyy"));
		
	Если Данные.НомерКорректировки > 0 Тогда
		
		Представление = Представление + СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = ', корректировка %1'"),
			Формат(Данные.НомерКорректировки, "ЧГ="));
			
	КонецЕсли;
	
КонецПроцедуры

Процедура ОбработкаПолученияПолейПредставления(Поля, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Поля.Добавить("ОтчетныйГод");
	Поля.Добавить("НомерКорректировки");
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
