#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Возвращает табличный документ с расходами по документу
//
// Параметры:
//  ПараметрыВыполнения - Структура
//   * ОбъектОтбора - ДкументСсылка - документ по которому формируется отчет
//   * Организация - СправочникСсылка.Организация
// 
// Возвращаемое значение:
//  Структура
//   * ТабличныйДокумент - ТабличныйДокумент - сформированный отчет по расходам
//   * ТаблицаОплат - ТаблицаЗнанчеий - содержит документы оплаты поставщику
//   * ТаблицаОплатПокупателей - ТаблицаЗнанчеий - содержит документы оплаты покупателем
//   * ТаблицаСписаний - ТаблицаЗнанчеий - содержит документы списания и реализации
//
Функция СформироватьРасходыПоДокументу(ПараметрыВыполнения) Экспорт
	
	ОбъектОтбора = ПараметрыВыполнения.ОбъектОтбора;
	Организация  = ПараметрыВыполнения.Организация;
	
	Результат = НовыйРезультатФормированияРасходовПоДокументу();
	Если Не ОбщегоНазначения.СсылкаСуществует(ОбъектОтбора) Тогда
		
		ТекстСообщения = НСтр("ru = 'Документ, для которого сформирован отчет, стал недоступен.'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
		Возврат Результат;
		
	КонецЕсли;
	
	Период = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОбъектОтбора, "Дата");
	
	НастройкиУчетаУСН = НастройкиУСН(Организация, Период);
	Если НастройкиУчетаУСН = Неопределено Тогда
		
		ТекстСообщения = НСтр("ru = 'Не удалось определить настройки УСН.'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
		Возврат Результат;
		
	КонецЕсли;
	
	ВидОсновногоДокумента = ОпределитьВидДокумента(ОбъектОтбора);
	ТаблицаРасходовУСН = ТаблицаРасходовУСН(ОбъектОтбора, ВидОсновногоДокумента, Организация, НастройкиУчетаУСН);
	
	Результат = СформироватьТабличныйДокумент(ТаблицаРасходовУСН, НастройкиУчетаУСН, ОбъектОтбора);

	Возврат Результат;
	
КонецФункции

// Инициализирует набор параметров, задающих флаги выполнения дополнительных действий над сущностями, обрабатываемыми
// в процессе формирования отчета.
//
// Возвращаемое значение:
//   Структура - флаги, задающие необходимость дополнительных действий.
//
Функция ПолучитьПараметрыИсполненияОтчета() Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("ИспользоватьПередКомпоновкойМакета", Истина);
	Результат.Вставить("ИспользоватьДанныеРасшифровки",      Истина);
	Результат.Вставить("ИспользоватьПриВыводеЗаголовка",     Истина);
	
	Возврат Результат;
	
КонецФункции

// В процедуре можно доработать компоновщик перед выводом в отчет. Изменения сохранены не будут.
//
// Параметры:
//   ПараметрыОтчета - Структура - см. ПодготовитьПараметрыОтчета() в ФормаОтчета.
//   Схема - СхемаКомпоновкиДанных - описание получаемых данных.
//   КомпоновщикНастроек - КомпоновщикНастроекКомпоновкиДанных - связь настроек компоновки данных и схемы компоновки.
//
Процедура ПередКомпоновкойМакета(ПараметрыОтчета, Схема, КомпоновщикНастроек) Экспорт
	
	НастройкиУСН = НастройкиУСН(ПараметрыОтчета.Организация, ПараметрыОтчета.КонецПериода);

	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"Организация", ПараметрыОтчета.Организация);
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"НачалоПериода", НачалоДня(ПараметрыОтчета.НачалоПериода));
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"КонецПериода", КонецДня(ПараметрыОтчета.КонецПериода));
	
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"СчетаУчетаМатериалов", СчетаУчетаМатериалов());
	
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"СчетаУчетаОС", СчетаУчетаОС());
	
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"РасходыПринимаемыеПоОплате", РасходыПринимаемыеПоОплате(НастройкиУСН));
		
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"ПростойУчетМатериалов", НастройкиУСН.ПростойУчетМатериалов);
		
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"ПрименяетсяОбщаяСтавкаНДС", НастройкиУСН.ПрименяетсяОбщаяСтавкаНДС);
	
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"ПростойУчетНДС", НастройкиУСН.ПростойУчетНДС);
	
	БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(КомпоновщикНастроек,
		"ВидРасхода", ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(ПараметрыОтчета, "ВидРасхода"));
	
	ПроверитьПериодыПримененияСтавокНДС(ПараметрыОтчета, КомпоновщикНастроек);
	
КонецПроцедуры

// Формирует текст, выводимый в заголовке отчета.
//
// Параметры:
//   ПараметрыОтчета - Структура - см. ПодготовитьПараметрыОтчета() в ФормаОтчета.
//
// Возвращаемое значение:
//   Строка - текст заголовка с учётом периода.
//
Функция ПолучитьТекстЗаголовка(ПараметрыОтчета) Экспорт
	
	Возврат СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		НСтр("ru = 'Расходы УСН%1'"),
		БухгалтерскиеОтчетыКлиентСервер.ПолучитьПредставлениеПериода(ПараметрыОтчета.НачалоПериода, ПараметрыОтчета.КонецПериода));
	
КонецФункции

// Возвращает структуру параметров, наличие которых требуется для успешного формирования отчета.
//
// Возвращаемое значение:
//   Структура - структура параметров для формирования отчета.
//
Функция ПустыеПараметрыКомпоновкиОтчета() Экспорт
	
	// Общая структура настроек.
	ПараметрыОтчета = БухгалтерскиеОтчеты.ПустыеПараметрыКомпоновкиОтчета();
	ПараметрыОтчета.ИдентификаторОтчета = "РасходыУСН";
	
	Возврат ПараметрыОтчета;
	
КонецФункции

// Заполняет структуру настроек универсального формата из реквизитов формы.
//
// Параметры:
//   ПараметрыОтчета - Структура - см. ПустыеПараметрыКомпоновкиОтчета()
//   Форма - УправляемаяФорма - содержит основновной реквизит Отчет .
//
Процедура ЗаполнитьПараметрыИзФормы(ПараметрыОтчета, Форма) Экспорт
	
	БухгалтерскиеОтчеты.ЗаполнитьПараметрыИзФормы(ПараметрыОтчета, Форма);

КонецПроцедуры

// Формирует заголовок отчета
//
// Параметры:
//	ПараметрыОтчета - Структура - содержит ключи:
//	  * ИдентификаторОтчета - Строка - Имя отчета, как оно указано в метаданных.
//	  * СхемаКомпоновкиДанных - СхемаКомпоновкиДанных - Схема отчета.
//	  * НастройкиКомпоновкиДанных - НастройкиКомпоновкиДанных - Настройки отчета.
//  КомпоновщикНастроек	 - КомпановщикНастроек - компановщик настроек
//  Результат - ТабличныйДокумент - табличный документ, куда выводится заголовок
//
Процедура ПриВыводеЗаголовка(ПараметрыОтчета, КомпоновщикНастроек, Результат) Экспорт
	
	Макет = ПолучитьОбщийМакет("ОбщиеОбластиСтандартногоОтчета");
	
	// Организация
	Если ЗначениеЗаполнено(ПараметрыОтчета.Организация) Тогда
		ОбластьОрганизация = Макет.ПолучитьОбласть("Организация|КолонкиЗаголовка");
		КонецПериода = ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(ПараметрыОтчета, "КонецПериода", '00010101');
		ТекстОрганизация = БухгалтерскиеОтчетыВызовСервера.ПолучитьТекстОрганизация(ПараметрыОтчета.Организация,
				ПараметрыОтчета.ВключатьОбособленныеПодразделения, КонецПериода);
				
		ОбластьОрганизация.Параметры.НазваниеОрганизации = ТекстОрганизация;
		Результат.Вывести(ОбластьОрганизация);
	КонецЕсли;
	
	// Заголовок
	ОбластьЗаголовок = Макет.ПолучитьОбласть("ОбластьЗаголовок|КолонкиЗаголовка");
	ОбластьЗаголовок.Параметры.ЗаголовокОтчета = Отчеты.РасходыУСН.ПолучитьТекстЗаголовка(ПараметрыОтчета);
	
	Если ПараметрыОтчета.ИмяВарианта = "ВариантРасшифровка" Тогда
		ВидРасходаСтрокой = Перечисления.ВидыРасходовУСН.ПредставлениеВидаРасходаУСН(ПараметрыОтчета.ВидРасхода);
		ОбластьЗаголовок.Параметры.ЗаголовокОтчета = ОбластьЗаголовок.Параметры.ЗаголовокОтчета
			+ СтрШаблон(НСтр("ru = ' по виду %1'"), ВидРасходаСтрокой);
	КонецЕсли;
	
	Результат.Вывести(ОбластьЗаголовок);

КонецПроцедуры

// Возвращает набор параметров, которые необходимо сохранять в рассылке отчетов.
// Значения параметров используются при формировании отчета в рассылке.
//
// Возвращаемое значение:
//   Структура - структура настроек, сохраняемых в рассылке с неинициализированными значениями.
//
Функция НастройкиОтчетаСохраняемыеВРассылке() Экспорт
	
	КоллекцияНастроек = Новый Структура;
	КоллекцияНастроек.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	
	Возврат КоллекцияНастроек;
	
КонецФункции
#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

Функция ПредставлениеДокументаРасхода(Документ) Экспорт
	
	ДанныеДокумента = РегистрыСведений.ДанныеПервичныхДокументов.ДанныеПервичногоДокумента(Документ);
	
	Если ДанныеДокумента <> Неопределено Тогда
		ПредставлениеНомер = ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ДанныеДокумента.НомерРегистратора, Истина, Истина);
		ДатаДокумента = ?(ДанныеДокумента.Дата = Дата('00010101'), ДанныеДокумента.ДатаРегистратора, ДанныеДокумента.Дата);
		ПредставлениеДата  = Формат(ДатаДокумента, "ДФ=dd.MM.yyyy");
		
		ПредставлениеРезультат  = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = '%1 № %2 от %3'"), Документ.МетаДанные().Синоним, ПредставлениеНомер, ПредставлениеДата);
	Иначе
		ПредставлениеРезультат = Строка(Документ);
	КонецЕсли;
		
	Возврат ПредставлениеРезультат;
	
КонецФункции

Функция ТабличныйДокументРасшифровкаПоДокументам(ПараметрыФормирования) Экспорт
	
	Расшифровка = ПараметрыФормирования.Расшифровка;
	ТаблицаСписаний = ПараметрыФормирования.ТаблицаСписаний;
	ТаблицаОплат = ПараметрыФормирования.ТаблицаОплат;
	ТаблицаОплатПокупателей = ПараметрыФормирования.ТаблицаОплатПокупателей;
	
	РезультатРасшифровки = Новый ТабличныйДокумент();
	Макет = ПолучитьМакет("РасшифровкаПоДокументу");
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьЗаголовок.Параметры.Заголовок = НСтр("ru = 'Документы движения расходов'");
	РезультатРасшифровки.Вывести(ОбластьЗаголовок);

	ОбластьЗаголовок = Макет.ПолучитьОбласть("ЗаголовокДокументы");
	РезультатРасшифровки.Вывести(ОбластьЗаголовок);
	
	ВывелиСтроки = Ложь;
	Если Расшифровка.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено
		Или Расшифровка.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплаченоНеОплаченоПокупателем Тогда
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаСписаний, Расшифровка.ВидРасхода, ВывелиСтроки);
	ИначеЕсли Расшифровка.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаОплат, Расшифровка.ВидРасхода, ВывелиСтроки);
	ИначеЕсли Расшифровка.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплаченоПокупателем Тогда
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаСписаний, Расшифровка.ВидРасхода, ВывелиСтроки);
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаОплат, Расшифровка.ВидРасхода, ВывелиСтроки);
	Иначе
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаСписаний, Расшифровка.ВидРасхода, ВывелиСтроки);
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаОплат, Расшифровка.ВидРасхода, ВывелиСтроки);
		ВывестиВТаблицу(Макет, РезультатРасшифровки, ТаблицаОплатПокупателей, Расшифровка.ВидРасхода, ВывелиСтроки);
	КонецЕсли;
	
	Если Не ВывелиСтроки Тогда
		ОбластьСтрока = Макет.ПолучитьОбласть("СтрокаДанныхБезСуммы");
		ОбластьСтрока.Параметры.Пояснение = НСтр("ru = 'Документы отсутствуют'");
		РезультатРасшифровки.Вывести(ОбластьСтрока);
	КонецЕсли;
	
	Возврат РезультатРасшифровки;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ПроверитьПериодыПримененияСтавокНДС(ПараметрыОтчета, КомпоновщикНастроек)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	НастройкиУчетаНДС.Период КАК Период,
		|	НастройкиУчетаНДС.СтавкаНалогообложенияПриУСН КАК Ставка
		|ИЗ
		|	РегистрСведений.НастройкиУчетаНДС КАК НастройкиУчетаНДС
		|ГДЕ
		|	НастройкиУчетаНДС.Организация = &Организация
		|	И НастройкиУчетаНДС.Период <= &ДатаОкончания
		|
		|УПОРЯДОЧИТЬ ПО
		|	Период УБЫВ";
	
	Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(ПараметрыОтчета.КонецПериода));
	Запрос.УстановитьПараметр("Организация", ПараметрыОтчета.Организация);
	
	ПериодыПримененияНДС = Запрос.Выполнить().Выгрузить();
	
	ПериодыНДС = Новый ТаблицаЗначений();
	ПериодыНДС.Колонки.Добавить("НачалоПериода", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.ДатаВремя));
	ПериодыНДС.Колонки.Добавить("КонецПериода", ОбщегоНазначения.ОписаниеТипаДата(ЧастиДаты.ДатаВремя));
	ПериодыНДС.Колонки.Добавить("ОбщаяСтавка", Новый ОписаниеТипов("Булево"));
	
	ОбщаяСтавка = Перечисления.ВидыСтавокНДС.Общая;
	Если ПериодыПримененияНДС.Количество() > 0 Тогда
		ТекущийПериод = ПериодыПримененияНДС[0].Период;
		КонецТекущегоПериода = ПараметрыОтчета.КонецПериода;
	КонецЕсли;
	
	Для Индекс = 0 По ПериодыПримененияНДС.Количество() - 2 Цикл
		Если ТекущийПериод > ПараметрыОтчета.НачалоПериода Тогда
			Если ПериодыПримененияНДС[Индекс].Ставка <> ПериодыПримененияНДС[Индекс + 1].Ставка
				И(ПериодыПримененияНДС[Индекс].Ставка = ОбщаяСтавка
				Или ПериодыПримененияНДС[Индекс + 1].Ставка = ОбщаяСтавка) Тогда
				НоваяСтрока = ПериодыНДС.Добавить();
				НоваяСтрока.НачалоПериода = ПериодыПримененияНДС[Индекс].Период;
				Если Индекс = 0 Тогда
					НоваяСтрока.КонецПериода = КонецДня(ПараметрыОтчета.КонецПериода);
				Иначе
					НоваяСтрока.КонецПериода = КонецДня(КонецТекущегоПериода - 1);
				КонецЕсли;
				НоваяСтрока.ОбщаяСтавка = ПериодыПримененияНДС[Индекс].Ставка = ОбщаяСтавка;
				КонецТекущегоПериода = НоваяСтрока.НачалоПериода;
			КонецЕсли;
		
			// Для последнего периода
			Если Индекс <> 0 И Индекс = ПериодыПримененияНДС.Количество() - 2 Тогда
				НоваяСтрока = ПериодыНДС.Добавить();
				НоваяСтрока.НачалоПериода = ПараметрыОтчета.НачалоПериода;
				НоваяСтрока.КонецПериода = КонецДня(КонецТекущегоПериода - 1);
				НоваяСтрока.ОбщаяСтавка = ПериодыПримененияНДС[Индекс + 1].Ставка = ОбщаяСтавка;
			КонецЕсли;
			
			ТекущийПериод = ПериодыПримененияНДС[Индекс].Период;
		КонецЕсли;
	КонецЦикла;
	
	ПоВидуРасхода = Не ПараметрыОтчета.Свойство("ВидРасхода");
	Счетчик = 0;
	// Если в периоде были смены ставок НДС, то необходимо разделить такие периоды на ставку 20% (общую) и остальные
	Если ПериодыНДС.Количество() > 1 Тогда
		ПериодыНДС.Сортировать("НачалоПериода");
		ПервыйЗапрос = Истина;
		ЗапросМатериалы = "";
		ВложенныйЗапрос = "";
		
		Для Каждого ПериодПримененияНДС Из ПериодыНДС Цикл
			НачалоПериода = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("{&НачалоПериода%1}", Счетчик);
			КонецПериода  = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("{&КонецПериода%1}", Счетчик);
			
			Если Не ПервыйЗапрос Тогда
				ДобавитьОбъединение(ЗапросМатериалы);
				ДобавитьОбъединение(ВложенныйЗапрос);
			КонецЕсли;
				
			Если ПоВидуРасхода Тогда
				Если ПериодПримененияНДС.ОбщаяСтавка Тогда
					ЗапросМатериалы = ЗапросМатериалы + ТекстЗапросаПоВидамРасходовМатериалыОбщаяСтавкаНДС(
						ПервыйЗапрос, НачалоПериода, КонецПериода);
					ВложенныйЗапрос = ВложенныйЗапрос + ТекстЗапросаПоВидамРасходовОборотОбщаяСтавкаНДС(
						НачалоПериода, КонецПериода);
				Иначе
					ЗапросМатериалы = ЗапросМатериалы + ТекстЗапросаПоВидамРасходовМатериалы(
						ПервыйЗапрос, НачалоПериода, КонецПериода);
					ВложенныйЗапрос = ВложенныйЗапрос + ТекстЗапросаПоВидамРасходовОборот(
						НачалоПериода, КонецПериода);
				КонецЕсли;
			Иначе
				Если ПериодПримененияНДС.ОбщаяСтавка Тогда
					ЗапросМатериалы = ЗапросМатериалы + ТекстЗапросаПоПартиямМатериалыОбщаяСтавкаНДС(
						ПервыйЗапрос, НачалоПериода, КонецПериода);
					ВложенныйЗапрос = ВложенныйЗапрос + ТекстЗапросаПоПартиямОборотОбщаяСтавкаНДС(
						ПервыйЗапрос, НачалоПериода, КонецПериода);
				Иначе
					ЗапросМатериалы = ЗапросМатериалы + ТекстЗапросаПоПартиямМатериалы(
						ПервыйЗапрос, НачалоПериода, КонецПериода);
					ВложенныйЗапрос = ВложенныйЗапрос + ТекстЗапросаПоПартиямОборот(
						ПервыйЗапрос, НачалоПериода, КонецПериода);
				КонецЕсли;
			КонецЕсли;
			ИмяПараметраНачалоПериода = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("НачалоПериода%1", Счетчик);
			ИмяПараметраКонецПериода = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("КонецПериода%1", Счетчик);
			ПервыйЗапрос = Ложь;
			ДобавитьПараметр(
				ИмяПараметраНачалоПериода,
				ПараметрыОтчета.СхемаКомпоновкиДанных.Параметры);
			ДобавитьПараметр(
				ИмяПараметраКонецПериода,
				ПараметрыОтчета.СхемаКомпоновкиДанных.Параметры);
			
			ПараметрыОтчета.Вставить(ИмяПараметраНачалоПериода, ПериодПримененияНДС.НачалоПериода);
			ПараметрыОтчета.Вставить(ИмяПараметраКонецПериода, ПериодПримененияНДС.КонецПериода);

			Счетчик = Счетчик + 1;
		КонецЦикла;
		
		Если ПоВидуРасхода Тогда
			ПараметрыОтчета.СхемаКомпоновкиДанных.НаборыДанных.ОсновнойНабор.Запрос =
				ТекстЗапросаПоВидамРасходов(ЗапросМатериалы, ВложенныйЗапрос);
		Иначе
			ПараметрыОтчета.СхемаКомпоновкиДанных.НаборыДанных.НаборДляРасшифровки.Запрос =
				ТекстЗапросаПоПартиям(ЗапросМатериалы, ВложенныйЗапрос);
		КонецЕсли;
		
		КомпоновщикНастроек.Инициализировать(
			Новый ИсточникДоступныхНастроекКомпоновкиДанных(ПараметрыОтчета.СхемаКомпоновкиДанных));
		
		Для Индекс = 0 По ПериодыНДС.Количество() - 1 Цикл
			БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(
				КомпоновщикНастроек, "НачалоПериода" + Строка(Индекс), ПериодыНДС[Индекс].НачалоПериода);
			БухгалтерскиеОтчетыКлиентСервер.УстановитьПараметр(
				КомпоновщикНастроек, "КонецПериода" + Строка(Индекс), ПериодыНДС[Индекс].КонецПериода);
		КонецЦикла;

	Иначе
		Если ПоВидуРасхода Тогда
			ПараметрыОтчета.СхемаКомпоновкиДанных.НаборыДанных.ОсновнойНабор.Запрос =
				ТекстЗапросаПоВидамРасходовОдинПериод();
		Иначе
			ПараметрыОтчета.СхемаКомпоновкиДанных.НаборыДанных.НаборДляРасшифровки.Запрос =
				ТекстЗапросаПоПартиямОдинПериод();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьПараметр(ИмяПараметра, Параметры)
	
	Параметр = Параметры.Найти(ИмяПараметра);
	Если Параметр = Неопределено Тогда
		Параметр = Параметры.Добавить();
		Параметр.Имя = ИмяПараметра;
		Параметр.ОграничениеИспользования = Истина;
	КонецЕсли;
	
КонецПроцедуры

Процедура ДобавитьОбъединение(ТекстЗапроса)
	
	ТекстЗапроса = ТекстЗапроса +
		"
		|
		|	ОБЪЕДИНИТЬ ВСЕ
		|
		|";

КонецПроцедуры

Функция ТекстЗапросаПоВидамРасходовМатериалы(ПервыйЗапрос, НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.ВидРасхода КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|				И (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|			ТОГДА ВЫБОР
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеОплачено)
		|				И РасходыПриУСНОбороты.СуммаОборот < 0
		|			ТОГДА ВЫБОР
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА - РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ - РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Сумма";
	Если ПервыйЗапрос Тогда
		ТекстЗапроса = ТекстЗапроса
			+ "
			|ПОМЕСТИТЬ вт_Признание_Материалов"
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса
		+ "
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			&ПростойУчетМатериалов
		|				И Организация = &Организация
		|				И СчетУчета В (&СчетаУчетаМатериалов)
		|				И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоВидамРасходовМатериалыОбщаяСтавкаНДС(ПервыйЗапрос, НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.ВидРасхода КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|				И (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|			ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеОплачено)
		|				И РасходыПриУСНОбороты.СуммаОборот < 0
		|			ТОГДА - РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Сумма";
	Если ПервыйЗапрос Тогда
		ТекстЗапроса = ТекстЗапроса
			+ "
			|ПОМЕСТИТЬ вт_Признание_Материалов"
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса
		+ "
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			&ПростойУчетМатериалов
		|				И Организация = &Организация
		|				И СчетУчета В (&СчетаУчетаМатериалов)
		|				И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоВидамРасходовОборот(НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|	КОНЕЦ КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА (РасходыПриУСНОбороты.СуммаОборот > 0
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|				И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|				И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные)
		|			ТОГДА ВЫБОР
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Приход,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|				ИЛИ РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА 0
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И &ПростойУчетМатериалов
		|			ТОГДА 0
		|		КОГДА ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах)
		|			ТОГДА 0
		|		КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.ВозвратТоваровПоставщику)
		|					И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.КорректировкаПоступления)
		|				ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|					И (РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|						ИЛИ РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные))
		|			ТОГДА ВЫБОР
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Расход
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|	КОНЕЦ,
		|	0,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И ((ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|						И ВЫРАЗИТЬ(РасходыПриУСНОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ПередачаТоваров))
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах))
		|					И РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписано)
		|				ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|					И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|					И ВЫРАЗИТЬ(РасходыПриУСНОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ПередачаТоваров)
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|			ТОГДА ВЫБОР
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(ПЕречисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА &ПростойУчетНДС
		|			ТОГДА РасходыПриУСНОбороты.СуммаПриход + РасходыПриУСНОбороты.НДСПриход
		|		ИНАЧЕ РасходыПриУСНОбороты.СуммаПриход
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|				ИЛИ РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА 0
		|		КОГДА &ПростойУчетНДС
		|			ТОГДА РасходыПриУСНОбороты.СуммаРасход + РасходыПриУСНОбороты.НДСРасход
		|		ИНАЧЕ РасходыПриУСНОбороты.СуммаРасход
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоВидамРасходовОборотОбщаяСтавкаНДС(НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|	КОНЕЦ КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА (РасходыПриУСНОбороты.СуммаОборот > 0
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|				И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|				И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные)
		|			ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Приход,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|				ИЛИ РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА 0
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И &ПростойУчетМатериалов
		|			ТОГДА 0
		|		КОГДА ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|				ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах)
		|			ТОГДА 0
		|		КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.ВозвратТоваровПоставщику)
		|					И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.КорректировкаПоступления)
		|				ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|					И (РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|						ИЛИ РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные))
		|			ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Расход
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|	КОНЕЦ,
		|	0,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И ((ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|						И ВЫРАЗИТЬ(РасходыПриУСНОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ПередачаТоваров))
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах))
		|					И РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписано)
		|				ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|					И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|					И ВЫРАЗИТЬ(РасходыПриУСНОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ПередачаТоваров)
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|			ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|	КОНЕЦ,
		|	РасходыПриУСНОбороты.СуммаПриход - РасходыПриУСНОбороты.НДСПриход,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|				ИЛИ РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА 0
		|		ИНАЧЕ РасходыПриУСНОбороты.СуммаРасход - РасходыПриУСНОбороты.НДСРасход
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоВидамРасходов(ЗапросПоМатериалам, ВложенныйЗапрос)
	
	ТекстЗапроса =
		"&ЗапросПоМатериалам
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС) КАК ВидРасхода,
		|	КнигаУчетаДоходовИРасходовОСОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_ОС
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовОС.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовОСОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА) КАК ВидРасхода,
		|	КнигаУчетаДоходовИРасходовНМАОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_НМА
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовНМА.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовНМАОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.ВидРасхода КАК ВидРасхода,
		|	СУММА(ВложенныйЗапрос.Приход) КАК Приход,
		|	СУММА(ВложенныйЗапрос.Расход) КАК Расход
		|ПОМЕСТИТЬ вт_ОборотыПоВидуРасхода
		|ИЗ
		|	(&ВложенныйЗапрос
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_ОС.ВидРасхода,
		|		0,
		|		вт_Признание_ОС.Сумма
		|	ИЗ
		|		вт_Признание_ОС КАК вт_Признание_ОС
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_НМА.ВидРасхода,
		|		0,
		|		вт_Признание_НМА.Сумма
		|	ИЗ
		|		вт_Признание_НМА КАК вт_Признание_НМА
		|	
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_Материалов.ВидРасхода,
		|		0,
		|		вт_Признание_Материалов.Сумма
		|	ИЗ
		|		вт_Признание_Материалов КАК вт_Признание_Материалов) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.ВидРасхода
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(ПЕречисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОстаткиИОбороты.ВидРасхода
		|	КОНЕЦ КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|			ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|		КОГДА &ПростойУчетНДС
		|			ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|		ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток
		|	КОНЕЦ КАК НачальныйОстаток,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		ИНАЧЕ ВЫБОР
		|				КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				КОГДА &ПростойУчетНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток
		|			КОНЕЦ
		|	КОНЕЦ КАК КонечныйОстаток
		|ПОМЕСТИТЬ вт_ОстаткиПоВидуРасхода
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Авто,
		|			,
		|			Организация = &Организация
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОстаткиИОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.ВидРасхода КАК ВидРасхода,
		|	СУММА(ВложенныйЗапрос.НачальныйОстаток) КАК НачальныйОстаток,
		|	СУММА(ВложенныйЗапрос.Приход) КАК Приход,
		|	СУММА(ВложенныйЗапрос.Расход) КАК Расход,
		|	ВЫБОР
		|		КОГДА ВложенныйЗапрос.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ ВложенныйЗапрос.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА СУММА(ВложенныйЗапрос.НачальныйОстаток + ВложенныйЗапрос.Приход - ВложенныйЗапрос.Расход)
		|		ИНАЧЕ СУММА(ВложенныйЗапрос.КонечныйОстаток)
		|	КОНЕЦ КАК КонечныйОстаток
		|ИЗ
		|	(ВЫБРАТЬ
		|		вт_ОборотыПоВидуРасхода.ВидРасхода КАК ВидРасхода,
		|		0 КАК НачальныйОстаток,
		|		вт_ОборотыПоВидуРасхода.Приход КАК Приход,
		|		вт_ОборотыПоВидуРасхода.Расход КАК Расход,
		|		0 КАК КонечныйОстаток
		|	ИЗ
		|		вт_ОборотыПоВидуРасхода КАК вт_ОборотыПоВидуРасхода
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_ОстаткиПоВидуРасхода.ВидРасхода,
		|		вт_ОстаткиПоВидуРасхода.НачальныйОстаток,
		|		0,
		|		0,
		|		вт_ОстаткиПоВидуРасхода.КонечныйОстаток
		|	ИЗ
		|		вт_ОстаткиПоВидуРасхода КАК вт_ОстаткиПоВидуРасхода
		|	ГДЕ
		|		вт_ОстаткиПоВидуРасхода.НачальныйОстаток + вт_ОстаткиПоВидуРасхода.КонечныйОстаток > 0) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.ВидРасхода";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ЗапросПоМатериалам", ЗапросПоМатериалам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ВложенныйЗапрос", ВложенныйЗапрос);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоПартиямМатериалы(ПервыйЗапрос, НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|				И &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|				ТОГДА ВЫБОР КОГДА &ПростойУчетНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеОплачено)
		|				И &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И РасходыПриУСНОбороты.СуммаОборот < 0
		|				ТОГДА ВЫБОР КОГДА &ПростойУчетНДС
		|						ТОГДА - РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ - РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК Сумма";
	Если ПервыйЗапрос Тогда
		ТекстЗапроса = ТекстЗапроса
			+ "
			|ПОМЕСТИТЬ вт_Признание_Материалов"
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса
		+ "
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			&ПростойУчетМатериалов
		|				И Организация = &Организация
		|				И СчетУчета В (&СчетаУчетаМатериалов)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоПартиямМатериалыОбщаяСтавкаНДС(ПервыйЗапрос, НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|				И &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|			ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеОплачено)
		|				И &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И РасходыПриУСНОбороты.СуммаОборот < 0
		|			ТОГДА - РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|		ИНАЧЕ 0
		|	КОНЕЦ) КАК Сумма";
	Если ПервыйЗапрос Тогда
		ТекстЗапроса = ТекстЗапроса
			+ "
			|ПОМЕСТИТЬ вт_Признание_Материалов"
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса
		+ "
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			&ПростойУчетМатериалов
		|				И Организация = &Организация
		|				И СчетУчета В (&СчетаУчетаМатериалов)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоПартиямОборот(ПервыйЗапрос, НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|			КОГДА (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаПриход,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|					И &ПростойУчетМатериалов
		|				ТОГДА 0
		|			КОГДА ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах)
		|				ТОГДА 0
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.ВозвратТоваровПоставщику)
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.КорректировкаПоступления)
		|					ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|						И (РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|							ИЛИ РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные))
		|				ТОГДА ВЫБОР
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаРасход";
	Если ПервыйЗапрос Тогда
		ТекстЗапроса = ТекстЗапроса
			+ "
			|ПОМЕСТИТЬ вт_ОборотыПоРасчетномуДокументу"
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса
		+ "
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	0,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И (ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах))
		|					И РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписано)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ)
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|			КОГДА &ПростойУчетНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаПриход + РасходыПриУСНОбороты.НДСПриход
		|			ИНАЧЕ РасходыПриУСНОбороты.СуммаПриход
		|		КОНЕЦ),
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|			ТОГДА ЕСТЬNULL(вт_Признание_ОС.Сумма, 0)
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА ЕСТЬNULL(вт_Признание_НМА.Сумма, 0)
		|		ИНАЧЕ СУММА(ВЫБОР
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаРасход + РасходыПриУСНОбороты.НДСРасход
		|					ИНАЧЕ РасходыПриУСНОбороты.СуммаРасход
		|				КОНЕЦ)
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			,
		|			Организация = &Организация
		|				И ВидРасхода = &ВидРасхода
		|				И ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Признание_ОС КАК вт_Признание_ОС
		|		ПО (вт_Признание_ОС.ОсновноеСредство = РасходыПриУСНОбороты.ЭлементРасхода)
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Признание_НМА КАК вт_Признание_НМА
		|		ПО (вт_Признание_НМА.НематериальныйАктив = РасходыПриУСНОбороты.ЭлементРасхода)
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	РасходыПриУСНОбороты.ВидРасхода,
		|	вт_Признание_ОС.Сумма,
		|	вт_Признание_НМА.Сумма";
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоПартиямОборотОбщаяСтавкаНДС(ПервыйЗапрос, НачалоПериода, КонецПериода)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|			КОГДА (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные)
		|				ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаПриход,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|					И &ПростойУчетМатериалов
		|				ТОГДА 0
		|			КОГДА ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах)
		|				ТОГДА 0
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.ВозвратТоваровПоставщику)
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.КорректировкаПоступления)
		|					ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|						И (РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|							ИЛИ РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные))
		|				ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаРасход";
	Если ПервыйЗапрос Тогда
		ТекстЗапроса = ТекстЗапроса
			+ "
			|ПОМЕСТИТЬ вт_ОборотыПоРасчетномуДокументу"
	КонецЕсли;
	ТекстЗапроса = ТекстЗапроса
		+ "
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	0,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И (ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах))
		|					И РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписано)
		|				ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|			ИНАЧЕ 0
		|		КОНЕЦ)
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	СУММА(РасходыПриУСНОбороты.СуммаПриход - РасходыПриУСНОбороты.НДСПриход),
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|			ТОГДА ЕСТЬNULL(вт_Признание_ОС.Сумма, 0)
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА ЕСТЬNULL(вт_Признание_НМА.Сумма, 0)
		|		ИНАЧЕ СУММА(РасходыПриУСНОбороты.СуммаРасход - РасходыПриУСНОбороты.НДСРасход)
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			,
		|			Организация = &Организация
		|				И ВидРасхода = &ВидРасхода
		|				И ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Признание_ОС КАК вт_Признание_ОС
		|		ПО (вт_Признание_ОС.ОсновноеСредство = РасходыПриУСНОбороты.ЭлементРасхода)
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Признание_НМА КАК вт_Признание_НМА
		|		ПО (вт_Признание_НМА.НематериальныйАктив = РасходыПриУСНОбороты.ЭлементРасхода)
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	РасходыПриУСНОбороты.ВидРасхода,
		|	вт_Признание_ОС.Сумма,
		|	вт_Признание_НМА.Сумма";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&НачалоПериода", НачалоПериода);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&КонецПериода", КонецПериода);
		
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоПартиям(ЗапросПоМатериалам, ВложенныйЗапрос)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	КнигаУчетаДоходовИРасходовОСОбороты.ОсновноеСредство КАК ОсновноеСредство,
		|	КнигаУчетаДоходовИРасходовОСОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_ОС
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовОС.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовОСОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КнигаУчетаДоходовИРасходовНМАОбороты.НематериальныйАктив КАК НематериальныйАктив,
		|	КнигаУчетаДоходовИРасходовНМАОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_НМА
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовНМА.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовНМАОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|&ЗапросПоМатериалам
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|&ВложенныйЗапрос
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	РасходыПриУСНОстаткиИОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		ИНАЧЕ ВЫБОР
		|				КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|				КОГДА &ПростойУчетНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|				ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток
		|			КОНЕЦ
		|	КОНЕЦ КАК СуммаНачальныйОстаток,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС) ИЛИ &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА 0
		|		ИНАЧЕ ВЫБОР
		|				КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				КОГДА &ПростойУчетНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток
		|			КОНЕЦ
		|	КОНЕЦ КАК СуммаКонечныйОстаток
		|ПОМЕСТИТЬ вт_ОстаткиПоРасчетномуДокументу
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			,
		|			,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС) И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОстаткиИОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВложенныйЗапрос.СуммаНачальныйОстаток) КАК СуммаНачальныйОстаток,
		|	СУММА(ВложенныйЗапрос.СуммаПриход) КАК СуммаПриход,
		|	СУММА(ВложенныйЗапрос.СуммаРасход) КАК СуммаРасход,
		|	ВЫБОР
		|		КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА СУММА(ВложенныйЗапрос.СуммаНачальныйОстаток + ВложенныйЗапрос.СуммаПриход - ВложенныйЗапрос.СуммаРасход)
		|		ИНАЧЕ СУММА(ВложенныйЗапрос.СуммаКонечныйОстаток)
		|	КОНЕЦ КАК СуммаКонечныйОстаток
		|ИЗ
		|	(ВЫБРАТЬ
		|		вт_ОборотыПоРасчетномуДокументу.РасчетныйДокумент КАК РасчетныйДокумент,
		|		0 КАК СуммаНачальныйОстаток,
		|		вт_ОборотыПоРасчетномуДокументу.СуммаПриход КАК СуммаПриход,
		|		вт_ОборотыПоРасчетномуДокументу.СуммаРасход КАК СуммаРасход,
		|		0 КАК СуммаКонечныйОстаток
		|	ИЗ
		|		вт_ОборотыПоРасчетномуДокументу КАК вт_ОборотыПоРасчетномуДокументу
		|	ГДЕ
		|		(вт_ОборотыПоРасчетномуДокументу.СуммаПриход 
		|				+ вт_ОборотыПоРасчетномуДокументу.СуммаРасход <> 0)
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_ОстаткиПоРасчетномуДокументу.РасчетныйДокумент,
		|		вт_ОстаткиПоРасчетномуДокументу.СуммаНачальныйОстаток,
		|		0,
		|		0,
		|		вт_ОстаткиПоРасчетномуДокументу.СуммаКонечныйОстаток
		|	ИЗ
		|		вт_ОстаткиПоРасчетномуДокументу КАК вт_ОстаткиПоРасчетномуДокументу
		|	ГДЕ
		|		(вт_ОстаткиПоРасчетномуДокументу.СуммаНачальныйОстаток
		|				+ вт_ОстаткиПоРасчетномуДокументу.СуммаКонечныйОстаток <> 0)
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_Материалов.РасчетныйДокумент,
		|		0,
		|		0,
		|		вт_Признание_Материалов.Сумма,
		|		0
		|	ИЗ
		|		вт_Признание_Материалов КАК вт_Признание_Материалов
		|	ГДЕ
		|		вт_Признание_Материалов.Сумма <> 0) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.РасчетныйДокумент";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ЗапросПоМатериалам", ЗапросПоМатериалам);
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ВложенныйЗапрос", ВложенныйЗапрос);
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоВидамРасходовОдинПериод()
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСНОбороты.ВидРасхода КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|				И (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|			ТОГДА ВЫБОР
		|					КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеОплачено)
		|				И РасходыПриУСНОбороты.СуммаОборот < 0
		|			ТОГДА ВЫБОР
		|					КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|						ТОГДА - РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА - РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|					ИНАЧЕ - РасходыПриУСНОбороты.СуммаОборот
		|				КОНЕЦ
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_Материалов
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			&ПростойУчетМатериалов
		|				И Организация = &Организация
		|				И СчетУчета В (&СчетаУчетаМатериалов)
		|				И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС) КАК ВидРасхода,
		|	КнигаУчетаДоходовИРасходовОСОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_ОС
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовОС.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовОСОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА) КАК ВидРасхода,
		|	КнигаУчетаДоходовИРасходовНМАОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_НМА
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовНМА.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовНМАОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.ВидРасхода КАК ВидРасхода,
		|	СУММА(ВложенныйЗапрос.Приход) КАК Приход,
		|	СУММА(ВложенныйЗапрос.Расход) КАК Расход
		|ПОМЕСТИТЬ вт_ОборотыПоВидуРасхода
		|ИЗ
		|	(ВЫБРАТЬ
		|		ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|			ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|		КОНЕЦ КАК ВидРасхода,
		|		ВЫБОР
		|			КОГДА (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ КАК Приход,
		|		ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|					ИЛИ РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|					ИЛИ РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|				ТОГДА 0
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|					И &ПростойУчетМатериалов
		|				ТОГДА 0
		|			КОГДА ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах)
		|				ТОГДА 0
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.ВозвратТоваровПоставщику)
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.КорректировкаПоступления)
		|					ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|						И (РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|							ИЛИ РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные))
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ КАК Расход
		|	ИЗ
		|		РегистрНакопления.РасходыПриУСН.Обороты(
		|				&НачалоПериода,
		|				&КонецПериода,
		|				Регистратор,
		|				Организация = &Организация
		|					И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|					И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|			ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|		КОНЕЦ,
		|		0,
		|		ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|						И (ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|								И ВЫРАЗИТЬ(РасходыПриУСНОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ПередачаТоваров)
		|							ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|							ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|							ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах))
		|						И РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписано)
		|					ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|						И ВЫРАЗИТЬ(РасходыПриУСНОбороты.Регистратор КАК Документ.РеализацияТоваровУслуг).ВидОперации <> ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРеализацияТоваров.ПередачаТоваров)
		|						И РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ
		|	ИЗ
		|		РегистрНакопления.РасходыПриУСН.Обороты(
		|				&НачалоПериода,
		|				&КонецПериода,
		|				Регистратор,
		|				Организация = &Организация
		|					И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|					И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|				ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|			ИНАЧЕ РасходыПриУСНОбороты.ВидРасхода
		|		КОНЕЦ,
		|		ВЫБОР
		|			КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаПриход - РасходыПриУСНОбороты.НДСПриход
		|			КОГДА &ПростойУчетНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаПриход + РасходыПриУСНОбороты.НДСПриход
		|			ИНАЧЕ РасходыПриУСНОбороты.СуммаПриход
		|		КОНЕЦ,
		|		ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|					ИЛИ РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|					ИЛИ РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаОС)
		|				ТОГДА 0
		|			КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаРасход - РасходыПриУСНОбороты.НДСРасход
		|			КОГДА &ПростойУчетНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаРасход + РасходыПриУСНОбороты.НДСРасход
		|			ИНАЧЕ РасходыПриУСНОбороты.СуммаРасход
		|		КОНЕЦ
		|	ИЗ
		|		РегистрНакопления.РасходыПриУСН.Обороты(
		|				&НачалоПериода,
		|				&КонецПериода,
		|				Регистратор,
		|				Организация = &Организация
		|					И ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|					И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_ОС.ВидРасхода,
		|		0,
		|		вт_Признание_ОС.Сумма
		|	ИЗ
		|		вт_Признание_ОС КАК вт_Признание_ОС
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_НМА.ВидРасхода,
		|		0,
		|		вт_Признание_НМА.Сумма
		|	ИЗ
		|		вт_Признание_НМА КАК вт_Признание_НМА
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_Материалов.ВидРасхода,
		|		0,
		|		вт_Признание_Материалов.Сумма
		|	ИЗ
		|		вт_Признание_Материалов КАК вт_Признание_Материалов) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.ВидРасхода
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаОС)
		|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|		ИНАЧЕ РасходыПриУСНОстаткиИОбороты.ВидРасхода
		|	КОНЕЦ КАК ВидРасхода,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|			ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|		КОГДА &ПростойУчетНДС
		|			ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|		ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток
		|	КОНЕЦ КАК НачальныйОстаток,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		ИНАЧЕ ВЫБОР
		|				КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				КОГДА &ПростойУчетНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток
		|			КОНЕЦ
		|	КОНЕЦ КАК КонечныйОстаток
		|ПОМЕСТИТЬ вт_ОстаткиПоВидуРасхода
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Авто,
		|			,
		|			Организация = &Организация
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОстаткиИОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.ВидРасхода КАК ВидРасхода,
		|	СУММА(ВложенныйЗапрос.НачальныйОстаток) КАК НачальныйОстаток,
		|	СУММА(ВложенныйЗапрос.Приход) КАК Приход,
		|	СУММА(ВложенныйЗапрос.Расход) КАК Расход,
		|	ВЫБОР
		|		КОГДА ВложенныйЗапрос.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ ВложенныйЗапрос.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА СУММА(ВложенныйЗапрос.НачальныйОстаток + ВложенныйЗапрос.Приход - ВложенныйЗапрос.Расход)
		|		ИНАЧЕ СУММА(ВложенныйЗапрос.КонечныйОстаток)
		|	КОНЕЦ КАК КонечныйОстаток
		|ИЗ
		|	(ВЫБРАТЬ
		|		вт_ОборотыПоВидуРасхода.ВидРасхода КАК ВидРасхода,
		|		0 КАК НачальныйОстаток,
		|		вт_ОборотыПоВидуРасхода.Приход КАК Приход,
		|		вт_ОборотыПоВидуРасхода.Расход КАК Расход,
		|		0 КАК КонечныйОстаток
		|	ИЗ
		|		вт_ОборотыПоВидуРасхода КАК вт_ОборотыПоВидуРасхода
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_ОстаткиПоВидуРасхода.ВидРасхода,
		|		вт_ОстаткиПоВидуРасхода.НачальныйОстаток,
		|		0,
		|		0,
		|		вт_ОстаткиПоВидуРасхода.КонечныйОстаток
		|	ИЗ
		|		вт_ОстаткиПоВидуРасхода КАК вт_ОстаткиПоВидуРасхода
		|	ГДЕ
		|		вт_ОстаткиПоВидуРасхода.НачальныйОстаток + вт_ОстаткиПоВидуРасхода.КонечныйОстаток > 0) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.ВидРасхода";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Функция ТекстЗапросаПоПартиямОдинПериод()
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	КнигаУчетаДоходовИРасходовОСОбороты.ОсновноеСредство КАК ОсновноеСредство,
		|	КнигаУчетаДоходовИРасходовОСОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_ОС
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовОС.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовОСОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КнигаУчетаДоходовИРасходовНМАОбороты.НематериальныйАктив КАК НематериальныйАктив,
		|	КнигаУчетаДоходовИРасходовНМАОбороты.Графа13_СуммаРасходовЗаКварталОборот КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_НМА
		|ИЗ
		|	РегистрНакопления.КнигаУчетаДоходовИРасходовНМА.Обороты(&НачалоПериода, &КонецПериода, , Организация = &Организация) КАК КнигаУчетаДоходовИРасходовНМАОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|					И &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|					И (РасходыПриУСНОбороты.СуммаОборот > 0
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			КОГДА РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеОплачено)
		|					И &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|					И РасходыПриУСНОбороты.СуммаОборот < 0
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА - РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА - РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ - РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК Сумма
		|ПОМЕСТИТЬ вт_Признание_Материалов
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			&ПростойУчетМатериалов
		|				И Организация = &Организация
		|				И СчетУчета В (&СчетаУчетаМатериалов)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|			КОГДА (РасходыПриУСНОбороты.СуммаОборот > 0
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ВозвратТоваровПоставщику)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.КорректировкаПоступления))
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|					И РасходыПриУСНОбороты.СтатусыПартийУСН <> ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаПриход,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|					И &ПростойУчетМатериалов
		|				ТОГДА 0
		|			КОГДА ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|					ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах)
		|				ТОГДА 0
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.ВозвратТоваровПоставщику)
		|						И ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) <> ТИП(Документ.КорректировкаПоступления)
		|					ИЛИ РасходыПриУСНОбороты.СуммаОборот > 0
		|						И (РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.НаРеализации)
		|							ИЛИ РасходыПриУСНОбороты.СтатусыПартийУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыПартийУСН.Списанные))
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаРасход
		|ПОМЕСТИТЬ вт_ОборотыПоРасчетномуДокументу
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	0,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСНОбороты.СуммаОборот < 0
		|					И (ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.РеализацияТоваровУслуг)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетОРозничныхПродажах)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ТребованиеНакладная)
		|						ИЛИ ТИПЗНАЧЕНИЯ(РасходыПриУСНОбороты.Регистратор) = ТИП(Документ.ОтчетКомиссионераОПродажах))
		|					И РасходыПриУСНОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписано)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот + РасходыПриУСНОбороты.НДСОборот
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА -РасходыПриУСНОбороты.СуммаОборот - РасходыПриУСНОбороты.НДСОборот
		|						ИНАЧЕ -РасходыПриУСНОбороты.СуммаОборот
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ)
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И НЕ ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	СУММА(ВЫБОР
		|			КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаПриход - РасходыПриУСНОбороты.НДСПриход
		|			КОГДА &ПростойУчетНДС
		|				ТОГДА РасходыПриУСНОбороты.СуммаПриход + РасходыПриУСНОбороты.НДСПриход
		|			ИНАЧЕ РасходыПриУСНОбороты.СуммаПриход
		|		КОНЕЦ),
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|			ТОГДА ЕСТЬNULL(вт_Признание_ОС.Сумма, 0)
		|		КОГДА РасходыПриУСНОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА ЕСТЬNULL(вт_Признание_НМА.Сумма, 0)
		|		ИНАЧЕ СУММА(ВЫБОР
		|					КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаРасход - РасходыПриУСНОбороты.НДСРасход
		|					КОГДА &ПростойУчетНДС
		|						ТОГДА РасходыПриУСНОбороты.СуммаРасход + РасходыПриУСНОбороты.НДСРасход
		|					ИНАЧЕ РасходыПриУСНОбороты.СуммаРасход
		|				КОНЕЦ)
		|	КОНЕЦ
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			Регистратор,
		|			,
		|			Организация = &Организация
		|				И ВидРасхода = &ВидРасхода
		|				И ВидРасхода В (&РасходыПринимаемыеПоОплате)
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОбороты
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Признание_ОС КАК вт_Признание_ОС
		|		ПО (вт_Признание_ОС.ОсновноеСредство = РасходыПриУСНОбороты.ЭлементРасхода)
		|		ЛЕВОЕ СОЕДИНЕНИЕ вт_Признание_НМА КАК вт_Признание_НМА
		|		ПО (вт_Признание_НМА.НематериальныйАктив = РасходыПриУСНОбороты.ЭлементРасхода)
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСНОбороты.РасчетныйДокумент,
		|	РасходыПриУСНОбороты.ВидРасхода,
		|	вт_Признание_ОС.Сумма,
		|	вт_Признание_НМА.Сумма
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	РасходыПриУСНОстаткиИОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		ИНАЧЕ ВЫБОР
		|				КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|				КОГДА &ПростойУчетНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСНачальныйОстаток
		|				ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаНачальныйОстаток
		|			КОНЕЦ
		|	КОНЕЦ КАК СуммаНачальныйОстаток,
		|	ВЫБОР
		|		КОГДА &ПростойУчетМатериалов
		|				И РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|				И РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН = ЗНАЧЕНИЕ(Перечисление.СтатусыРасходовУСН.НеСписаноПринято)
		|			ТОГДА 0
		|		КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА 0
		|		ИНАЧЕ ВЫБОР
		|				КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток - РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				КОГДА &ПростойУчетНДС
		|					ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток + РасходыПриУСНОстаткиИОбороты.НДСКонечныйОстаток
		|				ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаКонечныйОстаток
		|			КОНЕЦ
		|	КОНЕЦ КАК СуммаКонечныйОстаток
		|ПОМЕСТИТЬ вт_ОстаткиПоРасчетномуДокументу
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			,
		|			,
		|			Организация = &Организация
		|				И ВЫБОР
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|							И СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ЛОЖЬ
		|					КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|							И СчетУчета В (&СчетаУчетаОС)
		|							И ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|						ТОГДА ИСТИНА
		|					ИНАЧЕ ВидРасхода = &ВидРасхода
		|				КОНЕЦ
		|				И ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОстаткиИОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.РасчетныйДокумент КАК РасчетныйДокумент,
		|	СУММА(ВложенныйЗапрос.СуммаНачальныйОстаток) КАК СуммаНачальныйОстаток,
		|	СУММА(ВложенныйЗапрос.СуммаПриход) КАК СуммаПриход,
		|	СУММА(ВложенныйЗапрос.СуммаРасход) КАК СуммаРасход,
		|	ВЫБОР
		|		КОГДА &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС)
		|				ИЛИ &ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.НМА)
		|			ТОГДА СУММА(ВложенныйЗапрос.СуммаНачальныйОстаток + ВложенныйЗапрос.СуммаПриход - ВложенныйЗапрос.СуммаРасход)
		|		ИНАЧЕ СУММА(ВложенныйЗапрос.СуммаКонечныйОстаток)
		|	КОНЕЦ КАК СуммаКонечныйОстаток
		|ИЗ
		|	(ВЫБРАТЬ
		|		вт_ОборотыПоРасчетномуДокументу.РасчетныйДокумент КАК РасчетныйДокумент,
		|		0 КАК СуммаНачальныйОстаток,
		|		вт_ОборотыПоРасчетномуДокументу.СуммаПриход КАК СуммаПриход,
		|		вт_ОборотыПоРасчетномуДокументу.СуммаРасход КАК СуммаРасход,
		|		0 КАК СуммаКонечныйОстаток
		|	ИЗ
		|		вт_ОборотыПоРасчетномуДокументу КАК вт_ОборотыПоРасчетномуДокументу
		|	ГДЕ
		|		вт_ОборотыПоРасчетномуДокументу.СуммаПриход + вт_ОборотыПоРасчетномуДокументу.СуммаРасход <> 0
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_ОстаткиПоРасчетномуДокументу.РасчетныйДокумент,
		|		вт_ОстаткиПоРасчетномуДокументу.СуммаНачальныйОстаток,
		|		0,
		|		0,
		|		вт_ОстаткиПоРасчетномуДокументу.СуммаКонечныйОстаток
		|	ИЗ
		|		вт_ОстаткиПоРасчетномуДокументу КАК вт_ОстаткиПоРасчетномуДокументу
		|	ГДЕ
		|		вт_ОстаткиПоРасчетномуДокументу.СуммаНачальныйОстаток + вт_ОстаткиПоРасчетномуДокументу.СуммаКонечныйОстаток <> 0
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		вт_Признание_Материалов.РасчетныйДокумент,
		|		0,
		|		0,
		|		вт_Признание_Материалов.Сумма,
		|		0
		|	ИЗ
		|		вт_Признание_Материалов КАК вт_Признание_Материалов
		|	ГДЕ
		|		вт_Признание_Материалов.Сумма <> 0) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.РасчетныйДокумент";
	
	Возврат ТекстЗапроса;
	
КонецФункции

Процедура ВывестиВТаблицу(Макет, ТабличныйДокумент, Таблица, ВидРасхода, ВывелиСтроки)
	
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		Если СтрокаТаблицы.ВидРасхода = ВидРасхода Тогда
			ОбластьСтрока = Макет.ПолучитьОбласть("СтрокаДокумент");
			ОбластьСтрока.Параметры.Ссылка = СтрокаТаблицы.Документ;
			ОбластьСтрока.Параметры.Сумма = СтрокаТаблицы.Сумма;
			ТабличныйДокумент.Вывести(ОбластьСтрока);
			ВывелиСтроки = Истина;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Функция НовыйРезультатФормированияРасходовПоДокументу()
	
	Результат = Новый Структура;
	Результат.Вставить("ТабличныйДокумент", Новый ТабличныйДокумент);
	Результат.Вставить("ТаблицаОплат", Новый ТаблицаЗначений);
	Результат.Вставить("ТаблицаСписаний", Новый ТаблицаЗначений);
	Результат.Вставить("ТаблицаОплатПокупателей", Новый ТаблицаЗначений);
	
	Возврат Результат;
	
КонецФункции

Функция НовыеНастройкиУСН()
	
	НастройкиУСН = Новый Структура;
	НастройкиУСН.Вставить("ПростойУчетТоваров", Истина);
	НастройкиУСН.Вставить("ПростойУчетМатериалов", Истина);
	НастройкиУСН.Вставить("ПростойУчетНДС", Истина);
	НастройкиУСН.Вставить("ПростойУчетТаможенныхПлатежей", Истина);
	НастройкиУСН.Вставить("ПростойУчетДопРасходов", Истина);
	НастройкиУСН.Вставить("ПрименяетсяОбщаяСтавкаНДС", Ложь);
	
	Возврат НастройкиУСН;
	
КонецФункции

Функция НастройкиУСН(Организация, Период)
	
	НастройкиУСН = НовыеНастройкиУСН();
	
	НастройкиУСН.ПростойУчетДопРасходов = УчетнаяПолитика.ПорядокПризнанияДопРасходов(Организация, Период)
		= Перечисления.ПорядокПризнанияДопРасходов.ПоОплатеПоставщику;
	НастройкиУСН.ПростойУчетТоваров = УчетнаяПолитика.ПорядокПризнанияРасходовПоТоварам(Организация, Период)
		= Перечисления.ПорядокПризнанияРасходовПоТоварам.ПоФактуРеализации;
	НастройкиУСН.ПростойУчетМатериалов = УчетнаяПолитика.ПорядокПризнанияМатериальныхРасходов(Организация, Период)
		= Перечисления.ПорядокПризнанияМатериальныхРасходов.ПоОплатеПоставщику;
	НастройкиУСН.ПростойУчетНДС = УчетнаяПолитика.ПорядокПризнанияРасходовПоНДС(Организация, Период)
		= Перечисления.ПорядокПризнанияРасходовПоНДС.ПоОплатеПоставщику;
	НастройкиУСН.ПростойУчетТаможенныхПлатежей = УчетнаяПолитика.ПорядокПризнанияТаможенныхПлатежей(Организация, Период)
		= Перечисления.ПорядокПризнанияТаможенныхПлатежей.ПоОплате;
	НастройкиУСН.ПрименяетсяОбщаяСтавкаНДС = УчетНДС.ПрименяетсяОбщаяСтавкаНДС(Организация, Период);
		
	Возврат НастройкиУСН;
	
КонецФункции

Функция СчетаУчетаОС()
	
	МассивСчетовУчета = Новый Массив;
	МассивСчетовУчета.Добавить(ПланыСчетов.Хозрасчетный.ПриобретениеОбъектовОсновныхСредств);
	
	Возврат БухгалтерскийУчет.СформироватьМассивСубсчетов(МассивСчетовУчета);
	
КонецФункции

Функция СчетаУчетаМатериалов()
	
	МассивСчетовУчета = Новый Массив;
	МассивСчетовУчета.Добавить(ПланыСчетов.Хозрасчетный.Материалы);
	
	Возврат БухгалтерскийУчет.СформироватьМассивСубсчетов(МассивСчетовУчета);
	
КонецФункции

Функция РасходыПринимаемыеПоОплате(НастройкиУСН)
	
	МассивВидовРасходовУСН = Новый Массив;
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.Зарплата);
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.Командировки);
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.Налоги);
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.Услуги);
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.ЛизинговыеПлатежи);
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.НМА);
	МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.ОС);
	
	Если НастройкиУСН.ПростойУчетДопрасходов Тогда
		МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.ДопРасходы);
	КонецЕсли;
	Если НастройкиУСН.ПростойУчетТаможенныхПлатежей Тогда
		МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи);
	КонецЕсли;
	Если НастройкиУСН.ПростойУчетНДС Тогда
		МассивВидовРасходовУСН.Добавить(Перечисления.ВидыРасходовУСН.НДС);
	КонецЕсли;
	
	Возврат МассивВидовРасходовУСН;
	
КонецФункции

Функция ОпределитьВидДокумента(Документ)
	ТипДокумента = ТипЗнч(Документ);
	
	Если ТипДокумента = Тип("ДокументСсылка.ПоступлениеТоваровУслуг")
		Или ТипДокумента = Тип("ДокументСсылка.АвансовыйОтчет")
		Или ТипДокумента = Тип("ДокументСсылка.НачислениеЗарплаты")
		Или ТипДокумента = Тип("ДокументСсылка.ПоступлениеДопРасходов")
		Или ТипДокумента = Тип("ДокументСсылка.ОтражениеЗарплатыВБухучете")
		Или ТипДокумента = Тип("ДокументСсылка.ГТДИмпорт")
		Или ТипДокумента = Тип("ДокументСсылка.ДокументРасчетовСКонтрагентом")
		Или ТипДокумента = Тип("ДокументСсылка.РасходыПредпринимателя")
		Или ТипДокумента = Тип("ДокументСсылка.ПоступлениеНМА")
		Или ТипДокумента = Тип("ДокументСсылка.БольничныйЛист")
		Или ТипДокумента = Тип("ДокументСсылка.Отпуск")
		Или ТипДокумента = Тип("ДокументСсылка.Увольнение")
		Или ТипДокумента = Тип("ДокументСсылка.ВыплатыСамозанятым")
		Или ТипДокумента = Тип("ДокументСсылка.КорректировкаПоступления") Тогда
		Возврат ВидДокументаПартия();
	ИначеЕсли ТипДокумента = Тип("ДокументСсылка.СписаниеСРасчетногоСчета")
		Или ТипДокумента = Тип("ДокументСсылка.РасходныйКассовыйОрдер")
		Или ТипДокумента = Тип("ДокументСсылка.СведенияОбУплатеНалогов")
		Или ТипДокумента = Тип("ДокументСсылка.КорректировкаДолга") Тогда
		Возврат ВидДокументаОплата();
	ИначеЕсли ТипДокумента = Тип("ДокументСсылка.РеализацияТоваровУслуг")
		Или ТипДокумента = Тип("ДокументСсылка.ТребованиеНакладная")
		Или ТипДокумента = Тип("ДокументСсылка.ОтчетКомиссионераОПродажах") Тогда
		Возврат ВидДокументаРеализация();
	ИначеЕсли ТипДокумента = Тип("ДокументСсылка.ПоступлениеНаРасчетныйСчет")
		Или ТипДокумента = Тип("ДокументСсылка.ПриходныйКассовыйОрдер") Тогда
		Возврат ВидДокументаОплатаРеализации();
	ИначеЕсли ТипДокумента = Тип("ДокументСсылка.РегламентнаяОперация") Тогда
		ВидОперации = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Документ, "ВидОперации");
		Если ВидОперации = Перечисления.ВидыРегламентныхОпераций.ЗакрытиеСчета97 Тогда
			Возврат ВидДокументаРеализация();
		Иначе
			Возврат ВидДокументаПартия();
		КонецЕсли;
	ИначеЕсли ТипДокумента = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
		Возврат ВидДокументаВозвратТоваровПоставщику();
	Иначе
		Возврат Неопределено;
	КонецЕсли;
		
КонецФункции

Функция ВидДокументаПартия()
	Возврат "Партия";
КонецФункции

Функция ВидДокументаОплата()
	Возврат "Оплата";
КонецФункции

Функция ВидДокументаРеализация()
	Возврат "Реализация";
КонецФункции

Функция ВидДокументаОплатаРеализации()
	Возврат "ОплатаРеализации";
КонецФункции

Функция ТаблицаРасходовУСН(Документ, ВидДокумента, Организация, НастройкиУчетаУСН)
	
	ТаблицаДокументов = НоваяТаблицаДокументов();
	ТаблицаРасходов = ТаблицаРасходовПоДокументу(Документ, ВидДокумента, Организация, НастройкиУчетаУСН);
	Если ТаблицаРасходов = Неопределено Тогда
		Возврат ТаблицаДокументов;
	КонецЕсли;
	
	ВидДокументаПартия = ВидДокумента = ВидДокументаПартия();
	ВидДокументаРеализация = ВидДокумента = ВидДокументаРеализация();
	ВидДокументаОплата = ВидДокумента = ВидДокументаОплата();
	
	Для Каждого СтрокаРасхода Из ТаблицаРасходов Цикл
		
		// Передача на реализацию не формирует расходы
		Если ЭтоПередачаНаРеализацию(СтрокаРасхода.Регистратор) Тогда
			Продолжить;
		КонецЕсли;
		
		ВидРегистратора = ОпределитьВидДокумента(СтрокаРасхода.Регистратор);
		ЭтоРБП = СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП);
		
		// Проверим на Партию
		Если Не ВидДокументаРеализация Тогда
			ЭтоПартияПоНоменклатуре = ВидРегистратора = ВидДокументаПартия()
				И СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено;
			ЭтоПартияБезСписания = (ВидРегистратора = ВидДокументаПартия() Или СтрокаРасхода.Партия = Неопределено)
				И СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеОплачено;
			// Документ РасходПредпринимателя сразу устанавливает статус НеСписаноПринято для материалов
			ЭтоПартияПоРасходуПредпринимателя = ВидРегистратора = ВидДокументаПартия() И СтрокаРасхода.ВидРасхода = "Материалы"
				И СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписаноПринято
				И ТипЗнч(СтрокаРасхода.Партия) = Тип("ДокументСсылка.РасходыПредпринимателя");
				
			// В некоторых случаях расход признается самим же документом партии, по ранее произведенным оплатам.
			// Например, расходы на выплату аванса по заработной плате признаются при начислении зарплаты за месяц.
			Если СтрокаРасхода.СуммаРасход > 0
				И СтрокаРасхода.Регистратор = СтрокаРасхода.РасчетныйДокумент Тогда
				НоваяСтрока = ТаблицаДокументов.Добавить();
				НоваяСтрока.Ссылка = СтрокаРасхода.Регистратор;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Регистратор);
				НоваяСтрока.Родитель = СтрокаРасхода.РасчетныйДокумент;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.Сумма = СтрокаРасхода.СуммаРасход;
				НоваяСтрока.ВидДокумента = ВидДокументаОплата();
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			КонецЕсли;
			
			Если СтрокаРасхода.СуммаПриход > 0
				И (ЭтоПартияПоРасходуПредпринимателя Или ЭтоПартияПоНоменклатуре Или ЭтоПартияБезСписания И Не ЭтоРБП) Тогда
				НоваяСтрока = ТаблицаДокументов.Добавить();
				НоваяСтрока.ВидДокумента = ВидРегистратора;
				НоваяСтрока.Ссылка = СтрокаРасхода.Регистратор;
				НоваяСтрока.Сумма = СтрокаРасхода.СуммаПриход;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Регистратор);
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
				
				Продолжить;
			КонецЕсли;
		КонецЕсли;
			
		// Проверим на Оплату
		ВидДокументаОплаты = ОпределитьВидДокумента(СтрокаРасхода.РеквизитыДокументаОплаты);
		ОплаченоНеСписанное = ВидДокументаОплаты = ВидДокументаОплата()
			И СтрокаРасхода.СуммаПриход > 0
			И (СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписано
			Или СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписаноПринято);
		ОплаченоСписанное = ВидРегистратора = ВидДокументаОплата()
			И СтрокаРасхода.СуммаРасход > 0
			И СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеОплачено;
			
		Если ОплаченоНеСписанное Или ОплаченоСписанное Тогда
				
			Если ВидДокументаОплаты = ВидДокументаОплата() Тогда
				СуммаПоСтрокеРасхода = СтрокаРасхода.СуммаПриход;
				ВидДокументаПоСтрокеРасхода = ВидДокументаОплаты;
			Иначе
				СуммаПоСтрокеРасхода = СтрокаРасхода.СуммаРасход;
				ВидДокументаПоСтрокеРасхода = ВидРегистратора;
			КонецЕсли;
			
			// Если оплата по реализации сразу принимает расходы,
			// то необходимо добавить строку с Поступлением по ДокументуРасчетов
			Если ВидДокументаОплата И ВидДокументаОплаты = Неопределено Тогда
				НоваяСтрока = ТаблицаДокументов.Добавить();
				НоваяСтрока.Ссылка = СтрокаРасхода.РасчетныйДокумент;
				НоваяСтрока.Родитель = СтрокаРасхода.Регистратор;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.РасчетныйДокумент);
				НоваяСтрока.ВидДокумента = ОпределитьВидДокумента(СтрокаРасхода.РасчетныйДокумент);
				НоваяСтрока.Сумма = СуммаПоСтрокеРасхода;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СтрокаРасхода.Партия) Тогда
				НоваяСтрока = ТаблицаДокументов.Добавить();
				Если ВидДокументаОплата Тогда
					НоваяСтрока.Ссылка = СтрокаРасхода.Партия;
					НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Партия);
					Если ВидДокументаОплаты = Неопределено Тогда
						НоваяСтрока.Родитель = СтрокаРасхода.РасчетныйДокумент;
					Иначе
						НоваяСтрока.Родитель = СтрокаРасхода.Регистратор;
					КонецЕсли;
					НоваяСтрока.ВидДокумента = ОпределитьВидДокумента(СтрокаРасхода.Партия);
				Иначе
					НоваяСтрока.ВидДокумента = ВидДокументаПоСтрокеРасхода;
					Если СтрокаРасхода.СуммаРасход > 0 Тогда
						НоваяСтрока.Ссылка = СтрокаРасхода.Регистратор;
						НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Регистратор);
					Иначе
						НоваяСтрока.Ссылка = СтрокаРасхода.РеквизитыДокументаОплаты;
						НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.РеквизитыДокументаОплаты);
					КонецЕсли;
					Если ВидДокументаРеализация Тогда
						НоваяСтрока.Родитель = СтрокаРасхода.РасчетныйДокумент;
					Иначе
						НоваяСтрока.Родитель = СтрокаРасхода.Партия;
					КонецЕсли;
				КонецЕсли;
				НоваяСтрока.Сумма = СуммаПоСтрокеРасхода;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			Иначе
				НоваяСтрока = ТаблицаДокументов.Добавить();
				НоваяСтрока.Ссылка = СтрокаРасхода.Регистратор;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Регистратор);
				Если ВидДокументаОплаты = Неопределено Тогда
					НоваяСтрока.Родитель = СтрокаРасхода.РасчетныйДокумент;
				Иначе
					НоваяСтрока.Родитель = СтрокаРасхода.Регистратор;
				КонецЕсли;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.Сумма = СуммаПоСтрокеРасхода;
				НоваяСтрока.ВидДокумента = ОпределитьВидДокумента(СтрокаРасхода.Регистратор);
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			КонецЕсли;
			
			Продолжить;
		КонецЕсли;
		
		// Проверим на Реализацию
		ЭтоСписаниеРасходаПоРеализации = Не ОпределитьВидДокумента(СтрокаРасхода.Партия) = ВидДокументаРеализация()
			И Не ВидРегистратора = ВидДокументаВозвратТоваровПоставщику()
			И (СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено
			Или СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписано
			Или СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписаноПринято);
			
		Если СтрокаРасхода.СуммаРасход > 0
			И ВидРегистратора = ВидДокументаРеализация()
			И ЭтоСписаниеРасходаПоРеализации Тогда
			// Если реализация сразу принимает расходы,
			// то необходимо добавить строку с Поступлением по ДокументуРасчетов
			Если ВидДокументаРеализация Тогда
				НоваяСтрока = ТаблицаДокументов.Добавить();
				НоваяСтрока.Ссылка = СтрокаРасхода.РасчетныйДокумент;
				НоваяСтрока.Родитель = СтрокаРасхода.Регистратор;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.РасчетныйДокумент);
				НоваяСтрока.ВидДокумента = ОпределитьВидДокумента(СтрокаРасхода.РасчетныйДокумент);
				НоваяСтрока.Сумма = СтрокаРасхода.СуммаРасход;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			КонецЕсли;
			
			НоваяСтрока = ТаблицаДокументов.Добавить();
			НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			Если ВидДокументаРеализация И ВидДокументаОплаты = ВидДокументаОплата() Тогда
				НоваяСтрока.ВидДокумента = ВидДокументаОплаты;
				НоваяСтрока.Ссылка = СтрокаРасхода.РеквизитыДокументаОплаты;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.РеквизитыДокументаОплаты);
				НоваяСтрока.Сумма = СтрокаРасхода.СуммаРасход;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСТрока.Родитель = СтрокаРасхода.РасчетныйДокумент;
			Иначе
				НоваяСтрока.ВидДокумента = ВидРегистратора;
				НоваяСтрока.Ссылка = СтрокаРасхода.Регистратор;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Регистратор);
				НоваяСтрока.Сумма = СтрокаРасхода.СуммаРасход;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				Если СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписано
					И Не ВидДокументаОплата Тогда
					НоваяСТрока.Родитель = СтрокаРасхода.РеквизитыДокументаОплаты;
				ИначеЕсли ЭтоРБП Тогда
					НоваяСТрока.Родитель = СтрокаРасхода.РасчетныйДокумент;
				Иначе
					НоваяСТрока.Родитель = СтрокаРасхода.Партия;
				КонецЕсли;
			КонецЕсли;
			
			Продолжить;
		КонецЕсли;
		
		// Проверим на оплату от покупателя
		// Можем выводить только в структуру, строить на основании не можем, т.к.
		// оплата от покупателя в регистре выступает только как регистратор
		Если ВидРегистратора = ВидДокументаОплатаРеализации() И СтрокаРасхода.СуммаРасход > 0 Тогда
			// Проверим документы, если есть запись - добавим сумму, если нет - создадим
			ОплатыОтПокупателя = ТаблицаДокументов.Найти(СтрокаРасхода.Регистратор);
			Если ОплатыОтПокупателя <> Неопределено Тогда
				ОплатыОтПокупателя.Сумма = ОплатыОтПокупателя.Сумма + СтрокаРасхода.СуммаРасход;
			Иначе
				НоваяСтрока = ТаблицаДокументов.Добавить();
				НоваяСтрока.ВидДокумента = ОпределитьВидДокумента(СтрокаРасхода.Регистратор);
				НоваяСтрока.Ссылка = СтрокаРасхода.Регистратор;
				НоваяСтрока.Сумма = СтрокаРасхода.СуммаРасход;
				НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
				НоваяСтрока.Представление = ПредставлениеДокументаРасхода(СтрокаРасхода.Регистратор);
				НоваяСтрока.Родитель = СтрокаРасхода.Партия;
				НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
			КонецЕсли;
		КонецЕсли;
		
		// Возврат товара поставщику или корректировка в меньшую сторону
		КорректировкаУменьшение = ТипЗнч(СтрокаРасхода.Регистратор) = Тип("ДокументСсылка.КорректировкаПоступления")
			И СтрокаРасхода.СуммаРасход > 0;
		Если ВидРегистратора = ВидДокументаВозвратТоваровПоставщику() Или КорректировкаУменьшение Тогда
			Если СтрокаРасхода.ВидРасхода = "Материалы" Тогда
				КорректироватьОплату = (СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписаноПринято
					И НастройкиУчетаУСН.ПростойУчетМатериалов)
					Или (СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписано
					И Не НастройкиУчетаУСН.ПростойУчетМатериалов);
			ИначеЕсли СтрокаРасхода.ВидРасхода = "Товары" Тогда
				КорректироватьОплату = СтрокаРасхода.СтатусыОплатыРасходовУСН = Перечисления.СтатусыРасходовУСН.НеСписано;
			Иначе
				КорректироватьОплату = Ложь;
			КонецЕсли;
			
			СуммаКУменьшению = СтрокаРасхода.СуммаРасход;
			Для Каждого СтрокаТаблицы Из ТаблицаДокументов Цикл
				Если СтрокаТаблицы.ВидДокумента = ВидДокументаОплата() И КорректироватьОплату Тогда
					УменьшеноОплаты = Мин(СтрокаТаблицы.Сумма, СуммаКУменьшению);
					СтрокаТаблицы.Сумма = СтрокаТаблицы.Сумма - УменьшеноОплаты;
					СуммаКУменьшению = Макс(0, СуммаКУменьшению - УменьшеноОплаты);
				ИначеЕсли СтрокаТаблицы.ВидДокумента = ВидДокументаПартия() Тогда
					СтрокаТаблицы.Сумма = Макс(0, СтрокаТаблицы.Сумма - СтрокаРасхода.СуммаРасход);
				КонецЕсли;
			КонецЦикла;
			
			// После корректировки могут быть нулевые суммы, их необходимо удалить
			Отбор = Новый Структура;
			Отбор.Вставить("Сумма", 0);
			СтрокиДляУдаления = ТаблицаДокументов.НайтиСтроки(Отбор);
			Для Каждого СтрокаУдаления Из СтрокиДляУдаления Цикл
				ТаблицаДокументов.Удалить(СтрокаУдаления);
			КонецЦикла;
		КонецЕсли;
		
	КонецЦикла;
	
	// Если строим на основании Оплаты или Реализации, то надо добавить в таблицу без родителя
	Если ВидДокументаОплата Или (ВидДокументаРеализация И Не ЭтоПередачаНаРеализацию(СтрокаРасхода.Регистратор)) Тогда
		НоваяСтрока = ТаблицаДокументов.Добавить();
		НоваяСтрока.ВидДокумента = ВидДокумента;
		НоваяСтрока.Ссылка = Документ;
		НоваяСтрока.Представление = ПредставлениеДокументаРасхода(Документ);
		Если ВидДокументаРеализация Тогда
			НоваяСтрока.Сумма = ТаблицаРасходов.Итог("СуммаРасход");
		Иначе
			МетаданныеДокумента = Документ.Метаданные();
			Если ОбщегоНазначения.ЕстьРеквизитОбъекта("СуммаДокумента", МетаданныеДокумента) Тогда
				НоваяСтрока.Сумма = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Документ, "СуммаДокумента", Истина);
				Если НастройкиУчетаУСН.ПрименяетсяОбщаяСтавкаНДС
					И ЕстьТабличнаяЧастьОбъекта("РасшифровкаПлатежа", МетаданныеДокумента) Тогда
					РасшифровкаПлатежа = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Документ, "РасшифровкаПлатежа", Истина);
					НоваяСтрока.Сумма = Макс(0, НоваяСтрока.Сумма - РасшифровкаПлатежа.Выгрузить().Итог("СуммаНДС"));
				КонецЕсли;
			Иначе
				НоваяСтрока.Сумма = МаксимальноеЗначениеВМассиве(ТаблицаДокументов.ВыгрузитьКолонку("Сумма"));
			КонецЕсли;
		КонецЕсли;
		СтрокаРасхода = ТаблицаРасходов.Найти(Документ, "Регистратор");
		Если СтрокаРасхода = Неопределено Тогда
			НоваяСтрока.Валюта = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();
		Иначе
			НоваяСтрока.Валюта = СтрокаРасхода.Валюта;
			НоваяСтрока.ВидРасхода = СтрокаРасхода.ВидРасхода;
		КонецЕсли;
	КонецЕсли;
	
	// ОС и НМА признаются частями, т.е. необходимо добавить строки с видом "Реализация"
	ДополнитьТаблицуДаннымиОС(ТаблицаДокументов, Документ, Организация);
	ДополнитьТаблицуДаннымиНМА(ТаблицаДокументов, Документ, Организация);
	
	Возврат ТаблицаДокументов;
	
КонецФункции

Функция ЕстьТабличнаяЧастьОбъекта(ИмяРеквизита, МетаданныеОбъекта)

	ТабличныеЧасти = МетаданныеОбъекта.ТабличныеЧасти;
	Возврат Не (ТабличныеЧасти.Найти(ИмяРеквизита) = Неопределено);

КонецФункции

Функция ТаблицаРасходовПоДокументу(Документ, ВидДокумента, Организация, НастройкиУчетаУСН)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	РасходыПриУСН.Период КАК Период,
		|	РасходыПриУСН.Регистратор КАК Регистратор,
		|	РасходыПриУСН.Партия КАК Партия,
		|	РасходыПриУСН.РасчетныйДокумент КАК РасчетныйДокумент,
		|	РасходыПриУСН.РеквизитыДокументаОплаты КАК РеквизитыДокументаОплаты,
		|	РасходыПриУСН.СтатусыОплатыРасходовУСН КАК СтатусыОплатыРасходовУСН,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСН.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА РасходыПриУСН.Сумма - РасходыПриУСН.НДС
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА РасходыПриУСН.Сумма + РасходыПриУСН.НДС
		|						ИНАЧЕ РасходыПриУСН.Сумма
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаПриход,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСН.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА РасходыПриУСН.Сумма - РасходыПриУСН.НДС
		|						КОГДА &ПростойУчетНДС
		|							ТОГДА РасходыПриУСН.Сумма + РасходыПриУСН.НДС
		|						ИНАЧЕ РасходыПриУСН.Сумма
		|					КОНЕЦ
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК СуммаРасход,
		|	РасходыПриУСН.Валюта КАК Валюта,
		|	ВЫБОР
		|		КОГДА РасходыПриУСН.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|			ТОГДА ВЫБОР
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаМатериалов)
		|						ТОГДА ""Материалы""
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ПРЕДСТАВЛЕНИЕ(ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС))
		|					ИНАЧЕ ""Товары""
		|				КОНЕЦ
		|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(РасходыПриУСН.ВидРасхода)
		|	КОНЕЦ КАК ВидРасхода
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН КАК РасходыПриУСН
		|ГДЕ
		|	РасходыПриУСН.Организация = &Организация
		|	И РасходыПриУСН.ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)
		|	И (РасходыПриУСН.СтатусСписания = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.НеПринимаются)
		|				И (РасходыПриУСН.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|					ИЛИ РасходыПриУСН.Регистратор ССЫЛКА Документ.КорректировкаПоступления)
		|			ИЛИ РасходыПриУСН.СтатусСписания В (ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)))
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСН.Период,
		|	РасходыПриУСН.Регистратор,
		|	РасходыПриУСН.Партия,
		|	РасходыПриУСН.РасчетныйДокумент,
		|	РасходыПриУСН.РеквизитыДокументаОплаты,
		|	РасходыПриУСН.СтатусыОплатыРасходовУСН,
		|	РасходыПриУСН.Валюта,
		|	ВЫБОР
		|		КОГДА РасходыПриУСН.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|			ТОГДА ВЫБОР
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаМатериалов)
		|						ТОГДА ""Материалы""
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ПРЕДСТАВЛЕНИЕ(ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.ОС))
		|					ИНАЧЕ ""Товары""
		|				КОНЕЦ
		|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(РасходыПриУСН.ВидРасхода)
		|	КОНЕЦ
		|
		|УПОРЯДОЧИТЬ ПО
		|	Период";
	
	СхемаЗапроса = СхемыЗапросов.Создать(ТекстЗапроса);
	ОператорЗапроса = СхемаЗапроса.ПакетЗапросов[0].Операторы[0];
	
	Если ВидДокумента = ВидДокументаПартия() Тогда
		ОператорЗапроса.Отбор.Добавить("РасходыПриУСН.РасчетныйДокумент = &Документ");
	ИначеЕсли ВидДокумента = ВидДокументаОплата() Или ВидДокумента = ВидДокументаРеализация() Тогда
		ОператорЗапроса.Отбор.Добавить("РасходыПриУСН.Регистратор = &Документ");
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Документ", Документ);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("СчетаУчетаМатериалов", СчетаУчетаМатериалов());
	Запрос.УстановитьПараметр("СчетаУчетаОС", СчетаУчетаОС());
	Запрос.УстановитьПараметр("ПрименяетсяОбщаяСтавкаНДС", НастройкиУчетаУСН.ПрименяетсяОбщаяСтавкаНДС);
	Запрос.УстановитьПараметр("ПростойУчетНДС", НастройкиУчетаУСН.ПростойУчетНДС);
	Запрос.Текст = СхемаЗапроса.ПолучитьТекстЗапроса();
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТаблицаРасходов = РезультатЗапроса.Выгрузить();
	
	Возврат ТаблицаРасходов;
	
КонецФункции

Функция НоваяТаблицаДокументов()
	
	ТаблицаДокументов = Новый ТаблицаЗначений;
	ТаблицаДокументов.Колонки.Добавить("Ссылка", ОбщегоНазначения.ОписаниеТипаВсеСсылки());
	ТаблицаДокументов.Колонки.Добавить("Родитель", ОбщегоНазначения.ОписаниеТипаВсеСсылки());
	ТаблицаДокументов.Колонки.Добавить("Сумма", ОбщегоНазначения.ОписаниеТипаЧисло(15, 2));
	ТаблицаДокументов.Колонки.Добавить("Валюта", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	ТаблицаДокументов.Колонки.Добавить("Представление", ОбщегоНазначения.ОписаниеТипаСтрока(100));
	ТаблицаДокументов.Колонки.Добавить("ВидДокумента", ОбщегоНазначения.ОписаниеТипаСтрока(100));
	ТаблицаДокументов.Колонки.Добавить("ВидРасхода", ОбщегоНазначения.ОписаниеТипаСтрока(30));
	
	Возврат ТаблицаДокументов;
	
КонецФункции

Функция МаксимальноеЗначениеВМассиве(Массив)
	
	МаксимальноеЗначение = 0;
	
	Для Индекс = 0 По Массив.Количество() - 1 Цикл
		Значение = Массив[Индекс];
		
		Если МаксимальноеЗначение < Значение Тогда
			МаксимальноеЗначение = Значение;
		КонецЕсли;
	КонецЦикла;
	
	Возврат МаксимальноеЗначение;
	
КонецФункции

Процедура ДополнитьТаблицуДаннымиОС(ТаблицаДокументов, Документ, Организация)
	
	Отбор = Новый Структура;
	Отбор.Вставить("Ссылка", Документ);
	Отбор.Вставить("Родитель", Неопределено);
	СтрокиДокументов = ТаблицаДокументов.НайтиСтроки(Отбор);
	Если СтрокиДокументов.Количество() = 0
		Или СтрокиДокументов[0].ВидРасхода <> Строка(Перечисления.ВидыРасходовУСН.ОС) Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РасходыПриУСНОстаткиИОбороты.ЭлементРасхода КАК ЭлементРасхода,
		|	РасходыПриУСНОстаткиИОбороты.Валюта КАК Валюта
		|ПОМЕСТИТЬ вт_ОС_Партии
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			,
		|			,
		|			Регистратор,
		|			,
		|			Организация = &Организация
		|				И РасчетныйДокумент = &Документ) КАК РасходыПриУСНОстаткиИОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КнигаУчетаДоходовИРасходовОСОбороты.Регистратор КАК Регистратор,
		|	вт_ОС_Партии.Валюта КАК Валюта,
		|	ЕСТЬNULL(СУММА(КнигаУчетаДоходовИРасходовОСОбороты.Графа13_СуммаРасходовЗаКварталОборот), 0) КАК Сумма
		|ИЗ
		|	вт_ОС_Партии КАК вт_ОС_Партии
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КнигаУчетаДоходовИРасходовОС.Обороты(, , Регистратор, Организация = &Организация) КАК КнигаУчетаДоходовИРасходовОСОбороты
		|		ПО (КнигаУчетаДоходовИРасходовОСОбороты.ОсновноеСредство = вт_ОС_Партии.ЭлементРасхода)
		|
		|СГРУППИРОВАТЬ ПО
		|	КнигаУчетаДоходовИРасходовОСОбороты.Регистратор,
		|	вт_ОС_Партии.Валюта";
	
	Запрос.УстановитьПараметр("Документ", Документ);
	Запрос.УстановитьПараметр("Организация", Организация);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		Если Выборка.Сумма > 0 Тогда
			НоваяСтрока = ТаблицаДокументов.Добавить();
			НоваяСтрока.ВидДокумента = ВидДокументаРеализация();
			НоваяСтрока.Ссылка = Выборка.Регистратор;
			НоваяСтрока.Сумма = Выборка.Сумма;
			НоваяСтрока.Родитель = Документ;
			НоваяСтрока.Валюта = Выборка.Валюта;
			НоваяСтрока.Представление = ПредставлениеДокументаРасхода(Выборка.Регистратор);
			НоваяСтрока.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС);
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ДополнитьТаблицуДаннымиНМА(ТаблицаДокументов, Документ, Организация)
	
	Отбор = Новый Структура;
	Отбор.Вставить("Ссылка", Документ);
	Отбор.Вставить("Родитель", Неопределено);
	СтрокиДокументов = ТаблицаДокументов.НайтиСтроки(Отбор);
	Если СтрокиДокументов.Количество() = 0
		Или СтрокиДокументов[0].ВидРасхода <> Строка(Перечисления.ВидыРасходовУСН.НМА) Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	РасходыПриУСНОстаткиИОбороты.ЭлементРасхода КАК ЭлементРасхода,
		|	РасходыПриУСНОстаткиИОбороты.Валюта КАК Валюта
		|ПОМЕСТИТЬ вт_НМА_Партии
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(
		|			,
		|			,
		|			Регистратор,
		|			,
		|			Организация = &Организация
		|				И РасчетныйДокумент = &Документ) КАК РасходыПриУСНОстаткиИОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	КнигаУчетаДоходовИРасходовНМАОбороты.Регистратор КАК Регистратор,
		|	вт_НМА_Партии.Валюта КАК Валюта,
		|	СУММА(КнигаУчетаДоходовИРасходовНМАОбороты.Графа13_СуммаРасходовЗаКварталОборот) КАК Сумма
		|ИЗ
		|	вт_НМА_Партии КАК вт_НМА_Партии
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.КнигаУчетаДоходовИРасходовНМА.Обороты(, , Регистратор, Организация = &Организация) КАК КнигаУчетаДоходовИРасходовНМАОбороты
		|		ПО (КнигаУчетаДоходовИРасходовНМАОбороты.НематериальныйАктив = вт_НМА_Партии.ЭлементРасхода)
		|
		|СГРУППИРОВАТЬ ПО
		|	КнигаУчетаДоходовИРасходовНМАОбороты.Регистратор,
		|	вт_НМА_Партии.Валюта";
	
	Запрос.УстановитьПараметр("Документ", Документ);
	Запрос.УстановитьПараметр("Организация", Организация);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаДокументов.Добавить();
		НоваяСтрока.ВидДокумента = ВидДокументаРеализация();
		НоваяСтрока.Ссылка = Выборка.Регистратор;
		НоваяСтрока.Сумма = Выборка.Сумма;
		НоваяСтрока.Родитель = Документ;
		НоваяСтрока.Валюта = Выборка.Валюта;
		НоваяСтрока.Представление = ПредставлениеДокументаРасхода(Выборка.Регистратор);
		НоваяСтрока.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА);
	КонецЦикла;
	
КонецПроцедуры

Функция СформироватьТабличныйДокумент(ТаблицаРасходовУСН, НастройкиУчетаУСН, ОбъектОтбора)

	Результат = Новый ТабличныйДокумент();
	ВозвращаемыеДанные = НовыйРезультатФормированияРасходовПоДокументу();
	
	ВалютаРегламентированногоУчета = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();
	
	Макет = ПолучитьМакет("РасшифровкаПоДокументу");
	ПоФактуПолученияДохода = Не НастройкиУчетаУСН.ПростойУчетТоваров;
	ОбластьРазделитель = Макет.ПолучитьОбласть("Разделитель");
	
	// Вывод заголовка
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьЗаголовок.Параметры.Заголовок = СформироватьЗаголовок(ОбъектОтбора);
	Результат.Вывести(ОбластьЗаголовок);
	
	ВыводимыйОбъект = ТаблицаРасходовУСН.НайтиСтроки(Новый Структура("Родитель, Ссылка", Неопределено, ОбъектОтбора));
	Если ВыводимыйОбъект.Количество() = 0 Тогда
		// Нет движений по расходам
		ОбластьНетДвижений = Макет.ПолучитьОбласть("Легенда");
		ОбластьНетДвижений.Параметры.Пояснение = НСтр("ru = 'Документ не признает расходы УСН'");
		Результат.Вывести(ОбластьНетДвижений);
		ВозвращаемыеДанные.ТабличныйДокумент = Результат;
		Возврат ВозвращаемыеДанные;
	Иначе
		ВыводимыйОбъект = ВыводимыйОбъект[0];
	КонецЕсли;
	
	ДанныеОсновногоОбъекта = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(ВыводимыйОбъект);
	
	ВидыРасходов = 
		ОбщегоНазначенияКлиентСервер.СвернутьМассив(ТаблицаРасходовУСН.ВыгрузитьКолонку("ВидРасхода"));
		
	ОтборПоВидуРасхода = Новый Структура();
	ОтборПоВидуРасхода.Вставить("ВидРасхода");
	ОтборПоВидуРасхода.Вставить("Родитель", Неопределено);
	
	ТаблицаОплат            = НоваяТаблицаРасшифровкиПоДокументам();
	ТаблицаСписаний         = НоваяТаблицаРасшифровкиПоДокументам();
	ТаблицаОплатПокупателей = НоваяТаблицаРасшифровкиПоДокументам();
	
	МассивПодсказка = Новый Массив();
	Если ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаПартия() Тогда
		
		СуммаРасходаПоДокументу = 0;
		ТаблицаРасходовВсего = ТаблицаРасходовУСН.СкопироватьКолонки("ВидРасхода, Сумма, Валюта");
		
		// Вывод шапки и расчет сумм
		Для Каждого ВидРасхода Из ВидыРасходов Цикл
			ОтборПоВидуРасхода.ВидРасхода = ВидРасхода;
			СтрокиРасхода = ТаблицаРасходовУСН.НайтиСтроки(ОтборПоВидуРасхода);
			
			СуммаРасхода = 0;
			Если СтрокиРасхода.Количество() > 0 Тогда
				Для Каждого СтрокаРасхода Из СтрокиРасхода Цикл
					СуммаРасхода = СуммаРасхода + СтрокаРасхода.Сумма;
				КонецЦикла;
				Валюта = СтрокиРасхода[0].Валюта;
			Иначе
				Валюта = ВалютаРегламентированногоУчета;
			КонецЕсли;
			СуммаРасходаПоДокументу = СуммаРасходаПоДокументу + СуммаРасхода;
			
			Если СуммаРасхода > 0 Тогда
				ВывестиПодсказкуРасхода(Макет, ВидРасхода, НастройкиУчетаУСН, Результат);
				Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
					ВывестиПоступлениеРасхода(
						Макет, МассивПодсказка, ВидРасхода, СуммаРасхода, Валюта, РассчитатьНДФЛ(ОбъектОтбора), Результат);
				Иначе
					ВывестиПоступлениеРасхода(Макет, МассивПодсказка, ВидРасхода, СуммаРасхода, Валюта, , Результат);
				КонецЕсли;
				НоваяСтрока = ТаблицаРасходовВсего.Добавить();
				НоваяСтрока.ВидРасхода = ВидРасхода;
				НоваяСтрока.Сумма = СуммаРасхода;
				НоваяСтрока.Валюта = Валюта;
			КонецЕсли;
			
			// Расчет сумм
			Отбор = Новый Структура;
			Отбор.Вставить("ВидДокумента", ВидДокументаОплата());
			Отбор.Вставить("ВидРасхода", ВидРасхода);
			ДокументыОплаты = ТаблицаРасходовУСН.НайтиСтроки(Отбор);
			Для Каждого ДокументОплаты Из ДокументыОплаты Цикл
				СтрокаОплат = ТаблицаОплат.Добавить();
				СтрокаОплат.Документ = ДокументОплаты.Ссылка;
				СтрокаОплат.Сумма = ДокументОплаты.Сумма;
				СтрокаОплат.ВидРасхода = ДокументОплаты.ВидРасхода;
				СтрокаОплат.Валюта = ДокументОплаты.Валюта;
			КонецЦикла;
			
			Если НужныДокументыРеализации(ВидРасхода, НастройкиУчетаУСН) Тогда
				Отбор.ВидДокумента = ВидДокументаРеализация();
				ДокументыРеализации = ТаблицаРасходовУСН.НайтиСтроки(Отбор);
				Для Каждого ДокументРеализация Из ДокументыРеализации Цикл
					СтрокаСписания = ТаблицаСписаний.Добавить();
					СтрокаСписания.Документ = ДокументРеализация.Ссылка;
					СтрокаСписания.Сумма = ДокументРеализация.Сумма;
					СтрокаСписания.ВидРасхода = ВидРасхода;
					СтрокаСписания.Валюта = ДокументРеализация.Валюта;
				КонецЦикла;
				
				Если ПоФактуПолученияДохода Тогда
					// Вывод документов оплаты реализации
					Отбор.ВидДокумента = ВидДокументаОплатаРеализации();
					ДокументыОплатыРеализации = ТаблицаРасходовУСН.НайтиСтроки(Отбор);
					Для Каждого ДокументОплатыРеализации Из ДокументыОплатыРеализации Цикл
						СтрокаОплатПокупателей = ТаблицаОплатПокупателей.Добавить();
						СтрокаОплатПокупателей.Документ = ДокументОплатыРеализации.Ссылка;
						СтрокаОплатПокупателей.Сумма = ДокументОплатыРеализации.Сумма;
						СтрокаОплатПокупателей.ВидРасхода = ВидРасхода;
						СтрокаОплатПокупателей.Валюта = ДокументОплатыРеализации.Валюта;
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		ИтогиПоДокументу = ТаблицаИтоговПоДокументу(
			ОбъектОтбора, ВидРасхода, ТаблицаСписаний, СуммаРасходаПоДокументу, ДанныеОсновногоОбъекта, НастройкиУчетаУСН);
		
		ИтоговаяСумма = ИтогиПоДокументу.Итог("Сумма");
		// Вывести Признано
		Если СуммаРасходаПоДокументу <> ИтоговаяСумма Тогда
			ОбластьЗаголовок = Макет.ПолучитьОбласть("ПризнаноЗаголовок");
			Если ДанныеОсновногоОбъекта.Валюта <> ВалютаРегламентированногоУчета Тогда
				Оплачено = СуммаВВалютеРегламентированногоУчета(ТаблицаОплат, ВалютаРегламентированногоУчета);
				Если Не НужныДокументыРеализации(ВидРасхода, НастройкиУчетаУСН) Тогда
					СуммаПризнанногоРасхода = Оплачено;
				Иначе
					Списано = СуммаВВалютеРегламентированногоУчета(ТаблицаСписаний, ВалютаРегламентированногоУчета);
					Если Не ПоФактуПолученияДохода Тогда
						СуммаПризнанногоРасхода = Мин(Оплачено, Списано);
					Иначе
						ОплаченоПокупателем = СуммаВВалютеРегламентированногоУчета(ТаблицаОплатПокупателей, ВалютаРегламентированногоУчета);
						СуммаПризнанногоРасхода = Мин(Оплачено, Списано, ОплаченоПокупателем);
					КонецЕсли;
				КонецЕсли;
			Иначе
				СуммаПризнанногоРасхода = Макс(0, СуммаРасходаПоДокументу - ИтоговаяСумма);
			КонецЕсли;
			ОбластьЗаголовок.Параметры.Сумма = СуммаПризнанногоРасхода;
			Результат.Вывести(ОбластьЗаголовок);
			
			Если ИтоговаяСумма > 0 Тогда
				НеПризнаноПоВидуРасхода = ИтогиПоДокументу.Скопировать(, "ВидРасхода, Валюта, Сумма");
				НеПризнаноПоВидуРасхода.Свернуть("ВидРасхода, Валюта", "Сумма");
				
				ОднаЗапись = ТаблицаРасходовВсего.Количество() = 1;
				Для Каждого Расход Из ТаблицаРасходовВсего Цикл
					СтрокаРасходНеПризнан = НеПризнаноПоВидуРасхода.Найти(Расход.ВидРасхода);
					Если СтрокаРасходНеПризнан <> Неопределено Тогда
						Если ДанныеОсновногоОбъекта.Валюта <> ВалютаРегламентированногоУчета Тогда
							СуммаПризнания = СуммаПризнанногоРасхода;
						Иначе
							СуммаПризнания = Расход.Сумма - СтрокаРасходНеПризнан.Сумма;
						КонецЕсли;
						Если СуммаПризнания <> 0 Тогда
							ВывестиСтрокуПризнано(Макет, МассивПодсказка,
								Расход.ВидРасхода, СуммаПризнания, ВалютаРегламентированногоУчета, Ложь, ОднаЗапись, Результат, НастройкиУчетаУСН);
						КонецЕсли;
					Иначе
						ВывестиСтрокуПризнано(Макет, МассивПодсказка,
							Расход.ВидРасхода, Расход.Сумма, ВалютаРегламентированногоУчета, Истина, ОднаЗапись, Результат, НастройкиУчетаУСН);
					КонецЕсли;
				КонецЦикла;
			Иначе
				ОбластьСтрокаДанных = Макет.ПолучитьОбласть("ВсеРасходыПризнаны");
				Результат.Вывести(ОбластьСтрокаДанных);
				Если ДанныеОсновногоОбъекта.Валюта <> ВалютаРегламентированногоУчета Тогда
					СуммаСтрокой = СтрШаблон(
						"%1 %2" + Символы.НПП, Формат(ТаблицаОплат.Итог("Сумма"), "ЧДЦ=2"), ВалютаРегламентированногоУчета);
					Легенда = НСтр("ru = 'Признано расходов на %1'");
					Легенда = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Легенда, СуммаСтрокой);
					МассивПодсказка.Добавить(Легенда);
				КонецЕсли;
			КонецЕсли;
			
			Результат.Вывести(ОбластьРазделитель);
		КонецЕсли;
		
		// Вывести Не признано
		Если ИтоговаяСумма > 0 Тогда
			ОбластьЗаголовок = Макет.ПолучитьОбласть("НеПризнаноЗаголовок");
			ОбластьЗаголовок.Параметры.Сумма = ИтоговаяСумма;
			Результат.Вывести(ОбластьЗаголовок);
			
			ОтборПоВидуРасхода.Удалить("Родитель");
			Для Каждого ВидРасхода Из ВидыРасходов Цикл
				ОтборПоВидуРасхода.ВидРасхода = ВидРасхода;
				СтрокиРасхода = ИтогиПоДокументу.НайтиСтроки(ОтборПоВидуРасхода);
				НеВыводитьСумму = ВидыРасходов.Количество() = 1 И СтрокиРасхода.Количество() = 1;
				Для Каждого СтрокаРасхода Из СтрокиРасхода Цикл
					Если СтрокаРасхода.Сумма <> 0 Тогда
						ВывестиСтрокуНеПризнано(
							Макет, МассивПодсказка, СтрокаРасхода, Валюта, НеВыводитьСумму, , , Результат, НастройкиУчетаУСН);
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
			Результат.Вывести(ОбластьРазделитель);
		КонецЕсли;
		
	Иначе
		
		ОбластьСтрокаДанных = Макет.ПолучитьОбласть("СтрокаДанных");
		ОбластьСтрокаДанных.Параметры.Сумма = ДанныеОсновногоОбъекта.Сумма;
		Если ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаОплата() Тогда
			ОбластьСтрокаДанных.Параметры.Пояснение = НСтр("ru = 'Оплачено по документу всего'");
		ИначеЕсли ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаРеализация() Тогда
			ОбластьСтрокаДанных.Параметры.Пояснение = НСтр("ru = 'Продано по документу в ценах закупки'");
		Иначе
			ОбластьСтрокаДанных.Параметры.Пояснение = НСтр("ru = 'Получено оплаты по документу всего'");
		КонецЕсли;
		Результат.Вывести(ОбластьСтрокаДанных);
		Результат.Вывести(ОбластьРазделитель);
		
		ОтборПоВидуРасхода.Родитель = ВыводимыйОбъект.Ссылка;
		СуммаДвиженийПоДокументу = 0;
		ТаблицаДвиженийВсего = ТаблицаРасходовУСН.СкопироватьКолонки("ВидРасхода, Сумма");
		Для Каждого ВидРасхода Из ВидыРасходов Цикл
			ОтборПоВидуРасхода.ВидРасхода = ВидРасхода;
			СтрокиРасхода = ТаблицаРасходовУСН.НайтиСтроки(ОтборПоВидуРасхода);
			
			СуммаДвижений = 0;
			Если СтрокиРасхода.Количество() > 0 Тогда
				Для Каждого СтрокаРасхода Из СтрокиРасхода Цикл
					СуммаДвижений = СуммаДвижений + СтрокаРасхода.Сумма;
				КонецЦикла;
				Валюта = СтрокиРасхода[0].Валюта;
			Иначе
				Валюта = ВалютаРегламентированногоУчета;
			КонецЕсли;
			СуммаДвиженийПоДокументу = СуммаДвиженийПоДокументу + СуммаДвижений;
			
			Если СуммаДвижений > 0 Тогда
				ВывестиПодсказкуРасхода(Макет, ВидРасхода, НастройкиУчетаУСН, Результат);
				Если ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаОплата() Тогда
					Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
						ВывестиОплатуРасхода(
							Макет, МассивПодсказка, ВидРасхода, СуммаДвижений, Валюта, РассчитатьНДФЛ(ОбъектОтбора), Результат);
					Иначе
						ВывестиОплатуРасхода(Макет, МассивПодсказка, ВидРасхода, СуммаДвижений, Валюта, , Результат);
					КонецЕсли;
				ИначеЕсли ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаРеализация() Тогда
					Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
						ВывестиРеализациюРасхода(
							Макет, МассивПодсказка, ВидРасхода, СуммаДвижений, Валюта, РассчитатьНДФЛ(ОбъектОтбора), Результат);
					Иначе
						ВывестиРеализациюРасхода(Макет, МассивПодсказка, ВидРасхода, СуммаДвижений, Валюта, , Результат);
					КонецЕсли;
				КонецЕсли;
				НоваяСтрока = ТаблицаДвиженийВсего.Добавить();
				НоваяСтрока.ВидРасхода = ВидРасхода;
				НоваяСтрока.Сумма = СуммаДвижений;
			КонецЕсли;
			
			// Расчет сумм
			Отбор = Новый Структура;
			Отбор.Вставить("ВидДокумента", ВидДокументаОплата());
			Отбор.Вставить("ВидРасхода", ВидРасхода);
			ДокументыОплаты = ТаблицаРасходовУСН.НайтиСтроки(Отбор);
			Для Каждого ДокументОплаты Из ДокументыОплаты Цикл
				Если ЗначениеЗаполнено(ДокументОплаты.Родитель) Тогда
					СтрокаОплат = ТаблицаОплат.Добавить();
					СтрокаОплат.Документ = ДокументОплаты.Ссылка;
					СтрокаОплат.Сумма = ДокументОплаты.Сумма;
					СтрокаОплат.ВидРасхода = ДокументОплаты.ВидРасхода;
				КонецЕсли;
			КонецЦикла;
			
			Если НужныДокументыРеализации(ВидРасхода, НастройкиУчетаУСН) Тогда
				Отбор.ВидДокумента = ВидДокументаРеализация();
				ДокументыРеализации = ТаблицаРасходовУСН.НайтиСтроки(Отбор);
				Для Каждого ДокументРеализация Из ДокументыРеализации Цикл
					Если ЗначениеЗаполнено(ДокументРеализация.Родитель) Тогда
						СтрокаСписания = ТаблицаСписаний.Добавить();
						СтрокаСписания.Документ = ДокументРеализация.Ссылка;
						СтрокаСписания.Сумма = ДокументРеализация.Сумма;
						СтрокаСписания.ВидРасхода = ВидРасхода;
					КонецЕсли;
				КонецЦикла;
				
				Если ПоФактуПолученияДохода Тогда
					// Вывод документов оплаты реализации
					Отбор.ВидДокумента = ВидДокументаОплатаРеализации();
					ДокументыОплатыРеализации =
						ТаблицаРасходовУСН.НайтиСтроки(Отбор);
					Для Каждого ДокументОплатыРеализации Из ДокументыОплатыРеализации Цикл
						Если ЗначениеЗаполнено(ДокументОплатыРеализации.Родитель) Тогда
							СтрокаОплатПокупателей = ТаблицаОплатПокупателей.Добавить();
							СтрокаОплатПокупателей.Документ = ДокументОплатыРеализации.Ссылка;
							СтрокаОплатПокупателей.Сумма = ДокументОплатыРеализации.Сумма;
							СтрокаОплатПокупателей.ВидРасхода = ВидРасхода;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		ИтогиПоДокументу = ТаблицаИтоговПоДокументу(
			ОбъектОтбора, ВидРасхода, ТаблицаСписаний, СуммаДвиженийПоДокументу, ДанныеОсновногоОбъекта, НастройкиУчетаУСН);
		ИтоговаяСумма = ИтогиПоДокументу.Итог("Сумма");
		
		// Вывести Признано
		Если СуммаДвиженийПоДокументу <> ИтоговаяСумма Тогда
			ОбластьЗаголовок = Макет.ПолучитьОбласть("ПризнаноЗаголовок");
			ОбластьЗаголовок.Параметры.Сумма = Макс(0, СуммаДвиженийПоДокументу - ИтоговаяСумма);
			Результат.Вывести(ОбластьЗаголовок);
			
			Если ИтоговаяСумма > 0 Тогда
				НеПризнаноПоВидуРасхода = ИтогиПоДокументу.Скопировать(, "ВидРасхода, Сумма");
				НеПризнаноПоВидуРасхода.Свернуть("ВидРасхода", "Сумма");
				
				ОднаЗапись = ТаблицаДвиженийВсего.Количество() = 1;
				Для Каждого Расход Из ТаблицаДвиженийВсего Цикл
					СтрокаРасходНеПризнан = НеПризнаноПоВидуРасхода.Найти(Расход.ВидРасхода);
					Если СтрокаРасходНеПризнан <> Неопределено Тогда
						СуммаПризнания = Расход.Сумма - СтрокаРасходНеПризнан.Сумма;
						Если СуммаПризнания <> 0 Тогда
							ВывестиСтрокуПризнано(Макет, МассивПодсказка,
								Расход.ВидРасхода, СуммаПризнания, Валюта, Ложь, ОднаЗапись, Результат, НастройкиУчетаУСН);
						КонецЕсли;
					Иначе
						ВывестиСтрокуПризнано(Макет, МассивПодсказка,
							Расход.ВидРасхода, Расход.Сумма, Валюта, Истина, ОднаЗапись, Результат, НастройкиУчетаУСН);
					КонецЕсли;
				КонецЦикла;
			Иначе
				ОбластьСтрокаДанных = Макет.ПолучитьОбласть("ВсеРасходыПризнаны");
				Результат.Вывести(ОбластьСтрокаДанных);
			КонецЕсли;
			Результат.Вывести(ОбластьРазделитель);
		КонецЕсли;
		
		// Вывести Не признано
		СуммаДвиженияБезРасхода = Макс(0, ДанныеОсновногоОбъекта.Сумма - СуммаДвиженийПоДокументу);
		Если ИтоговаяСумма + СуммаДвиженияБезРасхода > 0 Тогда
			ОбластьЗаголовок = Макет.ПолучитьОбласть("НеПризнаноЗаголовок");
			ОбластьЗаголовок.Параметры.Сумма = ИтоговаяСумма + СуммаДвиженияБезРасхода;
			Результат.Вывести(ОбластьЗаголовок);
			
			ОтборПоВидуРасхода.Удалить("Родитель");
			Для Каждого ВидРасхода Из ВидыРасходов Цикл
				ОтборПоВидуРасхода.ВидРасхода = ВидРасхода;
				СтрокиРасхода = ИтогиПоДокументу.НайтиСтроки(ОтборПоВидуРасхода);
				НеВыводитьСумму = ВидыРасходов.Количество() = 1 И СтрокиРасхода.Количество() = 1;
				Для Каждого СтрокаРасхода Из СтрокиРасхода Цикл
					ВывестиСтрокуНеПризнано(
						Макет, МассивПодсказка, СтрокаРасхода, Валюта, НеВыводитьСумму, , , Результат, НастройкиУчетаУСН);
				КонецЦикла;
			КонецЦикла;
			
			// Вывести аванс
			Если СуммаДвиженияБезРасхода > 0 Тогда
				ЭтоОплата = ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаОплата();
				ДанныеРасхода = Новый Структура("ВидРасхода, СтатусРасхода, Сумма",
					Неопределено, Неопределено, СуммаДвиженияБезРасхода);
				ВывестиСтрокуНеПризнано(Макет, МассивПодсказка,
					ДанныеРасхода, Валюта, Ложь, СуммаДвиженияБезРасхода, ЭтоОплата, Результат, НастройкиУчетаУСН);
			КонецЕсли;
			Результат.Вывести(ОбластьРазделитель);
		КонецЕсли;
		
	КонецЕсли;
	
	ТаблицаОплат.Свернуть("Документ, ВидРасхода", "Сумма");
	ТаблицаСписаний.Свернуть("Документ, ВидРасхода", "Сумма");
	ТаблицаОплатПокупателей.Свернуть("Документ, ВидРасхода", "Сумма");
	
	ОбластьЛегенда = Макет.ПолучитьОбласть("Легенда");
	ОбластьЛегенда.Параметры.Пояснение = СтрСоединить(МассивПодсказка, " ");
	Результат.Вывести(ОбластьЛегенда);
	
	ВозвращаемыеДанные.ТабличныйДокумент = Результат;
	ВозвращаемыеДанные.ТаблицаОплат = ТаблицаОплат;
	ВозвращаемыеДанные.ТаблицаСписаний = ТаблицаСписаний;
	ВозвращаемыеДанные.ТаблицаОплатПокупателей = ТаблицаОплатПокупателей;
	
	Возврат ВозвращаемыеДанные;
	
КонецФункции

Функция СуммаВВалютеРегламентированногоУчета(Таблица, Валюта)
	
	Сумма = 0;
	СтрокиТаблицы = Таблица.НайтиСтроки(Новый Структура("Валюта", Валюта));
	Для Каждого СтрокаТаблицы Из СтрокиТаблицы Цикл
		Сумма = Сумма + СтрокаТаблицы.Сумма;
	КонецЦикла;
	
	Возврат Сумма;
	
КонецФункции

Функция НоваяТаблицаРасшифровкиПоДокументам()
	
	ТаблицаДокументов = Новый ТаблицаЗначений;
	ТаблицаДокументов.Колонки.Добавить("Документ", ОбщегоНазначения.ОписаниеТипаВсеСсылки());
	ТаблицаДокументов.Колонки.Добавить("Сумма", ОбщегоНазначения.ОписаниеТипаЧисло(15, 2));
	ТаблицаДокументов.Колонки.Добавить("ВидРасхода", ОбщегоНазначения.ОписаниеТипаСтрока(30));
	ТаблицаДокументов.Колонки.Добавить("Валюта", Новый ОписаниеТипов("СправочникСсылка.Валюты"));
	
	Возврат ТаблицаДокументов;
	
КонецФункции

Функция СформироватьЗаголовок(ОбъектОтбора)
	Возврат СтрШаблон(
		НСтр("ru = 'Признание расходов УСН
		|%1'"),
		ПредставлениеДокументаРасхода(ОбъектОтбора));
КонецФункции

Процедура ВывестиПодсказкуРасхода(Макет, ВидРасхода, НастройкиУчетаУСН, Результат)
	Если ВидРасхода = "Товары" Тогда
		Если НастройкиУчетаУСН.ПростойУчетТоваров Тогда
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаТоварыПросто");
		Иначе
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаТоварыСложно");
		КонецЕсли;
	ИначеЕсли ВидРасхода = "Материалы" Тогда
		Если НастройкиУчетаУСН.ПростойУчетМатериалов Тогда
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаМатериалыПросто");
		Иначе
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаМатериалыСложно");
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ДопРасходы) Тогда
		Если НастройкиУчетаУСН.ПростойУчетДопРасходов Тогда
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаДопРасходыПросто");
		Иначе
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаДопРасходыСложно");
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаЗП");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Командировки) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаКомандировки");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ЛизинговыеПлатежи) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаЛизинговыеПлатежи");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Налоги) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаНалог");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС) Тогда
		Если НастройкиУчетаУСН.ПростойУчетНДС Тогда
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаНДСПросто");
		Иначе
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаНДССложно");
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС_ТС) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаНДС_ТС");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаНМА");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаОС");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаРБП");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи) Тогда
		Если НастройкиУчетаУСН.ПростойУчетТаможенныхПлатежей Тогда
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаТаможенныеПлатежиПросто");
		Иначе
			ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаТаможенныеПлатежиСложно");
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Услуги) Тогда
		ОбластьПодсказка = Макет.ПолучитьОбласть("ПодсказкаУслуги");
	КонецЕсли;
	
	Результат.Вывести(ОбластьПодсказка);
	
КонецПроцедуры

Процедура ВывестиПоступлениеРасхода(Макет, МассивПодсказка, ВидРасхода, Сумма, Валюта, СуммаНДФЛ = 0, Результат)
	
	ОбластьПоступлениеРасхода = Макет.ПолучитьОбласть("СтрокаДанных");
	ОбластьПоступлениеРасхода.Параметры.Сумма = Сумма;
	ПрефиксНа = НСтр("ru = ' на '");
	Префикс = НСтр("ru = ' '");
	Если ВидРасхода = "Товары" Тогда
		Пояснение = НСтр("ru = 'Поступило товаров'");
		Префикс = ПрефиксНа;
	ИначеЕсли ВидРасхода = "Материалы" Тогда
		Пояснение = НСтр("ru = 'Поступило материалов'");
		Префикс = ПрефиксНа;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ДопРасходы) Тогда
		Пояснение = НСтр("ru = 'Дополнительные расходы'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
		Пояснение = НСтр("ru = 'Начислено зарплаты'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Командировки) Тогда
		Пояснение = НСтр("ru = 'Поступило расходов по командировкам'");
		Префикс = ПрефиксНа;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ЛизинговыеПлатежи) Тогда
		Пояснение = НСтр("ru = 'Расходы по лизинговым платежам'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Налоги) Тогда
		Пояснение = НСтр("ru = 'Начислено налогов (взносов)'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС) Тогда
		Пояснение = НСтр("ru = 'Начислено НДС'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС_ТС) Тогда
		Пояснение = НСтр("ru = 'Начисленно НДС Таможенного Союза'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА) Тогда
		Пояснение = НСтр("ru = 'Начислено расходов по нематериальным активам (НМА)'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС) Тогда
		Пояснение = НСтр("ru = 'Начислено расходов по основным средствам'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП) Тогда
		Пояснение = НСтр("ru = 'Расходы будущих периодов'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи) Тогда
		Пояснение = НСтр("ru = 'Таможенные платежи'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Услуги) Тогда
		Пояснение = НСтр("ru = 'Оказано услуг'");
		Префикс = ПрефиксНа;
	Иначе
		Пояснение = НСтр("ru = 'Неизвестный расход'");
	КонецЕсли;
	
	ОбластьПоступлениеРасхода.Параметры.Пояснение = Пояснение;
	Результат.Вывести(ОбластьПоступлениеРасхода);
	МассивПодсказка.Добавить(Пояснение);
	МассивПодсказка.Добавить(Префикс);
	ВалютаСтрокой = Строка(Валюта);
	Если Сред(Строка(Валюта), СтрДлина(Строка(Валюта)), 1) <> "." Тогда
		ВалютаСтрокой = ВалютаСтрокой + ".";
	КонецЕсли;
	СуммаСтрокой = СтрСоединить(
		ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(Сумма, "ЧДЦ=2"), ВалютаСтрокой),
		Символы.НПП);
	МассивПодсказка.Добавить(СуммаСтрокой);
	
	Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) И СуммаНДФЛ > 0 Тогда
		ОбластьНДФЛ = Макет.ПолучитьОбласть("ПоступлениеНДФЛ");
		ОбластьНДФЛ.Параметры.Сумма = СуммаНДФЛ;
		Результат.Вывести(ОбластьНДФЛ);
		СуммаСтрокой = СтрСоединить(
			ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(СуммаНДФЛ, "ЧДЦ=2"), Валюта),
			Символы.НПП);
		МассивПодсказка.Добавить(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = ' (в том числе %1 НДФЛ). '"),
			СуммаСтрокой));
	КонецЕсли;
	
	ОбластьРазделитель = Макет.ПолучитьОбласть("Разделитель");
	Результат.Вывести(ОбластьРазделитель);
	
КонецПроцедуры

Процедура ВывестиОплатуРасхода(Макет, МассивПодсказка, ВидРасхода, Сумма, Валюта, СуммаНДФЛ = 0, Результат)
	
	ОбластьПоступлениеРасхода = Макет.ПолучитьОбласть("СтрокаДанных");
	ОбластьПоступлениеРасхода.Параметры.Сумма = Сумма;
	Если ВидРасхода = "Товары" Тогда
		Пояснение = НСтр("ru = 'Оплачено товаров (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее поступивших товаров на сумму %1'");
	ИначеЕсли ВидРасхода = "Материалы" Тогда
		Пояснение = НСтр("ru = 'Оплачено материалов (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее поступивших материалов на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ДопРасходы) Тогда
		Пояснение = НСтр("ru = 'Оплачено дополнительных расходов (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее поступивших дополнительных расходов на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
		Пояснение = НСтр("ru = 'Выплачено зарплаты (начислена ранее)'");
		Легенда = НСтр("ru = 'Оплачена ранее начисленная Зарплата на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Командировки) Тогда
		Пояснение = НСтр("ru = 'Оплачено расходов по командировкам (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее поступивших расходов по командировке на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ЛизинговыеПлатежи) Тогда
		Пояснение = НСтр("ru = 'Оплачено лизинговых платежей (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачен лизинговый платеж на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Налоги) Тогда
		Пояснение = НСтр("ru = 'Оплачено налогов (взносов) (начислено ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее начисленных налогов (взносов) на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС) Тогда
		Пояснение = НСтр("ru = 'Оплачено НДС (начислен ранее)'");
		Легенда = НСтр("ru = 'Оплачен ранее начисленный НДС на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС_ТС) Тогда
		Пояснение = НСтр("ru = 'Оплачено НДС Таможенного Союза (начислен ранее)'");
		Легенда = НСтр("ru = 'Оплачен ранее начисленный НДС Таможенного Союза на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА) Тогда
		Пояснение = НСтр("ru = 'Оплачено нематериальных активов (НМА) (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее поступивших нематериальных активов (НМА) на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС) Тогда
		Пояснение = НСтр("ru = 'Оплачено расходов по основным средствам (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее поступивших основных средств на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП) Тогда
		Пояснение = НСтр("ru = 'Оплачены расходы будущих периодов (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачены расходы будущих периодов на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи) Тогда
		Пояснение = НСтр("ru = 'Оплачено таможенных платежей (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачен таможенный платеж на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Услуги) Тогда
		Пояснение = НСтр("ru = 'Оплачено услуг (поступили ранее)'");
		Легенда = НСтр("ru = 'Оплачено ранее оказанных услуг на сумму %1'");
	Иначе
		Пояснение = НСтр("ru = 'Неизвестные расходы'");
		Легенда = НСтр("ru = 'Оплачены неизвестные расходы на сумму %1'");
	КонецЕсли;
	
	ОбластьПоступлениеРасхода.Параметры.Пояснение = Пояснение;
	Результат.Вывести(ОбластьПоступлениеРасхода);
	СуммаСтрокой = СтрСоединить(
		ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(Сумма, "ЧДЦ=2"), Валюта),
		Символы.НПП);
	Легенда = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Легенда, СуммаСтрокой);
	МассивПодсказка.Добавить(Легенда);
	
	Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) И СуммаНДФЛ > 0 Тогда
		ОбластьНДФЛ = Макет.ПолучитьОбласть("СтрокаДанных");
		ОбластьНДФЛ.Параметры.Сумма = СуммаНДФЛ;
		ОбластьПоступлениеРасхода.Параметры.Пояснение = НСтр("ru = 'Рассчитан НДФЛ'");
		Результат.Вывести(ОбластьНДФЛ);
		СуммаСтрокой = СтрСоединить(
			ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(СуммаНДФЛ, "ЧДЦ=2"), Валюта),
			Символы.НПП);
		МассивПодсказка.Добавить(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = ' Также расходом признан начисленный НДФЛ %1'"),
			СуммаСтрокой));
	КонецЕсли;
	
	ОбластьРазделитель = Макет.ПолучитьОбласть("Разделитель");
	Результат.Вывести(ОбластьРазделитель);
	
КонецПроцедуры

Процедура ВывестиРеализациюРасхода(Макет, МассивПодсказка, ВидРасхода, Сумма, Валюта, СуммаНДФЛ = 0, Результат)
	
	ОбластьПоступлениеРасхода = Макет.ПолучитьОбласть("СтрокаДанных");
	ОбластьПоступлениеРасхода.Параметры.Сумма = Сумма;
	Если ВидРасхода = "Товары" Тогда
		Пояснение = НСтр("ru = 'Продано товаров (поступили ранее)'");
		Легенда = НСтр("ru = 'Продано ранее поступивших товаров на сумму %1'");
	ИначеЕсли ВидРасхода = "Материалы" Тогда
		Пояснение = НСтр("ru = 'Списано материалов (поступили ранее)'");
		Легенда = НСтр("ru = 'Списано ранее поступивших материалов на сумму %1'");
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи) Тогда
		Пояснение = НСтр("ru = 'Сумма таможенных платежей в реализованном товаре (поступили ранее)'");
		Легенда = НСтр("ru = 'Сумма таможенного платежа в реализованном товаре на сумму %1 признана расходом.'");
	КонецЕсли;
	
	ОбластьПоступлениеРасхода.Параметры.Пояснение = Пояснение;
	Результат.Вывести(ОбластьПоступлениеРасхода);
	СуммаСтрокой = СтрСоединить(
		ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(Сумма, "ЧДЦ=2"), Валюта),
		Символы.НПП);
	Легенда = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Легенда, СуммаСтрокой);
	МассивПодсказка.Добавить(Легенда);
	
	Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) И СуммаНДФЛ > 0 Тогда
		ОбластьНДФЛ = Макет.ПолучитьОбласть("СтрокаДанных");
		ОбластьНДФЛ.Параметры.Сумма = СуммаНДФЛ;
		ОбластьПоступлениеРасхода.Параметры.Пояснение = НСтр("ru = 'Рассчитан НДФЛ'");
		Результат.Вывести(ОбластьНДФЛ);
		СуммаСтрокой = СтрСоединить(
			ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(СуммаНДФЛ, "ЧДЦ=2"), Валюта),
			Символы.НПП);
		МассивПодсказка.Добавить(СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = ' Также расходом признан начисленный НДФЛ %1'"),
			СуммаСтрокой));
	КонецЕсли;
	
	ОбластьРазделитель = Макет.ПолучитьОбласть("Разделитель");
	Результат.Вывести(ОбластьРазделитель);
	
КонецПроцедуры

Функция РассчитатьНДФЛ(ОбъектОтбора)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(РасчетыНалогоплательщиковСБюджетомПоНДФЛОбороты.СуммаПриход + РасчетыНалогоплательщиковСБюджетомПоНДФЛОбороты.СуммаСПревышенияПриход, 0) КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Обороты(, , Регистратор, ) КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛОбороты
		|ГДЕ
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛОбороты.Регистратор = &Регистратор";
	
	Запрос.УстановитьПараметр("Регистратор", ОбъектОтбора);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Сумма;
	Иначе
		Возврат 0;
	КонецЕсли;
	
КонецФункции

Функция НужныДокументыРеализации(ВидРасхода, НастройкиУчетаУСН)
	
	Возврат ВидРасхода = "Товары"
		Или ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП)
		Или ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС)
		Или ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА)
		Или (ВидРасхода = "Материалы" И Не НастройкиУчетаУСН.ПростойУчетМатериалов);
	
КонецФункции

Функция ТаблицаИтоговПоДокументу(РасчетныйДокумент, ВидРасхода, ТаблицаСписаний, СуммаРасходаПоДокументу, ДанныеОсновногоОбъекта, НастройкиУчетаУСН)
	
	Если ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаПартия() Тогда
		ТекстЗапроса = 
		"ВЫБРАТЬ
		|	РасходыПриУСН.РасчетныйДокумент КАК РасчетныйДокумент,
		|	РасходыПриУСН.Валюта КАК Валюта,
		|	ВЫБОР
		|		КОГДА РасходыПриУСН.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|			ТОГДА ВЫБОР
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаМатериалов)
		|						ТОГДА ""Материалы""
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ""ОС""
		|					ИНАЧЕ ""Товары""
		|				КОНЕЦ
		|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(РасходыПриУСН.ВидРасхода)
		|	КОНЕЦ КАК ВидРасхода,
		|	РасходыПриУСН.СтатусыОплатыРасходовУСН КАК СтатусРасхода,
		|	СУММА(ВЫБОР
		|			КОГДА РасходыПриУСН.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|				ТОГДА ВЫБОР
		|						КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|							ТОГДА -РасходыПриУСН.Сумма + РасходыПриУСН.НДС
		|						ИНАЧЕ -РасходыПриУСН.Сумма
		|					КОНЕЦ
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|						ТОГДА РасходыПриУСН.Сумма - РасходыПриУСН.НДС
		|					ИНАЧЕ РасходыПриУСН.Сумма
		|				КОНЕЦ
		|		КОНЕЦ) КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН КАК РасходыПриУСН
		|ГДЕ
		|	РасходыПриУСН.РасчетныйДокумент = &РасчетныйДокумент
		|	И РасходыПриУСН.ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)
		|	И (РасходыПриУСН.СтатусСписания = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.НеПринимаются)
		|				И (РасходыПриУСН.Регистратор ССЫЛКА Документ.ВозвратТоваровПоставщику
		|					ИЛИ РасходыПриУСН.Регистратор ССЫЛКА Документ.КорректировкаПоступления)
		|			ИЛИ РасходыПриУСН.СтатусСписания В (ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.ПустаяСсылка), ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)))
		|
		|СГРУППИРОВАТЬ ПО
		|	РасходыПриУСН.РасчетныйДокумент,
		|	РасходыПриУСН.Валюта,
		|	РасходыПриУСН.СтатусыОплатыРасходовУСН,
		|	ВЫБОР
		|		КОГДА РасходыПриУСН.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|			ТОГДА ВЫБОР
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаМатериалов)
		|						ТОГДА ""Материалы""
		|					КОГДА РасходыПриУСН.СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ""ОС""
		|					ИНАЧЕ ""Товары""
		|				КОНЕЦ
		|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(РасходыПриУСН.ВидРасхода)
		|	КОНЕЦ";
	Иначе
		ТекстЗапроса = 
		"ВЫБРАТЬ
		|	РасходыПриУСНОстаткиИОбороты.РасчетныйДокумент КАК РасчетныйДокумент,
		|	РасходыПриУСНОстаткиИОбороты.Валюта КАК Валюта,
		|	ВЫБОР
		|		КОГДА РасходыПриУСНОстаткиИОбороты.ВидРасхода = ЗНАЧЕНИЕ(Перечисление.ВидыРасходовУСН.Номенклатура)
		|			ТОГДА ВЫБОР
		|					КОГДА РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаМатериалов)
		|						ТОГДА ""Материалы""
		|					КОГДА РасходыПриУСНОстаткиИОбороты.СчетУчета В (&СчетаУчетаОС)
		|						ТОГДА ""ОС""
		|					ИНАЧЕ ""Товары""
		|				КОНЕЦ
		|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(РасходыПриУСНОстаткиИОбороты.ВидРасхода)
		|	КОНЕЦ КАК ВидРасхода,
		|	РасходыПриУСНОстаткиИОбороты.СтатусыОплатыРасходовУСН КАК СтатусРасхода,
		|	ВЫБОР
		|		КОГДА &ПрименяетсяОбщаяСтавкаНДС
		|			ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаПриход - РасходыПриУСНОстаткиИОбороты.НДСПриход
		|		КОГДА &ПростойУчетНДС
		|			ТОГДА РасходыПриУСНОстаткиИОбороты.СуммаПриход - РасходыПриУСНОстаткиИОбороты.НДСПриход
		|		ИНАЧЕ РасходыПриУСНОстаткиИОбороты.СуммаПриход
		|	КОНЕЦ КАК Сумма
		|ИЗ
		|	РегистрНакопления.РасходыПриУСН.ОстаткиИОбороты(, , Регистратор, , ОтражениеВУСН = ЗНАЧЕНИЕ(Перечисление.ОтражениеВУСН.Принимаются)) КАК РасходыПриУСНОстаткиИОбороты
		|ГДЕ
		|	РасходыПриУСНОстаткиИОбороты.Регистратор = &РасчетныйДокумент";
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	Запрос.УстановитьПараметр("РасчетныйДокумент", РасчетныйДокумент);
	Запрос.УстановитьПараметр("СчетаУчетаМатериалов", СчетаУчетаМатериалов());
	Запрос.УстановитьПараметр("СчетаУчетаОС", СчетаУчетаОС());
	Запрос.УстановитьПараметр("ПрименяетсяОбщаяСтавкаНДС", НастройкиУчетаУСН.ПрименяетсяОбщаяСтавкаНДС);
	Запрос.УстановитьПараметр("ПростойУчетНДС", НастройкиУчетаУСН.ПростойУчетНДС);
	
	ТаблицаИтогов = Запрос.Выполнить().Выгрузить();
	
	// Материалы признаваемые по оплате продолжают оставаться в регистре до списания в производство,
	// хотя расход уже перенесен в КУДиР
	// Такие строки нужно удалить из таблицы, чтобы правильно считать итоги
	// Строку со статусом НеОплачено нужно объединить со строкой НеСписаноНеОплачено
	Если НастройкиУчетаУСН.ПростойУчетМатериалов Тогда
		Отбор = Новый Структура;
		Отбор.Вставить("ВидРасхода", "Материалы");
		Отбор.Вставить("СтатусРасхода", Перечисления.СтатусыРасходовУСН.НеСписаноПринято);
		СтрокиДляУдаления = ТаблицаИтогов.НайтиСтроки(Отбор);
		Для Каждого СтрокаУдаления Из СтрокиДляУдаления Цикл
			ТаблицаИтогов.Удалить(СтрокаУдаления);
		КонецЦикла;
		
		Отбор.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено;
		СтрокиНеОплачено = ТаблицаИтогов.НайтиСтроки(Отбор);
		Для Каждого СтрокаНеОплачено Из СтрокиНеОплачено Цикл
			СтрокаНеОплачено.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено;
		КонецЦикла;
	КонецЕсли;
	
	// Основные средства и Нематериальные активы исключаются из регистра после оплаты, но принимаются частями
	// поэтому в регистре будет только неоплаченная сумма
	// Т.к. неоплаченная сумма не может и списаться, то фактически это статус НеСписаноНеОплачено
	// Необходимо дополнить ТаблицуИтогов суммами еще не принятыми по сроку они будут со статусом НеСписано
	Если ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС)
		Или ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА)Тогда
		Оплачено = 0;
		СтрокаНеОплачено = ТаблицаИтогов.Найти(Перечисления.СтатусыРасходовУСН.НеОплачено, "СтатусРасхода");
		Если СтрокаНеОплачено <> Неопределено Тогда
			Оплачено = СуммаРасходаПоДокументу - СтрокаНеОплачено.Сумма;
			СтрокаНеОплачено.СтатусРасхода =  Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено;
			Валюта = СтрокаНеОплачено.Валюта;
		Иначе
			Валюта = ОбщегоНазначенияБПВызовСервераПовтИсп.ПолучитьВалютуРегламентированногоУчета();
		КонецЕсли;
		Списано = ТаблицаСписаний.Итог("Сумма");
		НеСписано = Макс(0, Оплачено - Списано);
		Если НеСписано <> 0 Тогда
			НоваяСтрока = ТаблицаИтогов.Добавить();
			НоваяСтрока.ВидРасхода = ВидРасхода;
			НоваяСтрока.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано;
			НоваяСтрока.Сумма = НеСписано;
			НоваяСтрока.Валюта = Валюта;
		КонецЕсли;
	КонецЕсли;
	
	// Свернем таблицу и удалим строки с суммой 0
	Если ДанныеОсновногоОбъекта.ВидДокумента = ВидДокументаПартия() Тогда
		ТаблицаИтогов.Свернуть("ВидРасхода, СтатусРасхода, Валюта", "Сумма");
		ОбратныйИндекс = ТаблицаИтогов.Количество() - 1;
		Пока ОбратныйИндекс >= 0 Цикл
			Если ТаблицаИтогов.Получить(ОбратныйИндекс).Сумма = 0 Тогда
				ТаблицаИтогов.Удалить(ТаблицаИтогов.Получить(ОбратныйИндекс));
			КонецЕсли;
			ОбратныйИндекс = ОбратныйИндекс - 1;
		КонецЦикла;
	КонецЕсли;
	
	Возврат ТаблицаИтогов;
	
КонецФункции

Процедура ВывестиСтрокуНеПризнано(Макет, МассивПодсказка, СтрокаРасхода, Валюта, НеВыводитьСумму, СуммаДвиженияБезРасхода = 0, ЭтоОплата = Ложь, Результат, НастройкиУчетаУСН)
	
	Если НеВыводитьСумму Тогда
		ОбластьСтрокаДанных = Макет.ПолучитьОбласть("СтрокаДанныхБезСуммы");
	Иначе
		ОбластьСтрокаДанных = Макет.ПолучитьОбласть("СтрокаДанных");
		ОбластьСтрокаДанных.Параметры.Сумма = СтрокаРасхода.Сумма;
	КонецЕсли;
	
	ВидРасшифровки = Новый Структура();
	ВидРасшифровки.Вставить("СтатусРасхода", СтрокаРасхода.СтатусРасхода);
	ВидРасшифровки.Вставить("ВидРасхода",    СтрокаРасхода.ВидРасхода);
	ОбластьСтрокаДанных.Параметры.ВидРасшифровки = ВидРасшифровки;
	
	Если СуммаДвиженияБезРасхода <> 0 Тогда
		ОбластьСтрокаДанных.Параметры.Сумма = СуммаДвиженияБезРасхода;
		Если ЭтоОплата Тогда
			Пояснение = НСтр("ru = 'Переплата расходом не является'");
			Легенда =
				НСтр("ru = 'Оплачено больше на %1, эта сумма является переплатой и в расходы не включается.'");
		Иначе
			Пояснение = НСтр("ru = 'Проданный товар без поступления расходом не является'");
			Легенда =
				НСтр("ru = 'Продано товара, который раньше не поступал на %1, эта сумма не может быть включена в расходы.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = "Товары" Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Товары реализованы, но не оплачены'");
			Легенда =
				НСтр("ru = 'Товары на %1 будут признаны расходом позже, когда будут оплачены.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
			Пояснение = НСтр("ru = 'Товары оплачены, но не реализованы'");
			Легенда =
				НСтр("ru = 'Товары на %1 будут признаны расходом позже, когда будут реализованы.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
			Пояснение = НСтр("ru = 'Товары не оплачены и не реализованы'");
			Легенда =
				НСтр("ru = 'Товары на %1 будут признаны расходом позже, когда будут оплачены и реализованы.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплаченоНеОплаченоПокупателем Тогда
			Пояснение = НСтр("ru = 'Товары не оплачены поставщику и не оплачены покупателем'");
			Легенда =
				НСтр("ru = 'Товары на %1 будут признаны расходом позже, когда будут оплачены поставщику и оплачены покупателем.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплаченоПокупателем Тогда
			Пояснение = НСтр("ru = 'Товары не оплачены покупателем'");
			Легенда =
				НСтр("ru = 'Товары на %1 будут признаны расходом позже, когда будут оплачены покупателем.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = "Материалы" Тогда
		Если НастройкиУчетаУСН.ПростойУчетМатериалов Тогда
			Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
				Пояснение = НСтр("ru = 'Материалы не оплачены'");
			Легенда =
				НСтр("ru = 'Материалы на %1 будут признаны расходом позже, когда будут оплачены.'");
			КонецЕсли;
		Иначе
			Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
				Пояснение = НСтр("ru = 'Материалы не оплачены и не переданы в производство'");
				Легенда =
					НСтр("ru = 'Материалы на %1 будут признаны расходом позже, когда будут оплачены и переданы в производство.'");
			ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
				Пояснение = НСтр("ru = 'Материалы не оплачены'");
				Легенда =
					НСтр("ru = 'Материалы на %1 будут признаны расходом позже, когда будут оплачены.'");
			ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноПринято
					Или СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
				Пояснение = НСтр("ru = 'Материалы не переданы в производство'");
				Легенда = 
					НСтр("ru = 'Материалы на %1 будут признаны расходом позже, когда будут переданы в производство.'");
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ДопРасходы) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Дополнительные расходы не оплачены'");
			Легенда = 
				НСтр("ru = 'Дополнительные расходы в сумме %1 будут признаны расходом позже, когда будут оплачены.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
			Пояснение = НСтр("ru = 'Не списана номенклатура с дополнительными расходами'");
			Легенда = 
				НСтр("ru = 'Дополнительные расходы в сумме %1 будут признаны расходом позже, когда будет списана номенклатура, на которую отнесены эти расходы.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
			Пояснение = НСтр("ru = 'Дополнительные расходы не оплачены и номенклатура не списана'");
			Легенда = 
				НСтр("ru = 'Дополнительные расходы в сумме %1 будут признаны расходом позже, когда будут оплачены и номенклатура, на которую отнесены эти расходы, списана.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Заработная плата не выплачена'");
			Легенда = 
				НСтр("ru = 'Заработная плата в размере %1 будет признана расходом позже, когда будет выплачена.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Командировки) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Командировка не оплачена'");
			Легенда = 
				НСтр("ru = 'Затраты на командировку в размере %1 будут признаны расходом позже, когда будут выплачены работнику.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ЛизинговыеПлатежи) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Лизинговый платеж не оплачен'");
			Легенда = 
				НСтр("ru = 'Лизинговый платеж в сумме %1 будет признан расходом позже, когда будет оплачен.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Налоги) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Налоги (взносы) не оплачены'");
			Легенда = 
				НСтр("ru = 'Налоги (взносы) в размере %1 будут признаны расходом позже, когда будут оплачены.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС) Тогда
		Если НастройкиУчетаУСН.ПростойУчетНДС Тогда
			Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
				Пояснение = НСтр("ru = 'НДС не оплачен'");
				Легенда = 
					НСтр("ru = 'НДС в размере %1 будет признан расходом позже, когда будет оплачен.'");
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС_ТС) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'НДС Таможенного Союза не оплачен'");
			Легенда = 
				НСтр("ru = 'НДС Таможенного Союза в размере %1 будет признан расходом позже, когда будет оплачен.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
			Пояснение = НСтр("ru = 'Срок признания расхода по нематериальному активу не наступил'");
			Легенда = 
				НСтр("ru = 'Затраты на нематериальный актив в сумме %1 будут признаны расходом позже, когда наступит срок.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
			Пояснение = НСтр("ru = 'Нематериальный актив не оплачен и срок не наступил'");
			Легенда =
				НСтр("ru = 'Нематериальный актив на %1 будет признан расходом позже, когда будет оплачен и наступит срок.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
			Пояснение = НСтр("ru = 'Срок признания расхода основного средства не наступил'");
			Легенда = 
				НСтр("ru = 'Затраты на основное средство в сумме %1 будут признаны расходом позже, когда наступит срок.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
			Пояснение = НСтр("ru = 'Основные средства не оплачены и срок не наступил'");
			Легенда =
				НСтр("ru = 'Основные средства на %1 будут признаны расходом позже, когда будут оплачены и наступит срок.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
			Пояснение = НСтр("ru = 'Расходы будущих периодов, не оплачены и не наступил срок'");
			Легенда = 
				НСтр("ru = 'Расходы будущих периодов, в сумме %1 будут признаны расходом позже, когда наступит срок и они будут оплачены.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Расходы будущих периодов, не оплачены'");
			Легенда = 
				НСтр("ru = 'Расходы будущих периодов в сумме %1 будут признаны расходом позже, когда будут оплачены.'");
		ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
			Пояснение = НСтр("ru = 'Расходы будущих периодов, не наступил срок'");
			Легенда = 
				НСтр("ru = 'Расходы будущих периодов в сумме %1 будут признаны расходом позже, когда наступит срок.'");
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи) Тогда
		Если НастройкиУчетаУСН.ПростойУчетТаможенныхПлатежей Тогда
			Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
				Пояснение = НСтр("ru = 'Таможенные платежи не оплачены'");
				Легенда = 
					НСтр("ru = 'Таможенные платежи в сумме %1 будут признаны расходом позже, когда будут оплачены.'");
			КонецЕсли;
		Иначе
			Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
				Пояснение = НСтр("ru = 'Товар реализован, но таможенные платежи не оплачены'");
				Легенда = 
					НСтр("ru = 'Таможенные платежи в сумме %1 будут признаны расходом позже, когда будут оплачены.'");
			ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписано Тогда
				Пояснение = НСтр("ru = 'Товар реализован, таможенные платежи оплачены, но не списаны'");
				Легенда = 
					НСтр("ru = 'Таможенные платежи в сумме %1 будут признаны расходом позже, когда будут списаны пропорционально стоимости реализованных товаров.'");
			ИначеЕсли СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеСписаноНеОплачено Тогда
				Пояснение = НСтр("ru = 'Таможенные платежи не оплачены и ввезенный товар не реализован'");
				Легенда = 
					НСтр("ru = 'Таможенные платежи в сумме %1 будут признаны расходом позже, когда будут оплачены и товар будет реализован.'");
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли СтрокаРасхода.ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Услуги) Тогда
		Если СтрокаРасхода.СтатусРасхода = Перечисления.СтатусыРасходовУСН.НеОплачено Тогда
			Пояснение = НСтр("ru = 'Услуги не оплачены'");
			Легенда = 
				НСтр("ru = 'Услуги на %1 будут признаны расходом позже, когда будут оплачены.'");
		КонецЕсли;
	КонецЕсли;
	
	Если Пояснение = "" И Легенда = "" Тогда
		ОбластьСтрокаДанных.Параметры.Пояснение = НСтр("ru = 'Ошибочный статус'");
	Иначе
		ОбластьСтрокаДанных.Параметры.Пояснение = Пояснение;
	КонецЕсли;
	
	Результат.Вывести(ОбластьСтрокаДанных);
	Если СуммаДвиженияБезРасхода = 0 Тогда
		СуммаСтрокой = СтрСоединить(
			ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(СтрокаРасхода.Сумма, "ЧДЦ=2"), Валюта), Символы.НПП);
	Иначе
		СуммаСтрокой = СтрСоединить(
			ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(СуммаДвиженияБезРасхода, "ЧДЦ=2"), Валюта), Символы.НПП);
	КонецЕсли;
	Легенда = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Легенда, СуммаСтрокой);
	МассивПодсказка.Добавить(Легенда);
	
КонецПроцедуры

Процедура ВывестиСтрокуПризнано(Макет, МассивПодсказка, ВидРасхода, Сумма, Валюта, ПолностьюПризнан, НеВыводитьСумму, Результат, НастройкиУчетаУСН)
	
	Если НеВыводитьСумму Тогда
		ОбластьСтрокаДанных = Макет.ПолучитьОбласть("СтрокаДанныхБезСуммы");
	Иначе
		ОбластьСтрокаДанных = Макет.ПолучитьОбласть("СтрокаДанных");
		ОбластьСтрокаДанных.Параметры.Сумма = Сумма;
	КонецЕсли;
	
	ВидРасшифровки = Новый Структура();
	ВидРасшифровки.Вставить("СтатусРасхода", Перечисления.СтатусыРасходовУСН.ПустаяСсылка());
	ВидРасшифровки.Вставить("ВидРасхода",    ВидРасхода);
	ОбластьСтрокаДанных.Параметры.ВидРасшифровки = ВидРасшифровки;
	
	НужныПараметры = Ложь;
	Если ВидРасхода = "Товары" Тогда
		Если НастройкиУчетаУСН.ПростойУчетТоваров Тогда
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Товары оплачены и реализованы полностью'");
				Легенда = НСтр("ru = 'Товары оплачены и реализованы полностью, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Товары оплачены и реализованы'");
				Легенда =
					НСтр("ru = 'Поскольку оплачено и реализовано товаров было только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		Иначе
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Товары оплачены поставщику, реализованы и оплачены покупателем полностью'");
				Легенда =
					НСтр("ru = 'Товары оплачены поставщику, реализованы и оплачены покупателем полностью, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Товары поставщику оплачены, реализованы и оплачены покупателем'");
				Легенда =
					НСтр("ru = 'Поскольку оплачено поставщику, реализовано и оплачено покупателем товаров было только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ВидРасхода = "Материалы" Тогда
		Если НастройкиУчетаУСН.ПростойУчетМатериалов Тогда
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Материалы оплачены полностью'");
				Легенда = НСтр("ru = 'Материалы оплачены полностью, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Оплачено материалов'");
				Легенда =
					НСтр("ru = 'Поскольку оплачено материалов было только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		Иначе
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Материалы оплачены и переданы в производство полностью'");
				Легенда = НСтр("ru = 'Материалы оплачены и переданы в производство полностью, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Оплачено и передано в производство материалов'");
				Легенда =
					НСтр("ru = 'Поскольку оплачено и передано в производство материалов было только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ДопРасходы) Тогда
		Если НастройкиУчетаУСН.ПростойУчетДопРасходов Тогда
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Дополнительные расходы оплачены полностью'");
				Легенда = НСтр("ru = 'Дополнительные расходы оплачены полностью, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Оплачено дополнительных расходов'");
				Легенда =
					НСтр("ru = 'Поскольку дополнительные расходы были оплачены только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		Иначе
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Дополнительные расходы оплачены и товары (материалы) реализованы (списаны)'");
				Легенда = НСтр("ru = 'Дополнительные расходы оплачены и товары (материалы), на которые отнесены дополнительные расходы, реализованы (списаны), поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Оплачено дополнительных расходов и реализовано (списано) товаров (материалов) '");
				Легенда =
					НСтр("ru = 'Поскольку дополнительные расходы были оплачены и товары (материалы), на которые отнесены дополнительные расходы, реализованы (списаны) только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Зарплата) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Зарплата оплачена полностью'");
			Легенда = НСтр("ru = 'Зарплата оплачена полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Выплачено зарплаты'");
			Легенда =
				НСтр("ru = 'Поскольку зарплата была оплачена только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Командировки) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Расходы по командировке оплачены полностью'");
			Легенда = НСтр("ru = 'Расходы по командировке оплачены полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачено расходов по командировке'");
			Легенда =
				НСтр("ru = 'Поскольку командировка оплачена только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ЛизинговыеПлатежи) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Лизинговый платеж оплачен полностью'");
			Легенда = НСтр("ru = 'Лизинговый платеж оплачен полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачено по лизинговому платежу'");
			Легенда =
				НСтр("ru = 'Поскольку лизинговый платеж составил %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Налоги) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Налоги (взносы) оплачены полностью'");
			Легенда = НСтр("ru = 'Налоги (взносы) оплачены полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачено налогов (взносов)'");
			Легенда =
				НСтр("ru = 'Поскольку налоги (взносы) оплачены только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'НДС оплачен полностью'");
			Легенда = НСтр("ru = 'НДС оплачен полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачен НДС'");
			Легенда =
				НСтр("ru = 'Поскольку НДС оплачен только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НДС_ТС) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'НДС Таможенного Союза оплачен полностью'");
			Легенда = НСтр("ru = 'НДС Таможенного Союза оплачен полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачен НДС Таможенного Союза'");
			Легенда =
				НСтр("ru = 'Поскольку НДС Таможенного Союза оплачен только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.НМА) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Нематериальные активы оплачены полностью'");
			Легенда = НСтр("ru = 'Нематериальные активы оплачены полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачено нематериальных активов и наступили сроки признания'");
			Легенда =
				НСтр("ru = 'Поскольку сроки признания наступили для оплат нематериальных активов только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ОС) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Основные средства оплачены полностью и сроки признания расходов наступили'");
			Легенда = НСтр("ru = 'Основные средства оплачены полностью и сроки признания расходов наступили, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачено расходов по основным средствам и наступили сроки признания'");
			Легенда =
				НСтр("ru = 'Поскольку сроки признания наступили для оплат основных средств только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.РБП) Тогда
		Пояснение = НСтр("ru = 'Признано расходов будущих периодов'");
		Легенда =
			НСтр("ru = 'Поскольку наступили сроки признания для оплат расходов будущих периодов только на %1, эта сумма признана расходом.'");
		НужныПараметры = Истина;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.ТаможенныеПлатежи) Тогда
		Если НастройкиУчетаУСН.ПростойУчетТаможенныхПлатежей Тогда
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Таможенные платежи оплачены полностью'");
				Легенда = НСтр("ru = 'Таможенные платежи оплачены полностью, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Оплачено таможенных платежей'");
				Легенда =
					НСтр("ru = 'Поскольку таможенные платежи оплачены только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		Иначе
			Если ПолностьюПризнан Тогда
				Пояснение = НСтр("ru = 'Таможенные платежи оплачены полностью и товары реализованы'");
				Легенда = НСтр("ru = 'Таможенные платежи оплачены полностью и товары реализованы, поэтому вся сумма признана в расходах.'");
			Иначе
				Пояснение = НСтр("ru = 'Оплачено таможенных платежей и реализовано товара'");
				Легенда =
					НСтр("ru = 'Поскольку в стоимости реализованных товаров таможенных платежей оплачено и списано только на %1, эта сумма признана расходом.'");
				НужныПараметры = Истина;
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ВидРасхода = Строка(Перечисления.ВидыРасходовУСН.Услуги) Тогда
		Если ПолностьюПризнан Тогда
			Пояснение = НСтр("ru = 'Услуги оплачены полностью'");
			Легенда = НСтр("ru = 'Услуги оплачены полностью, поэтому вся сумма признана в расходах.'");
		Иначе
			Пояснение = НСтр("ru = 'Оплачено услуг'");
			Легенда = 
				НСтр("ru = 'Поскольку услуги оплачены только на %1, эта сумма признана расходом.'");
			НужныПараметры = Истина;
		КонецЕсли;
	КонецЕсли;
	
	ОбластьСтрокаДанных.Параметры.Пояснение = Пояснение;
	Результат.Вывести(ОбластьСтрокаДанных);
	Если НужныПараметры Тогда
		СуммаСтрокой = СтрСоединить(
			ОбщегоНазначенияКлиентСервер.МассивЗначений(Формат(Сумма, "ЧДЦ=2"), Валюта),
			Символы.НПП);
		Легенда = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(Легенда, СуммаСтрокой);
	КонецЕсли;
	МассивПодсказка.Добавить(Легенда);
	
КонецПроцедуры

Функция ВидДокументаВозвратТоваровПоставщику()
	Возврат "ВозвратТоваровПоставщику";
КонецФункции

Функция ЭтоПередачаНаРеализацию(Документ)
	
	Возврат ОбщегоНазначения.СсылкаСуществует(Документ)
		И ТипЗнч(Документ) = Тип("ДокументСсылка.РеализацияТоваровУслуг")
		И ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Документ, "ВидОперации") =
			Перечисления.ВидыОперацийРеализацияТоваров.ПередачаТоваров;
	
КонецФункции

#КонецОбласти

#КонецЕсли