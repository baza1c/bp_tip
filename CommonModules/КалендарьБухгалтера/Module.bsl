#Область ПрограммныйИнтерфейс

Функция ПредставлениеПериодаСобытия(НачалоПериода, КонецПериода) Экспорт
	
	Возврат НРег(ПредставлениеПериода(НачалоПериода, КонецПериода, "ФП=Истина"));
	
КонецФункции

// Возвращает массив периодов в интервале. 
// Возвращаются все периоды, пересекающиеся с интервалом.
// Возвращаются даты начала периода.
Функция Периоды(НачалоИнтервала, КонецИнтервала, Период) Экспорт
	
	Периоды = Новый Массив;
	
	ТекущийПериод = ИнтерфейсыВзаимодействияБРОКлиентСервер.НачалоПериода(Период, КонецИнтервала);
	Периоды.Добавить(ТекущийПериод);
	
	Пока ТекущийПериод > НачалоИнтервала Цикл
	
		ТекущийПериод = ИнтерфейсыВзаимодействияБРОКлиентСервер.ДобавитьПериод(ТекущийПериод, Период, -1);
		Периоды.Вставить(0, ТекущийПериод); // Пятимся назад, а значения в массиве хотим по возрастанию.
	
	КонецЦикла;
	
	Возврат Периоды;
	
КонецФункции

Функция ДатаНачалаДеятельности(Организация) Экспорт
	
	НачалоИнтервала = КалендарьБухгалтераПовтИсп.ДатаНачалаДеятельности(Организация);
	Возврат НачалоИнтервала;
	
КонецФункции

Функция НачалоАктуальногоПериода(Правило, ТекущаяДата, ДатаНачалаДеятельности = '0001-01-01') Экспорт
	
	// В качестве параметра Правило можно передавать ссылку на правило 
	// или иной объект (выборку, структуру) со свойствами 
	// Периодичность, СрокМесяцев, СрокДней, Действие, БазовыйПериод, ОтставаниеБазовогоПериода
	
	День = 24 * 60 * 60;
	
	СобытиеПозжеРелевантногоПериода = СрокИстекаетПослеОкончанияРелевантногоПериода(Правило);
	
	// Запас позволяет игнорировать правила переноса дат на выходные
	АктуальныйПериод = ТекущаяДата - 15 * День;
	Если СобытиеПозжеРелевантногоПериода Тогда
		
		// В 2020 году сроки по некоторым отчетам/налогам перенесены произвольным образом,
		// не совпадающим со сроками в правилах, поэтому анализируем задачи с начала года.
		Если НачалоГода(ТекущаяДата) = НачалоГода(Дата(2020, 1, 1)) Тогда
			АктуальныйПериод = НачалоГода(ТекущаяДата);
		КонецЕсли;
		
		// В 2022 году сроки уплаты страховых взносов продлены на 12 месяцев, поэтому анализируем задачи с начала года.
		Если НачалоГода(ТекущаяДата) = НачалоГода(Дата(2022, 1, 1)) Тогда
			АктуальныйПериод = НачалоГода(ТекущаяДата);
		КонецЕсли;
		
		// В 2023 году сроки уплаты страховых взносов за 2022 год дополнительно продлены, поэтому анализируем задачи с начала прошлого года.
		Если НачалоГода(ТекущаяДата) = НачалоГода(Дата(2023, 1, 1)) Тогда
			АктуальныйПериод = НачалоГода(Дата(2022, 1, 1));
		КонецЕсли;
		
		// ограничимся периодом, по которому заведомо успеваем
		АктуальныйПериод = ДобавитьМесяц(АктуальныйПериод - Правило.СрокДней * День, - Правило.СрокМесяцев);
		
		АктуальныйПериод = Макс(АктуальныйПериод, ДатаНачалаДеятельности);
		
	Иначе
		
		// Базовый период предшествует релевантному и может быть другой длительности.
		ПростойБазовыйПериод = БазовыйПериодОпределяетсяПросто(Правило);
		ДлительностьБазовогоПериода = Правило.Периодичность;
		Если Не ПростойБазовыйПериод Тогда
			ДлительностьБазовогоПериода = Правило.БазовыйПериод;
		КонецЕсли;
		
		// Базовый период всегда предшествует сроку
		ОтставаниеБазовогоПериода = Правило.ОтставаниеБазовогоПериода;
		УточнитьОтставаниеБазовогоПериода(
			ОтставаниеБазовогоПериода, 
			ДлительностьБазовогоПериода, 
			Правило.СрокМесяцев);
		
		ОпережениеБазовогоПериода = 1 + ОтставаниеБазовогоПериода;
		
		АктуальныйПериод = ИнтерфейсыВзаимодействияБРОКлиентСервер.ДобавитьПериод(
			АктуальныйПериод,
			Правило.БазовыйПериод,
			- ОпережениеБазовогоПериода);
		
	КонецЕсли;
	
	
	Возврат АктуальныйПериод;
	
КонецФункции

Функция СрокИстекаетПослеОкончанияРелевантногоПериода(Правило) Экспорт
	
	// В качестве параметра можно передавать ссылку на правило 
	// или иной объект (выборку, структуру) со свойствами 
	// СрокМесяцев, СрокДней
	Возврат Не (Правило.СрокМесяцев < 0 Или Правило.СрокМесяцев = 0 И Правило.СрокДней <= 0);
	
КонецФункции

Функция БазовыйПериодОпределяетсяПросто(Правило) Экспорт
	
	// В качестве параметра можно передавать ссылку на правило 
	// или иной объект (выборку, структуру) со свойствами 
	// Действие, БазовыйПериод, Периодичность, ОтставаниеБазовогоПериода
	
	Возврат Правило.Действие <> Перечисления.ВидыДействийКалендаряБухгалтера.УплатаНалога
		Или Не ЗначениеЗаполнено(Правило.БазовыйПериод)
		Или (Правило.БазовыйПериод = Правило.Периодичность И Правило.ОтставаниеБазовогоПериода = 0);
		
КонецФункции 

Функция ЗапуститьЗаполнениеВФоне(УникальныйИдентификаторФормы, Организация, СозданаНоваяОрганизация = Ложь, ОбновитьИЗаполнитьЗадачиНачалаРаботы = Истина, ОбновитьИЗаполнитьРегулярныеЗадачи = Истина) Экспорт
	
	ПараметрыПроцедуры = Новый Структура();
	ПараметрыПроцедуры.Вставить("Организация", Организация);
	ПараметрыПроцедуры.Вставить("Упреждение", УпреждениеЗаполненияСписка());
	ПараметрыПроцедуры.Вставить("СозданаНоваяОрганизация", СозданаНоваяОрганизация);
	ПараметрыПроцедуры.Вставить("ОбновитьИЗаполнитьЗадачиНачалаРаботы", ОбновитьИЗаполнитьЗадачиНачалаРаботы);
	ПараметрыПроцедуры.Вставить("ОбновитьИЗаполнитьРегулярныеЗадачи",   ОбновитьИЗаполнитьРегулярныеЗадачи);
	
	ПараметрыВыполненияВФоне = ДлительныеОперации.ПараметрыВыполненияВФоне(УникальныйИдентификаторФормы);
	ПараметрыВыполненияВФоне.Вставить("ОжидатьЗавершение", 0); // Возвращать управление сразу
	ПараметрыВыполненияВФоне.Вставить("НаименованиеФоновогоЗадания",
		НСтр("ru = 'Обновление списка задач бухгалтера'"));
	
	Результат = ДлительныеОперации.ВыполнитьВФоне(
		"КалендарьБухгалтера.ЗаполнитьВФоне",
		ПараметрыПроцедуры,
		ПараметрыВыполненияВФоне);
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьВФоне(Параметры, ВременноеХранилищеРезультата) Экспорт
	Перем Организация, Упреждение, СозданаНоваяОрганизация;
	Перем ОбновитьИЗаполнитьЗадачиНачалаРаботы, ОбновитьИЗаполнитьРегулярныеЗадачи;
	Перем ОбновитьИЗаполнитьЗадачиСнятияСУчета;
	
	Если Параметры <> Неопределено Тогда
		
		Параметры.Свойство("Организация", Организация);
		Параметры.Свойство("Упреждение", Упреждение);
		Параметры.Свойство("СозданаНоваяОрганизация", СозданаНоваяОрганизация);
		
		Параметры.Свойство("ОбновитьИЗаполнитьЗадачиНачалаРаботы", ОбновитьИЗаполнитьЗадачиНачалаРаботы);
		Параметры.Свойство("ОбновитьИЗаполнитьРегулярныеЗадачи",   ОбновитьИЗаполнитьРегулярныеЗадачи);
		Параметры.Свойство("ОбновитьИЗаполнитьЗадачиСнятияСУчета", ОбновитьИЗаполнитьЗадачиСнятияСУчета);
		
	КонецЕсли;
	
	Если Упреждение = Неопределено Тогда
		Упреждение = УпреждениеЗаполненияСписка();
	КонецЕсли;
	
	Если СозданаНоваяОрганизация = Неопределено Тогда
		СозданаНоваяОрганизация = Ложь;
	КонецЕсли;
	
	Если ОбновитьИЗаполнитьЗадачиНачалаРаботы = Неопределено Или ОбновитьИЗаполнитьЗадачиНачалаРаботы Тогда
		ИзмененыЗадачиНачалаРаботы = РегистрыСведений.ЗадачиБухгалтера.ОбновитьИЗаполнитьЗадачиНачалаРаботы(Организация, СозданаНоваяОрганизация);
	Иначе
		ИзмененыЗадачиНачалаРаботы = Ложь;
	КонецЕсли;
	
	Если ОбновитьИЗаполнитьЗадачиСнятияСУчета = Неопределено Или ОбновитьИЗаполнитьЗадачиСнятияСУчета Тогда
		ИзмененыЗадачиСнятияСУчета = РегистрыСведений.ЗадачиБухгалтера.ОбновитьИЗаполнитьЗадачиСнятияСУчета(Организация);
	Иначе
		ИзмененыЗадачиСнятияСУчета = Ложь;
	КонецЕсли;
	
	Если ОбновитьИЗаполнитьРегулярныеЗадачи = Неопределено Или ОбновитьИЗаполнитьРегулярныеЗадачи Тогда
		ИзмененыРегулярныеЗадачи = РегистрыСведений.ЗадачиБухгалтера.ОбновитьИЗаполнитьРегулярныеЗадачи(Организация, Упреждение);
	Иначе
		ИзмененыРегулярныеЗадачи = Ложь;
	КонецЕсли;
	КалендарьБухгалтераПереопределяемый.ПриЗаполненииВФоне(Параметры, ВременноеХранилищеРезультата, Организация, ИзмененыРегулярныеЗадачи);
	
	ПоместитьВоВременноеХранилище(ИзмененыЗадачиНачалаРаботы Или ИзмененыРегулярныеЗадачи Или ИзмененыЗадачиСнятияСУчета, ВременноеХранилищеРезультата);
	
КонецПроцедуры

Процедура ЗаполнитьРегламентнымЗаданием() Экспорт
	
	ОбщегоНазначения.ПриНачалеВыполненияРегламентногоЗадания();
	
	РегистрыСведений.ЗадачиБухгалтера.ОбновитьИЗаполнитьЗадачиНачалаРаботы();
	
	ИзмененыРегулярныеЗадачи = РегистрыСведений.ЗадачиБухгалтера.ОбновитьИЗаполнитьРегулярныеЗадачи(
		, УпреждениеЗаполненияСписка());
	
	РегистрыСведений.ЗадачиБухгалтера.ОтправитьУведомленияПоЭлектроннойПочте();
	РегистрыСведений.ЗадачиБухгалтера.ОтправитьУведомленияСЭДОПоЭлектроннойПочте();
	
	КалендарьБухгалтераПереопределяемый.ПриЗаполненииРегламентнымЗаданием();
	
КонецПроцедуры

Функция НовоеРасписаниеРегламентногоЗадания()
	
	ЭталонноеРасписание = Новый РасписаниеРегламентногоЗадания;
	
	// стандартный вариант заполнения
	ЭталонноеРасписание.ПериодНедель = 1;
	ЭталонноеРасписание.ПериодПовтораДней = 1;
	
	НаборПериодов = Новый Массив;
	Для Инд = 1 По 7 Цикл
		НаборПериодов.Добавить(Инд);
	КонецЦикла;
	ЭталонноеРасписание.ДниНедели = НаборПериодов;
	
	НаборПериодов = Новый Массив;
	Для Инд = 1 По 12 Цикл
		НаборПериодов.Добавить(Инд);
	КонецЦикла;
	ЭталонноеРасписание.Месяцы = НаборПериодов;
	
	Возврат ЭталонноеРасписание;
	
КонецФункции

// Для регламентного задания ОбновлениеЗадачБухгалтера устанавливает расписание в зависимости от типа СУБД (файловая/серверная).
//
Процедура ИзменитьРасписаниеСогласноРежимуРаботы() Экспорт
	
	ЭталонноеРасписаниеЗадания = ОбщегоНазначенияКлиентСервер.РасписаниеВСтруктуру(НовоеРасписаниеРегламентногоЗадания());
	ЭталонноеРасписаниеЗадания.ВремяНачала = ВремяНачалаОбновленияЗадачБухгалтера();
	
	РегламентныеЗаданияЗадачБухгалтера = РегламентныеЗаданияСервер.НайтиЗадания(
		Новый Структура("Метаданные", "ОбновлениеЗадачБухгалтера"));
	Для каждого РегламентноеЗадание Из РегламентныеЗаданияЗадачБухгалтера Цикл
		
		СуществующееРасписание = ОбщегоНазначенияКлиентСервер.РасписаниеВСтруктуру(РегламентноеЗадание.Расписание);
		Если ОбщегоНазначения.ДанныеСовпадают(СуществующееРасписание, ЭталонноеРасписаниеЗадания) Тогда
			Продолжить;
		КонецЕсли;
		
		РегламентныеЗаданияСервер.УстановитьРасписаниеРегламентногоЗадания(РегламентноеЗадание, ЭталонноеРасписаниеЗадания);
		
	КонецЦикла;
	
КонецПроцедуры

Функция УпреждениеЗаполненияСписка() Экспорт
	
	Возврат 14;
	
КонецФункции

Функция ВремяНачалаОбновленияЗадачБухгалтера()
	
	// Предполагается три варианта расписания выполнения регламентного задания ОбновлениеЗадачБухгалтера в зависимости от СУБД:
	// 1) Файловая база. Задание запускается в период предполагаемой низкой активности пользователя - после обеда.
	// 2) Серверная база. Задание запускается ночью после технологических заданий СУБД и ИБ (индексы, агрегаты, поиск).
	// 3) Сервис. Планирование задания выполняется на ближайшую ночь в момент использования функциональности.
	//    Алгоритм планирования - см. КалендарьБухгалтера.ЗапланироватьОбновлениеЗадачБухгалтера()
	
	Возврат ?(ОбщегоНазначения.ИнформационнаяБазаФайловая(), Дата(1, 1, 1, 14, 22, 0), Дата(1, 1, 1, 2, 22, 0));
	
КонецФункции

Процедура УточнитьОтставаниеБазовогоПериода(ОтставаниеБазовогоПериода, ДлительностьБазовогоПериода, СрокМесяцев) Экспорт
	Если СрокМесяцев < -1 И ДлительностьБазовогоПериода = Перечисления.Периодичность.Месяц Тогда
		ОтставаниеБазовогоПериода = Макс(ОтставаниеБазовогоПериода, - 1 - СрокМесяцев);
	КонецЕсли;
КонецПроцедуры

// Возвращает возможность выполнения задачи текущим пользователем
//
Функция ПравоВыполненияЗадачи(Задача) Экспорт
	
	ЕстьПраво = Ложь;
	КалендарьБухгалтераПереопределяемый.ПолучитьПравоВыполненияЗадачи(ЕстьПраво, Задача);
	Возврат ЕстьПраво;
	
КонецФункции

// Выполняет обновление задач по указанной организации.
//
// Параметры:
//	Организация - СправочникСсылка.Организации - Организация, для которой проверяется актуальность задач.
//	БыстроеОбновление - Булево - Признак необходимости проверки актуальности задач перед обновлением.
//		Если Истина, то в случае, когда задачи актуальны, обновление не запускается.
//
Процедура ОбновитьЗадачи(Организация, БыстроеОбновление = Истина) Экспорт
	
	ЗапланироватьОбновлениеЗадачБухгалтера();
	
	УпреждениеЗаполнения = КалендарьБухгалтера.УпреждениеЗаполненияСписка();
	
	Если БыстроеОбновление Тогда
		
		// Обеспечим, с одной стороны, наличие задач на несколько дней вперед, с другой стороны, отсутствие лишних
		// срабатываний для пользователя, хотя бы раз в неделю заходящего в базу.
		МинимальныйГоризонтАктуальностиЗадач = ТекущаяДатаСеанса() + УпреждениеЗаполнения / 2 * 86400;
		
		ДатаАктуальности = РегистрыСведений.АктуальностьСпискаЗадачБухгалтера.ДатаАктуальности(Организация);
		Если МинимальныйГоризонтАктуальностиЗадач <= КонецМесяца(ДатаАктуальности) Тогда
			// Перезаполнение списка задач не требуется
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	ПараметрыЗаполнения = Новый Структура();
	ПараметрыЗаполнения.Вставить("Организация", Организация);
	ПараметрыЗаполнения.Вставить("Упреждение",  УпреждениеЗаполнения);
	ПараметрыЗаполнения.Вставить("ОбновитьИЗаполнитьЗадачиНачалаРаботы", Ложь);
	ПараметрыЗаполнения.Вставить("ОбновитьИЗаполнитьРегулярныеЗадачи",   Истина);
	
	АдресХранилища = ПоместитьВоВременноеХранилище(Неопределено);
	
	ЗаполнитьВФоне(ПараметрыЗаполнения, АдресХранилища);
	
КонецПроцедуры

// При работе в режиме сервиса добавляем в очередь выполнение регламентного задания ОбновлениеЗадачБухгалтера.
// Вызов данной процедуры выполняется из мест, непосредственно использующих функциональность списка задач бухгалтера.
// Таким образом периодическое выполнение обновлений списка задач происходит только для активных областей.
//
Процедура ЗапланироватьОбновлениеЗадачБухгалтера() Экспорт
	
	Если Не ОбщегоНазначения.РазделениеВключено()
		Или Не ОбщегоНазначения.ПодсистемаСуществует("ТехнологияСервиса.ОчередьЗаданий") Тогда
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	
	МетаданныеРегламентногоЗадания = Метаданные.РегламентныеЗадания.ОбновлениеЗадачБухгалтера;
	ПланируемыйМоментЗапуска = (КонецДня(ТекущаяДатаСеанса()) + 1) + (ВремяНачалаОбновленияЗадачБухгалтера() - '00010101');
	
	ПараметрыПоискаЗадания = Новый Структура;
	ПараметрыПоискаЗадания.Вставить("ИмяМетода",        МетаданныеРегламентногоЗадания.ИмяМетода);
	ПараметрыПоискаЗадания.Вставить("ОбластьДанных",    РаботаВМоделиСервиса.ЗначениеРазделителяСеанса());
	ПараметрыПоискаЗадания.Вставить("СостояниеЗадания", Перечисления.СостоянияЗаданий.Запланировано);
	ПараметрыПоискаЗадания.Вставить("Использование",    Истина);
	
	// Получаем ранее запланированные выполнения задания.
	ЗапланированныеВыполнения = РегламентныеЗаданияСервер.НайтиЗадания(ПараметрыПоискаЗадания);
	
	// Проверяем, есть ли запланированные на требуемую ночь (или ранее).
	УжеЗапланированоВыполнение = Ложь;
	Для каждого ЗапланированноеВыполнение Из ЗапланированныеВыполнения Цикл
		ОтклонениеОтПлана = ЗапланированноеВыполнение.ЗапланированныйМоментЗапуска - ПланируемыйМоментЗапуска;
		Если ОтклонениеОтПлана < 8 * 60 * 60 Тогда
			УжеЗапланированоВыполнение = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	// Создаём новый момент запуска.
	Если Не УжеЗапланированоВыполнение Тогда
		ПараметрыЗадания = Новый Структура;
		ПараметрыЗадания.Вставить("Метаданные",                               МетаданныеРегламентногоЗадания);
		ПараметрыЗадания.Вставить("ЗапланированныйМоментЗапуска", 	          ПланируемыйМоментЗапуска);
		ПараметрыЗадания.Вставить("ИнтервалПовтораПриАварийномЗавершении", 	  МетаданныеРегламентногоЗадания.ИнтервалПовтораПриАварийномЗавершении);
		ПараметрыЗадания.Вставить("КоличествоПовторовПриАварийномЗавершении", МетаданныеРегламентногоЗадания.КоличествоПовторовПриАварийномЗавершении);
		РегламентныеЗаданияСервер.ДобавитьЗадание(ПараметрыЗадания);
	КонецЕсли;
	
КонецПроцедуры

// При работе в режиме сервиса отключает предопределенное регламентное задание ОбновлениеЗадачБухгалтера.
//
Процедура ОтключитьОбновлениеЗадачБухгалтераВСервисе() Экспорт
	
	Если Не ОбщегоНазначения.РазделениеВключено()
		Или Не ОбщегоНазначения.ПодсистемаСуществует("ТехнологияСервиса.ОчередьЗаданий") Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		РегламентныеЗаданияСервер.УстановитьИспользованиеРегламентногоЗадания(Метаданные.РегламентныеЗадания.ОбновлениеЗадачБухгалтера, Ложь);
	Исключение
		
		ЗаписьЖурналаРегистрации("ПриВключенииРазделенияПоОбластямДанных",
			УровеньЖурналаРегистрации.Ошибка,
			Метаданные.РегламентныеЗадания.ОбновлениеЗадачБухгалтера,
			,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()),
			РежимТранзакцииЗаписиЖурналаРегистрации.Независимая);
		ВызватьИсключение;
		
	КонецПопытки;

КонецПроцедуры

Функция СписокЗадачАктуален(ДатаАктуальности) Экспорт
	
	Возврат НачалоДня(ТекущаяДатаСеанса()) < ДатаАктуальности;
	
КонецФункции

Функция СобытияКалендаряБухгалтера(Организации, ОтборЗадач) Экспорт
	
	ЗадачиОрганизаций = Новый Соответствие();
	КалендарьБухгалтераПереопределяемый.ЗаполнитьСобытияКалендаряБухгалтера(ЗадачиОрганизаций, Организации, ОтборЗадач);
	Возврат ЗадачиОрганизаций;
	
КонецФункции

// Возвращает количество просроченных не выполненных задач по организациям.
//
// Параметры:
//   Организации - Массив организаций, по которым нужно определить количество просроченных задач.
//   ОтборЗадач - Структура - описывает отборы по типам задач, описание полей см. в НовыйНовыйОтборЗадачПоВидам
// Возвращаемое значение:
//   Соответствие - Соответствие, которое содержит в качестве ключа организацию, а в качестве значения - количество просроченных задач.
//
Функция КоличествоПросроченныхСобытийКалендаряБухгалтера(Организации, ОтборЗадач) Экспорт
	
	КоличествоПросроченных = Новый Соответствие;
	КалендарьБухгалтераПереопределяемый.ПолучитьКоличествоПросроченныхСобытийКалендаряБухгалтера(КоличествоПросроченных, Организации, ОтборЗадач);
	Возврат КоличествоПросроченных;
	
КонецФункции

// Возвращает дату, которая отличается указанной даты ДатаОт на количество дней,
// входящих в указанный график или производственный календарь ГрафикРаботы.
//
// Параметры:
//	 ГрафикРаботы	- СправочникСсылка.Календари, СправочникСсылка.ПроизводственныеКалендари - график или 
//                    производственный календарь, который необходимо использовать для расчета даты.
//	 ДатаОт			- Дата - дата, от которой нужно рассчитать количество дней.
//	 КоличествоДней	- Число - количество дней, на которые нужно увеличить дату начала.
//
// Возвращаемое значение:
//	 Дата, Неопределено - дата, увеличенная или уменьшенная на количество дней, входящих в график.
//	                      Если выбранный график не заполнен, возвращается Неопределено.
//
Функция РабочаяДатаПоКалендарю(ГрафикРаботы, Знач ДатаОт, Знач КоличествоДней) Экспорт
	
	ДатаОт = НачалоДня(ДатаОт);
	
	Если КоличествоДней = 0 Тогда
		Возврат ДатаОт;
	ИначеЕсли КоличествоДней > 0 Тогда
		
		// Текущий день не учитываем при расчете переноса.
		// Приращение рабочих дней выполняем всегда со следующего рабочего дня.
		// Это позволяет корректно и без дополнительных вычислений рассчитать сдвиг рабочих дней, 
		// если ДатаОт выпадает на выходной день.
		ДатаОт = КалендарныеГрафики.ДатаПоКалендарю(ГрафикРаботы, ДатаОт, 1, Ложь);
		Если ДатаОт = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;
		
		Возврат КалендарныеГрафики.ДатаПоКалендарю(ГрафикРаботы, ДатаОт, КоличествоДней - 1, Ложь);
		
	Иначе
		День = 24 * 60 * 60;
		МассивДней = Новый Массив;
		
		// Определяем количество рабочих дней с небольшим запасом, 
		// поскольку рабочих дней всегда меньше календарных.
		КоличествоДней = -КоличествоДней;
		Запас = 4;
		Для НомерДня = 1 По КоличествоДней * Запас Цикл
			МассивДней.Добавить(НомерДня);
		КонецЦикла;
		
		РабочиеДаты = КалендарныеГрафики.ДатыПоКалендарю(
			ГрафикРаботы, ДатаОт - КоличествоДней * День * Запас, МассивДней, Ложь, Ложь);
		
		Если РабочиеДаты <> Неопределено Тогда
			// Интересны только рабочие даты не превышающие значение переменной ДатаОт.
			ГраницаРабочихДат = -1;
			Для Индекс = 0 По РабочиеДаты.ВГраница() Цикл
				Если РабочиеДаты[Индекс] >= ДатаОт Тогда
					ГраницаРабочихДат = Индекс;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Если РабочиеДаты.Количество() >= 0 И (ГраницаРабочихДат - КоличествоДней) > 0 Тогда
				Возврат РабочиеДаты[ГраницаРабочихДат - КоличествоДней];
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область ИнформационнаяПанель

Функция ДанныеЗадачиБухгалтера(Организация) Экспорт
	
	ДанныеЗадачиБухгалтера = Неопределено;
	КалендарьБухгалтераПереопределяемый.ПолучитьДанныеЗадачиБухгалтера(ДанныеЗадачиБухгалтера, Организация);
	Возврат ДанныеЗадачиБухгалтера;
	
КонецФункции

#КонецОбласти

#Область КалендарьGoogle

Функция СобытияКалендаряДляGoogle(Организации) Экспорт
	
	ОтборЗадачПоВидам = НовыйНовыйОтборЗадачПоВидам();
	ЗадачиОрганизаций = СобытияКалендаряБухгалтера(Организации, ОтборЗадачПоВидам);
	
	Для Каждого ЗадачиОрганизации ИЗ ЗадачиОрганизаций Цикл
		ДобавитьОписаниеВСписокЗадач(ЗадачиОрганизации.Значение);
	КонецЦикла;
	
	Возврат ЗадачиОрганизаций;
	
КонецФункции

Процедура ДобавитьОписаниеВСписокЗадач(ЗадачиОрганизации)
	
	ЗадачиОрганизации.Колонки.Добавить("Описание", Новый ОписаниеТипов("Строка"));
	
	Для Каждого Задача Из ЗадачиОрганизации Цикл
		
		Если Задача.Подзадачи.Количество() = 1 Тогда
			Задача.Описание = Задача.Подзадачи[0].Наименование;
		ИначеЕсли Задача.Подзадачи.Количество() > 1 Тогда
			Описания = Новый Массив;
			НомерПодзадачи = 0;
			Для Каждого Подзадача Из Задача.Подзадачи Цикл
				
				Описания.Добавить(НумерованноеОписаниеПодзадачи(НомерПодзадачи, Подзадача));
				
			КонецЦикла;
			Задача.Описание = СтрСоединить(Описания, Символы.ПС);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция НумерованноеОписаниеПодзадачи(НомерПодзадачи, Подзадача)
	
	ШаблонОписания = НСтр("ru = '%1. %2'"); // номер подзадачи и тело ее описания
	
	// Сдвигаем все строки, кроме первой, чтобы аккуратно выглядели номера
	ТелоОписанияЗадачи = СтрПолучитьСтроку(Подзадача.Наименование, 1);
	Для НомерСтроки = 2 По СтрЧислоСтрок(Подзадача.Наименование) Цикл
		ТелоОписанияЗадачи = ТелоОписанияЗадачи + Символы.ПС + Символы.Таб + СтрПолучитьСтроку(Подзадача.Наименование, НомерСтроки);
	КонецЦикла;
	
	НомерПодзадачи = НомерПодзадачи + 1;
	Возврат СтрШаблон(ШаблонОписания, НомерПодзадачи, ТелоОписанияЗадачи);

КонецФункции

#КонецОбласти

#Область Конструкторы

Функция НовыйСписокЗадач() Экспорт
	
	СписокЗадач = Новый ТаблицаЗначений();
	СписокЗадач.Колонки.Добавить("Наименование", Новый ОписаниеТипов("Строка")); // Нигде не используется
	СписокЗадач.Колонки.Добавить("ДатаЗадачи",   Новый ОписаниеТипов("Дата", , , Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	СписокЗадач.Колонки.Добавить("Выполнено",    Новый ОписаниеТипов("Булево")); // Нигде не используется
	СписокЗадач.Колонки.Добавить("Подзадачи",    Новый ОписаниеТипов("Массив"));
	Возврат СписокЗадач;
	
КонецФункции

Функция НовыйНовыйОтборЗадачПоВидам() Экспорт
	
	ОтборЗадач = Новый Структура;
	ОтборЗадач.Вставить("ЗадачиОтчетностиИУплатыНалогов", Истина);
	ОтборЗадач.Вставить("РегулярныеПлатежи",              Истина);
	ОтборЗадач.Вставить("ПроверкиКонтролирующихОрганов",  Истина);
	ОтборЗадач.Вставить("ФинОтчетность",                  Истина);
	Возврат ОтборЗадач;
	
КонецФункции

Функция НовыйОписаниеПодзадачиСобытия() Экспорт
	
	ОписаниеПодзадачи = Новый Структура;
	ОписаниеПодзадачи.Вставить("Идентификатор", "");
	ОписаниеПодзадачи.Вставить("Наименование",  "");
	ОписаниеПодзадачи.Вставить("Выполнено",     Ложь);
	ОписаниеПодзадачи.Вставить("ВАрхиве",       Ложь);
	
	Возврат ОписаниеПодзадачи;
	
КонецФункции

#КонецОбласти
